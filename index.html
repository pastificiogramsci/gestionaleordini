<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Ordini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dropbox@10.34.0/dist/Dropbox-sdk.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- ‚ö†Ô∏è CONFIGURAZIONE DROPBOX - AUTOMATICA ‚ö†Ô∏è -->
    <script>
        // Imposta la tua App Key
        const DROPBOX_APP_KEY = "jxj7rn2nzrs3y0p";

        // Rilevamento automatico ambiente
        const hostname = window.location.hostname;
        let redirectUri;

        if (hostname === "127.0.0.1" || hostname === "localhost") {
            // Ambiente locale (PC)
            redirectUri = "http://127.0.0.1:5500/";
        } else {
            // Online (usa l'origine corrente dinamicamente)
            redirectUri = `${window.location.origin}${window.location.pathname}`;
        }

        const DROPBOX_CONFIG = {
            clientId: DROPBOX_APP_KEY,
            redirectUri: redirectUri
        };

        console.log("üì¶ Dropbox redirect selezionato:", redirectUri);
    </script>
    <!-- ‚ö†Ô∏è Fine configurazione Dropbox ‚ö†Ô∏è -->

    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .modal {
            display: none;
        }

        .modal.open {
            display: flex;
        }

        .autocomplete-suggestions {
            position: absolute;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .autocomplete-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .autocomplete-suggestion:hover {
            background-color: #3b82f6;
            color: white;
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .stat-card {
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Responsive mobile */
        @media (max-width: 768px) {
            .tab-btn {
                font-size: 0.75rem;
                padding: 0.75rem 0.5rem !important;
            }

            .stat-card {
                font-size: 0.875rem;
            }

            .toast {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }

            .toast>div {
                min-width: auto !important;
            }

            .max-w-4xl {
                padding: 0.5rem;
            }

            h1 {
                font-size: 1.25rem;
            }
        }

        @media (max-width: 640px) {
            .grid.md\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid.md\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }

            .grid.md\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body class="bg-gray-100">

    <!-- Badge ambiente (discreto) -->
    <div id="env-badge" style="position:fixed; bottom:10px; left:10px; 
            background:rgba(0,0,0,0.6); color:white;
            padding:6px 10px; border-radius:8px; font-size:12px;
            font-weight:500; z-index:9999; backdrop-filter:blur(4px);
            pointer-events:none; user-select:none;">
    </div>

    <script>
        const host = window.location.hostname;
        let envMessage = "";

        if (host === "127.0.0.1" || host === "localhost") {
            envMessage = "Locale";
        }
        else if (/^192\.168\./.test(host) || /^10\./.test(host)) {
            envMessage = "LAN";
        }
        else {
            envMessage = "Online";
        }

        document.getElementById("env-badge").textContent = envMessage;
    </script>

    <!-- Schermata Login/Password -->
    <div id="auth-screen"
        class="fixed inset-0 bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center z-[9999] p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-8 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-8">
                <div
                    class="inline-block bg-gradient-to-br from-blue-600 to-purple-700 text-white rounded-full w-20 h-20 flex items-center justify-center mb-4">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">üîê Gestionale Sicuro</h1>
                <p class="text-gray-600 mt-2" id="auth-subtitle">Inserisci la password per accedere</p>
            </div>

            <!-- Form Password -->
            <div id="auth-form">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="auth-password"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Inserisci la password" onkeypress="if(event.key === 'Enter') authManager.login()">
                </div>

                <div class="mb-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="auth-remember" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm text-gray-700">Ricordami per 30 giorni</span>
                    </label>
                </div>

                <button onclick="if(typeof authManager !== 'undefined') authManager.login()"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-700 text-white py-3 px-4 rounded-lg hover:from-blue-700 hover:to-purple-800 font-semibold">
                    üîì Accedi
                </button>

                <div id="auth-error" class="hidden mt-4 p-3 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm">
                </div>
            </div>

            <!-- Setup Iniziale (Prima Password) -->
            <div id="auth-setup" class="hidden">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                    <p class="text-sm text-blue-800">
                        <strong>Prima configurazione:</strong> Crea una password per proteggere i tuoi dati con
                        crittografia AES-256.
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nuova Password</label>
                    <input type="password" id="setup-password"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Almeno 6 caratteri">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Conferma Password</label>
                    <input type="password" id="setup-password-confirm"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Ripeti la password"
                        onkeypress="if(event.key === 'Enter' && typeof authManager !== 'undefined') authManager.setupPassword()">
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                    <p class="text-sm text-yellow-800">
                        ‚ö†Ô∏è <strong>IMPORTANTE:</strong> Annota la password in un posto sicuro. Se la dimentichi, NON
                        potrai recuperare i dati!
                    </p>
                </div>

                <button onclick="authManager.setupPassword()"
                    class="w-full bg-gradient-to-r from-green-600 to-emerald-700 text-white py-3 px-4 rounded-lg hover:from-green-700 hover:to-emerald-800 font-semibold">
                    ‚úÖ Crea Password
                </button>
            </div>
        </div>
    </div>

    <!-- Indicatore Sincronizzazione -->
    <div id="sync-indicator" class="sync-indicator hidden">
        <div class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <span>Sincronizzazione...</span>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Modal Conferma Eliminazione -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-gray-800">‚ö†Ô∏è Conferma Eliminazione</h3>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex gap-3">
                <button onclick="app.cancelDelete()"
                    class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 font-medium">
                    Annulla
                </button>
                <button onclick="app.confirmDelete()"
                    class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 font-medium">
                    Elimina
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto p-4">
        <!-- Schermata Scanner QR (quando si apre da URL con parametro scan) -->
        <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
        <div id="qr-scanner-page" class="hidden" style="display: none !important;">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h1 class="text-3xl font-bold text-center mb-6">üì∑ Scanner Fidelity Card</h1>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                    <p class="text-sm text-blue-800">
                        <strong>Inquadra il QR code</strong> sulla tessera del cliente per visualizzare i suoi bollini e
                        premi
                    </p>
                </div>

                <!-- Video scanner -->
                <div class="relative mb-4">
                    <video id="scanner-page-video" class="w-full rounded-lg border-4 border-purple-500" autoplay
                        playsinline></video>
                    <canvas id="scanner-page-canvas" class="hidden"></canvas>

                    <!-- Overlay di mira -->
                    <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
                        <div class="w-64 h-64 border-4 border-green-400 rounded-lg shadow-lg"
                            style="box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
                    </div>
                </div>

                <div id="scanner-status" class="text-center text-lg font-semibold mb-4"></div>

                <!-- Carica immagine alternativa -->
                <div class="text-center mb-4">
                    <p class="text-sm text-gray-600 mb-2">Oppure carica un'immagine:</p>
                    <input type="file" id="scanner-page-file" accept="image/*" class="mx-auto"
                        onchange="app.scanFromFilePage(event)">
                </div>

                <button onclick="app.closeQRScannerPage()"
                    class="w-full bg-gray-200 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-300 font-medium">
                    ‚Üê Torna al Gestionale
                </button>
            </div>
        </div>

        <header class="bg-white shadow-md rounded-lg mb-4 sticky top-4 z-10" id="main-header">
            <h1 class="text-2xl font-bold text-gray-800 p-4 text-center">üìã Gestionale Ordini</h1>
            <nav class="border-t border-gray-200">
                <div class="flex justify-around overflow-x-auto">
                    <button onclick="app.switchTab('dashboard')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="dashboard">Dashboard</button>
                    <button onclick="app.switchTab('ordini')"
                        class="tab-btn flex-1 p-4 border-b-2 border-blue-600 text-blue-600 font-semibold whitespace-nowrap"
                        data-tab="ordini">Ordini</button>
                    <button onclick="app.switchTab('preparazione')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="preparazione">Preparazione</button>
                    <button onclick="app.switchTab('prodotti')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="prodotti">Prodotti</button>
                    <button onclick="app.switchTab('clienti')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="clienti">Clienti</button>
                    <button onclick="app.switchTab('impostazioni')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="impostazioni">Impostazioni</button>
                </div>
            </nav>
        </header>

        <!-- Tab Dashboard -->
        <div id="tab-dashboard" class="tab-content hidden">
            <div class="space-y-4">
                <!-- Statistiche Rapide -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow-lg cursor-pointer"
                        onclick="app.filterByToday()">
                        <div class="text-sm opacity-90">Ordini Oggi</div>
                        <div class="text-3xl font-bold mt-1" id="stat-orders-today">0</div>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow-lg cursor-pointer"
                        onclick="app.filterByToday()">
                        <div class="text-sm opacity-90">Fatturato Oggi</div>
                        <div class="text-2xl font-bold mt-1" id="stat-revenue-today">‚Ç¨0</div>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow-lg cursor-pointer"
                        onclick="app.filterByMonth()">
                        <div class="text-sm opacity-90">Ordini Mese</div>
                        <div class="text-3xl font-bold mt-1" id="stat-orders-month">0</div>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow-lg cursor-pointer"
                        onclick="app.filterByMonth()">
                        <div class="text-sm opacity-90">Fatturato Mese</div>
                        <div class="text-2xl font-bold mt-1" id="stat-revenue-month">‚Ç¨0</div>
                    </div>
                </div>

                <!-- Scanner QR Code nella Dashboard -->
                <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
                <div class="bg-white rounded-lg shadow-lg p-6" style="display: none !important;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üì∑ Scanner Tessere Fidelity</h3>
                        <button id="dashboard-scanner-toggle" onclick="app.toggleDashboardScanner()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-medium">
                            Avvia Scanner
                        </button>
                    </div>

                    <div id="dashboard-scanner-container" class="hidden">
                        <!-- Area Video Scanner -->
                        <div class="relative mb-4">
                            <video id="dashboard-scanner-video" class="w-full rounded-lg border-4 border-green-500"
                                autoplay playsinline style="max-height: 400px; display: none;"></video>
                            <canvas id="dashboard-scanner-canvas" class="hidden"></canvas>

                            <!-- Overlay di mira -->
                            <div id="dashboard-scanner-overlay"
                                class="absolute inset-0 pointer-events-none items-center justify-center hidden">
                                <div class="w-48 h-48 border-4 border-green-400 rounded-lg shadow-lg"
                                    style="box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
                            </div>
                        </div>

                        <!-- Stato Scanner -->
                        <div id="dashboard-scanner-status" class="text-center text-lg font-semibold mb-4"></div>

                        <!-- Opzione carica immagine -->
                        <div class="text-center mb-4">
                            <p class="text-sm text-gray-600 mb-2">Oppure carica un'immagine:</p>
                            <input type="file" id="dashboard-scanner-file" accept="image/*" class="mx-auto"
                                onchange="app.scanFromFileDashboard(event)">
                        </div>
                    </div>
                </div>

                <!-- Grafici e Analisi -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">üìä Analisi Rapida</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Stati Ordini</h4>
                            <div id="prep-status-chart" class="space-y-2"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Pagamenti</h4>
                            <div id="payment-status-chart" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Top Clienti -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">‚≠ê Top 5 Clienti</h3>
                    <div id="top-customers" class="space-y-3"></div>
                </div>

                <!-- Azioni Rapide -->
                <div class="grid md:grid-cols-3 gap-4">
                    <button onclick="app.switchTab('clienti'); app.openCustomerModal();"
                        class="bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-purple-700">
                        üë• Nuovo Cliente
                    </button>
                    <button onclick="app.exportOrders()"
                        class="bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-green-700">
                        üì• Esporta Ordini (CSV)
                    </button>
                    <button onclick="app.backupData()"
                        class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700">
                        üíæ Backup Locale
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-ordini" class="tab-content">
            <!-- Barra Ricerca e Filtri -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
                <div class="grid md:grid-cols-3 gap-3">
                    <input type="text" id="order-search" placeholder="üîç Cerca per numero, cliente..."
                        class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none"
                        oninput="app.filterOrders()">
                    <select id="prep-filter"
                        class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none"
                        onchange="app.filterOrders()">
                        <option value="">Tutti gli stati</option>
                        <option value="da preparare">Da preparare</option>
                        <option value="completato">Completato</option>
                        <option value="consegnato">Consegnato</option>
                    </select>
                    <select id="payment-filter"
                        class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none"
                        onchange="app.filterOrders()">
                        <option value="">Tutti i pagamenti</option>
                        <option value="non pagato">Non pagato</option>
                        <option value="pagato">Pagato</option>
                    </select>
                </div>
            </div>

            <button onclick="app.openOrderModal()"
                class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 mb-4">+
                Nuovo Ordine</button>
            <div id="orders-list" class="space-y-3"></div>
        </div>

        <!-- Tab Preparazione -->
        <div id="tab-preparazione" class="tab-content hidden">
            <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-lg shadow-lg mb-4">
                <h2 class="text-2xl font-bold mb-2">üî• Preparazione in Serie</h2>
                <p class="text-sm opacity-90">Raggruppa i prodotti per preparare tutti gli ordini contemporaneamente</p>
            </div>

            <!-- Filtri Data -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Consegna</label>
                        <input type="date" id="prep-date-filter"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                            onchange="app.filterPreparation()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mostra</label>
                        <select id="prep-status-filter"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                            onchange="app.filterPreparation()">
                            <option value="notcompleted">Solo da preparare</option>
                            <option value="all">Tutti</option>
                            <option value="completed">Solo completati</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="app.renderPreparation()"
                            class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 font-medium">
                            üîÑ Aggiorna
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista Prodotti Raggruppati -->
            <div id="preparation-list" class="space-y-4"></div>
        </div>

        <div id="tab-prodotti" class="tab-content hidden">
            <button onclick="app.openProductModal()"
                class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-green-700 mb-4">+
                Nuovo Prodotto</button>
            <div id="products-list" class="space-y-3"></div>
        </div>

        <div id="tab-clienti" class="tab-content hidden">
            <!-- Link Scanner Rapido -->
            <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white p-6 rounded-lg shadow-lg mb-4"
                style="display: none !important;">
                <h2 class="text-xl font-bold mb-2">üöÄ Scanner Veloce</h2>
                <p class="text-sm mb-4">Apri lo scanner in modalit√† fullscreen per scansionare rapidamente i clienti</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.openQRScannerPage()"
                        class="bg-white text-green-600 font-bold py-3 px-4 rounded-lg hover:bg-gray-100">
                        üì∑ Apri Scanner
                    </button>
                    <button onclick="app.copyScannerLink()"
                        class="bg-white text-green-600 font-bold py-3 px-4 rounded-lg hover:bg-gray-100">
                        üîó Copia Link
                    </button>
                </div>
                <p class="text-xs mt-2 opacity-90">üí° Salva il link come segnalibro per accesso rapido allo scanner!</p>
            </div>

            <!-- Aggiungi Cliente e Gestione -->
            <div class="grid md:grid-cols-1 gap-4 mb-4">
                <!-- Nuovo Cliente -->
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold mb-4">üë• Gestione Clienti</h2>
                    <button onclick="app.openCustomerModal()"
                        class="w-full bg-white text-purple-600 font-bold py-3 px-4 rounded-lg hover:bg-gray-100 mb-3">
                        + Nuovo Cliente
                    </button>
                    <p class="text-sm opacity-90">Crea un nuovo cliente per gestire ordini e informazioni</p>
                </div>

                <!-- Cliente Veloce con Bollini -->
                <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
                <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-lg shadow-lg"
                    style="display: none !important;">
                    <h2 class="text-xl font-bold mb-4">‚ö° Cliente in Negozio</h2>
                    <button onclick="app.openQuickCustomerAdd()"
                        class="w-full bg-white text-orange-600 font-bold py-3 px-4 rounded-lg hover:bg-gray-100 mb-3">
                        + Aggiungi Cliente & Bollini
                    </button>
                    <p class="text-sm opacity-90">Cliente senza ordine? Aggiungi bollini velocemente!</p>
                </div>
            </div>

            <!-- Scanner QR -->
            <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
            <div class="bg-white p-6 rounded-lg shadow mb-4" style="display: none !important;">
                <h2 class="text-xl font-bold mb-4">üîç Scanner Tessera Fidelity</h2>
                <button onclick="app.openQRScanner()"
                    class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">
                    üì∑ Scansiona QR Code Cliente
                </button>
            </div>

            <!-- Ricerca Cliente -->
            <div class="bg-white p-6 rounded-lg shadow mb-4">
                <h2 class="text-xl font-bold mb-4">üîç Cerca Cliente</h2>
                <div class="relative">
                    <input type="text" id="customer-search" class="w-full px-3 py-2 border rounded-lg"
                        placeholder="Nome, cognome o telefono..." oninput="app.searchCustomer(this.value)">
                    <div id="customer-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
            </div>

            <!-- Lista Clienti con Bollini e Info -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">üí≥ Tutti i Clienti</h2>
                <div id="customers-list" class="space-y-3"></div>
            </div>
        </div>

        <div id="tab-impostazioni" class="tab-content hidden">
            <!-- Sicurezza -->
            <div class="bg-white p-6 rounded-lg shadow space-y-4 mb-4">
                <h2 class="text-xl font-bold">üîê Sicurezza</h2>

                <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                    <p class="text-sm text-green-800">
                        ‚úÖ <strong>Protezione attiva:</strong> I tuoi dati sono criptati con AES-256
                    </p>
                    <p class="text-xs text-green-700 mt-1">
                        Sia i dati locali che i backup su Dropbox sono protetti dalla tua password
                    </p>
                </div>

                <div class="grid md:grid-cols-2 gap-3">
                    <button onclick="authManager.logout()"
                        class="bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 font-medium flex items-center justify-center gap-2">
                        üö™ Esci (Logout)
                    </button>

                    <button onclick="authManager.openChangePasswordModal()"
                        class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-medium flex items-center justify-center gap-2">
                        üîí Cambia Password
                    </button>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                    <p class="text-sm text-yellow-800">
                        <strong>‚è∞ Auto-logout:</strong> Verrai disconnesso automaticamente dopo 2 ore di inattivit√†
                    </p>
                </div>
            </div>

            <!-- Configurazione Dropbox -->
            <div class="bg-white p-6 rounded-lg shadow space-y-4 mb-4">
                <h2 class="text-xl font-bold">üîó Connessione Dropbox</h2>

                <div id="dropbox-status"></div>

                <!-- Pannello Debug (appare dopo 3 secondi di pressione) -->
                <div id="debug-panel" class="hidden bg-gray-900 text-white p-4 rounded-lg space-y-2 text-xs font-mono">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-sm">üêõ Debug Sincronizzazione</span>
                        <button onclick="document.getElementById('debug-panel').classList.add('hidden')"
                            class="text-red-400 hover:text-red-300">‚úï</button>
                    </div>
                    <div id="debug-info"></div>
                    <button onclick="app.forceCheckRemote()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded mt-2">
                        üîç Forza Controllo Remoto
                    </button>
                    <button onclick="app.clearDebugLogs()"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded">
                        üóëÔ∏è Pulisci Log
                    </button>
                </div>

                <div id="dropbox-config" class="space-y-3">
                    <div class="bg-blue-50 p-4 rounded-lg text-sm border-l-4 border-blue-500">
                        <p class="text-blue-900 mb-3 font-semibold">
                            üì¶ Come configurare Dropbox
                        </p>

                        <ol class="text-xs text-blue-800 space-y-2 mb-4">
                            <li class="flex items-start gap-2">
                                <span class="font-bold min-w-[20px]">1.</span>
                                <span>Vai su <a href="https://www.dropbox.com/developers/apps" target="_blank"
                                        class="text-blue-600 underline font-medium">Dropbox Developers</a> e crea una
                                    nuova app</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="font-bold min-w-[20px]">2.</span>
                                <span>Copia l'<strong>App Key</strong> dalla sezione "Settings"</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="font-bold min-w-[20px]">3.</span>
                                <span>Modifica il file HTML (riga ~30) con la tua App Key:
                                    <pre
                                        class="text-xs bg-white p-2 rounded mt-1 overflow-x-auto border border-blue-200">const DROPBOX_CONFIG = {
  clientId: '<span class="text-red-600">LA_TUA_APP_KEY</span>',
  redirectUri: "https://gestionaleordini.netlify.app/"
};</pre>
                                </span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="font-bold min-w-[20px]">4.</span>
                                <span>Aggiungi questo URL nei <strong>Redirect URIs</strong> dell'app Dropbox:<br>
                                    <code
                                        class="bg-white px-2 py-1 rounded text-xs mt-1 inline-block border border-blue-200">
                        https://gestionaleordini.netlify.app/
                    </code>
                                    <button
                                        onclick="navigator.clipboard.writeText('https://gestionaleordini.netlify.app/'); app.showToast('‚úÖ URL copiato!')"
                                        class="ml-2 text-blue-600 hover:text-blue-800" title="Copia URL">
                                        üìã
                                    </button>
                                </span>
                            </li>
                        </ol>

                        <div class="bg-green-50 border border-green-200 rounded p-3">
                            <p class="text-xs text-green-800">
                                ‚úÖ <strong>PKCE OAuth2:</strong> Sicuro, non serve App Secret!
                            </p>
                        </div>
                    </div>

                    <button onclick="app.avviaAuthDropbox()"
                        class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold">
                        üîó Connetti Dropbox
                    </button>

                    <button onclick="app.testDropboxConnection()"
                        class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 font-medium mt-2">
                        üß™ Test Connessione Dropbox
                    </button>

                    <button onclick="app.disconnectDropbox()"
                        class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 text-sm">
                        Disconnetti
                    </button>
                </div>

                <script>
                    // Mostra l'URL corrente per Redirect URI
                    document.addEventListener('DOMContentLoaded', () => {
                        const urlEl = document.getElementById('current-url');
                        if (urlEl) {
                            urlEl.textContent = `${window.location.origin}${window.location.pathname}`;
                        }
                    });
                </script>

                <div class="border-t pt-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h3 class="font-semibold">Sincronizzazione Automatica</h3>
                            <p class="text-sm text-gray-600">Sincronizza ogni 30 secondi con Dropbox</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="auto-sync-toggle" checked class="sr-only peer"
                                onchange="app.toggleAutoSync()">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                    <p class="text-sm font-semibold text-blue-900 mb-1">‚ÑπÔ∏è Come funziona (OAuth2 PKCE)</p>
                    <ul class="list-disc ml-4 space-y-1 text-sm text-blue-800">
                        <li>Inserisci l'App Key e clicca "Autorizza Dropbox"</li>
                        <li>Verrai reindirizzato a Dropbox per autorizzare l'app</li>
                        <li>Il token verr√† salvato automaticamente e non scadr√†</li>
                        <li>Attiva la sincronizzazione automatica per sync ogni 30s</li>
                        <li>Tutti i dispositivi si sincronizzeranno automaticamente</li>
                    </ul>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow space-y-4 mb-4">
                <h2 class="text-xl font-bold">Gestione Categorie Prodotti</h2>
                <button onclick="app.openCategoryModal()"
                    class="w-full bg-orange-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-orange-700">+ Nuova
                    Categoria</button>
                <div id="categories-list" class="space-y-2"></div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">Backup Manuale</h2>
                <div id="sync-status-manual" class="mb-4"></div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="app.syncToDropbox()"
                        class="bg-blue-600 text-white font-medium py-4 px-4 rounded-lg hover:bg-blue-700 flex flex-col items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span class="font-bold">Carica su Dropbox</span>
                    </button>
                    <button onclick="app.syncFromDropbox()"
                        class="bg-green-600 text-white font-medium py-4 px-4 rounded-lg hover:bg-green-700 flex flex-col items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                        </svg>
                        <span class="font-bold">Scarica da Dropbox</span>
                    </button>
                </div>
                <div id="last-sync-info" class="text-sm text-gray-600 text-center mb-4"></div>
                <details class="mb-4">
                    <summary class="cursor-pointer font-medium text-gray-700 hover:text-gray-900 py-2">üíæ Backup Locale
                    </summary>
                    <div class="mt-3 space-y-3 pl-4 border-l-2 border-gray-200">
                        <button onclick="app.downloadLocalBackup()"
                            class="w-full bg-purple-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-purple-700">Scarica
                            Backup Locale</button>
                        <button onclick="document.getElementById('local-backup-file').click()"
                            class="w-full bg-orange-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-orange-700">Carica
                            Backup Locale</button>
                        <input type="file" id="local-backup-file" class="hidden" accept=".json"
                            onchange="app.loadLocalBackup(event)">
                    </div>
                </details>
                <div class="grid grid-cols-3 gap-3 pt-4 border-t">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-blue-600" id="stats-orders">0</p>
                        <p class="text-xs text-gray-600">Ordini</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-green-600" id="stats-products">0</p>
                        <p class="text-xs text-gray-600">Prodotti</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-600" id="stats-customers">0</p>
                        <p class="text-xs text-gray-600">Clienti</p>
                    </div>
                </div>
            </div>

            <!-- Configurazione Fidelity -->
            <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
            <div class="bg-white p-6 rounded-lg shadow mt-4" style="display: none !important;">
                <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Configurazione Fidelity Card</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Attivit√†</label>
                        <input type="text" id="business-name" class="w-full px-3 py-2 border rounded-lg"
                            placeholder="Es. Pasticceria Rossi" value="La Mia Attivit√†">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‚Ç¨ per Bollino</label>
                            <input type="number" id="euros-per-stamp" class="w-full px-3 py-2 border rounded-lg"
                                value="20" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bollini per Premio</label>
                            <input type="number" id="stamps-per-reward" class="w-full px-3 py-2 border rounded-lg"
                                value="10" min="1">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Link Gruppo WhatsApp</label>
                        <input type="text" id="whatsapp-group" class="w-full px-3 py-2 border rounded-lg"
                            placeholder="https://chat.whatsapp.com/...">
                        <p class="text-xs text-gray-500 mt-1">I clienti con consenso marketing vedranno un pulsante per
                            unirsi al gruppo</p>
                    </div>

                    <button onclick="app.saveFidelityConfig()"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                        Salva Configurazione
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (ordine, prodotto, cliente, categoria) - stessi di prima -->
    <div id="order-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Nuovo Ordine</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Numero Prenotazione (Automatico)
                    </label>
                    <input type="text" id="order-number"
                        class="w-full px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed"
                        placeholder="Verr√† calcolato automaticamente" readonly>
                    <p class="text-xs text-gray-500 mt-1">ü§ñ Calcolato automaticamente in base alla data di consegna</p>
                </div>
                <div class="border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                    <h3 class="text-sm font-semibold text-blue-900 mb-3">Dati Cliente</h3>
                    <div class="relative mb-3"><label class="block text-sm font-medium text-gray-700 mb-1">Cerca
                            Cliente</label><input type="text" id="customer-search-order"
                            class="w-full px-3 py-2 border rounded-lg" placeholder="Digita nome, cognome o telefono..."
                            oninput="app.searchCustomerInOrder(this.value)">
                        <div id="customer-suggestions-order" class="autocomplete-suggestions hidden"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label><input
                                type="text" id="customer-firstname" class="w-full px-3 py-2 border rounded-lg"
                                onblur="app.checkCustomerDuplicate()" required></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Cognome *</label><input
                                type="text" id="customer-lastname" class="w-full px-3 py-2 border rounded-lg"
                                onblur="app.checkCustomerDuplicate()" required></div>
                    </div>
                    <div class="mt-3"><label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label><input
                            type="tel" id="customer-phone" class="w-full px-3 py-2 border rounded-lg"
                            onblur="app.checkCustomerDuplicate()"></div>
                    <div class="mt-3 flex items-start gap-2">
                        <input type="checkbox" id="customer-marketing-order"
                            class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="customer-marketing-order" class="text-sm text-gray-700 cursor-pointer">
                            <span class="font-medium">Acconsente a ricevere offerte promozionali</span>
                            <span class="block text-xs text-gray-500 mt-0.5">üìß Newsletter, SMS e comunicazioni
                                marketing</span>
                        </label>
                    </div>
                    <div id="customer-status" class="mt-3 text-sm"></div>
                    <input type="hidden" id="selected-customer-id">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Data Inserimento</label><input
                            type="date" id="order-created-date" class="w-full px-3 py-2 border rounded-lg bg-gray-50"
                            readonly></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Data Consegna *</label><input
                            type="date" id="order-delivery-date" class="w-full px-3 py-2 border rounded-lg" required
                            onchange="app.updateOrderNumber()"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Stato Preparazione</label><select
                            id="order-prep-status" class="w-full px-3 py-2 border rounded-lg">
                            <option value="da preparare">Da Preparare</option>
                            <option value="completato">Completato</option>
                            <option value="consegnato">Consegnato</option>
                        </select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Stato Pagamento</label><select
                            id="order-payment-status" class="w-full px-3 py-2 border rounded-lg">
                            <option value="non pagato">Non Pagato</option>
                            <option value="pagato">Pagato</option>
                        </select></div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">üí∞ Acconto (‚Ç¨)</label>
                    <input type="number" id="order-deposit" step="0.01" min="0" placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                        oninput="app.updateOrderDeposit()">
                    <p class="text-xs text-gray-600 mt-1">Lascia vuoto se non c'√® acconto</p>
                    <div id="deposit-info" class="mt-2 text-sm font-medium text-green-700 hidden"></div>
                </div>
                <div class="border-t border-b py-4">
                    <h3 class="text-lg font-semibold mb-3">Prodotti</h3>
                    <div class="space-y-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Prodotto *</label>
                            <div class="relative">
                                <input type="text" id="order-product" class="w-full px-3 py-2 border rounded-lg"
                                    placeholder="Cerca prodotto per nome..." autocomplete="off"
                                    oninput="app.searchProductForOrder(this.value)"
                                    onfocus="app.showAllProductsForOrder()">
                                <div id="product-suggestions" class="autocomplete-suggestions hidden"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Peso (kg)
                                    <span class="text-xs text-gray-500">opzionale</span>
                                </label>
                                <input type="number" id="order-weight" step="0.001" min="0" placeholder="es. 1.5"
                                    class="w-full px-3 py-2 border rounded-lg" oninput="app.calculatePriceFromWeight()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√†</label>
                                <input type="number" id="order-qty" step="0.1" min="0" placeholder="Qt√†"
                                    class="w-full px-3 py-2 border rounded-lg" oninput="app.calculateAutomaticPrice()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prezzo (‚Ç¨)</label>
                                <input type="number" id="order-price" step="0.01" min="0" placeholder="Prezzo"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded p-2 text-sm text-blue-700"
                            id="weight-info" style="display: none;">
                            üí° <span id="weight-calculation"></span>
                        </div>
                        <button onclick="app.addProductToOrder()"
                            class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-medium">
                            + Aggiungi Prodotto
                        </button>
                    </div>
                    <div id="order-items" class="space-y-2 bg-gray-50 p-3 rounded-lg min-h-[100px]">
                        <p class="text-gray-500 text-center">Nessun prodotto aggiunto</p>
                    </div>
                    <div class="text-right mt-3 text-xl font-bold">Totale: <span id="order-total">0,00 ‚Ç¨</span></div>
                </div>
            </div>
            <div class="flex justify-between mt-6">
                <button onclick="app.deleteOrder()" id="btn-delete-order"
                    class="text-red-600 hover:text-red-800 font-medium hidden">Elimina Ordine</button>
                <div class="flex gap-3 ml-auto">
                    <button onclick="app.closeModal('order-modal')"
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Annulla</button>
                    <button onclick="app.saveOrder()"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Salva Ordine</button>
                </div>
            </div>
        </div>
    </div>

    <div id="product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Nuovo Prodotto</h2>
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Nome Prodotto *</label><input
                        type="text" id="product-name" class="w-full px-3 py-2 border rounded-lg" required></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label><select
                        id="product-category" class="w-full px-3 py-2 border rounded-lg"></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Prezzo *</label><input
                            type="number" id="product-price" step="0.01" min="0"
                            class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Unit√†</label><select
                            id="product-unit" class="w-full px-3 py-2 border rounded-lg">
                            <option value="kg">kg</option>
                            <option value="pezzo">pezzo</option>
                            <option value="lt">lt</option>
                        </select></div>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                    <div class="space-y-3">
                        <div class="flex items-start gap-2">
                            <input type="checkbox" id="product-has-average-weight"
                                class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                onchange="app.toggleAverageWeightField()">
                            <label for="product-has-average-weight" class="text-sm text-gray-700 cursor-pointer">
                                <span class="font-medium">‚öñÔ∏è Calcolo automatico per peso medio</span>
                                <span class="block text-xs text-gray-600 mt-0.5">Per prodotti con peso medio fisso (es.
                                    vitello tonnato: 50g per fettina)</span>
                            </label>
                        </div>
                        <div id="average-weight-field" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Peso medio per unit√†
                                (kg)</label>
                            <input type="number" id="product-average-weight" step="0.001" min="0"
                                placeholder="es. 0.050 (50g)" class="w-full px-3 py-2 border rounded-lg">
                            <p class="text-xs text-gray-500 mt-1">Es. vitello tonnato = 0.050 kg (50g) per fettina. Il
                                sistema calcoler√†: quantit√† √ó peso medio √ó prezzo al kg</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-between mt-6">
                <button onclick="app.deleteProduct()" id="btn-delete-product"
                    class="text-red-600 hover:text-red-800 font-medium hidden">Elimina</button>
                <div class="flex gap-3">
                    <button onclick="app.closeModal('product-modal')"
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Annulla</button>
                    <button onclick="app.saveProduct()"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <div id="customer-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Nuovo Cliente</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label><input type="text"
                            id="edit-customer-firstname" class="w-full px-3 py-2 border rounded-lg" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Cognome *</label><input type="text"
                            id="edit-customer-lastname" class="w-full px-3 py-2 border rounded-lg" required></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label><input type="tel"
                        id="edit-customer-phone" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email"
                        id="edit-customer-email" class="w-full px-3 py-2 border rounded-lg"></div>
                <div class="flex items-start"><input type="checkbox" id="edit-customer-marketing" class="mt-1 mr-3">
                    <div><label class="font-medium text-gray-700">Approvazione Marketing</label>
                        <p class="text-sm text-gray-500">Autorizza invio info e promozioni</p>
                    </div>
                </div>

                <!-- Sezione Bollini Fedelt√† (solo per clienti esistenti) -->
                <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
                <div id="customer-stamps-section" class="hidden border-t pt-4 mt-4" style="display: none !important;">
                    <h3 class="text-lg font-bold mb-3">üé´ Gestione Bollini Fedelt√†</h3>
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Bollini attuali:</span>
                            <span id="customer-stamps-count" class="text-2xl font-bold text-blue-600">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Premi disponibili:</span>
                            <span id="customer-rewards-count" class="text-xl font-bold text-green-600">0</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button onclick="app.addStampsToCustomerInModal()"
                            class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 font-medium">
                            ‚ûï Aggiungi Bollini
                        </button>
                        <button onclick="app.removeStampsFromCustomerInModal()"
                            class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 font-medium">
                            ‚ûñ Rimuovi Bollini
                        </button>
                    </div>

                    <button onclick="app.sendStampsUpdateFromModal()"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-medium">
                        üì± Invia Aggiornamento WhatsApp
                    </button>
                </div>
            </div>
            <div class="flex justify-between mt-6">
                <button onclick="app.deleteCustomer()" id="btn-delete-customer"
                    class="text-red-600 hover:text-red-800 font-medium hidden">Elimina</button>
                <div class="flex gap-3">
                    <button onclick="app.closeModal('customer-modal')"
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Annulla</button>
                    <button onclick="app.saveCustomer()"
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <div id="category-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Nuova Categoria</h2>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Nome Categoria *</label><input
                    type="text" id="category-name" class="w-full px-3 py-2 border rounded-lg" required></div>
            <div class="flex justify-between">
                <button onclick="app.deleteCategory()" id="btn-delete-category"
                    class="text-red-600 hover:text-red-800 font-medium hidden">Elimina</button>
                <div class="flex gap-3">
                    <button onclick="app.closeModal('category-modal')"
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Annulla</button>
                    <button onclick="app.saveCategory()"
                        class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Fidelity Card -->
    <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
    <div id="fidelity-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"
        style="display: none !important;">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4" id="fidelity-modal-title">Fidelity Card</h2>

            <div id="fidelity-card-content" class="space-y-4">
                <!-- Contenuto dinamico -->
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModal('fidelity-modal')"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal QR Scanner -->
    <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
    <div id="qr-scanner-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"
        style="display: none !important;">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">üì∑ Scansiona QR Code</h2>

            <div class="space-y-4">
                <div class="bg-gray-100 rounded-lg p-4">
                    <video id="qr-video" class="w-full rounded-lg" style="display: none;"></video>
                    <canvas id="qr-canvas" class="w-full rounded-lg hidden"></canvas>
                    <div id="qr-result" class="text-center"></div>
                </div>

                <div class="text-center text-sm text-gray-600">
                    <p>Oppure carica un'immagine del QR code:</p>
                    <input type="file" id="qr-file" accept="image/*" class="mt-2" onchange="app.scanQRFromFile(event)">
                </div>
            </div>

            <div class="flex justify-between gap-3 mt-6">
                <button onclick="app.closeQRScanner()"
                    class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Chiudi</button>
                <button onclick="app.startQRScanner()" id="start-scanner-btn"
                    class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Avvia Camera</button>
            </div>
        </div>
    </div>

    <!-- Modal Aggiungi Cliente Rapido -->
    <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
    <div id="quick-customer-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"
        style="display: none !important;">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">‚ö° Cliente in Negozio</h2>

            <div class="space-y-4">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Flusso rapido:</strong> Inserisci nome e telefono del cliente, e il numero di bollini da
                        aggiungere!
                    </p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                        <input type="text" id="quick-firstname" class="w-full px-3 py-2 border rounded-lg"
                            oninput="app.checkQuickCustomerExists()" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cognome *</label>
                        <input type="text" id="quick-lastname" class="w-full px-3 py-2 border rounded-lg"
                            oninput="app.checkQuickCustomerExists()" required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefono *</label>
                    <input type="tel" id="quick-phone" class="w-full px-3 py-2 border rounded-lg"
                        placeholder="es. 3331234567" oninput="app.checkQuickCustomerExists()" required>
                </div>

                <!-- Status cliente esistente - SPOSTATO QUI -->
                <div id="quick-customer-status" class="hidden"></div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email (opzionale)</label>
                    <input type="email" id="quick-email" class="w-full px-3 py-2 border rounded-lg"
                        placeholder="es. mario@email.com">
                </div>

                <!-- Consenso Marketing -->
                <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <input type="checkbox" id="quick-marketing" class="mt-1 mr-3 w-5 h-5 text-purple-600">
                        <div class="flex-1">
                            <label class="font-medium text-gray-900 cursor-pointer" for="quick-marketing">
                                üì¢ Consenso Marketing
                            </label>
                            <p class="text-sm text-gray-600 mt-1">
                                Il cliente autorizza l'invio di promozioni, offerte e aggiornamenti via
                                WhatsApp/SMS/Email
                            </p>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Numero Bollini da Aggiungere *</label>
                    <input type="number" id="quick-stamps" class="w-full px-3 py-2 border rounded-lg"
                        placeholder="es. 2" min="1" step="1" oninput="app.updateQuickStampsPreview()" required>
                    <p class="text-xs text-gray-500 mt-1">Inserisci direttamente quanti bollini vuoi aggiungere al
                        cliente</p>
                </div>

                <div id="quick-stamps-preview" class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 hidden">
                    <p class="text-center">
                        <span class="text-3xl font-bold text-purple-600" id="preview-stamps">0</span>
                        <span class="text-sm text-gray-600 block mt-1">bollini verranno aggiunti</span>
                    </p>
                </div>

                <input type="hidden" id="quick-existing-customer-id">
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModal('quick-customer-modal')"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Annulla</button>
                <button onclick="app.saveQuickCustomer()"
                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                    <span id="quick-save-btn-text">Salva & Invia Tessera</span>
                </button>
            </div>
        </div>
    </div>


    <script>
        // Fix per Dropbox SDK - Wrapper fetch
        const originalFetch = window.fetch;
        const boundFetch = function (...args) {
            return originalFetch.apply(window, args);
        };

        // ============================================
        // SISTEMA AUTENTICAZIONE E CRITTOGRAFIA
        // ============================================
        class AuthManager {
            constructor() {
                this.password = null;
                this.sessionKey = 'auth_session';
                this.passwordHashKey = 'auth_password_hash';
                this.inactivityTimeout = 2 * 60 * 60 * 1000; // 2 ore
                this.inactivityTimer = null;
                this.isAuthenticated = false;
            }

            async init() {
                // Controlla se esiste gi√† una password configurata
                const hasPassword = localStorage.getItem(this.passwordHashKey);

                if (!hasPassword) {
                    this.showSetup();
                    return;
                }

                // üîê Autologin sicuro ‚Äì cerca sessione e valida
                const session = this.getSession();
                if (session && !this.sessionExpired(session)) {
                    // üîì Decripta la password dalla sessione
                    try {
                        const decrypted = CryptoJS.AES.decrypt(session.encryptedPassword, session.token);
                        const password = decrypted.toString(CryptoJS.enc.Utf8);

                        if (password && password.length > 0) {
                            console.log("üîì Login automatico con sessione valida");
                            this.password = password;
                            this.isAuthenticated = true;

                            // Nascondi schermata auth e carica dati
                            document.getElementById('auth-screen').style.display = 'none';
                            if (typeof app !== 'undefined') {
                                app.loadData();
                                app.render();
                                app.renderDashboard();
                                app.updateStats();
                            }
                            this.startInactivityTimer();
                            return;
                        } else {
                            console.warn("‚ö†Ô∏è Token non valido, richiedo login");
                        }
                    } catch (err) {
                        console.warn("‚ö†Ô∏è Errore decrittazione token:", err);
                        // Elimina sessione corrotta
                        this.clearSession();
                    }
                }

                // Mostra form login
                this.showLogin();
            }

            showSetup() {
                document.getElementById('auth-form').classList.add('hidden');
                document.getElementById('auth-setup').classList.remove('hidden');
                document.getElementById('auth-subtitle').textContent = 'Configura la tua password';
            }

            showLogin() {
                document.getElementById('auth-form').classList.remove('hidden');
                document.getElementById('auth-setup').classList.add('hidden');
                document.getElementById('auth-subtitle').textContent = 'Inserisci la password per accedere';
            }

            setupPassword() {
                const password = document.getElementById('setup-password').value;
                const confirm = document.getElementById('setup-password-confirm').value;
                const errorDiv = document.getElementById('auth-error');

                if (!password || password.length < 6) {
                    errorDiv.textContent = '‚ùå La password deve essere di almeno 6 caratteri';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                if (password !== confirm) {
                    errorDiv.textContent = '‚ùå Le password non corrispondono';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // Salva hash della password
                const hash = CryptoJS.SHA256(password).toString();
                localStorage.setItem(this.passwordHashKey, hash);

                // Imposta password e accedi
                this.password = password;
                this.isAuthenticated = true;
                this.saveSession(true); // Salva sessione con ricordami

                // Nascondi schermata auth e carica dati
                document.getElementById('auth-screen').style.display = 'none';
                if (typeof app !== 'undefined') {
                    app.loadData();
                    app.render();
                    app.renderDashboard();
                    app.updateStats();
                }
                this.startInactivityTimer();
            }

            login() {
                const password = document.getElementById('auth-password').value;
                const remember = document.getElementById('auth-remember').checked;
                const errorDiv = document.getElementById('auth-error');

                if (!password) {
                    errorDiv.textContent = '‚ùå Inserisci la password';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // Verifica password
                const hash = CryptoJS.SHA256(password).toString();
                const storedHash = localStorage.getItem(this.passwordHashKey);

                if (hash !== storedHash) {
                    errorDiv.textContent = '‚ùå Password errata';
                    errorDiv.classList.remove('hidden');
                    document.getElementById('auth-password').value = '';
                    return;
                }

                // Login riuscito
                this.password = password;
                this.isAuthenticated = true;
                this.saveSession(remember);

                // Nascondi schermata auth e carica dati
                document.getElementById('auth-screen').style.display = 'none';
                if (typeof app !== 'undefined') {
                    app.loadData();
                    app.render();
                    app.renderDashboard();
                    app.updateStats();
                }
                this.startInactivityTimer();
            }

            logout() {
                this.password = null;
                this.isAuthenticated = false;
                this.clearSession();
                this.stopInactivityTimer();
                location.reload();
            }

            saveSession(remember) {
                const expiry = remember
                    ? Date.now() + (30 * 24 * 60 * 60 * 1000)
                    : Date.now() + this.inactivityTimeout;

                // üîê Genera un token casuale come chiave di cifratura
                const token = this.generateSecureToken();

                // CORREZIONE: Cripta la PASSWORD con il token (non il contrario)
                const encryptedPassword = CryptoJS.AES.encrypt(this.password, token).toString();

                const session = {
                    token: token,
                    encryptedPassword: encryptedPassword,
                    expiry: expiry
                };

                const storage = remember ? localStorage : sessionStorage;
                storage.setItem(this.sessionKey, JSON.stringify(session));
            }

            generateSecureToken() {
                // Genera un token casuale di 32 caratteri
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }
            getSession() {
                // Controlla localStorage (ricordami)
                let sessionData = localStorage.getItem(this.sessionKey);
                if (sessionData) {
                    return JSON.parse(sessionData);
                }
                // Controlla sessionStorage (sessione corrente)
                sessionData = sessionStorage.getItem(this.sessionKey);
                if (sessionData) {
                    return JSON.parse(sessionData);
                }
                return null;
            }

            clearSession() {
                localStorage.removeItem(this.sessionKey);
                sessionStorage.removeItem(this.sessionKey);
            }

            sessionExpired(session) {
                return Date.now() > session.expiry;
            }

            hideAuthScreen() {
                this.showApp();
            }

            showApp() {
                document.getElementById('auth-screen').style.display = 'none';

                // ‚≠ê Carica i dati DOPO che la password √® disponibile
                if (typeof app !== 'undefined') {
                    app.loadData(); // ‚úÖ ORA VIENE CHIAMATO DOPO IL LOGIN
                    app.render();
                    app.renderDashboard();
                    app.updateStats();
                }
            }

            // Timer inattivit√†
            startInactivityTimer() {
                this.resetInactivityTimer();

                // Eventi per rilevare attivit√†
                ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                    document.addEventListener(event, () => this.resetInactivityTimer(), true);
                });
            }

            resetInactivityTimer() {
                if (this.inactivityTimer) {
                    clearTimeout(this.inactivityTimer);
                }
                this.inactivityTimer = setTimeout(() => {
                    alert('‚è∞ Sessione scaduta per inattivit√†. Verrai disconnesso.');
                    this.logout();
                }, this.inactivityTimeout);
            }

            stopInactivityTimer() {
                if (this.inactivityTimer) {
                    clearTimeout(this.inactivityTimer);
                    this.inactivityTimer = null;
                }
            }

            // Funzioni crittografia
            encrypt(data) {
                if (!this.password) return null;
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), this.password).toString();
                return encrypted;
            }

            decrypt(encryptedData) {
                if (!this.password || !encryptedData) return null;
                try {
                    const decrypted = CryptoJS.AES.decrypt(encryptedData, this.password);
                    const decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);
                    return JSON.parse(decryptedStr);
                } catch (e) {
                    console.error('Errore decrittazione:', e);
                    return null;
                }
            }

            openChangePasswordModal() {
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-new-password').value = '';
                document.getElementById('change-password-error').classList.add('hidden');
                document.getElementById('change-password-modal').classList.add('open');
            }

            closeChangePasswordModal() {
                document.getElementById('change-password-modal').classList.remove('open');
            }

            changePassword() {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;
                const errorDiv = document.getElementById('change-password-error');

                // Reset errori
                errorDiv.classList.add('hidden');

                // Validazioni
                if (!currentPassword || !newPassword || !confirmPassword) {
                    errorDiv.textContent = '‚ùå Compila tutti i campi';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // Verifica password attuale
                const currentHash = CryptoJS.SHA256(currentPassword).toString();
                const storedHash = localStorage.getItem(this.passwordHashKey);

                if (currentHash !== storedHash) {
                    errorDiv.textContent = '‚ùå Password attuale errata';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // Verifica nuova password
                if (newPassword.length < 6) {
                    errorDiv.textContent = '‚ùå La nuova password deve essere di almeno 6 caratteri';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = '‚ùå Le password non corrispondono';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // Salva nuova password
                const newHash = CryptoJS.SHA256(newPassword).toString();
                localStorage.setItem(this.passwordHashKey, newHash);

                // Ricarica i dati con la nuova password e ri-cripta
                this.password = newPassword;
                if (typeof app !== 'undefined') {
                    app.saveData(); // Ri-cripta tutto con la nuova password
                }

                alert('‚úÖ Password cambiata con successo!\n\nVerrai disconnesso per sicurezza.');
                this.logout();
            }
        }

        // Inizializza AuthManager
        const authManager = new AuthManager();

        // Avvia autenticazione quando la pagina √® pronta
        window.addEventListener('DOMContentLoaded', () => {
            authManager.init();
        });

        // ============================================
        // GESTIONALE ORDINI (Modificato per crittografia)
        // ============================================
        class OrderManager {
            constructor() {
                this.db = { products: [], customers: [], orders: [], categories: [] };
                this.currentOrder = { items: [] };
                this.editingId = null;
                this.dropboxClient = null;
                this.dropboxRefreshToken = localStorage.getItem('dropboxRefreshToken');
                this.autoSyncEnabled = false;
                this.syncInProgress = false;
                this.autoSyncInterval = null;
                this.debugLogs = [];
                this.qrStream = null;
                this.fidelityConfig = {
                    businessName: 'Pastificio Gramsci',
                    eurosPerStamp: 20,
                    stampsPerReward: 10,
                    whatsappGroup: ''
                };
                this.scannerPageStream = null;
                this.pendingDelete = null;
                this.filteredOrders = null;
                this.searchDebounceTimer = null;

                // Setup debug logger intercept
                this.setupDebugLogger();
                this.loadFidelityConfig();
                this.initDropbox();
                this.checkUrlParams();

                // ‚ö†Ô∏è NON caricare dati qui - aspetta che authManager sia pronto
                // this.loadData(); // ‚ùå RIMUOVI QUESTA RIGA
                // this.render(); // ‚ùå RIMUOVI QUESTA RIGA

                this.updateStats();
                this.updateLastSyncInfo();
                this.checkDropboxStatus();
                this.renderDashboard();

                // Setup long press su titolo per mostrare debug
                this.setupDebugPanel();
            }

            // NUOVE FUNZIONI PER FILTRI DATA
            filterByToday() {
                // Passa alla tab ordini
                this.switchTab('ordini');

                // Imposta il filtro per la data odierna
                const today = new Date().toISOString().split('T')[0];

                // Filtra gli ordini
                this.filteredOrders = this.db.orders.filter(order => {
                    return order.deliveryDate === today;
                });

                // Aggiorna la lista ordini
                this.renderOrders();

                // Mostra un messaggio
                this.showToast('üìÖ Filtrati ordini di oggi');
            }

            filterByMonth() {
                // Passa alla tab ordini
                this.switchTab('ordini');

                // Calcola il primo giorno del mese corrente
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const firstDayStr = firstDay.toISOString().split('T')[0];

                // Calcola l'ultimo giorno del mese corrente
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                const lastDayStr = lastDay.toISOString().split('T')[0];

                // Filtra gli ordini
                this.filteredOrders = this.db.orders.filter(order => {
                    return order.deliveryDate >= firstDayStr && order.deliveryDate <= lastDayStr;
                });

                // Aggiorna la lista ordini
                this.renderOrders();

                // Mostra un messaggio
                this.showToast('üìÖ Filtrati ordini del mese');
            }

            checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('scan') === 'true') {
                    this.openQRScannerPage();
                }
            }

            openQRScannerPage() {
                document.getElementById('qr-scanner-page').classList.remove('hidden');
                document.getElementById('main-header').classList.add('hidden');
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

                this.startScannerPageCamera();
            }

            async startScannerPageCamera() {
                const video = document.getElementById('scanner-page-video');
                const canvas = document.getElementById('scanner-page-canvas');
                const status = document.getElementById('scanner-status');

                try {
                    // Verifica che getUserMedia sia disponibile
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Il tuo browser non supporta l\'accesso alla fotocamera');
                    }

                    status.textContent = 'üì∑ Richiesta permessi fotocamera...';
                    status.className = 'text-center text-lg font-semibold mb-4 text-blue-600';

                    // Prova prima con fotocamera posteriore
                    let constraints = {
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };

                    try {
                        this.scannerPageStream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (firstError) {
                        console.log('Tentativo con fotocamera posteriore fallito, provo con qualsiasi fotocamera...', firstError);

                        // Fallback: prova con qualsiasi fotocamera disponibile
                        constraints = {
                            video: {
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        };
                        this.scannerPageStream = await navigator.mediaDevices.getUserMedia(constraints);
                    }

                    video.srcObject = this.scannerPageStream;
                    await video.play();

                    status.textContent = 'üéØ Inquadra il QR code della tessera';
                    status.className = 'text-center text-lg font-semibold mb-4 text-green-600';

                    const ctx = canvas.getContext('2d');
                    let isScanning = true;

                    const scan = () => {
                        if (!isScanning || !this.scannerPageStream) return;

                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.height = video.videoHeight;
                            canvas.width = video.videoWidth;
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);

                            if (code) {
                                isScanning = false;
                                this.processQRCodePage(code.data);
                                return;
                            }
                        }
                        requestAnimationFrame(scan);
                    };
                    scan();

                } catch (err) {
                    console.error('Errore accesso fotocamera:', err);

                    let errorMessage = '‚ùå Impossibile accedere alla fotocamera';
                    let suggestion = 'üí° Prova a caricare un\'immagine del QR code';

                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMessage = '‚ùå Permesso negato';
                        suggestion = 'üí° Vai nelle impostazioni del browser e consenti l\'accesso alla fotocamera';
                    } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                        errorMessage = '‚ùå Nessuna fotocamera trovata';
                        suggestion = 'üí° Assicurati che il dispositivo abbia una fotocamera';
                    } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                        errorMessage = '‚ùå Fotocamera in uso';
                        suggestion = 'üí° Chiudi altre app che usano la fotocamera e riprova';
                    } else if (err.name === 'OverconstrainedError') {
                        errorMessage = '‚ùå Impostazioni non supportate';
                        suggestion = 'üí° La tua fotocamera non supporta le impostazioni richieste';
                    } else if (err.name === 'SecurityError') {
                        errorMessage = '‚ùå Errore di sicurezza';
                        suggestion = 'üí° Assicurati di usare HTTPS o localhost';
                    } else if (err.message) {
                        errorMessage = `‚ùå ${err.message}`;
                    }

                    status.innerHTML = `<div class="text-center">
                        <p class="text-red-600 font-semibold mb-2">${errorMessage}</p>
                        <p class="text-sm text-gray-600">${suggestion}</p>
                    </div>`;

                    this.showToast(errorMessage, 'error');
                }
            }

            scanFromFilePage(event) {
                const file = event.target.files[0];
                if (!file) return;

                const status = document.getElementById('scanner-status');
                status.textContent = 'üîç Analisi immagine...';
                status.className = 'text-center text-lg font-semibold mb-4 text-blue-600';

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('scanner-page-canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code) {
                            this.processQRCodePage(code.data);
                        } else {
                            status.textContent = '‚ùå QR Code non trovato';
                            status.className = 'text-center text-lg font-semibold mb-4 text-red-600';
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                event.target.value = '';
            }

            processQRCodePage(data) {
                const status = document.getElementById('scanner-status');

                try {
                    const qrData = JSON.parse(data);
                    if (qrData.app === 'fidelity-card' && qrData.id) {
                        status.textContent = '‚úÖ QR Code riconosciuto!';
                        status.className = 'text-center text-lg font-semibold mb-4 text-green-600';

                        // Chiudi scanner e apri scheda cliente
                        setTimeout(() => {
                            this.closeQRScannerPage();
                            this.switchTab('fidelity');
                            this.openFidelityCard(qrData.id);
                        }, 500);
                    } else {
                        status.textContent = '‚ùå QR Code non valido';
                        status.className = 'text-center text-lg font-semibold mb-4 text-red-600';
                        setTimeout(() => this.startScannerPageCamera(), 2000);
                    }
                } catch (err) {
                    status.textContent = '‚ùå QR Code non valido';
                    status.className = 'text-center text-lg font-semibold mb-4 text-red-600';
                    setTimeout(() => this.startScannerPageCamera(), 2000);
                }
            }

            closeQRScannerPage() {
                if (this.scannerPageStream) {
                    this.scannerPageStream.getTracks().forEach(track => track.stop());
                    this.scannerPageStream = null;
                }

                const video = document.getElementById('scanner-page-video');
                if (video) {
                    video.srcObject = null;
                }

                document.getElementById('qr-scanner-page').classList.add('hidden');
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('tab-ordini').classList.remove('hidden');

                // Rimuovi parametro dall'URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            copyScannerLink() {
                const currentUrl = window.location.href.split('?')[0];
                const scannerUrl = `${currentUrl}?scan=true`;

                // Copia negli appunti
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(scannerUrl).then(() => {
                        this.showToast('‚úÖ Link scanner copiato! Salvalo come segnalibro');
                    }).catch(() => {
                        this.fallbackCopy(scannerUrl);
                    });
                } else {
                    this.fallbackCopy(scannerUrl);
                }
            }

            fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    this.showToast('‚úÖ Link scanner copiato!');
                } catch (err) {
                    this.showToast('Copia manualmente: ' + text, 'error');
                }
                document.body.removeChild(textarea);
            }

            // DROPBOX INTEGRATION (OAuth2 PKCE)
            initDropbox() {

                console.log("üöÄ Inizializzazione Dropbox (PKCE)...");

                // Gestisce eventuale callback OAuth
                this.handleOAuthCallback();

                // Recupera token
                this.dropboxAccessToken = localStorage.getItem("dropboxAccessToken") || null;
                this.dropboxRefreshToken = localStorage.getItem("dropboxRefreshToken") || null;

                if (this.dropboxAccessToken) {
                    console.log("üîë Token Dropbox trovato, creo client...");
                    this.dropboxClient = new Dropbox.Dropbox({
                        accessToken: this.dropboxAccessToken
                    });
                } else {
                    console.log("‚ÑπÔ∏è Nessun token Dropbox trovato");
                    this.dropboxClient = null;
                }

                // Gestione auto-sync
                const savedValue = localStorage.getItem('autoSyncEnabled');
                this.autoSyncEnabled = savedValue === null ? true : savedValue === 'true';
                const autoSyncSwitch = document.getElementById("autosync-toggle");

                if (autoSyncSwitch) {
                    autoSyncSwitch.checked = this.autoSyncEnabled;
                    autoSyncSwitch.addEventListener("change", (e) => {
                        if (e.target.checked) {
                            localStorage.setItem("autoSyncEnabled", "true");
                            this.autoSyncEnabled = true;
                            this.startAutoSync();
                        } else {
                            localStorage.setItem("autoSyncEnabled", "false");
                            this.autoSyncEnabled = false;
                            this.stopAutoSync();
                        }
                    });
                }

                if (this.autoSyncEnabled && this.dropboxClient) {
                    this.startAutoSync();
                }

                this.updateLastSyncInfo();
            }

            // === PKCE: Avvio Autenticazione Dropbox ===
            async avviaAuthDropbox() {
                if (!DROPBOX_CONFIG.clientId || DROPBOX_CONFIG.clientId.includes("INSERISCI")) {
                    this.showToast("‚ö†Ô∏è Configura prima la App Key Dropbox", "error");
                    return;
                }

                console.log("üîê Avvio autenticazione Dropbox tramite PKCE...");

                // Genera code_verifier
                const verifierArray = new Uint8Array(64);
                crypto.getRandomValues(verifierArray);
                const codeVerifier = btoa(String.fromCharCode(...verifierArray))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

                // Salva il verifier in sessionStorage (pi√π affidabile per OAuth)
                const verifierData = {
                    verifier: codeVerifier,
                    timestamp: Date.now()
                };
                sessionStorage.setItem("dropbox_pkce_verifier", JSON.stringify(verifierData));
                console.log("üíæ Code verifier salvato in sessionStorage:", codeVerifier.substring(0, 10) + "...");

                // Genera il code_challenge
                const encoder = new TextEncoder();
                const data = encoder.encode(codeVerifier);
                const digest = await crypto.subtle.digest("SHA-256", data);
                const hashArray = Array.from(new Uint8Array(digest));
                const binary = String.fromCharCode(...hashArray);
                const codeChallenge = btoa(binary)
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

                console.log("üîê Code challenge generato:", codeChallenge.substring(0, 10) + "...");

                // URL OAuth2 autorizzazione PKCE
                const params = new URLSearchParams({
                    response_type: "code",
                    client_id: DROPBOX_CONFIG.clientId,
                    redirect_uri: DROPBOX_CONFIG.redirectUri,
                    code_challenge: codeChallenge,
                    code_challenge_method: "S256",
                    token_access_type: "offline" // refresh token
                });

                const authUrl = `https://www.dropbox.com/oauth2/authorize?${params.toString()}`;

                console.log("üîÑ Redirect a Dropbox per autorizzazione...");

                // Reindirizza a Dropbox
                window.location.href = authUrl;
            }

            // === PKCE: Callback dopo il redirect da Dropbox ===
            async handleOAuthCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                const authCode = urlParams.get("code");

                if (!authCode) return;

                console.log("üîê Gestione callback OAuth con codice:", authCode.substring(0, 10) + "...");

                // Pulisci l'URL IMMEDIATAMENTE per evitare riutilizzo del codice
                window.history.replaceState({}, document.title, window.location.pathname);

                let verifierData = sessionStorage.getItem("dropbox_pkce_verifier");

                if (!verifierData) {
                    console.error("‚ùå Nessun code_verifier trovato.");
                    this.showToast("Errore autenticazione Dropbox: riprova a connetterti.", "error");
                    return;
                }

                let verifier;
                try {
                    const parsed = JSON.parse(verifierData);
                    verifier = parsed.verifier;

                    // Controlla che non sia scaduto (max 10 minuti)
                    if (Date.now() - parsed.timestamp > 10 * 60 * 1000) {
                        console.error("‚ùå Code verifier scaduto")
                        this.showToast("Sessione scaduta, riprova a connetterti.", "error");
                        return;
                    }
                } catch (e) {
                    // Retrocompatibilit√† con vecchio formato
                    verifier = verifierData;
                }

                if (!verifier) {
                    console.error("‚ùå Code verifier non valido");
                    return;
                }

                console.log("‚úÖ Code verifier trovato:", verifier.substring(0, 10) + "...");

                try {
                    // Costruisci il corpo della richiesta come application/x-www-form-urlencoded
                    const params = new URLSearchParams();
                    params.append("code", authCode);
                    params.append("grant_type", "authorization_code");
                    params.append("client_id", DROPBOX_CONFIG.clientId);
                    params.append("redirect_uri", DROPBOX_CONFIG.redirectUri);
                    params.append("code_verifier", verifier);

                    console.log("üì§ Invio richiesta token a Dropbox...");

                    const response = await fetch("https://api.dropboxapi.com/oauth2/token", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: params.toString()
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("Risposta errore:", errorText);

                        // Pulisci il verifier usato da entrambi gli storage
                        sessionStorage.removeItem("dropbox_pkce_verifier");

                        // Errori specifici
                        if (errorText.includes("code has expired")) {
                            this.showToast("‚è±Ô∏è Il codice √® scaduto. Clicca di nuovo su 'Connetti Dropbox'.", "error");
                        } else if (errorText.includes("invalid_grant")) {
                            this.showToast("‚ùå Codice non valido. Riprova a connetterti.", "error");
                        } else {
                            this.showToast("‚ùå Errore autenticazione Dropbox", "error");
                        }

                        throw new Error(`Errore HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    console.log("üì• Token ricevuto con successo!");

                    if (!data.access_token) {
                        console.error("‚ùå Nessun access_token nella risposta.");
                        this.showToast("Errore autenticazione Dropbox", "error");
                        return;
                    }

                    // Salva access token
                    this.dropboxAccessToken = data.access_token;
                    localStorage.setItem("dropboxAccessToken", data.access_token);

                    // CORREZIONE: Salva refresh token se presente
                    if (data.refresh_token) {
                        this.dropboxRefreshToken = data.refresh_token;
                        localStorage.setItem("dropboxRefreshToken", data.refresh_token);
                        console.log("‚úÖ Refresh token salvato");
                    }

                    // Pulisci il verifier usato
                    sessionStorage.removeItem("dropbox_pkce_verifier");

                    // Ricrea il client Dropbox
                    this.dropboxClient = new Dropbox.Dropbox({
                        accessToken: this.dropboxAccessToken
                    });

                    // Aggiorna UI
                    this.checkDropboxStatus();

                    this.showToast("‚úîÔ∏è Dropbox collegato con successo!", "success");

                    // Download dati iniziali da Dropbox
                    console.log('üì• Download iniziale da Dropbox...');
                    await this.checkForRemoteUpdates();

                    // Avvia auto-sync
                    this.startAutoSync();

                } catch (err) {
                    console.error("‚ùå Errore OAuth:", err);

                    // Pulisci tutto in caso di errore
                    sessionStorage.removeItem("dropbox_pkce_verifier");

                    // NON mostrare toast se gi√† mostrato prima
                    if (!err.message.includes("Errore HTTP")) {
                        this.showToast("Errore durante l'autenticazione Dropbox", "error");
                    }
                }
            }

            // === PKCE: Rinnovo token Dropbox SOLO quando richiesto ===
            async rinnovaAccessToken() {
                console.log("üîÑ Richiesta rinnovo access token...");

                if (!this.dropboxRefreshToken) {
                    console.warn("‚ö†Ô∏è Nessun refresh token disponibile");
                    return null;
                }

                try {
                    const params = new URLSearchParams();
                    params.append("grant_type", "refresh_token");
                    params.append("refresh_token", this.dropboxRefreshToken);
                    params.append("client_id", DROPBOX_CONFIG.clientId);

                    const response = await fetch("https://api.dropboxapi.com/oauth2/token", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: params.toString()
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("‚ùå Errore rinnovo:", errorText);
                        return null;
                    }

                    const data = await response.json();

                    if (!data.access_token) {
                        console.error("‚ùå Nessun token nella risposta");
                        return null;
                    }

                    this.dropboxAccessToken = data.access_token;
                    localStorage.setItem("dropboxAccessToken", data.access_token);

                    if (data.refresh_token) {
                        this.dropboxRefreshToken = data.refresh_token;
                        localStorage.setItem("dropboxRefreshToken", data.refresh_token);
                    }

                    this.dropboxClient = new Dropbox.Dropbox({
                        fetch: boundFetch,
                        accessToken: this.dropboxAccessToken
                    });

                    console.log("‚úîÔ∏è Token rinnovato con successo");
                    return data.access_token;

                } catch (err) {
                    console.error("‚ùå Errore rinnovo token:", err);
                    return null;
                }
            }

            async mergeWithRemoteData() {
                try {
                    console.log('üîÄ Merge: scarico dati remoti...');

                    // Scarica dati remoti
                    const response = await this.dropboxClient.filesDownload({
                        path: '/gestionale-ordini-backup.json'
                    });

                    const blob = response.result.fileBlob;
                    const text = await blob.text();
                    const parsedData = JSON.parse(text);

                    // Decripta usando authManager
                    let remoteData;
                    if (parsedData.encrypted) {
                        remoteData = authManager.decrypt(parsedData.data);
                        if (!remoteData) {
                            console.error('‚ùå Errore: impossibile decriptare dati remoti');
                            return false;
                        }
                    } else {
                        remoteData = parsedData;
                    }

                    console.log('üîÄ Merge: unisco i dati...');

                    // ========== MERGE ORDINI ==========
                    const localOrderMap = new Map(this.db.orders.map(o => [o.id, o]));
                    let addedOrders = 0;
                    let updatedOrders = 0;

                    remoteData.orders.forEach(remoteOrder => {
                        const localOrder = localOrderMap.get(remoteOrder.id);

                        if (localOrder) {
                            // Ordine esiste: aggiorna SOLO campi specifici

                            // CASO 1: Remoto deleted, locale no ‚Üí marca come deleted
                            if (remoteOrder.deleted && !localOrder.deleted) {
                                localOrder.deleted = true;
                                localOrder.deletedAt = remoteOrder.deletedAt;
                                updatedOrders++;
                            }
                            // CASO 2: Locale deleted, remoto no ‚Üí mantieni locale deleted (priorit√†)
                            else if (localOrder.deleted && !remoteOrder.deleted) {
                                // Non fare nulla
                            }
                            // CASO 3: Entrambi non deleted ‚Üí aggiorna campi modificabili
                            else if (!remoteOrder.deleted && !localOrder.deleted) {
                                let hasChanges = false;

                                // Confronta e aggiorna items
                                if (JSON.stringify(localOrder.items) !== JSON.stringify(remoteOrder.items)) {
                                    localOrder.items = remoteOrder.items;
                                    hasChanges = true;
                                }

                                // Aggiorna stati
                                if (localOrder.prepStatus !== remoteOrder.prepStatus) {
                                    localOrder.prepStatus = remoteOrder.prepStatus;
                                    hasChanges = true;
                                }

                                if (localOrder.paymentStatus !== remoteOrder.paymentStatus) {
                                    localOrder.paymentStatus = remoteOrder.paymentStatus;
                                    hasChanges = true;
                                }

                                // Aggiorna preparazione
                                if (JSON.stringify(localOrder.preparedItems) !== JSON.stringify(remoteOrder.preparedItems)) {
                                    localOrder.preparedItems = remoteOrder.preparedItems;
                                    hasChanges = true;
                                }

                                // Aggiorna acconto
                                if (localOrder.deposit !== remoteOrder.deposit) {
                                    localOrder.deposit = remoteOrder.deposit;
                                    hasChanges = true;
                                }

                                // Aggiorna note
                                if (localOrder.notes !== remoteOrder.notes) {
                                    localOrder.notes = remoteOrder.notes;
                                    hasChanges = true;
                                }

                                if (hasChanges) updatedOrders++;
                            }
                        } else {
                            // Ordine nuovo: aggiungilo
                            this.db.orders.push(remoteOrder);
                            addedOrders++;
                        }
                    });

                    // ========== MERGE PRODOTTI ==========
                    const localProductMap = new Map(this.db.products.map(p => [p.id, p]));
                    let addedProducts = 0;
                    let updatedProducts = 0;

                    remoteData.products.forEach(remoteProduct => {
                        const localProduct = localProductMap.get(remoteProduct.id);

                        if (localProduct) {
                            // Prodotto esiste

                            if (remoteProduct.deleted && !localProduct.deleted) {
                                localProduct.deleted = true;
                                localProduct.deletedAt = remoteProduct.deletedAt;
                                updatedProducts++;
                            }
                            else if (!remoteProduct.deleted && !localProduct.deleted) {
                                // Aggiorna solo se diverso
                                const remoteStr = JSON.stringify(remoteProduct);
                                const localStr = JSON.stringify(localProduct);

                                if (remoteStr !== localStr) {
                                    // Aggiorna campi (escluso id)
                                    localProduct.name = remoteProduct.name;
                                    localProduct.category = remoteProduct.category;
                                    localProduct.price = remoteProduct.price;
                                    localProduct.unit = remoteProduct.unit;
                                    localProduct.weightPerPiece = remoteProduct.weightPerPiece;
                                    updatedProducts++;
                                }
                            }
                        } else {
                            // Prodotto nuovo
                            this.db.products.push(remoteProduct);
                            addedProducts++;
                        }
                    });

                    // ========== MERGE CLIENTI ==========
                    const localCustomerMap = new Map(this.db.customers.map(c => [c.id, c]));
                    let addedCustomers = 0;
                    let updatedCustomers = 0;

                    remoteData.customers.forEach(remoteCustomer => {
                        const localCustomer = localCustomerMap.get(remoteCustomer.id);

                        if (localCustomer) {
                            // Cliente esiste

                            if (remoteCustomer.deleted && !localCustomer.deleted) {
                                localCustomer.deleted = true;
                                localCustomer.deletedAt = remoteCustomer.deletedAt;
                                updatedCustomers++;
                            }
                            else if (!remoteCustomer.deleted && !localCustomer.deleted) {
                                // Aggiorna solo se diverso
                                const remoteStr = JSON.stringify(remoteCustomer);
                                const localStr = JSON.stringify(localCustomer);

                                if (remoteStr !== localStr) {
                                    localCustomer.firstName = remoteCustomer.firstName;
                                    localCustomer.lastName = remoteCustomer.lastName;
                                    localCustomer.phone = remoteCustomer.phone;
                                    localCustomer.address = remoteCustomer.address;
                                    localCustomer.fidelity = remoteCustomer.fidelity;
                                    updatedCustomers++;
                                }
                            }
                        } else {
                            // Cliente nuovo
                            this.db.customers.push(remoteCustomer);
                            addedCustomers++;
                        }
                    });

                    console.log(`‚úÖ Merge completato:`);
                    console.log(`   Ordini: +${addedOrders} nuovi, ${updatedOrders} aggiornati`);
                    console.log(`   Prodotti: +${addedProducts} nuovi, ${updatedProducts} aggiornati`);
                    console.log(`   Clienti: +${addedCustomers} nuovi, ${updatedCustomers} aggiornati`);

                    return true;
                } catch (error) {
                    if (error.status === 409) {
                        console.log('‚ÑπÔ∏è Nessun file remoto da mergeare');
                        return true;
                    }
                    console.error('‚ùå Errore merge:', error);
                    return false;
                }
            }

            async syncToDropbox(silent = false, retryCount = 0) {
                if (!this.dropboxClient || !this.dropboxAccessToken) {
                    console.error('‚ùå Dropbox non configurato');
                    if (!silent) this.showToast('Dropbox non configurato', 'error');
                    return;
                }

                if (retryCount > 5) {
                    console.error('‚ùå Troppi tentativi di sincronizzazione falliti');
                    if (!silent) this.showToast('‚ùå Errore sincronizzazione: troppi conflitti', 'error');
                    return;
                }

                if (!authManager.password) {
                    console.error('‚ùå Password non disponibile per crittografia');
                    if (!silent) this.showToast('Errore: password non disponibile', 'error');
                    return;
                }

                if (this.syncInProgress) {
                    console.log('‚è≥ Sync gi√† in corso');
                    return;
                }

                try {
                    this.syncInProgress = true;
                    if (!silent) this.showSyncIndicator(true);

                    // PASSO 1: Ottieni revision corrente del file
                    let currentRev = null;
                    try {
                        const metadata = await this.dropboxClient.filesGetMetadata({
                            path: '/gestionale-ordini-backup.json'
                        });
                        currentRev = metadata.result.rev;
                        console.log('üìã Revision corrente:', currentRev);
                    } catch (metaErr) {
                        if (metaErr.status === 409) {
                            // File non esiste, primo upload
                            console.log('üìù Primo upload (file non esiste)');
                        } else {
                            throw metaErr;
                        }
                    }

                    // PASSO 2: MERGE con dati remoti
                    const mergeSuccess = await this.mergeWithRemoteData();
                    if (!mergeSuccess) {
                        console.error('‚ùå Merge fallito');
                        return;
                    }

                    console.log('üì§ Upload su Dropbox con crittografia...');

                    const dataToSync = {
                        ...this.db,
                        lastModified: new Date().toISOString()
                    };

                    const encryptedData = authManager.encrypt(dataToSync);
                    if (!encryptedData) {
                        throw new Error('Errore durante la crittografia dei dati');
                    }

                    const payload = {
                        encrypted: true,
                        version: '1.0',
                        data: encryptedData
                    };

                    const jsonData = JSON.stringify(payload);
                    const blob = new Blob([jsonData], { type: 'application/json' });

                    console.log('üì¶ Dimensione dati criptati:', (blob.size / 1024).toFixed(2), 'KB');

                    // PASSO 3: Upload con controllo revision
                    try {
                        const uploadParams = {
                            path: '/gestionale-ordini-backup.json',
                            contents: blob,
                            autorename: false
                        };

                        if (currentRev) {
                            // File esiste: usa mode 'update' con revision
                            uploadParams.mode = {
                                '.tag': 'update',
                                update: currentRev
                            };
                        } else {
                            // File non esiste: usa mode 'add'
                            uploadParams.mode = { '.tag': 'add' };
                        }

                        await this.dropboxClient.filesUpload(uploadParams);

                    } catch (uploadErr) {
                        // Conflitto rilevato: il file √® stato modificato da altro dispositivo
                        if (uploadErr.status === 409 || uploadErr.error?.error['.tag'] === 'conflict') {
                            console.log('‚ö†Ô∏è Conflitto rilevato! Un altro dispositivo ha modificato il file.');
                            console.log('üîÑ Riprovo con nuovo merge... (tentativo ' + (retryCount + 1) + '/5)');

                            // Aspetta un tempo casuale tra 500ms e 2000ms per ridurre conflitti
                            const waitTime = 500 + Math.random() * 1500;
                            await new Promise(resolve => setTimeout(resolve, waitTime));

                            return await this.syncToDropbox(silent, retryCount + 1);
                        }
                        throw uploadErr;
                    }

                    const now = new Date().toISOString();
                    localStorage.setItem('lastDropboxSync', now);
                    localStorage.setItem('lastModified', dataToSync.lastModified);

                    this.updateLastSyncInfo();

                    if (!silent) this.showToast('‚úÖ Dati criptati caricati su Dropbox!');
                    console.log('‚úÖ Upload completato con successo' + (retryCount > 0 ? ` (dopo ${retryCount} retry)` : ''));

                } catch (err) {
                    console.error('‚ùå Errore upload Dropbox:', err);

                    if (err?.error?.error_summary?.includes("expired_access_token") && this.dropboxRefreshToken) {
                        console.log('üîÑ Token scaduto, rinnovo automatico...');
                        const nuovoToken = await this.rinnovaAccessToken();
                        if (nuovoToken) {
                            console.log('üîÅ Riprovo upload...');
                            await this.syncToDropbox(silent, retryCount);
                            return;
                        }
                    }

                    if (!silent) this.showToast('‚ùå Errore caricamento su Dropbox', 'error');
                } finally {
                    this.syncInProgress = false;
                    if (!silent) this.showSyncIndicator(false);
                }
            }

            // ========== SISTEMA DI LOCK PER ORDINI SIMULTANEI ==========

            async acquireLock() {
                const lockData = {
                    locked: true,
                    device: /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'Smartphone/Tablet' : 'PC',
                    timestamp: new Date().toISOString()
                };

                try {
                    await this.dropboxClient.filesUpload({
                        path: '/order-lock.json',
                        contents: new Blob([JSON.stringify(lockData)], { type: 'application/json' }),
                        mode: { '.tag': 'overwrite' }
                    });
                    console.log('üîí Lock acquisito');
                    return true;
                } catch (err) {
                    console.error('‚ùå Errore acquisizione lock:', err);
                    return false;
                }
            }

            async releaseLock() {
                try {
                    await this.dropboxClient.filesDeleteV2({ path: '/order-lock.json' });
                    console.log('üîì Lock rilasciato');
                } catch (err) {
                    // Lock gi√† rimosso o non esiste
                    console.log('‚ÑπÔ∏è Lock gi√† rilasciato');
                }
            }

            async checkLock() {
                try {
                    const response = await this.dropboxClient.filesDownload({ path: '/order-lock.json' });
                    const blob = response.result.fileBlob;
                    const text = await blob.text();
                    const lockData = JSON.parse(text);

                    // Timeout: se lock > 30 secondi, consideralo scaduto
                    const lockAge = Date.now() - new Date(lockData.timestamp).getTime();
                    if (lockAge > 30000) {
                        console.log('‚è∞ Lock scaduto, lo rimuovo');
                        await this.releaseLock();
                        return null;
                    }

                    return lockData;
                } catch (err) {
                    return null; // Nessun lock attivo
                }
            }

            async waitForLock(maxWait = 30000) {
                const startTime = Date.now();
                let attempts = 0;

                while (Date.now() - startTime < maxWait) {
                    const lock = await this.checkLock();
                    if (!lock) {
                        console.log('‚úÖ Lock libero, procedo');
                        return true; // Lock libero
                    }

                    attempts++;
                    console.log(`‚è≥ Attesa lock... tentativo ${attempts}`);
                    this.showToast(`‚è≥ Attendi... ${lock.device} sta salvando ordine`, 'info');
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Controlla ogni 2 secondi
                }

                console.log('‚ùå Timeout attesa lock');
                return false; // Timeout
            }
            toggleAutoSync() {
                this.autoSyncEnabled = document.getElementById('auto-sync-toggle').checked;
                localStorage.setItem('autoSync', this.autoSyncEnabled);

                if (this.autoSyncEnabled && !this.dropboxClient) {
                    this.showToast('Configura prima Dropbox', 'error');
                    document.getElementById('auto-sync-toggle').checked = false;
                    this.autoSyncEnabled = false;
                    return;
                }

                const status = this.autoSyncEnabled ? 'attivata' : 'disattivata';
                this.showToast(`Sincronizzazione automatica ${status}`);

                if (this.autoSyncEnabled) {
                    this.syncToDropbox();
                    this.startAutoSync();
                } else {
                    this.stopAutoSync();
                }
            }

            startAutoSync() {
                // Ferma eventuali intervalli precedenti
                this.stopAutoSync();

                console.log('üöÄ Avvio sincronizzazione automatica...');
                console.log('‚è∞ Intervallo: controllo ogni 10 secondi');
                console.log('üì± Dispositivo:', navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop');

                // Controlla aggiornamenti ogni 10 secondi
                this.autoSyncInterval = setInterval(() => {
                    console.log('‚è∞ Timer scattato - controllo aggiornamenti...');
                    if (!this.syncInProgress && this.dropboxClient) {
                        this.checkForRemoteUpdates();
                    } else {
                        console.log('‚è≠Ô∏è Skip: syncing=' + this.syncInProgress + ', client=' + !!this.dropboxClient);
                    }
                }, 10000); // 10 secondi

                console.log('‚úÖ Sincronizzazione automatica avviata (ID:', this.autoSyncInterval, ')');

                // Esegui subito un primo controllo
                console.log('üîÑ Primo controllo immediato...');
                setTimeout(() => {
                    if (!this.syncInProgress && this.dropboxClient) {
                        this.checkForRemoteUpdates();
                    }
                }, 2000); // Dopo 2 secondi dall'avvio
            }


            stopAutoSync() {
                if (this.autoSyncInterval) {
                    clearInterval(this.autoSyncInterval);
                    this.autoSyncInterval = null;
                    console.log('üõë Sincronizzazione automatica fermata');
                }
            }

            async checkForRemoteUpdates() {
                if (this.modalOpen) {
                    console.log('‚è∏Ô∏è Modal aperto, skip autosync');
                    return;
                }

                if (!this.dropboxClient || this.syncInProgress) {
                    console.log('‚è≠Ô∏è Skip check: client=', !!this.dropboxClient, 'syncing=', this.syncInProgress);
                    return;
                }

                try {
                    console.log('üîç Controllo aggiornamenti remoti...');

                    // Usa sincronizzazione silente che confronta i timestamp
                    await this.syncFromDropboxSilent();

                } catch (err) {
                    console.log('‚ö†Ô∏è Errore controllo aggiornamenti:', err.message);
                }
            }

            async syncFromDropbox(silent = false) {
                console.log('üì• syncFromDropbox chiamata - silent:', silent);

                if (!this.dropboxClient) {
                    console.error('‚ùå dropboxClient non inizializzato');
                    if (!silent) this.showToast('Configura prima Dropbox', 'error');
                    return;
                }

                if (this.syncInProgress) {
                    console.log('‚è≥ Sync gi√† in corso, ignoro');
                    return;
                }

                try {
                    this.syncInProgress = true;
                    if (!silent) this.showSyncIndicator(true);

                    console.log('üì• Download da Dropbox...');
                    const response = await this.dropboxClient.filesDownload({
                        path: '/gestionale-ordini-backup.json'
                    });

                    // ‚úÖ CORREZIONE: Verifica che response.result esista
                    if (!response || !response.result || !response.result.fileBlob) {
                        throw new Error('Risposta Dropbox non valida o file non trovato');
                    }

                    const blob = response.result.fileBlob;
                    const text = await blob.text();
                    const parsedData = JSON.parse(text);

                    let datiRemoti;
                    if (parsedData.encrypted) {
                        // Dati criptati, decripta
                        console.log('üîì Decrittazione dati da Dropbox...');
                        datiRemoti = authManager.decrypt(parsedData.data);
                        if (!datiRemoti) {
                            throw new Error('Errore decrittazione dati da Dropbox');
                        }
                    } else {
                        // Dati non criptati (vecchio formato), usa direttamente
                        datiRemoti = parsedData;
                    }

                    // Dati locali con timestamp
                    const datiLocali = {
                        ...this.db,
                        lastModified: this.db.lastModified || localStorage.getItem('lastModified') || new Date(0).toISOString()
                    };

                    const dataLocale = new Date(datiLocali.lastModified);
                    const dataRemota = new Date(datiRemoti.lastModified || 0);

                    console.log('üìÖ Timestamp locale:', datiLocali.lastModified);
                    console.log('üìÖ Timestamp remoto:', datiRemoti.lastModified);

                    if (dataRemota > dataLocale) {
                        // Dati remoti pi√π recenti
                        console.log('üÜï Dati remoti pi√π recenti');

                        this.db = datiRemoti;
                        if (!this.db.categories) this.db.categories = [];

                        // Salva i dati criptati localmente
                        this.saveData();
                        localStorage.setItem('lastModified', datiRemoti.lastModified);

                        this.render();
                        this.renderDashboard();
                        this.renderPreparation();
                        this.updateStats();

                        if (!silent) this.showToast('‚úÖ Dati scaricati da Dropbox!');
                        console.log('‚úÖ Dati aggiornati da remoto');

                    } else if (dataLocale > dataRemota) {
                        // Dati locali pi√π recenti, carica su Dropbox
                        console.log('üì§ Dati locali pi√π recenti, carico su Dropbox...');

                        await this.syncToDropbox(true);
                        if (!silent) this.showToast('‚úÖ Dati locali caricati su Dropbox!');

                    } else {
                        // Dati identici
                        console.log('‚úÖ Dati gi√† sincronizzati');
                        if (!silent) this.showToast('‚úÖ Dati gi√† sincronizzati!');
                    }

                    const now = new Date().toISOString();
                    localStorage.setItem('lastDropboxSync', now);
                    this.updateLastSyncInfo();

                } catch (err) {
                    console.error('‚ùå Errore download Dropbox:', err);

                    if (err.status === 401 && this.dropboxRefreshToken) {
                        // Token scaduto, rinnova e riprova
                        console.log('üîÑ Token scaduto, rinnovo e riprovo...');
                        const nuovoToken = await this.rinnovaAccessToken();
                        if (nuovoToken) {
                            await this.syncFromDropbox(silent);
                            return;
                        }
                    } else if (err.status === 409) {
                        // File non esiste, crealo
                        console.log('üì§ File non esiste su Dropbox, lo creo...');
                        await this.syncToDropbox(silent);
                        if (!silent) this.showToast('‚úÖ Backup creato su Dropbox!');
                    } else if (err.message && err.message.includes('Password errata')) {
                        // Errore specifico di decrittazione
                        if (!silent) this.showToast('‚ùå Password errata: impossibile decrittare i dati Dropbox', 'error');
                    } else {
                        if (!silent) this.showToast('‚ùå Errore download da Dropbox', 'error');
                    }
                } finally {
                    this.syncInProgress = false;
                    if (!silent) this.showSyncIndicator(false);
                }
            }

            async syncFromDropboxSilent() {
                if (!this.dropboxClient || !authManager.password) {
                    console.log('‚è≠Ô∏è Skip sync silente: client o password mancanti');
                    return;
                }

                // üîê Evita sincronizzazioni parallele
                if (this.syncInProgress) {
                    console.log('‚è≠Ô∏è Sync silente ignorata: sync gi√† in corso');
                    return;
                }

                this.syncInProgress = true;

                try {
                    console.log('üîÑ Sync silente da Dropbox...');

                    const response = await this.dropboxClient.filesDownload({
                        path: '/gestionale-ordini-backup.json'
                    });

                    // Verifica risposta Dropbox
                    if (!response || !response.result || !response.result.fileBlob) {
                        console.log('‚ö†Ô∏è File non trovato o risposta non valida');
                        return;
                    }

                    const blob = response.result.fileBlob;
                    const text = await blob.text();
                    const parsedData = JSON.parse(text);

                    let datiRemoti;
                    if (parsedData.encrypted) {
                        // üîì Decrittazione
                        datiRemoti = authManager.decrypt(parsedData.data);
                        if (!datiRemoti) {
                            console.error('‚ùå Impossibile decrittare dati remoti');
                            return;
                        }
                    } else {
                        datiRemoti = parsedData;
                    }

                    // Dati locali
                    const datiLocali = {
                        ...this.db,
                        lastModified: this.db.lastModified ||
                            localStorage.getItem('lastModified') ||
                            new Date(0).toISOString()
                    };

                    const dataLocale = new Date(datiLocali.lastModified);
                    const dataRemota = new Date(datiRemoti.lastModified || 0);

                    console.log('üìÖ Timestamp locale:', datiLocali.lastModified);
                    console.log('üìÖ Timestamp remoto:', datiRemoti.lastModified);

                    // MERGE SEMPRE, indipendentemente dal timestamp!
                    if (dataRemota > dataLocale) {
                        console.log('üÜï Dati remoti pi√π recenti, faccio merge...');
                    } else if (dataRemota.getTime() === dataLocale.getTime()) {
                        console.log('‚öñÔ∏è Timestamp uguali, faccio merge...');
                    } else {
                        console.log('‚ÑπÔ∏è Dati locali pi√π recenti, faccio merge comunque...');
                    }

                    // Salva i dati locali PRIMA di sovrascrivere
                    const oldLocalData = {
                        orders: [...this.db.orders],
                        products: [...this.db.products],
                        customers: [...this.db.customers]
                    };

                    // Carica dati remoti
                    this.db = datiRemoti;
                    if (!this.db.categories) this.db.categories = [];

                    // MERGE: Aggiungi elementi locali che non sono nei dati remoti

                    // Ordini
                    const remoteOrderIds = new Set(this.db.orders.map(o => o.id));
                    const localOnlyOrders = oldLocalData.orders.filter(o => !remoteOrderIds.has(o.id));
                    this.db.orders.push(...localOnlyOrders);

                    // Prodotti
                    const remoteProductIds = new Set(this.db.products.map(p => p.id));
                    const localOnlyProducts = oldLocalData.products.filter(p => !remoteProductIds.has(p.id));
                    this.db.products.push(...localOnlyProducts);

                    // Clienti
                    const remoteCustomerIds = new Set(this.db.customers.map(c => c.id));
                    const localOnlyCustomers = oldLocalData.customers.filter(c => !remoteCustomerIds.has(c.id));
                    this.db.customers.push(...localOnlyCustomers);

                    console.log(`üîÄ Merge completato: +${localOnlyOrders.length} ordini, +${localOnlyProducts.length} prodotti, +${localOnlyCustomers.length} clienti locali preservati`);

                    // Aggiorna timestamp solo se remoto √® pi√π recente
                    const newTimestamp = dataRemota > dataLocale ? datiRemoti.lastModified : datiLocali.lastModified;
                    this.db.lastModified = newTimestamp;

                    // Se non ci sono cambiamenti, NON fare render (evita scroll jump)
                    const hasChanges = localOnlyOrders.length > 0 || localOnlyProducts.length > 0 || localOnlyCustomers.length > 0;

                    if (!hasChanges) {
                        console.log('‚ÑπÔ∏è Nessun cambiamento, skip render');

                        // Salva comunque (potrebbero esserci aggiornamenti di stato)
                        const encrypted = authManager.encrypt(this.db);
                        if (encrypted) {
                            localStorage.setItem('orderManagerData', encrypted);
                            localStorage.setItem('lastModified', newTimestamp);
                        }

                        const now = new Date().toISOString();
                        localStorage.setItem('lastDropboxSync', now);
                        this.updateLastSyncInfo();

                        console.log('‚úÖ Dati sincronizzati da Dropbox (silent) - no render');
                        return; // Exit PRIMA del render
                    }
                    // Salva criptato
                    const encrypted = authManager.encrypt(this.db);
                    if (encrypted) {
                        localStorage.setItem('orderManagerData', encrypted);
                        localStorage.setItem('lastModified', newTimestamp);
                    }

                    const now = new Date().toISOString();
                    localStorage.setItem('lastDropboxSync', now);
                    this.updateLastSyncInfo();

                    // Salva posizione scroll
                    const scrollPos = window.scrollY;

                    this.render();
                    this.renderDashboard();
                    this.renderPreparation();
                    this.updateStats();

                    // Ripristina posizione scroll
                    setTimeout(() => window.scrollTo(0, scrollPos), 50);

                    console.log('‚úÖ Dati sincronizzati da Dropbox (silent)');

                } catch (error) {

                    console.error('‚ùå Errore sync silent:', error);

                    // Token scaduto ‚Üí rinnova
                    if (error.status === 401 && this.dropboxRefreshToken) {
                        console.log('üîÑ Token scaduto, rinnovo...');
                        await this.rinnovaAccessToken();

                        // File non trovato ‚Üí creiamo il backup
                    } else if (error.status === 409) {
                        console.log('üì§ File non esiste su Dropbox, lo creo (silent)...');
                        await this.syncToDropbox(true);

                    } else {
                        console.log('‚ö†Ô∏è Errore sync silent:', error.message);
                    }

                } finally {
                    // üîì Rilascia il blocco
                    this.syncInProgress = false;
                }
            }

            showSyncIndicator(show) {
                const indicator = document.getElementById('sync-indicator');
                if (show) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            }

            checkDropboxStatus() {
                const statusDiv = document.getElementById('dropbox-status');
                const configDiv = document.getElementById('dropbox-config');

                if (this.dropboxClient) {
                    statusDiv.innerHTML = `
            <div class="bg-green-50 border-l-4 border-green-500 p-4">
                <div class="flex items-start">
                    <svg class="w-6 h-6 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="font-semibold text-green-800">‚úÖ Dropbox Connesso</p>
                        <p class="text-sm text-green-700 mt-1">La sincronizzazione √® attiva</p>
                        <button onclick="app.disconnectDropbox()" class="mt-2 text-sm text-green-800 underline hover:text-green-900">Disconnetti</button>
                    </div>
                </div>
            </div>
        `;
                    configDiv.classList.add('hidden');
                } else {
                    statusDiv.innerHTML = `
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                <div class="flex items-start">
                    <svg class="w-6 h-6 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-blue-800">üì¶ Dropbox non connesso</p>
                        <p class="text-sm text-blue-700 mt-1">Segui le istruzioni qui sotto per collegare Dropbox</p>
                    </div>
                </div>
            </div>
        `;
                    configDiv.classList.remove('hidden');
                }
            }

            disconnectDropbox() {
                if (confirm('Sei sicuro di voler disconnettere Dropbox?')) {
                    localStorage.removeItem('dropboxAccessToken');
                    localStorage.removeItem('dropboxRefreshToken');
                    this.dropboxClient = null;
                    this.dropboxAccessToken = null;
                    this.dropboxRefreshToken = null;

                    // Disattiva auto-sync
                    this.autoSyncEnabled = false;
                    localStorage.setItem('autoSyncEnabled', 'false');  // ‚Üê Cambiato qui
                    this.stopAutoSync();

                    this.checkDropboxStatus();
                    this.showToast('‚úÖ Dropbox disconnesso');
                }
            }

            // BACKUP LOCALE
            downloadLocalBackup() {
                const dataStr = JSON.stringify(this.db, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                a.download = `gestionale-ordini-${timestamp}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showToast('‚úÖ Backup locale scaricato!');
            }

            loadLocalBackup(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.products && data.customers && data.orders) {
                            const confirm = window.confirm(
                                `Backup trovato:\n\n` +
                                `üì¶ ${data.orders?.length || 0} ordini\n` +
                                `üõçÔ∏è ${data.products?.length || 0} prodotti\n` +
                                `üë• ${data.customers?.length || 0} clienti\n\n` +
                                `Importare?`
                            );
                            if (confirm) {
                                this.db = data;
                                if (!this.db.categories) this.db.categories = [];
                                this.saveData();
                                this.render();
                                this.showToast('‚úÖ Backup caricato!');

                                // Sync automatico su Dropbox se attivo
                                if (this.autoSyncEnabled) {
                                    this.syncToDropbox(true);
                                }
                            }
                        } else this.showToast('‚ùå File non valido', 'error');
                    } catch (err) {
                        this.showToast('‚ùå Errore lettura', 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            // DATA MANAGEMENT
            loadData() {
                const data = localStorage.getItem('orderManagerData');
                if (!data) {
                    console.log('‚ÑπÔ∏è Nessun dato locale trovato');
                    this.db = { products: [], customers: [], orders: [], categories: [] };
                    return;
                }

                // Controlla se la password √® disponibile
                if (!authManager.password) {
                    console.log('‚è≥ Password non ancora disponibile, attendo login...');
                    this.db = { products: [], customers: [], orders: [], categories: [] };
                    return;
                }

                // Prova a decrittare (nuovo formato)
                const decryptedData = authManager.decrypt(data);

                if (decryptedData) {
                    console.log('üîì Dati locali decrittati con successo');
                    this.db = decryptedData;
                } else {
                    // Prova formato vecchio (JSON non criptato) - RETROCOMPATIBILIT√Ä
                    try {
                        console.log('‚ö†Ô∏è Tentativo caricamento dati non criptati (vecchio formato)');
                        this.db = JSON.parse(data);

                        // Ricripta immediatamente con la nuova password
                        console.log('üîê Migrazione dati al formato criptato...');
                        this.saveData();

                    } catch (e) {
                        console.error('‚ùå Errore caricamento dati:', e);
                        console.error('‚ùå I dati sembrano criptati ma la password non li decripta');
                        this.db = { products: [], customers: [], orders: [], categories: [] };
                    }
                }

                // Inizializza categorie se mancano
                if (!this.db.categories) {
                    this.db.categories = [];
                }

                // Inizializza fidelity per clienti esistenti
                if (this.db.customers) {
                    this.db.customers.forEach(c => {
                        if (!c.fidelity) {
                            c.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [] };
                        }
                    });
                }

                console.log('‚úÖ Dati caricati:', {
                    ordini: this.db.orders?.length || 0,
                    prodotti: this.db.products?.length || 0,
                    clienti: this.db.customers?.length || 0
                });
            }

            loadFidelityConfig() {
                const config = localStorage.getItem('fidelityConfig');
                if (config) {
                    this.fidelityConfig = JSON.parse(config);
                }
                // Carica valori nei campi
                if (document.getElementById('business-name')) {
                    document.getElementById('business-name').value = this.fidelityConfig.businessName;
                    document.getElementById('euros-per-stamp').value = this.fidelityConfig.eurosPerStamp;
                    document.getElementById('stamps-per-reward').value = this.fidelityConfig.stampsPerReward;
                    document.getElementById('whatsapp-group').value = this.fidelityConfig.whatsappGroup || '';
                }
            }

            saveFidelityConfig() {
                this.fidelityConfig = {
                    businessName: document.getElementById('business-name').value.trim() || 'La Mia Attivit√†',
                    eurosPerStamp: parseInt(document.getElementById('euros-per-stamp').value) || 20,
                    stampsPerReward: parseInt(document.getElementById('stamps-per-reward').value) || 10,
                    whatsappGroup: document.getElementById('whatsapp-group').value.trim()
                };
                localStorage.setItem('fidelityConfig', JSON.stringify(this.fidelityConfig));
                this.showToast('‚úÖ Configurazione salvata!');
            }

            // FIDELITY CARD FUNCTIONS
            calculateStamps(amount) {
                return Math.floor(amount / this.fidelityConfig.eurosPerStamp);
            }

            addStampsFromOrder(customerId, orderTotal) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer) return;

                if (!customer.fidelity) {
                    customer.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [], cardSent: false };
                }

                const stampsEarned = this.calculateStamps(orderTotal);
                if (stampsEarned > 0) {
                    customer.fidelity.stamps += stampsEarned;
                    customer.fidelity.totalSpent += orderTotal;
                    customer.fidelity.history.push({
                        date: new Date().toISOString(),
                        type: 'earned',
                        stamps: stampsEarned,
                        amount: orderTotal
                    });

                    // Controlla se ha raggiunto un premio
                    const rewardsEarned = Math.floor(customer.fidelity.stamps / this.fidelityConfig.stampsPerReward);
                    if (rewardsEarned > customer.fidelity.rewards) {
                        const newRewards = rewardsEarned - customer.fidelity.rewards;
                        customer.fidelity.rewards = rewardsEarned;
                        customer.fidelity.stamps = customer.fidelity.stamps % this.fidelityConfig.stampsPerReward;

                        this.showToast(`üéÅ ${customer.firstName} ha guadagnato ${newRewards} premio/i!`);
                    }

                    this.saveData();

                    // Mostra un messaggio
                    this.showToast(`‚úÖ +${stampsEarned} bollini per ${customer.firstName}!`);

                    // Invio automatico messaggio di aggiornamento bollini se c'√® un numero di telefono
                    if (customer.phone) {
                        // Se la tessera non √® mai stata inviata, invia la tessera completa automaticamente
                        if (!customer.fidelity.cardSent) {
                            this.sendFidelityCardWhatsApp(customer.id);
                        } else {
                            // Se la tessera √® gi√† stata inviata, invia automaticamente l'aggiornamento
                            this.sendStampsUpdateWhatsApp(customer.id, stampsEarned);
                        }
                    }
                }
            }

            // Funzione per aggiungere bollini direttamente (senza calcolo da importo)
            addStampsDirectly(customerId, stampsToAdd) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer) return;

                if (!customer.fidelity) {
                    customer.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [], cardSent: false };
                }

                if (stampsToAdd > 0) {
                    customer.fidelity.stamps += stampsToAdd;
                    customer.fidelity.history.push({
                        date: new Date().toISOString(),
                        type: 'earned',
                        stamps: stampsToAdd,
                        amount: 0 // Non c'√® un importo specifico
                    });

                    // Controlla se ha raggiunto un premio
                    const rewardsEarned = Math.floor(customer.fidelity.stamps / this.fidelityConfig.stampsPerReward);
                    if (rewardsEarned > customer.fidelity.rewards) {
                        const newRewards = rewardsEarned - customer.fidelity.rewards;
                        customer.fidelity.rewards = rewardsEarned;
                        customer.fidelity.stamps = customer.fidelity.stamps % this.fidelityConfig.stampsPerReward;

                        this.showToast(`üéÅ ${customer.firstName} ha guadagnato ${newRewards} premio/i!`);
                    }

                    this.saveData();
                }
            }

            openFidelityCard(customerId) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer) return;

                if (!customer.fidelity) {
                    customer.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [] };
                }

                const stampsNeeded = this.fidelityConfig.stampsPerReward;
                const currentStamps = customer.fidelity.stamps;
                const progress = (currentStamps / stampsNeeded) * 100;

                let historyHTML = '';
                if (customer.fidelity.history && customer.fidelity.history.length > 0) {
                    const recentHistory = customer.fidelity.history.slice(-10).reverse();
                    historyHTML = recentHistory.map(h => {
                        const date = new Date(h.date).toLocaleDateString('it-IT');
                        const icon = h.type === 'earned' ? '‚úÖ' : 'üéÅ';
                        const text = h.type === 'earned' ? `+${h.stamps} bollini (‚Ç¨${h.amount.toFixed(2)})` : `Premio riscattato`;
                        return `<div class="flex justify-between text-sm py-2 border-b"><span>${icon} ${text}</span><span class="text-gray-500">${date}</span></div>`;
                    }).join('');
                }

                const whatsappButton = customer.marketing && this.fidelityConfig.whatsappGroup ?
                    `<a href="${this.fidelityConfig.whatsappGroup}" target="_blank" class="w-full bg-green-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                        Unisciti al Gruppo WhatsApp
                    </a>` : '';

                const cardSentInfo = customer.fidelity.cardSent ?
                    `<div class="text-xs text-green-600 mt-1">
                        ‚úì Tessera inviata ${customer.fidelity.cardSentDate ? 'il ' + new Date(customer.fidelity.cardSentDate).toLocaleDateString('it-IT') : ''}
                     </div>` :
                    `<div class="text-xs text-orange-600 mt-1">
                        ‚ö†Ô∏è Tessera non ancora inviata
                     </div>`;

                const content = `
                    <div class="text-center mb-6">
                        <div class="inline-block bg-gradient-to-br from-amber-600 to-orange-700 text-white rounded-full w-24 h-24 flex items-center justify-center mb-4">
                            <span class="text-4xl font-bold">${customer.firstName.charAt(0)}${customer.lastName.charAt(0)}</span>
                        </div>
                        <h3 class="text-2xl font-bold">${customer.firstName} ${customer.lastName}</h3>
                        <p class="text-gray-600">${customer.phone || 'Nessun telefono'}</p>
                        ${cardSentInfo}
                    </div>

                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <p class="text-3xl font-bold text-amber-700">${currentStamps}</p>
                                <p class="text-sm text-gray-600">Bollini Attuali</p>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-green-600">${customer.fidelity.rewards}</p>
                                <p class="text-sm text-gray-600">Premi Disponibili</p>
                            </div>
                        </div>
                        
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div><span class="text-xs font-semibold inline-block text-amber-700">Progresso</span></div>
                                <div class="text-right"><span class="text-xs font-semibold inline-block text-amber-700">${currentStamps}/${stampsNeeded}</span></div>
                            </div>
                            <div class="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-amber-200">
                                <div style="width:${progress}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-amber-500 to-orange-600"></div>
                            </div>
                        </div>

                        <p class="text-center text-sm text-gray-600">Mancano <strong>${stampsNeeded - currentStamps}</strong> bollini al prossimo premio!</p>
                    </div>

                    <!-- GESTIONE PREMI -->
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                        <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                            üéÅ Gestione Premi
                        </h4>
                        
                        <div class="text-center py-4 text-gray-700">
                            <p class="text-sm font-semibold">Nessun premio ancora registrato</p>
                            <p class="text-xs mt-1 text-gray-500">Clicca il pulsante sotto per convertire un premio disponibile</p>
                        </div>
                        
                        <button onclick="app.addNewReward('${customer.id}')" class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-3 px-4 rounded-lg hover:from-yellow-500 hover:to-orange-600 font-bold mt-3" ${customer.fidelity.rewards === 0 ? 'disabled opacity-50' : ''}>
                            + Segna Premio come Disponibile (${customer.fidelity.rewards} da convertire)
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="app.generateFidelityCard('${customer.id}')" class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-medium">
                            üé´ Scarica Tessera PNG
                        </button>
                        ${!customer.fidelity.cardSent ?
                        `<button onclick="app.sendFidelityCardWhatsApp('${customer.id}')" class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-medium">
                            üì± Invia su WhatsApp
                        </button>` :
                        `<button onclick="app.sendStampsUpdateWhatsApp('${customer.id}', 0)" class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-medium">
                            üì± Invia Aggiornamento
                        </button>`}
                    </div>

                    ${whatsappButton}

                    ${historyHTML ? `
                        <div class="mt-6 border-t pt-4">
                            <h4 class="font-semibold mb-3">üìä Storico Recente</h4>
                            ${historyHTML}
                        </div>
                    ` : ''}

                    <div class="mt-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-lg">
                        <h4 class="font-semibold mb-3">‚úèÔ∏è Gestione Bollini</h4>
                        
                        <!-- Aggiungi bollini -->
                        <div class="mb-3">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Aggiungi Bollini</label>
                            <div class="flex gap-2">
                                <input type="number" id="manual-stamps" class="flex-1 px-3 py-2 border rounded-lg" placeholder="N¬∞ bollini" min="1" step="1" value="1">
                                <button onclick="app.addManualStampsDirect('${customer.id}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 whitespace-nowrap">+ Aggiungi</button>
                            </div>
                        </div>

                        <!-- Rimuovi bollini -->
                        <div class="mb-3">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Rimuovi Bollini (in caso di errore)</label>
                            <div class="flex gap-2">
                                <input type="number" id="remove-stamps" class="flex-1 px-3 py-2 border rounded-lg" placeholder="N¬∞ bollini" min="1" step="1" value="1">
                                <button onclick="app.removeStamps('${customer.id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 whitespace-nowrap">- Rimuovi</button>
                            </div>
                        </div>

                        <div class="text-xs text-gray-500 mt-2">
                            üí° Aggiungi o rimuovi bollini direttamente senza inserire l'importo
                        </div>
                    </div>

                    <!-- Pulsante Elimina Cliente -->
                    <div class="mt-6 pt-6 border-t">
                        <button onclick="app.deleteFidelityCustomer('${customer.id}')" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-medium flex items-center justify-center gap-2">
                            üóëÔ∏è Elimina Cliente
                        </button>
                        <p class="text-xs text-gray-500 text-center mt-2">Attenzione: questa azione √® irreversibile</p>
                    </div>
                `;

                document.getElementById('fidelity-card-content').innerHTML = content;
                this.openModal('fidelity-modal');
            }

            renderRewardsList(customer) {
                // Inizializza l'array dei premi se non esiste
                if (!customer.fidelity.rewardsList) {
                    customer.fidelity.rewardsList = [];
                }

                const rewardsList = customer.fidelity.rewardsList;

                if (rewardsList.length === 0) {
                    return '<div class="text-center py-4 text-gray-500"><p class="text-sm font-bold">Nessun premio ancora registrato</p><p class="text-xs mt-1">Clicca il pulsante sotto per convertire un premio disponibile</p></div>';
                }

                let html = '<div class="space-y-2 max-h-60 overflow-y-auto">';

                rewardsList.forEach((reward, index) => {
                    const statusIcon = reward.claimed ? '‚úÖ' : 'üéÅ';
                    const statusText = reward.claimed ? 'Ritirato' : 'Disponibile';
                    const statusColor = reward.claimed ? 'bg-green-50 border-green-300' : 'bg-yellow-50 border-yellow-300';
                    const date = new Date(reward.date).toLocaleDateString('it-IT');

                    // Escape delle virgolette nella descrizione
                    const safeDescription = reward.description ? reward.description.replace(/'/g, '&#39;').replace(/"/g, '&quot;') : '';

                    html += '<div class="border-2 ' + statusColor + ' rounded-lg p-3">';
                    html += '<div class="flex justify-between items-start mb-2">';
                    html += '<div class="flex-1">';
                    html += '<div class="flex items-center gap-2 mb-1">';
                    html += '<span class="text-lg">' + statusIcon + '</span>';
                    html += '<span class="font-semibold">' + statusText + '</span>';
                    html += '<span class="text-xs text-gray-500">' + date + '</span>';
                    html += '</div>';

                    if (safeDescription) {
                        html += '<p class="text-sm text-gray-700 mt-1">üìù ' + safeDescription + '</p>';
                    }

                    if (reward.claimedDate) {
                        const claimedDate = new Date(reward.claimedDate).toLocaleDateString('it-IT');
                        html += '<p class="text-xs text-gray-500 mt-1">Ritirato il ' + claimedDate + '</p>';
                    }

                    html += '</div>';

                    if (!reward.claimed) {
                        html += '<button onclick="app.markRewardAsClaimed(\'' + customer.id + '\', ' + index + ')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 whitespace-nowrap ml-2">Segna Ritirato</button>';
                    }

                    html += '</div>';

                    if (!reward.claimed) {
                        html += '<div class="mt-2">';
                        html += '<input type="text" id="reward-desc-' + index + '" placeholder="Descrivi il premio (es. Torta cioccolato 500g)" value="' + safeDescription + '" onchange="app.updateRewardDescription(\'' + customer.id + '\', ' + index + ', this.value)" class="w-full px-2 py-1 border rounded text-sm">';
                        html += '</div>';
                    }

                    html += '</div>';
                });

                html += '</div>';
                return html;
            }

            addNewReward(customerId) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer || customer.fidelity.rewards === 0) {
                    this.showToast('Nessun premio disponibile da convertire', 'error');
                    return;
                }

                // Inizializza l'array se non esiste
                if (!customer.fidelity.rewardsList) {
                    customer.fidelity.rewardsList = [];
                }

                // Aggiungi un nuovo premio alla lista
                customer.fidelity.rewardsList.push({
                    date: new Date().toISOString(),
                    claimed: false,
                    description: '',
                    claimedDate: null
                });

                // Decrementa i premi disponibili
                customer.fidelity.rewards--;

                this.saveData();
                this.showToast('‚úÖ Premio aggiunto alla lista!');

                // Ricarica la fidelity card
                this.openFidelityCard(customerId);
            }

            markRewardAsClaimed(customerId, rewardIndex) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer || !customer.fidelity.rewardsList || !customer.fidelity.rewardsList[rewardIndex]) {
                    this.showToast('Premio non trovato', 'error');
                    return;
                }

                const reward = customer.fidelity.rewardsList[rewardIndex];

                if (confirm(`Confermi che il cliente ha ritirato questo premio?`)) {
                    reward.claimed = true;
                    reward.claimedDate = new Date().toISOString();

                    // Aggiungi anche allo storico
                    customer.fidelity.history.push({
                        date: reward.claimedDate,
                        type: 'redeemed',
                        stamps: 0,
                        amount: 0,
                        description: reward.description || 'Premio ritirato'
                    });

                    this.saveData();
                    this.showToast('üéÅ Premio segnato come ritirato!');

                    // Ricarica la fidelity card
                    this.openFidelityCard(customerId);
                }
            }

            updateRewardDescription(customerId, rewardIndex, description) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer || !customer.fidelity.rewardsList || !customer.fidelity.rewardsList[rewardIndex]) {
                    return;
                }

                customer.fidelity.rewardsList[rewardIndex].description = description.trim();
                this.saveData();
                this.showToast('üíæ Descrizione salvata');
            }

            addManualStampsDirect(customerId) {
                const stamps = parseInt(document.getElementById('manual-stamps').value) || 1;
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer) return;

                if (stamps <= 0) {
                    this.showToast('Inserisci un numero valido di bollini', 'error');
                    return;
                }

                if (!customer.fidelity) {
                    customer.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [] };
                }

                customer.fidelity.stamps += stamps;
                customer.fidelity.history.push({
                    date: new Date().toISOString(),
                    type: 'manual_add',
                    stamps: stamps,
                    amount: 0
                });

                // Controlla premi
                const rewardsEarned = Math.floor(customer.fidelity.stamps / this.fidelityConfig.stampsPerReward);
                if (rewardsEarned > customer.fidelity.rewards) {
                    const newRewards = rewardsEarned - customer.fidelity.rewards;
                    customer.fidelity.rewards = rewardsEarned;
                    customer.fidelity.stamps = customer.fidelity.stamps % this.fidelityConfig.stampsPerReward;
                    this.showToast(`üéÅ ${customer.firstName} ha guadagnato ${newRewards} premio/i!`);
                }

                this.saveData();
                this.showToast(`‚úÖ +${stamps} bollini aggiunti!`);
                this.closeModal('fidelity-modal');
                this.render();
            }

            removeStamps(customerId) {
                const stamps = parseInt(document.getElementById('remove-stamps').value) || 1;
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer || !customer.fidelity) return;

                if (stamps <= 0) {
                    this.showToast('Inserisci un numero valido di bollini', 'error');
                    return;
                }

                if (customer.fidelity.stamps < stamps) {
                    this.showToast(`‚ùå Il cliente ha solo ${customer.fidelity.stamps} bollini`, 'error');
                    return;
                }

                if (!confirm(`Rimuovere ${stamps} bollini da ${customer.firstName}?`)) return;

                customer.fidelity.stamps -= stamps;
                customer.fidelity.history.push({
                    date: new Date().toISOString(),
                    type: 'manual_remove',
                    stamps: -stamps,
                    amount: 0
                });

                this.saveData();
                this.showToast(`‚úÖ ${stamps} bollini rimossi`);
                this.closeModal('fidelity-modal');
                this.render();
            }

            addManualStamps(customerId) {
                const amount = parseFloat(document.getElementById('manual-amount').value);
                if (isNaN(amount) || amount <= 0) {
                    this.showToast('Inserisci un importo valido', 'error');
                    return;
                }

                this.addStampsFromOrder(customerId, amount);
                document.getElementById('manual-amount').value = '';
                this.closeModal('fidelity-modal');
                this.render();
            }

            redeemReward(customerId) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer || customer.fidelity.rewards === 0) {
                    this.showToast('Nessun premio disponibile', 'error');
                    return;
                }

                if (confirm(`Confermi il riscatto di 1 premio per ${customer.firstName}?`)) {
                    customer.fidelity.rewards--;
                    customer.fidelity.history.push({
                        date: new Date().toISOString(),
                        type: 'redeemed',
                        stamps: 0,
                        amount: 0
                    });
                    this.saveData();
                    this.showToast('üéÅ Premio riscattato!');
                    this.closeModal('fidelity-modal');
                    this.render();
                }
            }


            generateFidelityCard(customerId) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer) return;

                // Genera l'immagine PNG della tessera
                const qrData = JSON.stringify({
                    id: customer.id,
                    name: `${customer.firstName} ${customer.lastName}`,
                    app: 'fidelity-card'
                });

                const qrContainer = document.createElement('div');
                qrContainer.style.display = 'none';
                document.body.appendChild(qrContainer);

                new QRCode(qrContainer, {
                    text: qrData,
                    width: 400,
                    height: 400,
                    colorDark: "#3E2723",
                    colorLight: "#ffffff"
                });

                setTimeout(() => {
                    const qrImg = qrContainer.querySelector('img');
                    if (qrImg) {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Formato card elegante (stessa dimensione della tessera WhatsApp)
                        canvas.width = 1200;
                        canvas.height = 750;

                        // Gradiente elegante beige simile al logo
                        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                        gradient.addColorStop(0, '#F8E3C4'); // Beige chiaro
                        gradient.addColorStop(1, '#F2D4A4'); // Beige pi√π caldo
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Texture leggera
                        ctx.globalAlpha = 0.03;
                        for (let i = 0; i < 2000; i++) {
                            ctx.fillStyle = '#5D3F24'; // Marrone pi√π scuro
                            ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
                        }
                        ctx.globalAlpha = 1;

                        // Intestazione Pastificio Gramsci (nome attivit√† pi√π evidente)
                        ctx.fillStyle = '#5D3F24'; // Marrone del logo
                        ctx.font = 'bold 60px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('PASTIFICIO GRAMSCI', canvas.width / 2, 100);

                        // Sottotitolo
                        ctx.font = 'italic 36px Georgia';
                        ctx.fillStyle = '#5D3F24';
                        ctx.fillText('TESSERA FEDELT√Ä', canvas.width / 2, 160);

                        // Linea decorativa ondulata
                        ctx.strokeStyle = '#5D3F24';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        for (let x = 0; x <= canvas.width; x += 10) {
                            const y = 200 + Math.sin(x * 0.02) * 5;
                            if (x === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.stroke();

                        // Nome cliente elegante
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'bold 46px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${customer.firstName} ${customer.lastName}`, canvas.width / 2, 280);

                        // QR Code con cornice elegante
                        const qrSize = 300;
                        const qrX = canvas.width / 2 - qrSize / 2; // Centrato
                        const qrY = 350; // Sotto il nome

                        // Ombra QR
                        ctx.shadowColor = 'rgba(0,0,0,0.2)';
                        ctx.shadowBlur = 20;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 10;

                        // Cornice marrone QR
                        ctx.fillStyle = '#5D3F24'; // Marrone del logo
                        ctx.fillRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30);

                        ctx.shadowColor = 'transparent';

                        // Sfondo bianco QR
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(qrX - 8, qrY - 8, qrSize + 16, qrSize + 16);

                        // Disegna QR
                        ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

                        // Testo sotto QR
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'italic 20px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('Scansiona in negozio', qrX + qrSize / 2, qrY + qrSize + 40);

                        // Footer elegante
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'italic 22px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('Grazie per la tua fedelt√†!', canvas.width / 2, canvas.height - 30);

                        // Converti canvas in PNG e scarica/condividi
                        canvas.toBlob(async (blob) => {
                            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                            const fileName = `tessera-fidelity-${customer.lastName}-${customer.firstName}.png`;
                            const currentStamps = customer.fidelity?.stamps || 0;

                            const messageText =
                                `üéâ Ciao ${customer.firstName}!\n\n` +
                                `üí≥ Ti rimando la tua tessera fedelt√†!\n\n` +
                                `üìä Stato attuale: ${currentStamps}/${this.fidelityConfig.stampsPerReward || 10} bollini\n` +
                                (customer.fidelity?.rewards > 0 ? `üéÅ Hai ${customer.fidelity.rewards} premio/i da riscattare!\n\n` : '\n') +
                                `üì± SALVA l'immagine sul telefono!\n\n` +
                                `Pastificio Gramsci`;

                            // Prova Web Share API su mobile (condivisione diretta con immagine allegata)
                            if (isMobile && navigator.share && navigator.canShare) {
                                try {
                                    const file = new File([blob], fileName, { type: 'image/png' });

                                    // Verifica se pu√≤ condividere file
                                    if (navigator.canShare({ files: [file] })) {
                                        await navigator.share({
                                            files: [file],
                                            title: 'Tessera Fidelity',
                                            text: messageText
                                        });

                                        this.showToast('‚úÖ Tessera condivisa! Scegli WhatsApp per inviarla');
                                        document.body.removeChild(qrContainer);
                                        return;
                                    }
                                } catch (err) {
                                    // Se l'utente annulla o c'√® un errore, continua con il metodo di fallback
                                    console.log('Condivisione annullata o non supportata:', err);
                                }
                            }

                            // Fallback: Download + apertura WhatsApp (per desktop o se Web Share non funziona)
                            const url = URL.createObjectURL(blob);

                            // Crea link per download
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = fileName;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();

                            // Pulizia
                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);

                            this.showToast('‚úÖ Tessera scaricata! Apertura WhatsApp...');

                            // Apri WhatsApp dopo il download
                            setTimeout(() => {
                                if (customer.phone) {
                                    const phone = customer.phone.replace(/[^0-9]/g, '');
                                    const phoneFormatted = phone.startsWith('39') ? phone : '39' + phone;
                                    const whatsappUrl = `https://wa.me/${phoneFormatted}?text=${encodeURIComponent(messageText)}`;
                                    window.open(whatsappUrl, '_blank');
                                } else {
                                    this.showToast('‚ö†Ô∏è Numero di telefono mancante per aprire WhatsApp', 'warning');
                                }
                            }, 800);
                        }, 'image/png', 1.0);
                    }
                    document.body.removeChild(qrContainer);
                }, 500);
            }

            sendFidelityCardWhatsApp(customerId) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer || !customer.phone) {
                    this.showToast('‚ùå Cliente senza numero di telefono', 'error');
                    return;
                }

                const qrData = JSON.stringify({
                    id: customer.id,
                    name: `${customer.firstName} ${customer.lastName}`,
                    app: 'fidelity-card'
                });

                const qrContainer = document.createElement('div');
                qrContainer.style.display = 'none';
                document.body.appendChild(qrContainer);

                new QRCode(qrContainer, {
                    text: qrData,
                    width: 400,
                    height: 400,
                    colorDark: "#3E2723",
                    colorLight: "#ffffff"
                });

                setTimeout(() => {
                    const qrImg = qrContainer.querySelector('img');
                    if (qrImg) {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Formato card elegante
                        canvas.width = 1200;
                        canvas.height = 750;

                        // Gradiente elegante beige simile al logo
                        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                        gradient.addColorStop(0, '#F8E3C4'); // Beige chiaro
                        gradient.addColorStop(1, '#F2D4A4'); // Beige pi√π caldo
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Texture leggera
                        ctx.globalAlpha = 0.03;
                        for (let i = 0; i < 2000; i++) {
                            ctx.fillStyle = '#5D3F24'; // Marrone pi√π scuro
                            ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
                        }
                        ctx.globalAlpha = 1;

                        // Intestazione Pastificio Gramsci (nome attivit√† pi√π evidente)
                        ctx.fillStyle = '#5D3F24'; // Marrone del logo
                        ctx.font = 'bold 60px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('PASTIFICIO GRAMSCI', canvas.width / 2, 100);

                        // Sottotitolo
                        ctx.font = 'italic 36px Georgia';
                        ctx.fillStyle = '#5D3F24';
                        ctx.fillText('TESSERA FEDELT√Ä', canvas.width / 2, 160);

                        // Linea decorativa ondulata
                        ctx.strokeStyle = '#5D3F24';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        for (let x = 0; x <= canvas.width; x += 10) {
                            const y = 200 + Math.sin(x * 0.02) * 5;
                            if (x === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.stroke();

                        // Nome cliente elegante
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'bold 46px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${customer.firstName} ${customer.lastName}`, canvas.width / 2, 280);

                        // QR Code con cornice elegante
                        const qrSize = 300;
                        const qrX = canvas.width / 2 - qrSize / 2; // Centrato
                        const qrY = 350; // Sotto il nome

                        // Ombra QR
                        ctx.shadowColor = 'rgba(0,0,0,0.2)';
                        ctx.shadowBlur = 20;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 10;

                        // Cornice marrone QR
                        ctx.fillStyle = '#5D3F24'; // Marrone del logo
                        ctx.fillRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30);

                        ctx.shadowColor = 'transparent';

                        // Sfondo bianco QR
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(qrX - 8, qrY - 8, qrSize + 16, qrSize + 16);

                        // Disegna QR
                        ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

                        // Testo sotto QR
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'italic 20px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('Scansiona in negozio', qrX + qrSize / 2, qrY + qrSize + 40);

                        // Footer elegante
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'italic 22px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('Grazie per la tua fedelt√†!', canvas.width / 2, canvas.height - 30);

                        // Esporta l'immagine come data URL
                        const cardImageDataUrl = canvas.toDataURL('image/jpeg', 0.8);

                        // Prepara il messaggio WhatsApp
                        const phone = customer.phone.replace(/[^0-9]/g, '');
                        const phoneFormatted = phone.startsWith('39') ? phone : '39' + phone;
                        const currentStamps = customer.fidelity?.stamps || 0;

                        const messageText =
                            `üéâ Ciao ${customer.firstName}! Benvenuto nel programma Fedelt√†!\n\n` +
                            `üí≥ Ecco la tua tessera digitale personale!\n\n` +
                            `üìä Come funziona:\n` +
                            `üìç Ogni ${this.fidelityConfig.eurosPerStamp || 20}‚Ç¨ = 1 bollino ‚úì\n` +
                            `üè∑Ô∏è Accumula ${this.fidelityConfig.stampsPerReward || 10} bollini = 1 PREMIO! üéÅ\n\n` +
                            `üéØ Stato attuale: ${currentStamps}/${this.fidelityConfig.stampsPerReward || 10} bollini\n` +
                            (customer.fidelity?.rewards > 0 ? `üéÅ Hai ${customer.fidelity.rewards} premio/i da riscattare!\n\n` : '\n') +
                            `üì± SALVA QUESTA TESSERA sul telefono!\n\n` +
                            `Grazie per la fiducia! üòä\n\nPastificio Gramsci`;

                        // üöÄ SISTEMA AVANZATO DI AUTOMAZIONE COMPLETA
                        this.advancedCardSender(cardImageDataUrl, messageText, phoneFormatted, customer);
                    }
                    document.body.removeChild(qrContainer);
                }, 500);
            }

            async advancedCardSender(imageDataUrl, messageText, phoneFormatted, customer) {
                // Strategia 1: Web Share API - Condivisione nativa del sistema (solo su mobile)
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                if (isMobile) {
                    const shareSuccess = await this.tryWebShare(imageDataUrl, messageText, customer);
                    if (shareSuccess) {
                        // Se Web Share funziona, non serve altro
                        this.markCardAsSent(customer);
                        return;
                    }
                }

                // Strategia di backup: Download singolo + WhatsApp
                // Download UN SOLO FILE invece di 4 duplicati
                const fileName = `tessera-fidelity-${customer.lastName}-${customer.firstName}.jpg`;
                const link = document.createElement('a');
                link.href = imageDataUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('‚úÖ Download singolo creato:', fileName);

                // Crea URL temporaneo per drag&drop (solo desktop)
                let shareUrl = null;
                if (!isMobile) {
                    shareUrl = await this.createShareableUrl(imageDataUrl, customer);
                }

                // Mostra istruzioni PRIMA di aprire WhatsApp per evitare che vengano coperte
                this.showPreWhatsAppInstructions(customer.firstName, !isMobile);

                // Apre WhatsApp dopo un delay per permettere di leggere le istruzioni
                setTimeout(() => {
                    this.openWhatsAppWithMessage(messageText, phoneFormatted, shareUrl, !isMobile);
                }, 3000); // 3 secondi di delay

                this.markCardAsSent(customer);
            }

            markCardAsSent(customer) {
                if (!customer.fidelity) {
                    customer.fidelity = { stamps: 0, rewards: 0, history: [], cardSent: false };
                }
                customer.fidelity.cardSent = true;
                customer.fidelity.cardSentDate = new Date().toISOString();
                this.saveData();
            }

            async tryWebShare(imageDataUrl, messageText, customer) {
                if (!navigator.share) {
                    console.log('‚ùå Web Share API non supportata');
                    return false;
                }

                try {
                    // Converte data URL in blob
                    const response = await fetch(imageDataUrl);
                    const blob = await response.blob();
                    const file = new File([blob], `tessera-${customer.firstName}.jpg`, { type: 'image/jpeg' });

                    // Usa Web Share API per condivisione nativa
                    await navigator.share({
                        title: `Tessera Fedelt√† - ${customer.firstName} ${customer.lastName}`,
                        text: messageText,
                        files: [file]
                    });

                    console.log('‚úÖ Condivisione Web Share API completata!');
                    this.showToast(`üéâ Tessera condivisa con successo per ${customer.firstName}!`);
                    return true;
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.log('‚ùå Errore Web Share API:', error);
                    }
                    return false;
                }
            }

            async createShareableUrl(imageDataUrl, customer) {
                try {
                    // Crea un URL blob temporaneo per l'immagine
                    const response = await fetch(imageDataUrl);
                    const blob = await response.blob();
                    const shareUrl = URL.createObjectURL(blob);

                    console.log('‚úÖ URL temporaneo creato per drag&drop');
                    return shareUrl;
                } catch (error) {
                    console.log('‚ùå Errore creazione URL condivisione:', error);
                    return null;
                }
            }

            openWhatsAppWithMessage(messageText, phoneFormatted, shareUrl, isDesktop, customerName) {
                if (isDesktop) {
                    // Desktop: apre WhatsApp Web + finestra immagine separata
                    const whatsappWebUrl = `https://web.whatsapp.com/send?phone=${phoneFormatted}&text=${encodeURIComponent(messageText)}`;
                    window.open(whatsappWebUrl, '_blank');

                    // Apre anche l'immagine in una nuova tab per drag&drop facile
                    if (shareUrl) {
                        setTimeout(() => {
                            const imageWindow = window.open(shareUrl, '_blank', 'width=500,height=400,left=100,top=100');
                            if (imageWindow) {
                                imageWindow.document.title = `Trascina in WhatsApp - ${customerName}`;
                            }
                        }, 1000);
                    }
                } else {
                    // Mobile: apre app WhatsApp
                    const whatsappAppUrl = `https://wa.me/${phoneFormatted}?text=${encodeURIComponent(messageText)}`;
                    window.open(whatsappAppUrl, '_blank');
                }

                console.log('‚úÖ WhatsApp aperto con messaggio corretto');
            }

            showPreWhatsAppInstructions(customerName, isDesktop) {
                const popup = document.createElement('div');
                popup.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #10B981, #059669);
                    color: white;
                    padding: 30px;
                    border-radius: 20px;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
                    z-index: 10000;
                    max-width: 500px;
                    animation: popInCenter 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                    border: 3px solid rgba(255,255,255,0.3);
                    text-align: center;
                `;

                popup.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">üéØ</div>
                    <h2 style="margin: 0 0 15px 0; font-size: 24px;">Tessera per ${customerName}</h2>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px;">‚úÖ TUTTO PRONTO!</div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            üì• Tessera scaricata in Download<br>
                            üì± WhatsApp si aprir√† tra 3 secondi<br>
                            ${isDesktop ? 'üñºÔ∏è Finestra immagine separata si aprir√†' : 'üìé Usa il pulsante allega in WhatsApp'}
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(59,130,246,0.9), rgba(37,99,235,0.9)); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">üöÄ PROSSIMO PASSO:</div>
                        ${isDesktop ?
                        '<div style="font-size: 15px;">Trascina l\'immagine dalla finestra separata ‚Üí WhatsApp</div>' :
                        '<div style="font-size: 15px;">Tocca üìé in WhatsApp ‚Üí Seleziona l\'immagine tessera</div>'
                    }
                    </div>
                    
                    <div style="font-size: 18px; font-weight: bold; color: #FFF; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        WhatsApp si apre automaticamente in <span id="countdown" style="font-size: 24px;">3</span>
                    </div>
                `;

                // Stile per animazione
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes popInCenter {
                        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
                        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);

                document.body.appendChild(popup);

                // Countdown 3 secondi
                let count = 3;
                const countdownEl = document.getElementById('countdown');
                const countdownInterval = setInterval(() => {
                    count--;
                    if (countdownEl) countdownEl.textContent = count;
                    if (count <= 0) {
                        clearInterval(countdownInterval);
                        if (popup.parentNode) {
                            popup.parentNode.removeChild(popup);
                            if (style.parentNode) style.parentNode.removeChild(style);
                        }
                    }
                }, 1000);
            }



            sendStampsUpdateWhatsApp(customerId, stampsAdded) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer || !customer.phone) return;

                const phone = customer.phone.replace(/[^0-9]/g, '');
                const phoneFormatted = phone.startsWith('39') ? phone : '39' + phone;

                const currentStamps = customer.fidelity.stamps;
                const totalNeeded = this.fidelityConfig.stampsPerReward;
                const stampsToNext = totalNeeded - currentStamps;

                let message = `üéâ Ciao ${customer.firstName}!\n\n`;

                // Cambia il messaggio in base a se sono stati aggiunti bollini o √® solo un aggiornamento
                if (stampsAdded > 0) {
                    message += `üìç Hai appena guadagnato ${stampsAdded} bollino${stampsAdded > 1 ? 'i' : ''}!\n\n`;
                } else {
                    message += `üí≥ Ecco la situazione aggiornata della tua tessera fedelt√†!\n\n`;
                }

                message += `üè∑Ô∏è Bollini totali: ${currentStamps}/${totalNeeded}\n`;

                if (customer.fidelity.rewards > 0) {
                    message += `üéÅ Hai ${customer.fidelity.rewards} premio${customer.fidelity.rewards > 1 ? 'i' : ''} disponibile${customer.fidelity.rewards > 1 ? 'i' : ''}!\n\n` +
                        `üéä Fantastico! Passa in negozio per riscattare il tuo premio! üéä\n`;
                } else if (stampsToNext > 0) {
                    message += `\n‚≠ê Ti mancano solo ${stampsToNext} bollino${stampsToNext > 1 ? 'i' : ''} al prossimo premio!\n`;
                } else {
                    message += `\nüî• Hai completato la card! Al prossimo acquisto avrai un premio! üî•\n`;
                }

                message += `\nGrazie per la fiducia! üòä\n\nPastificio Gramsci`;

                const whatsappUrl = `https://wa.me/${phoneFormatted}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('‚úÖ Messaggio aggiornamento pronto su WhatsApp');
            }

            showWhatsAppInstructions(customer, imageUrl, isCard = false) {
                const modal = document.createElement('div');
                modal.className = 'modal open fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-[150]';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
                        <h3 class="text-xl font-bold mb-4">üì± Invia ${isCard ? 'Tessera' : 'QR'} su WhatsApp</h3>
                        
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                            <p class="text-sm text-green-800 mb-2">
                                <strong>‚úÖ ${isCard ? 'Tessera' : 'QR Code'} scaricata!</strong>
                            </p>
                            <p class="text-sm text-green-700">
                                Troverai l'immagine nella cartella Download
                            </p>
                        </div>

                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                            <p class="text-sm font-semibold text-blue-900 mb-2">Prossimi passaggi:</p>
                            <ol class="list-decimal ml-4 space-y-2 text-sm text-blue-800">
                                <li>WhatsApp si aprir√† con ${customer.firstName}</li>
                                <li>Il messaggio √® gi√† pronto</li>
                                <li><strong>Allega l'immagine</strong> (click su üìé ‚Üí Foto)</li>
                                <li>Invia!</li>
                            </ol>
                        </div>

                        <div class="space-y-3">
                            <a href="${imageUrl}" download="tessera-${customer.firstName}-${customer.lastName}.png" 
                               class="block w-full bg-purple-600 text-white text-center py-3 px-4 rounded-lg hover:bg-purple-700 font-medium">
                                üì• Scarica di nuovo l'immagine
                            </a>
                            <button onclick="this.closest('.modal').remove()" 
                                    class="w-full bg-gray-200 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-300 font-medium">
                                Ho capito, chiudi
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                this.showToast(`‚úÖ ${isCard ? 'Tessera' : 'QR'} generata! Segui le istruzioni`);
            }

            // QUICK CUSTOMER ADD
            openQuickCustomerAdd() {
                document.getElementById('quick-firstname').value = '';
                document.getElementById('quick-lastname').value = '';
                document.getElementById('quick-phone').value = '';
                document.getElementById('quick-email').value = '';
                document.getElementById('quick-marketing').checked = false;
                document.getElementById('quick-stamps').value = '';
                document.getElementById('quick-stamps-preview').classList.add('hidden');
                document.getElementById('quick-customer-status').classList.add('hidden');
                document.getElementById('quick-existing-customer-id').value = '';
                document.getElementById('quick-save-btn-text').textContent = 'Salva & Invia Tessera';

                this.openModal('quick-customer-modal');
            }

            checkQuickCustomerExists() {
                const firstName = document.getElementById('quick-firstname').value.trim().toLowerCase();
                const lastName = document.getElementById('quick-lastname').value.trim().toLowerCase();
                const phone = document.getElementById('quick-phone').value.trim().replace(/[^0-9]/g, '');

                // Cerca solo se c'√® almeno un dato
                if (!firstName && !lastName && !phone) {
                    document.getElementById('quick-customer-status').classList.add('hidden');
                    document.getElementById('quick-existing-customer-id').value = '';
                    return;
                }

                // Cerca cliente esistente
                const existingCustomer = this.db.customers.find(c => {
                    const nameMatch = firstName && lastName &&
                        c.firstName.toLowerCase() === firstName &&
                        c.lastName.toLowerCase() === lastName;
                    const phoneMatch = phone.length >= 9 && c.phone &&
                        c.phone.replace(/[^0-9]/g, '').includes(phone);
                    return nameMatch || phoneMatch;
                });

                if (existingCustomer) {
                    // Cliente trovato - popola i campi
                    document.getElementById('quick-firstname').value = existingCustomer.firstName;
                    document.getElementById('quick-lastname').value = existingCustomer.lastName;
                    document.getElementById('quick-phone').value = existingCustomer.phone || '';
                    document.getElementById('quick-email').value = existingCustomer.email || '';
                    document.getElementById('quick-marketing').checked = existingCustomer.marketing || false;
                    document.getElementById('quick-existing-customer-id').value = existingCustomer.id;

                    // Mostra status
                    const statusDiv = document.getElementById('quick-customer-status');
                    statusDiv.innerHTML = `
                        <div class="bg-green-50 border-l-4 border-green-500 p-4">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="flex-1">
                                    <p class="font-semibold text-green-800">‚úÖ Cliente Trovato!</p>
                                    <p class="text-sm text-green-700 mt-1">
                                        ${existingCustomer.firstName} ${existingCustomer.lastName}<br>
                                        Bollini attuali: <strong>${existingCustomer.fidelity?.stamps || 0}/${this.fidelityConfig.stampsPerReward}</strong><br>
                                        Premi: <strong>${existingCustomer.fidelity?.rewards || 0}</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    statusDiv.classList.remove('hidden');
                    document.getElementById('quick-save-btn-text').textContent = 'Aggiungi Bollini & Aggiorna';
                } else {
                    document.getElementById('quick-customer-status').classList.add('hidden');
                    document.getElementById('quick-existing-customer-id').value = '';
                    document.getElementById('quick-save-btn-text').textContent = 'Salva & Invia Tessera';
                }

                // Aggiorna anteprima bollini se c'√® un importo
                this.updateQuickStampsPreview();
            }

            updateQuickStampsPreview() {
                const stamps = parseInt(document.getElementById('quick-stamps').value) || 0;
                if (stamps > 0) {
                    document.getElementById('preview-stamps').textContent = stamps;
                    document.getElementById('quick-stamps-preview').classList.remove('hidden');
                } else {
                    document.getElementById('quick-stamps-preview').classList.add('hidden');
                }
            }

            saveQuickCustomer() {
                const firstName = document.getElementById('quick-firstname').value.trim();
                const lastName = document.getElementById('quick-lastname').value.trim();
                const phone = document.getElementById('quick-phone').value.trim();
                const email = document.getElementById('quick-email').value.trim();
                const marketing = document.getElementById('quick-marketing').checked;
                const stampsToAdd = parseInt(document.getElementById('quick-stamps').value);
                const existingCustomerId = document.getElementById('quick-existing-customer-id').value;

                if (!firstName || !lastName || !phone) {
                    this.showToast('‚ùå Compila tutti i campi obbligatori', 'error');
                    return;
                }

                if (isNaN(stampsToAdd) || stampsToAdd <= 0) {
                    this.showToast('‚ùå Inserisci un numero di bollini valido', 'error');
                    return;
                }

                if (existingCustomerId) {
                    // Cliente esistente - aggiorna dati e aggiungi bollini
                    const customer = this.db.customers.find(c => c.id === existingCustomerId);
                    if (customer) {
                        customer.phone = phone;
                        customer.email = email;
                        customer.marketing = marketing;

                        this.addStampsDirectly(customer.id, stampsToAdd);
                        this.saveData();
                        this.showToast(`‚úÖ ${stampsToAdd} bollini aggiunti a ${customer.firstName}!`);

                        // Invia solo messaggio di aggiornamento
                        setTimeout(() => {
                            if (confirm(`Vuoi inviare l'aggiornamento bollini a ${customer.firstName} su WhatsApp?`)) {
                                this.sendStampsUpdateWhatsApp(customer.id, stampsToAdd);
                            }
                        }, 1000);
                    }
                } else {
                    // Nuovo cliente - invia tessera completa
                    const newCustomer = {
                        id: this.generateId(),
                        firstName,
                        lastName,
                        phone,
                        email,
                        marketing,
                        fidelity: { stamps: 0, totalSpent: 0, rewards: 0, history: [], cardSent: false }
                    };

                    this.db.customers.push(newCustomer);
                    this.addStampsDirectly(newCustomer.id, stampsToAdd);
                    this.saveData();

                    this.showToast(`‚úÖ Cliente ${firstName} creato con ${stampsToAdd} bollini!`);

                    // Invia tessera automaticamente su WhatsApp per nuovi clienti
                    setTimeout(() => {
                        this.sendFidelityCardWhatsApp(newCustomer.id);
                        this.showToast(`üì± Apertura WhatsApp con tessera di ${firstName}...`);
                    }, 1000);
                }

                this.closeModal('quick-customer-modal');
                this.render();
            }

            // QR SCANNER
            openQRScanner() {
                this.openModal('qr-scanner-modal');
                document.getElementById('qr-result').innerHTML = '<p class="text-gray-500">Clicca "Avvia Camera" o carica un\'immagine</p>';
            }

            async startQRScanner() {
                const video = document.getElementById('qr-video');
                const canvas = document.getElementById('qr-canvas');
                const result = document.getElementById('qr-result');
                const startBtn = document.getElementById('start-scanner-btn');

                try {
                    // Verifica che getUserMedia sia disponibile
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Il tuo browser non supporta l\'accesso alla fotocamera');
                    }

                    startBtn.textContent = 'Richiesta permessi...';
                    startBtn.disabled = true;

                    // Prova prima con fotocamera posteriore (environment)
                    let constraints = {
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };

                    try {
                        this.qrStream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (firstError) {
                        console.log('Tentativo con fotocamera posteriore fallito, provo con qualsiasi fotocamera...', firstError);

                        // Fallback: prova con qualsiasi fotocamera disponibile
                        constraints = {
                            video: {
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        };
                        this.qrStream = await navigator.mediaDevices.getUserMedia(constraints);
                    }

                    video.srcObject = this.qrStream;
                    video.style.display = 'block';

                    // Attendi che il video sia pronto
                    await video.play();

                    startBtn.textContent = 'üì∑ Scansionando...';
                    result.innerHTML = '<p class="text-green-600">‚úÖ Camera attiva - Inquadra il QR code</p>';

                    const ctx = canvas.getContext('2d');
                    let scanning = true;

                    const scan = () => {
                        if (!scanning || !this.qrStream) return;

                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.height = video.videoHeight;
                            canvas.width = video.videoWidth;
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);

                            if (code) {
                                scanning = false;
                                this.processQRCode(code.data);
                                return;
                            }
                        }
                        requestAnimationFrame(scan);
                    };
                    scan();

                } catch (err) {
                    console.error('Errore accesso fotocamera:', err);

                    let errorMessage = '‚ùå Impossibile accedere alla fotocamera';

                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMessage = '‚ùå Permesso fotocamera negato. Vai nelle impostazioni del browser e consenti l\'accesso alla fotocamera per questo sito.';
                    } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                        errorMessage = '‚ùå Nessuna fotocamera trovata sul dispositivo.';
                    } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                        errorMessage = '‚ùå Fotocamera in uso da un\'altra applicazione. Chiudi altre app che usano la camera.';
                    } else if (err.name === 'OverconstrainedError') {
                        errorMessage = '‚ùå Le impostazioni richieste non sono supportate dalla fotocamera.';
                    } else if (err.name === 'SecurityError') {
                        errorMessage = '‚ùå Errore di sicurezza. Assicurati di usare HTTPS o localhost.';
                    } else if (err.message) {
                        errorMessage = `‚ùå ${err.message}`;
                    }

                    result.innerHTML = `<p class="text-red-600">${errorMessage}</p>
                        <p class="text-sm text-gray-600 mt-2">üí° Suggerimento: Prova a caricare un'immagine del QR code usando il pulsante qui sotto</p>`;

                    startBtn.textContent = 'Riprova Camera';
                    startBtn.disabled = false;

                    this.showToast(errorMessage, 'error');
                }
            }

            scanQRFromFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('qr-canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code) {
                            this.processQRCode(code.data);
                        } else {
                            document.getElementById('qr-result').innerHTML = '<p class="text-red-600">‚ùå QR Code non trovato nell\'immagine</p>';
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            processQRCode(data) {
                try {
                    const qrData = JSON.parse(data);
                    if (qrData.app === 'fidelity-card' && qrData.id) {
                        this.closeQRScanner();
                        this.openFidelityCard(qrData.id);
                    } else {
                        document.getElementById('qr-result').innerHTML = '<p class="text-red-600">‚ùå QR Code non valido</p>';
                    }
                } catch (err) {
                    document.getElementById('qr-result').innerHTML = '<p class="text-red-600">‚ùå QR Code non valido</p>';
                }
            }

            closeQRScanner() {
                if (this.qrStream) {
                    this.qrStream.getTracks().forEach(track => track.stop());
                    this.qrStream = null;
                }
                const video = document.getElementById('qr-video');
                video.style.display = 'none';
                video.srcObject = null;
                document.getElementById('start-scanner-btn').textContent = 'Avvia Camera';
                document.getElementById('start-scanner-btn').disabled = false;
                document.getElementById('qr-file').value = '';
                this.closeModal('qr-scanner-modal');
            }

            // FUNZIONI SCANNER DASHBOARD
            async toggleDashboardScanner() {
                const container = document.getElementById('dashboard-scanner-container');
                const video = document.getElementById('dashboard-scanner-video');
                const toggleBtn = document.getElementById('dashboard-scanner-toggle');

                if (container.classList.contains('hidden')) {
                    // Apri scanner
                    container.classList.remove('hidden');
                    toggleBtn.textContent = 'Ferma Scanner';
                    toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    this.startDashboardScanner();
                } else {
                    // Chiudi scanner
                    this.stopDashboardScanner();
                    container.classList.add('hidden');
                    toggleBtn.textContent = 'Avvia Scanner';
                    toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            }

            async startDashboardScanner() {
                const video = document.getElementById('dashboard-scanner-video');
                const canvas = document.getElementById('dashboard-scanner-canvas');
                const status = document.getElementById('dashboard-scanner-status');
                const overlay = document.getElementById('dashboard-scanner-overlay');

                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Il tuo browser non supporta l\'accesso alla fotocamera');
                    }

                    status.textContent = 'üì∑ Richiesta permessi fotocamera...';
                    status.className = 'text-center text-lg font-semibold mb-4 text-blue-600';

                    let constraints = {
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };

                    try {
                        this.dashboardScannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (firstError) {
                        console.log('Tentativo con fotocamera posteriore fallito, provo con qualsiasi fotocamera...', firstError);
                        constraints = {
                            video: {
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        };
                        this.dashboardScannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                    }

                    video.srcObject = this.dashboardScannerStream;
                    video.style.display = 'block';
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                    await video.play();

                    status.textContent = 'üéØ Inquadra il QR code della tessera';
                    status.className = 'text-center text-lg font-semibold mb-4 text-green-600';

                    const ctx = canvas.getContext('2d');
                    let isScanning = true;

                    const scan = () => {
                        if (!isScanning || !this.dashboardScannerStream) return;

                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.height = video.videoHeight;
                            canvas.width = video.videoWidth;
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);

                            if (code) {
                                isScanning = false;
                                this.processDashboardQRCode(code.data);
                                return;
                            }
                        }
                        requestAnimationFrame(scan);
                    };
                    scan();

                } catch (err) {
                    console.error('Errore accesso fotocamera:', err);

                    let errorMessage = '‚ùå Impossibile accedere alla fotocamera';

                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMessage = '‚ùå Permesso negato. Vai nelle impostazioni del browser e consenti l\'accesso alla fotocamera';
                    } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                        errorMessage = '‚ùå Nessuna fotocamera trovata';
                    } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                        errorMessage = '‚ùå Fotocamera in uso. Chiudi altre app';
                    } else if (err.message) {
                        errorMessage = `‚ùå ${err.message}`;
                    }

                    status.innerHTML = `<div class="text-center">
                        <p class="text-red-600 font-semibold mb-2">${errorMessage}</p>
                        <p class="text-sm text-gray-600">üí° Prova a caricare un'immagine del QR code</p>
                    </div>`;

                    this.showToast(errorMessage, 'error');
                }
            }

            stopDashboardScanner() {
                if (this.dashboardScannerStream) {
                    this.dashboardScannerStream.getTracks().forEach(track => track.stop());
                    this.dashboardScannerStream = null;
                }
                const video = document.getElementById('dashboard-scanner-video');
                const overlay = document.getElementById('dashboard-scanner-overlay');
                video.style.display = 'none';
                video.srcObject = null;
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                document.getElementById('dashboard-scanner-status').textContent = '';
                document.getElementById('dashboard-scanner-file').value = '';
            }

            processDashboardQRCode(data) {
                try {
                    const qrData = JSON.parse(data);
                    if (qrData.app === 'fidelity-card' && qrData.id) {
                        this.stopDashboardScanner();
                        document.getElementById('dashboard-scanner-container').classList.add('hidden');
                        const toggleBtn = document.getElementById('dashboard-scanner-toggle');
                        toggleBtn.textContent = 'Avvia Scanner';
                        toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                        this.showToast('‚úÖ Tessera rilevata!');
                        this.openFidelityCard(qrData.id);
                    } else {
                        document.getElementById('dashboard-scanner-status').innerHTML = '<p class="text-red-600">‚ùå QR Code non valido</p>';
                    }
                } catch (err) {
                    document.getElementById('dashboard-scanner-status').innerHTML = '<p class="text-red-600">‚ùå QR Code non valido</p>';
                }
            }

            scanFromFileDashboard(event) {
                const file = event.target.files[0];
                if (!file) return;

                const status = document.getElementById('dashboard-scanner-status');
                status.textContent = 'üîç Analisi immagine...';
                status.className = 'text-center text-lg font-semibold mb-4 text-blue-600';

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('dashboard-scanner-canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code) {
                            this.processDashboardQRCode(code.data);
                        } else {
                            status.textContent = '‚ùå QR Code non trovato nell\'immagine';
                            status.className = 'text-center text-lg font-semibold mb-4 text-red-600';
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                event.target.value = '';
            }

            searchFidelityCustomer(query) {
                const suggestions = document.getElementById('fidelity-suggestions');
                if (query.length < 2) { suggestions.classList.add('hidden'); return; }
                const matches = this.db.customers.filter(c => {
                    const fullName = `${c.firstName} ${c.lastName}`.toLowerCase();
                    const phone = (c.phone || '').toLowerCase();
                    return fullName.includes(query.toLowerCase()) || phone.includes(query.toLowerCase());
                });
                if (matches.length === 0) { suggestions.classList.add('hidden'); return; }
                suggestions.innerHTML = matches.map(c => `<div class="autocomplete-suggestion" data-customer-id="${c.id}" onclick="app.openFidelityCard(this.dataset.customerId)"><div class="font-medium">${c.lastName} ${c.firstName}</div><div class="text-sm text-gray-600">${c.fidelity?.stamps || 0} bollini - ${c.fidelity?.rewards || 0} premi</div></div>`).join('');
                suggestions.classList.remove('hidden');
            }

            saveData() {
                // Aggiungi timestamp di ultima modifica
                this.db.lastModified = new Date().toISOString();

                // Cripta i dati prima di salvarli
                const encryptedData = authManager.encrypt(this.db);
                if (encryptedData) {
                    localStorage.setItem('orderManagerData', encryptedData);
                } else {
                    console.error('Errore crittografia dati');
                    return;
                }

                const now = new Date().toISOString();
                localStorage.setItem('lastSync', now);
                this.updateLastSyncInfo();
                this.updateStats();

                // Sync automatico su Dropbox se attivo
                if (this.autoSyncEnabled && !this.syncInProgress) {
                    this.syncToDropbox(true);
                }
            }

            generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
            formatPrice(price) { return parseFloat(price || 0).toFixed(2).replace('.', ',') + ' ‚Ç¨'; }
            formatDate(dateStr) { if (!dateStr) return ''; const d = new Date(dateStr + 'T00:00:00'); return d.toLocaleDateString('it-IT'); }

            // Sanitizzazione per prevenire XSS
            sanitizeHTML(str) {
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            }

            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');

                const toast = document.createElement('div');
                toast.className = 'toast';

                const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
                const icon = type === 'success' ? '‚úì' : '‚úï';

                toast.innerHTML = `
                    <div class="${bgColor} text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 min-w-[300px]">
                        <span class="text-2xl font-bold">${icon}</span>
                        <span class="font-medium">${message}</span>
                    </div>
                `;

                container.appendChild(toast);

                // Anima l'entrata
                setTimeout(() => toast.classList.add('show'), 10);

                // Rimuovi dopo 3 secondi
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => container.removeChild(toast), 300);
                }, 3000);
            }

            switchTab(tabName) {
                // Ferma lo scanner della Dashboard se attivo
                if (this.dashboardScannerStream) {
                    this.stopDashboardScanner();
                    const container = document.getElementById('dashboard-scanner-container');
                    const toggleBtn = document.getElementById('dashboard-scanner-toggle');
                    if (container && !container.classList.contains('hidden')) {
                        container.classList.add('hidden');
                        toggleBtn.textContent = 'Avvia Scanner';
                        toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    }
                }

                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.className = btn.dataset.tab === tabName ? 'tab-btn flex-1 p-4 border-b-2 border-blue-600 text-blue-600 font-semibold whitespace-nowrap' : 'tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap';
                });
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');

                // Reset filtri quando si cambia tab
                if (tabName === 'ordini') {
                    this.filteredOrders = null;
                    if (document.getElementById('order-search')) {
                        document.getElementById('order-search').value = '';
                        document.getElementById('prep-filter').value = '';
                        document.getElementById('payment-filter').value = '';
                    }
                }

                // Aggiorna dashboard quando si apre
                if (tabName === 'dashboard') {
                    this.renderDashboard();
                }

                // Aggiorna preparazione quando si apre
                if (tabName === 'preparazione') {
                    // Imposta data di domani di default
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    document.getElementById('prep-date-filter').value = tomorrow.toISOString().split('T')[0];
                    this.renderPreparation();
                }
            }

            openModal(modalId) {
                this.modalOpen = true;
                document.getElementById(modalId).classList.add('open');
            }

            closeModal(modalId) {
                this.modalOpen = false;
                document.getElementById(modalId).classList.remove('open');
            }

            // CATEGORIE
            openCategoryModal(id = null) {
                this.editingId = id;
                document.getElementById('category-name').value = '';
                document.getElementById('btn-delete-category').classList.add('hidden');
                if (id) {
                    const cat = this.db.categories.find(c => c.id === id);
                    if (cat) {
                        document.getElementById('category-name').value = cat.name;
                        document.getElementById('btn-delete-category').classList.remove('hidden');
                    }
                }
                this.openModal('category-modal');
            }

            saveCategory() {
                const name = document.getElementById('category-name').value.trim();
                if (!name) { this.showToast('Nome obbligatorio', 'error'); return; }
                const isDuplicate = this.db.categories.some(c => c.name.toLowerCase() === name.toLowerCase() && c.id !== this.editingId);
                if (isDuplicate) { this.showToast('Categoria esistente', 'error'); return; }
                if (this.editingId) {
                    const idx = this.db.categories.findIndex(c => c.id === this.editingId);
                    if (idx > -1) this.db.categories[idx].name = name;
                } else {
                    this.db.categories.push({ id: this.generateId(), name });
                }
                this.saveData();
                this.render();
                this.closeModal('category-modal');
                this.showToast('Categoria salvata');
            }

            deleteCategory() {
                if (!confirm('Eliminare categoria?')) return;
                const usedInProducts = this.db.products.some(p => p.category === this.db.categories.find(c => c.id === this.editingId)?.name);
                if (usedInProducts) { this.showToast('Categoria in uso', 'error'); return; }
                this.db.categories = this.db.categories.filter(c => c.id !== this.editingId);
                this.saveData();
                this.render();
                this.closeModal('category-modal');
                this.showToast('Categoria eliminata');
            }

            // PRODOTTI
            openProductModal(id = null) {
                this.editingId = id;
                document.getElementById('product-name').value = '';
                document.getElementById('product-price').value = '';
                document.getElementById('product-unit').value = 'kg';
                document.getElementById('product-has-average-weight').checked = false;
                document.getElementById('product-average-weight').value = '';
                document.getElementById('average-weight-field').classList.add('hidden');
                document.getElementById('btn-delete-product').classList.add('hidden');
                const select = document.getElementById('product-category');
                select.innerHTML = '<option value="">Nessuna categoria</option>';
                this.db.categories.forEach(cat => { select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`; });
                if (id) {
                    const prod = this.db.products.find(p => p.id === id);
                    if (prod) {
                        document.getElementById('product-name').value = prod.name;
                        document.getElementById('product-category').value = prod.category || '';
                        document.getElementById('product-price').value = prod.price;
                        document.getElementById('product-unit').value = prod.unit;

                        // Gestisci peso medio
                        if (prod.averageWeight) {
                            document.getElementById('product-has-average-weight').checked = true;
                            document.getElementById('product-average-weight').value = prod.averageWeight;
                            document.getElementById('average-weight-field').classList.remove('hidden');
                        }

                        document.getElementById('btn-delete-product').classList.remove('hidden');
                    }
                }
                this.openModal('product-modal');
            }

            toggleAverageWeightField() {
                const checkbox = document.getElementById('product-has-average-weight');
                const field = document.getElementById('average-weight-field');

                if (checkbox.checked) {
                    field.classList.remove('hidden');
                } else {
                    field.classList.add('hidden');
                    document.getElementById('product-average-weight').value = '';
                }
            }

            saveProduct() {
                const name = document.getElementById('product-name').value.trim();
                const price = parseFloat(document.getElementById('product-price').value);
                const category = document.getElementById('product-category').value;
                const unit = document.getElementById('product-unit').value;
                const hasAverageWeight = document.getElementById('product-has-average-weight').checked;
                const averageWeight = hasAverageWeight ? parseFloat(document.getElementById('product-average-weight').value) : null;

                // Validazione migliorata
                if (!name) {
                    this.showToast('‚ùå Nome prodotto obbligatorio', 'error');
                    return;
                }
                if (isNaN(price)) {
                    this.showToast('‚ùå Prezzo non valido', 'error');
                    return;
                }
                if (price < 0) {
                    this.showToast('‚ùå Il prezzo non pu√≤ essere negativo', 'error');
                    return;
                }
                if (price === 0 && !confirm('‚ö†Ô∏è Il prezzo √® zero. Confermi?')) {
                    return;
                }
                if (price > 100000) {
                    this.showToast('‚ùå Prezzo troppo elevato (max ‚Ç¨100,000)', 'error');
                    return;
                }
                if (hasAverageWeight && (isNaN(averageWeight) || averageWeight <= 0)) {
                    this.showToast('‚ùå Peso medio non valido', 'error');
                    return;
                }

                const product = {
                    id: this.editingId || this.generateId(),
                    name,
                    category,
                    price,
                    unit
                };

                // Aggiungi peso medio solo se specificato
                if (hasAverageWeight && averageWeight > 0) {
                    product.averageWeight = averageWeight;
                }

                if (this.editingId) {
                    const idx = this.db.products.findIndex(p => p.id === this.editingId);
                    if (idx > -1) this.db.products[idx] = product;
                } else {
                    this.db.products.push(product);
                }
                this.saveData();
                this.render();
                this.closeModal('product-modal');
                this.showToast('‚úÖ Prodotto salvato');
            }

            deleteProduct() {
                const usedInOrders = this.db.orders.some(o => o.items.some(item => item.productId === this.editingId));
                if (usedInOrders) {
                    this.showToast('‚ùå Impossibile eliminare: prodotto presente in ordini esistenti', 'error');
                    return;
                }
                const product = this.db.products.find(p => p.id === this.editingId);
                this.pendingDelete = {
                    type: 'product',
                    id: this.editingId,
                    name: product?.name || 'questo prodotto'
                };
                document.getElementById('confirm-message').textContent =
                    `Sei sicuro di voler eliminare "${this.pendingDelete.name}"? Questa azione non pu√≤ essere annullata.`;

                // Chiudi modal prodotto prima di aprire conferma
                this.closeModal('product-modal');

                // Apri modal conferma dopo un piccolo delay
                setTimeout(() => {
                    this.openModal('confirm-modal');
                }, 100);
            }

            // CLIENTI
            openCustomerModal(id = null) {
                this.editingId = id;
                document.getElementById('edit-customer-firstname').value = '';
                document.getElementById('edit-customer-lastname').value = '';
                document.getElementById('edit-customer-phone').value = '';
                document.getElementById('edit-customer-email').value = '';
                document.getElementById('edit-customer-marketing').checked = false;
                document.getElementById('btn-delete-customer').classList.add('hidden');
                document.getElementById('customer-stamps-section').classList.add('hidden');

                if (id) {
                    const cust = this.db.customers.find(c => c.id === id);
                    if (cust) {
                        document.getElementById('edit-customer-firstname').value = cust.firstName;
                        document.getElementById('edit-customer-lastname').value = cust.lastName;
                        document.getElementById('edit-customer-phone').value = cust.phone || '';
                        document.getElementById('edit-customer-email').value = cust.email || '';
                        document.getElementById('edit-customer-marketing').checked = cust.marketing || false;
                        document.getElementById('btn-delete-customer').classList.remove('hidden');

                        // Mostra sezione bollini per clienti esistenti
                        document.getElementById('customer-stamps-section').classList.remove('hidden');
                        const stamps = cust.fidelity?.stamps || 0;
                        const rewards = cust.fidelity?.rewards || 0;
                        document.getElementById('customer-stamps-count').textContent = stamps;
                        document.getElementById('customer-rewards-count').textContent = rewards;
                    }
                }
                this.openModal('customer-modal');
            }

            saveCustomer() {
                const firstName = document.getElementById('edit-customer-firstname').value.trim();
                const lastName = document.getElementById('edit-customer-lastname').value.trim();
                const phone = document.getElementById('edit-customer-phone').value.trim();
                const email = document.getElementById('edit-customer-email').value.trim();
                const marketing = document.getElementById('edit-customer-marketing').checked;
                if (!firstName || !lastName) { this.showToast('Nome e cognome obbligatori', 'error'); return; }
                const isDuplicate = this.db.customers.some(c => {
                    if (c.id === this.editingId) return false;
                    const sameName = c.firstName.toLowerCase() === firstName.toLowerCase() && c.lastName.toLowerCase() === lastName.toLowerCase();
                    const samePhone = phone && c.phone && c.phone === phone;
                    return sameName || samePhone;
                });
                if (isDuplicate) { this.showToast('Cliente gi√† presente', 'error'); return; }

                const isNewCustomer = !this.editingId;

                if (this.editingId) {
                    // Cliente esistente - aggiorna solo i dati anagrafici preservando fidelity
                    const idx = this.db.customers.findIndex(c => c.id === this.editingId);
                    if (idx > -1) {
                        const existingCustomer = this.db.customers[idx];
                        this.db.customers[idx] = {
                            ...existingCustomer,
                            firstName,
                            lastName,
                            phone,
                            email,
                            marketing
                        };
                    }
                } else {
                    // Nuovo cliente
                    const customer = {
                        id: this.generateId(),
                        firstName,
                        lastName,
                        phone,
                        email,
                        marketing,
                        fidelity: { stamps: 0, totalSpent: 0, rewards: 0, history: [], cardSent: false }
                    };
                    this.db.customers.push(customer);
                }

                this.saveData();
                this.render();
                this.closeModal('customer-modal');
                this.showToast('Cliente salvato');

                /* ‚ö†Ô∏è FIDELITY DISABILITATA
                // Invio automatico tessera per nuovi clienti con telefono
                if (isNewCustomer) {
                    const newCustomer = this.db.customers[this.db.customers.length - 1];
                    if (newCustomer.phone) {
                        setTimeout(() => {
                            this.sendFidelityCardWhatsApp(newCustomer.id);
                            this.showToast(`üì± Tessera fedelt√† inviata a ${newCustomer.firstName}!`);
                        }, 1000);
                    }           
                }
                */
            }

            deleteCustomer() {
                const usedInOrders = this.db.orders.some(o => o.customerId === this.editingId);
                if (usedInOrders) {
                    this.showToast('‚ùå Impossibile eliminare: cliente presente in ordini esistenti', 'error');
                    return;
                }
                const customer = this.db.customers.find(c => c.id === this.editingId);
                this.pendingDelete = {
                    type: 'customer',
                    id: this.editingId,
                    name: customer ? `${customer.firstName} ${customer.lastName}` : 'questo cliente'
                };
                document.getElementById('confirm-message').textContent =
                    `Sei sicuro di voler eliminare ${this.pendingDelete.name}? Questa azione non pu√≤ essere annullata.`;

                // Chiudi modal cliente prima di aprire conferma
                this.closeModal('customer-modal');

                // Apri modal conferma dopo un piccolo delay
                setTimeout(() => {
                    this.openModal('confirm-modal');
                }, 100);
            }

            deleteFidelityCustomer(customerId) {
                const usedInOrders = this.db.orders.some(o => o.customerId === customerId);
                if (usedInOrders) {
                    this.showToast('‚ùå Impossibile eliminare: cliente presente in ordini esistenti', 'error');
                    return;
                }
                const customer = this.db.customers.find(c => c.id === customerId);
                this.pendingDelete = {
                    type: 'customer',
                    id: customerId,
                    name: customer ? `${customer.firstName} ${customer.lastName}` : 'questo cliente'
                };
                document.getElementById('confirm-message').textContent =
                    `Sei sicuro di voler eliminare ${this.pendingDelete.name}? Questa azione non pu√≤ essere annullata.`;

                // Chiudi modal fidelity prima di aprire conferma
                this.closeModal('fidelity-modal');

                // Apri modal conferma dopo un piccolo delay
                setTimeout(() => {
                    this.openModal('confirm-modal');
                }, 100);
            }

            // Funzioni per gestire bollini dal modale cliente
            addStampsToCustomerInModal() {
                if (!this.editingId) return;
                const customer = this.db.customers.find(c => c.id === this.editingId);
                if (!customer) return;

                const amount = prompt('Quanti bollini vuoi aggiungere?', '1');
                if (!amount) return;

                const stamps = parseInt(amount);
                if (isNaN(stamps) || stamps < 1) {
                    this.showToast('‚ùå Numero non valido', 'error');
                    return;
                }

                if (!customer.fidelity) {
                    customer.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [], cardSent: false };
                }

                customer.fidelity.stamps += stamps;

                // Controlla se ha raggiunto 10 bollini per premio
                const stampsNeeded = 10;
                while (customer.fidelity.stamps >= stampsNeeded) {
                    customer.fidelity.stamps -= stampsNeeded;
                    customer.fidelity.rewards += 1;
                }

                customer.fidelity.history = customer.fidelity.history || [];
                customer.fidelity.history.push({
                    date: new Date().toISOString(),
                    type: 'manual_add',
                    stamps: stamps,
                    note: 'Bollini aggiunti manualmente'
                });

                this.saveData();

                // Aggiorna visualizzazione
                document.getElementById('customer-stamps-count').textContent = customer.fidelity.stamps;
                document.getElementById('customer-rewards-count').textContent = customer.fidelity.rewards;

                this.showToast(`‚úÖ Aggiunti ${stamps} bollini a ${customer.firstName}!`);
            }

            removeStampsFromCustomerInModal() {
                if (!this.editingId) return;
                const customer = this.db.customers.find(c => c.id === this.editingId);
                if (!customer || !customer.fidelity) return;

                const amount = prompt('Quanti bollini vuoi rimuovere?', '1');
                if (!amount) return;

                const stamps = parseInt(amount);
                if (isNaN(stamps) || stamps < 1) {
                    this.showToast('‚ùå Numero non valido', 'error');
                    return;
                }

                if (customer.fidelity.stamps < stamps) {
                    this.showToast('‚ùå Non ci sono abbastanza bollini da rimuovere', 'error');
                    return;
                }

                customer.fidelity.stamps -= stamps;

                customer.fidelity.history = customer.fidelity.history || [];
                customer.fidelity.history.push({
                    date: new Date().toISOString(),
                    type: 'manual_remove',
                    stamps: -stamps,
                    note: 'Bollini rimossi manualmente'
                });

                this.saveData();

                // Aggiorna visualizzazione
                document.getElementById('customer-stamps-count').textContent = customer.fidelity.stamps;

                this.showToast(`‚úÖ Rimossi ${stamps} bollini da ${customer.firstName}!`);
            }

            sendStampsUpdateFromModal() {
                if (!this.editingId) return;
                const customer = this.db.customers.find(c => c.id === this.editingId);
                if (!customer) return;

                // Invia aggiornamento bollini via WhatsApp
                this.sendStampsUpdateWhatsApp(customer.id, 0);
                this.showToast(`üì± Messaggio WhatsApp inviato a ${customer.firstName}!`);
            }

            // ORDINI
            openOrderModal(id = null) {
                this.modalOpen = true;
                this.editingId = id;
                this.currentOrder = { items: [] };
                document.getElementById('order-number').value = '';
                document.getElementById('customer-search-order').value = '';
                document.getElementById('customer-firstname').value = '';
                document.getElementById('customer-lastname').value = '';
                document.getElementById('customer-phone').value = '';
                document.getElementById('customer-marketing-order').checked = false;
                document.getElementById('selected-customer-id').value = '';
                document.getElementById('customer-status').innerHTML = '';
                document.getElementById('order-created-date').value = new Date().toISOString().split('T')[0];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('order-delivery-date').value = tomorrow.toISOString().split('T')[0];
                document.getElementById('order-prep-status').value = 'da preparare';
                document.getElementById('order-payment-status').value = 'non pagato';
                document.getElementById('btn-delete-order').classList.add('hidden');
                document.getElementById('order-deposit').value = '';
                document.getElementById('deposit-info').classList.add('hidden');

                // Nascondi campo peso di default
                const weightField = document.getElementById('order-weight');
                const weightContainer = weightField.closest('.grid').children[0];
                weightContainer.style.display = 'none';

                // Non √® pi√π necessario popolare un select, ora utilizziamo l'autocomplete

                if (id) {
                    const order = this.db.orders.find(o => o.id === id);
                    if (order) {
                        document.getElementById('order-number').value = order.number;
                        document.getElementById('order-created-date').value = order.createdDate;
                        document.getElementById('order-delivery-date').value = order.deliveryDate;
                        document.getElementById('order-prep-status').value = order.prepStatus;
                        document.getElementById('order-payment-status').value = order.paymentStatus;
                        document.getElementById('order-deposit').value = order.deposit || '';
                        const customer = this.db.customers.find(c => c.id === order.customerId);
                        if (customer) {
                            document.getElementById('selected-customer-id').value = customer.id;
                            document.getElementById('customer-firstname').value = customer.firstName;
                            document.getElementById('customer-lastname').value = customer.lastName;
                            document.getElementById('customer-phone').value = customer.phone || '';
                            document.getElementById('customer-marketing-order').checked = customer.marketing || false;
                            this.showCustomerStatus('existing');
                        }
                        this.currentOrder.items = [...order.items];
                        document.getElementById('btn-delete-order').classList.remove('hidden');
                    }
                } else {
                    // Calcola il numero ordine automaticamente per nuovi ordini
                    this.updateOrderNumber();
                }
                this.renderOrderItems();
                this.updateOrderDeposit(); // Aggiorna info acconto
                this.openModal('order-modal');
            }

            updateOrderNumber() {
                // Non ricalcolare se stiamo modificando un ordine esistente
                if (this.editingId) {
                    return;
                }

                const deliveryDate = document.getElementById('order-delivery-date').value;

                if (!deliveryDate) {
                    document.getElementById('order-number').value = '';
                    return;
                }

                // Formatta la data nel formato gg/m/aa
                const date = new Date(deliveryDate);
                const day = date.getDate();
                const month = date.getMonth() + 1;
                const year = date.getFullYear().toString().slice(-2);
                const dateFormatted = `${day}/${month}/${year}`;

                // Conta quanti ordini esistono gi√† per quella data (escluso quello in modifica)
                const ordersOnDate = this.db.orders.filter(o => {
                    // Escludi l'ordine in modifica dal conteggio
                    if (this.editingId && o.id === this.editingId) return false;
                    return o.deliveryDate === deliveryDate;
                });

                // Genera il numero progressivo (01, 02, 03, ...)
                const progressive = String(ordersOnDate.length + 1).padStart(2, '0');

                // Componi il numero finale: progressivo-gg/m/aa
                const orderNumber = `${progressive}-${dateFormatted}`;

                document.getElementById('order-number').value = orderNumber;
            }

            searchCustomer(query) {
                const suggestions = document.getElementById('customer-suggestions');
                if (query.length < 2) { suggestions.classList.add('hidden'); return; }
                const matches = this.db.customers.filter(c => {
                    const fullName1 = `${c.firstName} ${c.lastName}`.toLowerCase();
                    const fullName2 = `${c.lastName} ${c.firstName}`.toLowerCase();
                    const firstName = c.firstName.toLowerCase();
                    const lastName = c.lastName.toLowerCase();
                    const phone = (c.phone || '').toLowerCase();
                    const q = query.toLowerCase();
                    return fullName1.includes(q) || fullName2.includes(q) || firstName.includes(q) || lastName.includes(q) || phone.includes(q);
                });
                if (matches.length === 0) { suggestions.classList.add('hidden'); return; }
                suggestions.innerHTML = matches.map(c => `<div class="autocomplete-suggestion" data-customer-id="${c.id}" onclick="app.selectCustomerFromSearch(this.dataset.customerId)"><div class="font-medium">${c.lastName} ${c.firstName}</div><div class="text-sm text-gray-600">${c.phone || 'Nessun telefono'}</div></div>`).join('');
                suggestions.classList.remove('hidden');
            }

            // Funzione dedicata per la ricerca clienti nel modal ordini
            searchCustomerInOrder(query) {
                const suggestions = document.getElementById('customer-suggestions-order');
                if (query.length < 2) { suggestions.classList.add('hidden'); return; }
                const matches = this.db.customers.filter(c => {
                    const fullName1 = `${c.firstName} ${c.lastName}`.toLowerCase();
                    const fullName2 = `${c.lastName} ${c.firstName}`.toLowerCase();
                    const firstName = c.firstName.toLowerCase();
                    const lastName = c.lastName.toLowerCase();
                    const phone = (c.phone || '').toLowerCase();
                    const q = query.toLowerCase();
                    return fullName1.includes(q) || fullName2.includes(q) || firstName.includes(q) || lastName.includes(q) || phone.includes(q);
                });
                if (matches.length === 0) { suggestions.classList.add('hidden'); return; }
                suggestions.innerHTML = matches.map(c => `<div class="autocomplete-suggestion" data-customer-id="${c.id}" onclick="app.selectCustomerForOrder(this.dataset.customerId)"><div class="font-medium">${c.lastName} ${c.firstName}</div><div class="text-sm text-gray-600">${c.phone || 'Nessun telefono'}</div></div>`).join('');
                suggestions.classList.remove('hidden');
            }

            selectCustomerFromSearch(customerId) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer) return;
                document.getElementById('selected-customer-id').value = customer.id;
                document.getElementById('customer-firstname').value = customer.firstName;
                document.getElementById('customer-lastname').value = customer.lastName;
                document.getElementById('customer-phone').value = customer.phone || '';
                document.getElementById('customer-marketing-order').checked = customer.marketing || false;
                document.getElementById('customer-search').value = `${customer.lastName} ${customer.firstName}`;
                document.getElementById('customer-suggestions').classList.add('hidden');
                this.showCustomerStatus('existing');
            }

            // Funzione dedicata per selezionare un cliente nel modal ordini
            selectCustomerForOrder(customerId) {
                const customer = this.db.customers.find(c => c.id === customerId);
                if (!customer) return;

                // Compila tutti i campi del modal ordini
                document.getElementById('selected-customer-id').value = customer.id;
                document.getElementById('customer-firstname').value = customer.firstName;
                document.getElementById('customer-lastname').value = customer.lastName;
                document.getElementById('customer-phone').value = customer.phone || '';
                document.getElementById('customer-marketing-order').checked = customer.marketing || false;

                // Aggiorna il campo di ricerca con il nome completo
                document.getElementById('customer-search-order').value = `${customer.lastName} ${customer.firstName}`;

                // Nascondi i suggerimenti
                document.getElementById('customer-suggestions-order').classList.add('hidden');

                // Mostra lo status di cliente esistente
                this.showCustomerStatus('existing');
            }

            checkCustomerDuplicate() {
                const firstName = document.getElementById('customer-firstname').value.trim();
                const lastName = document.getElementById('customer-lastname').value.trim();
                const phone = document.getElementById('customer-phone').value.trim();
                if (!firstName && !lastName && !phone) { document.getElementById('customer-status').innerHTML = ''; return; }
                const existing = this.db.customers.find(c => {
                    const sameName = c.firstName.toLowerCase() === firstName.toLowerCase() && c.lastName.toLowerCase() === lastName.toLowerCase();
                    const samePhone = phone && c.phone && c.phone === phone;
                    return sameName || samePhone;
                });
                if (existing) this.selectCustomerFromSearch(existing.id);
                else this.showCustomerStatus('new');
            }

            showCustomerStatus(status) {
                const statusDiv = document.getElementById('customer-status');
                if (status === 'existing') {
                    statusDiv.innerHTML = `<div class="flex items-center gap-2 text-green-700 bg-green-50 p-2 rounded"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span class="font-medium">Cliente gi√† presente</span></div>`;
                } else if (status === 'new') {
                    statusDiv.innerHTML = `<div class="flex items-center gap-2 text-blue-700 bg-blue-50 p-2 rounded"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg><span class="font-medium">Nuovo cliente - verr√† aggiunto</span></div>`;
                }
            }

            selectProduct() {
                const productInput = document.getElementById('order-product');
                const productId = productInput.dataset.productId || productInput.value;
                const weightField = document.getElementById('order-weight');
                const weightContainer = weightField.closest('.grid').children[0]; // primo div del grid (peso)

                if (!productId) {
                    document.getElementById('order-weight').value = '';
                    document.getElementById('order-qty').value = '';
                    document.getElementById('order-price').value = '';
                    document.getElementById('weight-info').style.display = 'none';
                    weightContainer.style.display = 'none'; // Nascondi campo peso
                    return;
                }

                const product = this.db.products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('order-qty').value = 1;
                    document.getElementById('order-price').value = product.price.toFixed(2);
                    document.getElementById('order-weight').value = '';
                    document.getElementById('weight-info').style.display = 'none';

                    // Se ha peso medio, nasconde il campo peso e calcola automaticamente
                    if (product.averageWeight && product.averageWeight > 0) {
                        weightContainer.style.display = 'none';
                        // Mostra info peso medio
                        const weightInfo = document.getElementById('weight-info');
                        const weightCalc = document.getElementById('weight-calculation');
                        weightCalc.textContent = `Peso medio: ${product.averageWeight}kg per unit√†. Prezzo calcolato automaticamente.`;
                        weightInfo.style.display = 'block';

                        // Calcola prezzo automatico per quantit√† 1
                        const autoPrice = 1 * product.averageWeight * product.price;
                        document.getElementById('order-price').value = autoPrice.toFixed(2);
                    } else {
                        // Vecchio sistema per prodotti senza peso medio
                        weightContainer.style.display = 'none';
                    }

                    // Salva il prezzo base del prodotto per calcoli successivi
                    document.getElementById('order-price').dataset.basePrice = product.price;
                }
            }

            calculatePriceFromWeight() {
                const weight = parseFloat(document.getElementById('order-weight').value);
                const priceInput = document.getElementById('order-price');
                const basePrice = parseFloat(priceInput.dataset.basePrice || priceInput.value);
                const weightInfo = document.getElementById('weight-info');
                const weightCalc = document.getElementById('weight-calculation');

                if (!weight || weight <= 0 || !basePrice) {
                    weightInfo.style.display = 'none';
                    if (basePrice) {
                        priceInput.value = basePrice.toFixed(2);
                    }
                    return;
                }

                // Calcola prezzo totale: peso √ó prezzo al kg
                const totalPrice = weight * basePrice;
                priceInput.value = totalPrice.toFixed(2);

                // Mostra info calcolo
                weightCalc.textContent = `${weight} kg √ó ${this.formatPrice(basePrice)} = ${this.formatPrice(totalPrice)}`;
                weightInfo.style.display = 'block';
            }

            calculateAutomaticPrice() {
                const productInput = document.getElementById('order-product');
                const productId = productInput.dataset.productId;
                const qty = parseFloat(document.getElementById('order-qty').value) || 0;

                if (!productId || qty <= 0) return;

                const product = this.db.products.find(p => p.id === productId);
                if (!product) return;

                // Calcolo automatico solo se ha peso medio
                if (product.averageWeight && product.averageWeight > 0) {
                    const totalWeight = qty * product.averageWeight;
                    const totalPrice = totalWeight * product.price;

                    document.getElementById('order-price').value = totalPrice.toFixed(2);

                    // Aggiorna info peso
                    const weightInfo = document.getElementById('weight-info');
                    const weightCalc = document.getElementById('weight-calculation');
                    weightCalc.textContent = `${qty} √ó ${product.averageWeight}kg √ó ${this.formatPrice(product.price)}/kg = ${this.formatPrice(totalPrice)}`;
                    weightInfo.style.display = 'block';
                } else if (product.unit === 'kg') {
                    // ‚úÖ Prodotti a peso (Acciughe) - calcola: qty(peso) √ó prezzo/kg
                    const totalPrice = qty * product.price;
                    document.getElementById('order-price').value = totalPrice.toFixed(2);
                }
                // ‚úÖ Per prodotti a pezzo: NON calcolare nulla, lascia il prezzo base
            }
            searchProductForOrder(query) {
                const suggestions = document.getElementById('product-suggestions');

                if (!query.trim()) {
                    suggestions.classList.add('hidden');
                    return;
                }

                // Filtra prodotti per nome
                const filteredProducts = this.db.products.filter(p =>
                    p.name.toLowerCase().includes(query.toLowerCase())
                );

                if (filteredProducts.length === 0) {
                    suggestions.innerHTML = '<div class="autocomplete-suggestion text-gray-500">Nessun prodotto trovato</div>';
                    suggestions.classList.remove('hidden');
                    return;
                }

                // Raggruppa per categoria
                const categories = {};
                filteredProducts.forEach(prod => {
                    const category = prod.category || 'Senza categoria';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(prod);
                });

                // Genera HTML raggruppato
                let html = '';
                Object.keys(categories).sort().forEach(categoryName => {
                    const products = categories[categoryName];
                    html += `<div class="py-1 px-2 bg-gray-100 text-xs font-semibold text-gray-700 border-b">${categoryName}</div>`;
                    products.forEach(prod => {
                        html += `<div class="autocomplete-suggestion" data-product-id="${prod.id}">${prod.name} - ${this.formatPrice(prod.price)}/${prod.unit}</div>`;
                    });
                });

                suggestions.innerHTML = html;
                suggestions.classList.remove('hidden');

                // Aggiungi eventi click
                suggestions.querySelectorAll('.autocomplete-suggestion[data-product-id]').forEach(item => {
                    item.onclick = () => this.selectProductForOrder(item.dataset.productId, item.textContent);
                });
            }

            showAllProductsForOrder() {
                const suggestions = document.getElementById('product-suggestions');

                if (this.db.products.length === 0) {
                    suggestions.innerHTML = '<div class="autocomplete-suggestion text-gray-500">Nessun prodotto disponibile</div>';
                    suggestions.classList.remove('hidden');
                    return;
                }

                // Raggruppa tutti i prodotti per categoria
                const categories = {};
                const sorted = [...this.db.products].sort((a, b) => a.name.localeCompare(b.name));

                sorted.forEach(prod => {
                    const category = prod.category || 'Senza categoria';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(prod);
                });

                // Genera HTML raggruppato
                let html = '';
                Object.keys(categories).sort().forEach(categoryName => {
                    const products = categories[categoryName];
                    html += `<div class="py-1 px-2 bg-gray-100 text-xs font-semibold text-gray-700 border-b">${categoryName} (${products.length})</div>`;
                    products.forEach(prod => {
                        html += `<div class="autocomplete-suggestion" data-product-id="${prod.id}">${prod.name} - ${this.formatPrice(prod.price)}/${prod.unit}</div>`;
                    });
                });

                suggestions.innerHTML = html;
                suggestions.classList.remove('hidden');

                // Aggiungi eventi click
                suggestions.querySelectorAll('.autocomplete-suggestion[data-product-id]').forEach(item => {
                    item.onclick = () => this.selectProductForOrder(item.dataset.productId, item.textContent);
                });
            }

            selectProductForOrder(productId, productText) {
                const input = document.getElementById('order-product');
                const suggestions = document.getElementById('product-suggestions');

                input.value = productText;
                input.dataset.productId = productId;
                suggestions.classList.add('hidden');

                // Simula il comportamento della vecchia selectProduct()
                this.selectProduct();
            }

            addProductToOrder() {
                const productInput = document.getElementById('order-product');
                const productId = productInput.dataset.productId || productInput.value;
                const qty = parseFloat(document.getElementById('order-qty').value);
                const price = parseFloat(document.getElementById('order-price').value);
                const weight = parseFloat(document.getElementById('order-weight').value) || null;

                if (!productId || isNaN(qty) || qty <= 0 || isNaN(price) || price <= 0) {
                    this.showToast('‚ùå Dati prodotto non validi', 'error');
                    return;
                }

                const product = this.db.products.find(p => p.id === productId);
                if (!product) return;


                // Sistema peso medio automatico
                let finalPrice = price; // price viene dal campo ed √® gi√† calcolato
                let calculatedWeight = null;
                let finalUnit = product.unit;

                if (product.averageWeight && product.averageWeight > 0) {
                    // Prodotti con peso medio automatico (es. Focaccia Barese)
                    calculatedWeight = qty * product.averageWeight;
                    finalPrice = calculatedWeight * product.price;
                    finalUnit = 'pezzo';
                    console.log(`Peso automatico: ${qty} pezzi √ó ${product.averageWeight}kg = ${calculatedWeight}kg, Prezzo: ${calculatedWeight}kg √ó ‚Ç¨${product.price}/kg = ‚Ç¨${finalPrice.toFixed(2)}`);
                } else if (product.unit === 'kg') {
                    // Prodotti a peso (es. Acciughe) - qty √® il peso, price √® gi√† totale
                    finalPrice = price;
                    calculatedWeight = qty;
                } else {
                    // Prodotti normali a pezzo (es. Panino)
                    finalPrice = qty * price;
                }

                // Salva il prodotto
                const item = {
                    productId: product.id,
                    productName: product.name,
                    qty,
                    unit: finalUnit, // Usa l'unit√† corretta (pezzo per peso medio, originale altrimenti)
                    price: finalPrice
                };

                // Aggiungi peso calcolato automaticamente o inserito manualmente
                if (calculatedWeight) {
                    item.weight = calculatedWeight;
                    item.calculatedFromAverage = true;
                } else if (weight && weight > 0) {
                    item.weight = weight;
                    item.calculatedFromAverage = false;
                }

                this.currentOrder.items.push(item);

                // Reset campi
                document.getElementById('order-product').value = '';
                document.getElementById('order-qty').value = '';
                document.getElementById('order-price').value = '';
                document.getElementById('order-weight').value = '';
                document.getElementById('weight-info').style.display = 'none';

                this.renderOrderItems();
                this.showToast('‚úÖ Prodotto aggiunto');
            }

            removeOrderItem(index) {
                this.currentOrder.items.splice(index, 1);
                this.renderOrderItems();
            }

            renderOrderItems() {
                const container = document.getElementById('order-items');
                if (this.currentOrder.items.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Nessun prodotto aggiunto</p>';
                    document.getElementById('order-total').textContent = '0,00 ‚Ç¨';
                    return;
                }
                let total = 0;
                container.innerHTML = this.currentOrder.items.map((item, index) => {
                    // IMPORTANTE: item.price √® SEMPRE il totale gi√† calcolato
                    const itemTotal = item.price;
                    total += itemTotal;

                    // Costruisci la descrizione
                    let description;
                    if (item.calculatedFromAverage && item.weight) {
                        // Per prodotti con peso medio, mostra: "2 pezzi (‚öñÔ∏è 0.6 kg) = ‚Ç¨X.XX"
                        description = `${item.qty} ${item.unit} (‚öñÔ∏è ${item.weight.toFixed(3)} kg) = ${this.formatPrice(itemTotal)}`;
                    } else if (item.weight && item.weight > 0) {
                        description = `‚öñÔ∏è ${item.weight} kg = ${this.formatPrice(itemTotal)}`;
                    } else {
                        // Per prodotti normali senza peso
                        if (item.unit === 'kg') {
                            // Prodotto a peso - price √® gi√† totale
                            description = `${item.qty} ${item.unit} = ${this.formatPrice(itemTotal)}`;
                        } else {
                            // Prodotto a pezzo - calcola prezzo unitario
                            const pricePerUnit = item.price / item.qty;
                            description = `${item.qty} ${item.unit} √ó ${this.formatPrice(pricePerUnit)} = ${this.formatPrice(itemTotal)}`;
                        }
                    }

                    return `<div class="flex justify-between items-center bg-white p-2 rounded">
                        <div class="flex-1">
                            <div class="font-medium">${item.productName}</div>
                            <div class="text-sm text-gray-600">${description}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold">${this.formatPrice(itemTotal)}</span>
                            <button onclick="app.removeOrderItem(${index})" class="text-red-600 hover:text-red-800">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('order-total').textContent = this.formatPrice(total);
                this.updateOrderDeposit(); // Aggiorna info acconto quando cambiano i prodotti
            }

            updateOrderDeposit() {
                // CORREZIONE: item.price √® gi√† il totale, non serve moltiplicare per qty
                const total = this.currentOrder.items.reduce((sum, item) => sum + item.price, 0);
                const deposit = parseFloat(document.getElementById('order-deposit').value) || 0;
                const depositInfo = document.getElementById('deposit-info');

                if (deposit > 0) {
                    const remaining = total - deposit;
                    depositInfo.innerHTML = `
                        Totale: ${this.formatPrice(total)}<br>
                        Acconto: ${this.formatPrice(deposit)}<br>
                        <strong>Resto da pagare: ${this.formatPrice(remaining)}</strong>
                    `;
                    depositInfo.classList.remove('hidden');

                    if (deposit > total) {
                        depositInfo.innerHTML += '<br><span class="text-red-600">‚ö†Ô∏è L\'acconto supera il totale!</span>';
                    }
                } else {
                    depositInfo.classList.add('hidden');
                }
            }

            async saveOrder() {
                const number = document.getElementById('order-number').value.trim();
                const firstName = document.getElementById('customer-firstname').value.trim();
                const lastName = document.getElementById('customer-lastname').value.trim();
                const phone = document.getElementById('customer-phone').value.trim();
                const deliveryDate = document.getElementById('order-delivery-date').value;

                // Validazioni
                if (!firstName || !lastName) { this.showToast('‚ùå Dati cliente obbligatori', 'error'); return; }
                if (this.currentOrder.items.length === 0) { this.showToast('‚ùå Aggiungi almeno un prodotto', 'error'); return; }
                if (!deliveryDate) { this.showToast('‚ùå Data consegna obbligatoria', 'error'); return; }

                // Assicurati che il numero sia stato generato
                if (!number) {
                    this.updateOrderNumber();
                    const generatedNumber = document.getElementById('order-number').value.trim();
                    if (!generatedNumber) {
                        this.showToast('‚ùå Errore generazione numero ordine', 'error');
                        return;
                    }
                }

                // Validazione data consegna
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const delivery = new Date(deliveryDate);
                delivery.setHours(0, 0, 0, 0);

                if (delivery < today && !this.editingId) {
                    if (!confirm('‚ö†Ô∏è La data di consegna √® nel passato. Confermi?')) {
                        return;
                    }
                }

                let customerId = document.getElementById('selected-customer-id').value;
                const marketing = document.getElementById('customer-marketing-order').checked;

                if (!customerId) {
                    // Nuovo cliente
                    const newCustomer = {
                        id: this.generateId(),
                        firstName,
                        lastName,
                        phone,
                        email: '',
                        marketing: marketing,
                        fidelity: { stamps: 0, totalSpent: 0, rewards: 0, history: [] }
                    };
                    this.db.customers.push(newCustomer);
                    customerId = newCustomer.id;
                } else {
                    // Cliente esistente - aggiorna consenso marketing
                    const existingCustomer = this.db.customers.find(c => c.id === customerId);
                    if (existingCustomer) {
                        existingCustomer.marketing = marketing;
                    }
                }

                const deposit = parseFloat(document.getElementById('order-deposit').value) || 0;

                // Rileggi il numero ordine (potrebbe essere stato generato automaticamente)
                const finalOrderNumber = document.getElementById('order-number').value.trim();

                const order = {
                    id: this.editingId || this.generateId(),
                    number: finalOrderNumber,
                    customerId,
                    createdDate: document.getElementById('order-created-date').value,
                    deliveryDate,
                    prepStatus: document.getElementById('order-prep-status').value,
                    paymentStatus: document.getElementById('order-payment-status').value,
                    items: [...this.currentOrder.items],
                    deposit: deposit > 0 ? deposit : 0
                };

                const isNewOrder = !this.editingId;
                const orderTotal = order.items.reduce((sum, item) => sum + item.price, 0);

                // ========== ACQUISISCI LOCK PER EVITARE DUPLICATI ==========
                if (!this.editingId) {
                    // Solo per ordini nuovi
                    console.log('üîí Acquisizione lock...');
                    const canProceed = await this.waitForLock();

                    if (!canProceed) {
                        this.showToast('‚ùå Timeout: altro dispositivo occupato. Riprova!', 'error');
                        return;
                    }

                    await this.acquireLock();

                    // RIGENERA il numero ordine DOPO aver acquisito il lock
                    console.log('üîÑ Rigenero numero ordine con dati aggiornati...');
                    await this.syncFromDropboxSilent(); // Scarica ultimi ordini
                    this.updateOrderNumber(); // Rigenera numero

                    // Aggiorna il numero nell'oggetto order
                    order.number = document.getElementById('order-number').value.trim();
                    console.log('üìã Nuovo numero ordine:', order.number);
                }

                try {
                    if (this.editingId) {
                        const idx = this.db.orders.findIndex(o => o.id === this.editingId);
                        if (idx > -1) this.db.orders[idx] = order;
                    } else {
                        this.db.orders.push(order);
                    }

                    this.saveData();
                    await this.syncToDropbox(true);

                    // Aggiungi bollini solo per ordini nuovi con pagamento completato
                    if (isNewOrder && order.paymentStatus === 'pagato') {
                        this.addStampsFromOrder(customerId, orderTotal);
                    }

                    this.render();
                    this.closeModal('order-modal');
                    this.showToast('‚úÖ Ordine salvato');

                    // Genera messaggio WhatsApp sempre (sia per ordini nuovi che modificati)
                    const customer = this.db.customers.find(c => c.id === customerId);
                    this.generateWhatsAppMessage(order, customer);

                } finally {
                    // Rilascia sempre il lock
                    if (!this.editingId) {
                        await this.releaseLock();
                    }
                }
            }
            generateWhatsAppMessage(order, customer) {
                if (!customer) {
                    console.error('Cliente non trovato per generare messaggio WhatsApp');
                    return;
                }

                // Raggruppa prodotti per categoria
                const productsByCategory = {};
                order.items.forEach(item => {
                    const product = this.db.products.find(p => p.name === item.productName);
                    const category = product ? (product.category || 'Altro') : 'Altro';

                    if (!productsByCategory[category]) {
                        productsByCategory[category] = [];
                    }

                    productsByCategory[category].push({
                        name: item.productName,
                        quantity: item.qty,
                        unit: item.unit || 'pz'
                    });
                });

                // Costruisci il messaggio (senza template literals per evitare problemi)
                let message = '';
                message += 'üçù *PASTIFICIO GRAMSCI*\n';
                message += '\nüî¢ *ORDINE #' + order.number + '*\n';
                message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';

                // Data di consegna
                const deliveryDate = new Date(order.deliveryDate + 'T00:00:00');
                const formattedDate = deliveryDate.toLocaleDateString('it-IT', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                message += 'üìÖ *Consegna:* ' + formattedDate + '\n\n';

                // Prodotti per categoria
                message += 'üìã *RIEPILOGO ORDINE:*\n';
                Object.keys(productsByCategory).sort().forEach(category => {
                    message += '\n*' + category.toUpperCase() + ':*\n';
                    productsByCategory[category].forEach(item => {
                        message += '‚Ä¢ ' + item.name + ' - ' + item.quantity + ' ' + item.unit + '\n';
                    });
                });

                // Acconto se presente (senza mostrare il totale)
                if (order.deposit && order.deposit > 0) {
                    message += '\nüíµ *Acconto lasciato:* ‚Ç¨' + order.deposit.toFixed(2) + '\n';
                }

                message += '\n‚úÖ Ordine confermato!';

                // Prepara il numero di telefono se presente
                let phoneNumber = '';
                if (customer.phone) {
                    phoneNumber = customer.phone.replace(/[^0-9]/g, '');
                    if (phoneNumber && !phoneNumber.startsWith('39')) {
                        phoneNumber = '39' + phoneNumber;
                    }
                }

                // Crea l'URL di WhatsApp
                let whatsappUrl;
                if (phoneNumber) {
                    whatsappUrl = 'https://wa.me/' + phoneNumber;
                } else {
                    whatsappUrl = 'https://wa.me/';
                }

                // Mostra il messaggio di anteprima
                this.showWhatsAppPreview(message, whatsappUrl, customer);
            }

            showWhatsAppPreview(message, whatsappUrl, customer) {
                console.log('>>> showWhatsAppPreview CHIAMATA');

                // Codifica il messaggio - usa encodeURIComponent per gestire caratteri speciali
                const encodedMessage = encodeURIComponent(message);
                const fullWhatsappUrl = whatsappUrl + '?text=' + encodedMessage;

                console.log('Lunghezza messaggio:', message.length);
                console.log('Lunghezza URL completo:', fullWhatsappUrl.length);

                // HTML per anteprima (escape HTML)
                let htmlMessage = message
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');

                // Rimuovi modal esistenti
                const existingModal = document.getElementById('whatsapp-preview-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Crea modal
                const modal = document.createElement('div');
                modal.id = 'whatsapp-preview-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 99999; padding: 20px;';

                const content = document.createElement('div');
                content.style.cssText = 'background: white; border-radius: 10px; padding: 30px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;';

                content.innerHTML =
                    '<h3 style="font-size: 20px; font-weight: bold; margin-bottom: 20px; text-align: center;">üì± Messaggio WhatsApp</h3>' +
                    '<div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 15px; margin-bottom: 20px;">' +
                    '<div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">üìû ' + this.sanitizeHTML(customer.firstName + ' ' + customer.lastName) + '</div>' +
                    '<div style="font-size: 12px; color: #999; margin-bottom: 15px;">' + this.sanitizeHTML(customer.phone || 'Numero non disponibile') + '</div>' +
                    '<div style="background: white; border: 1px solid #ddd; border-radius: 6px; padding: 12px; font-size: 13px; max-height: 300px; overflow-y: auto; line-height: 1.6; white-space: pre-wrap; font-family: monospace;">' + htmlMessage + '</div>' +
                    '</div>' +
                    '<div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; margin-bottom: 20px; border-radius: 6px;">' +
                    '<p style="font-size: 13px; color: #1e40af; margin: 0;">' +
                    '<strong>üìã Istruzioni:</strong><br>' +
                    '1. Verifica il messaggio nell\'anteprima sopra<br>' +
                    '2. Clicca "Apri WhatsApp"<br>' +
                    '3. Il messaggio sar√† gi√† pronto<br>' +
                    '4. Controlla e premi Invia manualmente' +
                    '</p>' +
                    '</div>' +
                    '<div style="display: flex; gap: 10px;">' +
                    '<button id="btn-wa-close" style="flex: 1; background: #e5e7eb; color: #374151; padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">‚ùå Annulla</button>' +
                    '<button id="btn-wa-open" style="flex: 2; background: #16a34a; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">üì± Apri WhatsApp</button>' +
                    '</div>';

                modal.appendChild(content);
                document.body.appendChild(modal);

                console.log('>>> Modal aggiunto al DOM');

                // Event listeners
                const btnClose = document.getElementById('btn-wa-close');
                const btnOpen = document.getElementById('btn-wa-open');

                btnClose.addEventListener('click', function () {
                    console.log('>>> Bottone CHIUDI cliccato');
                    modal.remove();
                });

                btnOpen.addEventListener('click', function () {
                    console.log('>>> Bottone APRI WHATSAPP cliccato MANUALMENTE');
                    console.log('>>> Apertura URL:', fullWhatsappUrl);

                    // Apri WhatsApp
                    window.open(fullWhatsappUrl, '_blank');

                    // Chiudi modal dopo l'apertura
                    setTimeout(() => {
                        modal.remove();
                    }, 500);
                });

                // Chiudi modal cliccando fuori (opzionale)
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

                console.log('>>> Modal pronto, attesa click manuale');
                this.showToast('üì± Verifica il messaggio e clicca "Apri WhatsApp"');
            }
            deleteOrder() {
                const order = this.db.orders.find(o => o.id === this.editingId);
                this.pendingDelete = {
                    type: 'order',
                    id: this.editingId,
                    name: 'Ordine #' + (order ? order.number : '')
                };
                const confirmMsg = 'Sei sicuro di voler eliminare ' + this.pendingDelete.name + '? Questa azione non pu√≤ essere annullata.';
                document.getElementById('confirm-message').textContent = confirmMsg;

                this.closeModal('order-modal');

                setTimeout(() => {
                    this.openModal('confirm-modal');
                }, 100);
            }

            updateStats() {
                document.getElementById('stats-orders').textContent = this.db.orders.filter(o => !o.deleted).length;
                document.getElementById('stats-products').textContent = this.db.products.filter(p => !p.deleted).length;
                document.getElementById('stats-customers').textContent = this.db.customers.filter(c => !c.deleted).length;
            }

            // CONFERMA ELIMINAZIONE
            confirmDelete() {
                if (!this.pendingDelete) return;

                const { type, id } = this.pendingDelete;
                const now = new Date().toISOString();

                switch (type) {
                    case 'order':
                        const order = this.db.orders.find(o => o.id === id);
                        if (order) {
                            order.deleted = true;
                            order.deletedAt = now;
                        }
                        this.showToast('‚úÖ Ordine eliminato');
                        break;
                    case 'product':
                        const product = this.db.products.find(p => p.id === id);
                        if (product) {
                            product.deleted = true;
                            product.deletedAt = now;
                        }
                        this.showToast('‚úÖ Prodotto eliminato');
                        break;
                    case 'customer':
                        const customer = this.db.customers.find(c => c.id === id);
                        if (customer) {
                            customer.deleted = true;
                            customer.deletedAt = now;
                        }
                        this.showToast('‚úÖ Cliente eliminato');
                        break;
                }

                this.saveData();
                this.render();
                this.renderDashboard();
                this.closeModal('confirm-modal');
                this.pendingDelete = null;
            }

            cancelDelete() {
                this.pendingDelete = null;
                this.closeModal('confirm-modal');
            }

            // FILTRI ORDINI
            filterOrders() {
                if (this.searchDebounceTimer) {
                    clearTimeout(this.searchDebounceTimer);
                }

                this.searchDebounceTimer = setTimeout(() => {
                    const searchTerm = document.getElementById('order-search').value.toLowerCase().trim();
                    const prepFilter = document.getElementById('prep-filter').value;
                    const paymentFilter = document.getElementById('payment-filter').value;

                    this.filteredOrders = this.db.orders.filter(order => {
                        // Filtro testo
                        if (searchTerm) {
                            const customer = this.db.customers.find(c => c.id === order.customerId);
                            const customerName = customer ? `${customer.firstName} ${customer.lastName}`.toLowerCase() : '';
                            const orderNumber = order.number.toString();

                            if (!orderNumber.includes(searchTerm) && !customerName.includes(searchTerm)) {
                                return false;
                            }
                        }

                        // Filtro stato preparazione
                        if (prepFilter && order.prepStatus !== prepFilter) {
                            return false;
                        }

                        // Filtro pagamento
                        if (paymentFilter && order.paymentStatus !== paymentFilter) {
                            return false;
                        }

                        return true;
                    });

                    this.renderOrders();
                }, 300); // Debounce di 300ms
            }

            // DASHBOARD E STATISTICHE
            renderDashboard() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const firstDayMonth = new Date(today.getFullYear(), today.getMonth(), 1);

                // Ordini e fatturato oggi (FILTRO AGGIUNTO)
                const ordersToday = this.db.orders.filter(o => {
                    if (o.deleted) return false; // ‚Üê AGGIUNTO
                    const orderDate = new Date(o.deliveryDate);
                    orderDate.setHours(0, 0, 0, 0);
                    return orderDate.getTime() === today.getTime();
                });

                const revenueToday = ordersToday.reduce((sum, order) => {
                    return sum + order.items.reduce((itemSum, item) => itemSum + item.price, 0);
                }, 0);

                // Ordini e fatturato mese (FILTRO AGGIUNTO)
                const ordersMonth = this.db.orders.filter(o => {
                    if (o.deleted) return false; // ‚Üê AGGIUNTO
                    const orderDate = new Date(o.deliveryDate);
                    return orderDate >= firstDayMonth;
                });

                const revenueMonth = ordersMonth.reduce((sum, order) => {
                    return sum + order.items.reduce((itemSum, item) => itemSum + item.price, 0);
                }, 0);

                // Aggiorna statistiche
                const statOrdersToday = document.getElementById('stat-orders-today');
                const statRevenueToday = document.getElementById('stat-revenue-today');
                const statOrdersMonth = document.getElementById('stat-orders-month');
                const statRevenueMonth = document.getElementById('stat-revenue-month');

                if (statOrdersToday) statOrdersToday.textContent = ordersToday.length;
                if (statRevenueToday) statRevenueToday.textContent = this.formatPrice(revenueToday);
                if (statOrdersMonth) statOrdersMonth.textContent = ordersMonth.length;
                if (statRevenueMonth) statRevenueMonth.textContent = this.formatPrice(revenueMonth);

                // Grafici stati
                this.renderStatusCharts();

                // Top clienti
                this.renderTopCustomers();
            }

            renderStatusCharts() {
                const prepStatusChart = document.getElementById('prep-status-chart');
                const paymentStatusChart = document.getElementById('payment-status-chart');

                if (!prepStatusChart || !paymentStatusChart) return;

                // Conteggio stati preparazione
                const prepCounts = {
                    'da preparare': 0,
                    'completato': 0,
                    'consegnato': 0
                };

                const paymentCounts = {
                    'non pagato': 0,
                    'pagato': 0
                };

                // FILTRO AGGIUNTO: ignora ordini eliminati
                const visibleOrders = this.db.orders.filter(o => !o.deleted);

                visibleOrders.forEach(order => {
                    prepCounts[order.prepStatus]++;
                    paymentCounts[order.paymentStatus]++;
                });

                // CORREZIONE: usa visibleOrders invece di this.db.orders
                const total = visibleOrders.length || 1;

                // Render preparazione
                prepStatusChart.innerHTML = Object.entries(prepCounts).map(([status, count]) => {
                    const percentage = Math.round((count / total) * 100);
                    const colors = {
                        'da preparare': 'bg-red-500',
                        'completato': 'bg-green-500',
                        'consegnato': 'bg-blue-500'
                    };
                    return `
            <div class="flex items-center gap-2 mb-2">
                <div class="flex-1">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium capitalize">${status}</span>
                        <span class="text-gray-600">${count} (${percentage}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${colors[status]} h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
                }).join('');

                // Render pagamenti
                paymentStatusChart.innerHTML = Object.entries(paymentCounts).map(([status, count]) => {
                    const percentage = Math.round((count / total) * 100);
                    const colors = {
                        'non pagato': 'bg-red-500',
                        'pagato': 'bg-green-500'
                    };
                    return `
            <div class="flex items-center gap-2 mb-2">
                <div class="flex-1">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium capitalize">${status}</span>
                        <span class="text-gray-600">${count} (${percentage}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${colors[status]} h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
                }).join('');
            }

            renderTopCustomers() {
                const container = document.getElementById('top-customers');
                if (!container) return;

                // Calcola totale speso per cliente
                const customerTotals = {};

                // FILTRO AGGIUNTO: ignora ordini eliminati
                this.db.orders.filter(o => !o.deleted).forEach(order => {
                    const total = order.items.reduce((sum, item) => sum + item.price, 0);
                    if (!customerTotals[order.customerId]) {
                        customerTotals[order.customerId] = { total: 0, orders: 0 };
                    }
                    customerTotals[order.customerId].total += total;
                    customerTotals[order.customerId].orders++;
                });

                // Ordina e prendi top 5
                const topCustomers = Object.entries(customerTotals)
                    .sort((a, b) => b[1].total - a[1].total)
                    .slice(0, 5)
                    .map(([customerId, data]) => {
                        const customer = this.db.customers.find(c => c.id === customerId);
                        return { customer, ...data };
                    })
                    .filter(item => item.customer);

                if (topCustomers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Nessun ordine ancora</p>';
                    return;
                }

                container.innerHTML = topCustomers.map((item, index) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                    return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">${medals[index]}</span>
                    <div>
                        <div class="font-semibold">${item.customer.lastName} ${item.customer.firstName}</div>
                        <div class="text-sm text-gray-600">${item.orders} ordini</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-green-600">${this.formatPrice(item.total)}</div>
                </div>
            </div>
        `;
                }).join('');
            }
            // EXPORT CSV
            exportOrders() {
                if (this.db.orders.filter(o => !o.deleted).length === 0) {
                    this.showToast('‚ö†Ô∏è Nessun ordine da esportare', 'error');
                    return;
                }

                const headers = ['Numero', 'Cliente', 'Data Consegna', 'Stato Prep', 'Stato Pagamento', 'Totale', 'Acconto', 'Resto'];
                const rows = this.db.orders.filter(o => !o.deleted).map(order => {
                    const customer = this.db.customers.find(c => c.id === order.customerId);
                    const customerName = customer ? `${customer.lastName} ${customer.firstName}` : 'Sconosciuto';
                    const total = order.items.reduce((sum, item) => sum + item.price, 0);
                    const deposit = order.deposit || 0;
                    const remaining = total - deposit;

                    return [
                        order.number,
                        customerName,
                        this.formatDate(order.deliveryDate),
                        order.prepStatus,
                        order.paymentStatus,
                        `‚Ç¨ ${total.toFixed(2).replace('.', ',')}`, // Formato valuta con simbolo ‚Ç¨
                        deposit > 0 ? `‚Ç¨ ${deposit.toFixed(2).replace('.', ',')}` : '-', // Mostra "-" se nessun acconto
                        `‚Ç¨ ${remaining.toFixed(2).replace('.', ',')}` // Formato valuta
                    ];
                });

                // Usa punto e virgola come separatore per Excel italiano
                const csvContent = [
                    headers.join(';'),
                    ...rows.map(row => row.map(cell => {
                        // Escape delle virgolette e aggiungi virgolette se contiene punto e virgola o spazi
                        const cellStr = String(cell);
                        const escaped = cellStr.replace(/"/g, '""');
                        // Racchiudi tra virgolette se contiene punto e virgola, virgola o inizia con ‚Ç¨
                        return (escaped.includes(';') || escaped.includes(',') || escaped.startsWith('‚Ç¨'))
                            ? `"${escaped}"`
                            : escaped;
                    }).join(';'))
                ].join('\n');

                // BOM UTF-8 per caratteri accentati corretti in Excel
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                const date = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `ordini_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                this.showToast('‚úÖ Ordini esportati in CSV (formato Excel IT)');
            }

            // BACKUP LOCALE
            backupData() {
                const backup = {
                    version: '1.0',
                    date: new Date().toISOString(),
                    data: this.db,
                    fidelityConfig: this.fidelityConfig
                };

                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                const date = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `backup_gestionale_${date}.json`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                this.showToast('‚úÖ Backup scaricato');
            }

            updateLastSyncInfo() {
                const lastSync = localStorage.getItem('lastSync');
                const lastDropboxSync = localStorage.getItem('lastDropboxSync');
                const infoDiv = document.getElementById('last-sync-info');

                let html = '';

                if (lastSync) {
                    const date = new Date(lastSync);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    let timeText;
                    if (diffMins < 1) timeText = 'adesso';
                    else if (diffMins < 60) timeText = `${diffMins} min fa`;
                    else if (diffMins < 1440) { const hours = Math.floor(diffMins / 60); timeText = `${hours}h fa`; }
                    else { const days = Math.floor(diffMins / 1440); timeText = `${days}g fa`; }
                    html += `üíæ Locale: ${timeText}`;
                }

                if (lastDropboxSync) {
                    const date = new Date(lastDropboxSync);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    let timeText;
                    if (diffMins < 1) timeText = 'adesso';
                    else if (diffMins < 60) timeText = `${diffMins} min fa`;
                    else if (diffMins < 1440) { const hours = Math.floor(diffMins / 60); timeText = `${hours}h fa`; }
                    else { const days = Math.floor(diffMins / 1440); timeText = `${days}g fa`; }
                    html += ` | ‚òÅÔ∏è Dropbox: ${timeText}`;
                }

                infoDiv.innerHTML = html || '<span class="text-gray-500">Nessun salvataggio</span>';
            }

            render() {
                this.renderOrders();
                this.renderProducts();
                this.renderCustomers();
                this.renderCategories();
                this.renderFidelityList();
            }

            renderOrders() {
                const container = document.getElementById('orders-list');

                // Usa ordini filtrati se disponibili, altrimenti tutti
                const ordersToShow = this.filteredOrders !== null ? this.filteredOrders : this.db.orders.filter(o => !o.deleted);

                if (ordersToShow.length === 0) {
                    const message = this.filteredOrders !== null
                        ? '<p class="text-gray-500 text-center p-4">‚ö†Ô∏è Nessun ordine corrisponde ai filtri</p>'
                        : '<p class="text-gray-500 text-center p-4">Nessun ordine</p>';
                    container.innerHTML = message;
                    return;
                }

                const statusColors = {
                    'da preparare': 'bg-red-100 text-red-800',
                    'completato': 'bg-green-100 text-green-800',
                    'consegnato': 'bg-blue-100 text-blue-800',
                    'non pagato': 'bg-red-100 text-red-800',
                    'pagato': 'bg-green-100 text-green-800'
                };
                const sorted = [...ordersToShow].sort((a, b) => new Date(b.deliveryDate) - new Date(a.deliveryDate));
                container.innerHTML = sorted.map(order => {
                    const customer = this.db.customers.find(c => c.id === order.customerId);
                    const customerName = customer ? `${customer.lastName} ${customer.firstName}` : 'Sconosciuto';
                    const total = order.items.reduce((sum, item) => sum + (item.qty * item.price), 0);

                    // Calcola stato preparazione prodotti
                    const totalItems = order.items.length;
                    const preparedItems = order.preparedItems ? order.preparedItems.length : 0;
                    const allPrepared = preparedItems === totalItems && totalItems > 0;
                    const preparationBadge = order.prepStatus === 'da preparare' ?
                        `<span class="px-2 py-1 rounded-full text-xs font-medium ${allPrepared ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                            üì¶ ${preparedItems}/${totalItems}
                        </span>` : '';

                    // Badge acconto
                    const depositBadge = order.deposit && order.deposit > 0 ?
                        `<span class="px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            üí∞ Acconto: ${this.formatPrice(order.deposit)}
                        </span>` : '';

                    return `<div onclick="app.openOrderModal('${order.id}')" class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition slide-in">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center">
                                    <span class="font-bold text-blue-900">${order.number}</span>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg">${customerName}</h3>
                                    <p class="text-sm text-gray-600">Consegna: ${this.formatDate(order.deliveryDate)}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-xl">${this.formatPrice(total)}</p>
                                <div class="flex gap-2 mt-1 flex-wrap justify-end">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[order.prepStatus]}">${order.prepStatus}</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[order.paymentStatus]}">${order.paymentStatus}</span>
                                    ${preparationBadge}
                                    ${depositBadge}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }

            renderProducts() {
                const container = document.getElementById('products-list');
                if (this.db.products.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center p-4">Nessun prodotto</p>';
                    return;
                }

                // Raggruppa prodotti per categoria
                const categories = {};
                const sorted = [...this.db.products].sort((a, b) => a.name.localeCompare(b.name));

                sorted.forEach(prod => {
                    const category = prod.category || 'Senza categoria';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(prod);
                });

                // Ordina le categorie alfabeticamente
                const sortedCategories = Object.keys(categories).sort();

                let html = '';
                sortedCategories.forEach(categoryName => {
                    const products = categories[categoryName];
                    html += `
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3 pb-2 border-b-2 border-green-200">
                                üì¶ ${categoryName} (${products.length})
                            </h3>
                            <div class="grid md:grid-cols-2 gap-3">
                                ${products.map(prod => `
                                    <div onclick="app.openProductModal('${prod.id}')" class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition">
                                        <div class="flex items-center gap-4">
                                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                                </svg>
                                            </div>
                                            <div class="flex-1">
                                                <h4 class="font-bold text-md">${prod.name}</h4>
                                                <p class="text-sm font-semibold text-green-700">${this.formatPrice(prod.price)} / ${prod.unit}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            renderCustomers() {
                const container = document.getElementById('customers-list');
                if (this.db.customers.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center p-4">Nessun cliente</p>'; return; }
                const sorted = [...this.db.customers].sort((a, b) => a.lastName.localeCompare(b.lastName));
                container.innerHTML = sorted.map(cust => {
                    const stamps = cust.fidelity?.stamps || 0;
                    const rewards = cust.fidelity?.rewards || 0;
                    return `<div onclick="app.openCustomerModal('${cust.id}')" class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">${cust.lastName} ${cust.firstName}</h3>
                                <p class="text-sm text-gray-600">${cust.phone || 'Nessun telefono'}</p>
                                <div class="flex items-center gap-3 text-sm mt-1">
                                    <span class="text-purple-600 font-semibold">üéØ ${stamps} bollini</span>
                                    ${rewards > 0 ? `<span class="text-green-600 font-semibold">üéÅ ${rewards} premi</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }

            renderCategories() {
                const container = document.getElementById('categories-list');
                if (this.db.categories.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center">Nessuna categoria</p>'; return; }
                const sorted = [...this.db.categories].sort((a, b) => a.name.localeCompare(b.name));
                container.innerHTML = sorted.map(cat => {
                    const count = this.db.products.filter(p => p.category === cat.name).length;
                    return `<div onclick="app.openCategoryModal('${cat.id}')" class="bg-gray-50 p-3 rounded flex justify-between items-center cursor-pointer hover:bg-gray-100"><span class="font-medium">${cat.name}</span><span class="text-sm text-gray-500">${count} prodotti</span></div>`;
                }).join('');
            }

            renderFidelityList() {
                const container = document.getElementById('fidelity-list');
                if (!container) return;

                if (this.db.customers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center p-4">Nessun cliente</p>';
                    return;
                }

                const sorted = [...this.db.customers].sort((a, b) => {
                    const aStamps = (a.fidelity?.stamps || 0);
                    const bStamps = (b.fidelity?.stamps || 0);
                    return bStamps - aStamps;
                });

                container.innerHTML = sorted.map(cust => {
                    const stamps = cust.fidelity?.stamps || 0;
                    const rewards = cust.fidelity?.rewards || 0;
                    const progress = (stamps / this.fidelityConfig.stampsPerReward) * 100;

                    return `<div onclick="app.openFidelityCard('${cust.id}')" class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                ${cust.firstName.charAt(0)}${cust.lastName.charAt(0)}
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">${cust.lastName} ${cust.firstName}</h3>
                                <div class="flex items-center gap-4 text-sm mt-1">
                                    <span class="text-purple-600 font-semibold">üéØ ${stamps}/${this.fidelityConfig.stampsPerReward} bollini</span>
                                    ${rewards > 0 ? `<span class="text-green-600 font-semibold">üéÅ ${rewards} premi</span>` : ''}
                                </div>
                                <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }

            // PREPARAZIONE IN SERIE
            filterPreparation() {
                this.renderPreparation();
            }

            renderPreparation() {
                const container = document.getElementById('preparation-list');
                const dateFilter = document.getElementById('prep-date-filter').value;
                const statusFilter = document.getElementById('prep-status-filter').value;

                // Filtra ordini per data
                let ordersToShow = this.db.orders.filter(o => !o.deleted);
                this.db.orders.filter
                if (dateFilter) {
                    ordersToShow = ordersToShow.filter(o => o.deliveryDate === dateFilter);
                }

                // Filtra per stato preparazione (solo ordini da preparare)
                ordersToShow = ordersToShow.filter(o =>
                    o.prepStatus === 'da preparare'
                );

                if (ordersToShow.length === 0) {
                    container.innerHTML = '<div class="bg-white rounded-lg shadow p-8 text-center"><p class="text-gray-500 text-lg">üì¶ Nessun ordine da preparare per questa data</p><p class="text-sm text-gray-400 mt-2">Prova a cambiare la data filtro</p></div>';
                    return;
                }

                // Raggruppa prodotti per nome
                const productGroups = {};

                ordersToShow.forEach(order => {
                    const customer = this.db.customers.find(c => c.id === order.customerId);
                    const customerName = customer ? `${customer.lastName} ${customer.firstName}` : 'Sconosciuto';

                    order.items.forEach((item, itemIndex) => {
                        const key = item.productName;
                        if (!productGroups[key]) {
                            productGroups[key] = {
                                productName: item.productName,
                                unit: item.unit,
                                orders: []
                            };
                        }

                        // Inizializza preparedItems se non esiste
                        if (!order.preparedItems) {
                            order.preparedItems = [];
                        }

                        const isPrepared = order.preparedItems.includes(itemIndex);

                        productGroups[key].orders.push({
                            orderId: order.id,
                            orderNumber: order.number,
                            customerName: customerName,
                            qty: item.qty,
                            weight: item.weight,
                            itemIndex: itemIndex,
                            isPrepared: isPrepared
                        });
                    });
                });

                // Filtra per stato completamento
                const filteredGroups = Object.values(productGroups).filter(group => {
                    const allPrepared = group.orders.every(o => o.isPrepared);
                    const nonePrepared = group.orders.every(o => !o.isPrepared);

                    if (statusFilter === 'completed') return allPrepared;
                    if (statusFilter === 'notcompleted') return !allPrepared;
                    return true; // 'all'
                });

                if (filteredGroups.length === 0) {
                    container.innerHTML = '<div class="bg-white rounded-lg shadow p-8 text-center"><p class="text-gray-500 text-lg">‚úÖ Tutto preparato!</p></div>';
                    return;
                }

                // Ordina per numero di ordini (prodotti pi√π richiesti prima)
                const sortedGroups = filteredGroups.sort((a, b) => b.orders.length - a.orders.length);

                // Render
                container.innerHTML = sortedGroups.map(group => {
                    const totalQty = group.orders.reduce((sum, o) => sum + o.qty, 0);
                    const preparedCount = group.orders.filter(o => o.isPrepared).length;
                    const totalOrders = group.orders.length;
                    const allPrepared = preparedCount === totalOrders;
                    const progress = (preparedCount / totalOrders) * 100;

                    return `
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden ${allPrepared ? 'opacity-60' : ''}">
                            <div class="bg-gradient-to-r ${allPrepared ? 'from-green-500 to-green-600' : 'from-orange-500 to-red-500'} text-white p-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-xl font-bold">${allPrepared ? '‚úÖ' : 'üì¶'} ${group.productName}</h3>
                                        <p class="text-sm opacity-90 mt-1">
                                            ${totalOrders} ordini ‚Ä¢ Totale: ${totalQty.toFixed(1)} ${group.unit}
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold">${preparedCount}/${totalOrders}</div>
                                        <div class="text-xs opacity-90">preparati</div>
                                    </div>
                                </div>
                                <div class="mt-3 h-2 bg-white bg-opacity-30 rounded-full overflow-hidden">
                                    <div class="h-full bg-white transition-all duration-300" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            
                            <div class="p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-sm font-medium text-gray-700">Dettaglio ordini:</span>
                                    ${!allPrepared ? `<button data-product-name="${group.productName}" data-date-filter="${dateFilter}" onclick="app.markAllProductPrepared(this.dataset.productName, this.dataset.dateFilter)" 
                                        class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 font-medium">
                                        ‚úì Segna tutti
                                    </button>` : ''}
                                </div>
                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    ${group.orders.map(order => {
                        const weightInfo = order.weight ? ` <span class="text-xs text-gray-500">(‚öñÔ∏è ${order.weight}kg)</span>` : '';
                        return `
                                            <div class="flex items-center gap-3 p-2 rounded ${order.isPrepared ? 'bg-green-50' : 'bg-gray-50'} hover:bg-gray-100 transition">
                                                <input type="checkbox" 
                                                    ${order.isPrepared ? 'checked' : ''} 
                                                    onchange="app.toggleItemPrepared('${order.orderId}', ${order.itemIndex})"
                                                    class="h-5 w-5 text-green-600 rounded border-gray-300 focus:ring-green-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900">
                                                        #${order.orderNumber} - ${order.customerName}
                                                    </div>
                                                    <div class="text-sm text-gray-600">
                                                        ${order.qty} ${group.unit}${weightInfo}
                                                    </div>
                                                </div>
                                                ${order.isPrepared ? '<span class="text-green-600 font-medium text-sm">‚úì Fatto</span>' : ''}
                                            </div>
                                        `;
                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            toggleItemPrepared(orderId, itemIndex) {
                const order = this.db.orders.find(o => o.id === orderId);
                if (!order) return;

                if (!order.preparedItems) {
                    order.preparedItems = [];
                }

                const idx = order.preparedItems.indexOf(itemIndex);
                if (idx > -1) {
                    order.preparedItems.splice(idx, 1);
                } else {
                    order.preparedItems.push(itemIndex);
                }

                // Controlla se tutti i prodotti sono stati preparati
                const totalItems = order.items.length;
                const preparedCount = order.preparedItems.length;

                if (preparedCount === totalItems && order.prepStatus === 'da preparare') {
                    // Tutti i prodotti preparati! Passa automaticamente a completato
                    console.log(`‚úÖ Cambio stato ordine #${order.number}: da preparare ‚Üí completato`);
                    order.prepStatus = 'completato';
                    const customer = this.db.customers.find(c => c.id === order.customerId);
                    const customerName = customer ? `${customer.lastName} ${customer.firstName}` : 'Ordine';
                    this.showToast(`‚úÖ ${customerName} #${order.number} ‚Üí COMPLETATO!`);
                }

                console.log(`Ordine #${order.number} - Stato: ${order.prepStatus}, Preparati: ${preparedCount}/${totalItems}`);

                this.saveData();
                this.renderPreparation();
                this.filteredOrders = null; // Reset filtri per mostrare tutti gli ordini
                this.render(); // Aggiorna anche la lista ordini
                this.renderDashboard(); // Aggiorna dashboard
            }

            markAllProductPrepared(productName, dateFilter) {
                let ordersToMark = this.db.orders;

                if (dateFilter) {
                    ordersToMark = ordersToMark.filter(o => o.deliveryDate === dateFilter);
                }

                ordersToMark = ordersToMark.filter(o =>
                    o.prepStatus === 'da preparare'
                );

                let completedOrders = 0;

                ordersToMark.forEach(order => {
                    if (!order.preparedItems) {
                        order.preparedItems = [];
                    }

                    order.items.forEach((item, index) => {
                        if (item.productName === productName && !order.preparedItems.includes(index)) {
                            order.preparedItems.push(index);
                        }
                    });

                    // Controlla se questo ordine √® ora completo
                    if (order.preparedItems.length === order.items.length && order.prepStatus === 'da preparare') {
                        order.prepStatus = 'completato';
                        completedOrders++;
                    }
                });

                this.saveData();
                this.renderPreparation();
                this.filteredOrders = null; // Reset filtri
                this.render(); // Aggiorna lista ordini
                this.renderDashboard(); // Aggiorna dashboard

                let message = `‚úÖ Tutti i "${productName}" segnati come preparati`;
                if (completedOrders > 0) {
                    message += `\nüéâ ${completedOrders} ordini completati automaticamente!`;
                }
                this.showToast(message);
            }

            // DEBUG FUNCTIONS
            setupDebugLogger() {
                const originalLog = console.log;
                const originalError = console.error;

                console.log = (...args) => {
                    originalLog.apply(console, args);
                    this.addDebugLog('log', args.join(' '));
                };

                console.error = (...args) => {
                    originalError.apply(console, args);
                    this.addDebugLog('error', args.join(' '));
                };
            }

            addDebugLog(type, message) {
                const timestamp = new Date().toLocaleTimeString();
                this.debugLogs.push({ type, message, timestamp });

                // Mantieni solo gli ultimi 50 log
                if (this.debugLogs.length > 50) {
                    this.debugLogs.shift();
                }

                // Aggiorna il pannello se visibile
                const debugPanel = document.getElementById('debug-panel');
                if (debugPanel && !debugPanel.classList.contains('hidden')) {
                    this.updateDebugPanel();
                }
            }

            updateDebugPanel() {
                const debugInfo = document.getElementById('debug-info');
                if (!debugInfo) return;

                const statusInfo = `
                    <div class="mb-3 p-2 bg-gray-800 rounded">
                        <div>üîå Client: ${this.dropboxClient ? '‚úÖ Connesso' : '‚ùå Non connesso'}</div>
                        <div>üîÑ Sync in corso: ${this.syncInProgress ? 'S√¨' : 'No'}</div>
                        <div>‚öôÔ∏è Auto-sync: ${this.autoSyncEnabled ? '‚úÖ Attivo' : '‚ùå Inattivo'}</div>
                        <div>‚è∞ Interval ID: ${this.autoSyncInterval || 'N/A'}</div>
                        <div>üìä Ordini: ${this.db.orders?.length || 0}</div>
                        <div>üõçÔ∏è Prodotti: ${this.db.products?.length || 0}</div>
                        <div>üë• Clienti: ${this.db.customers?.length || 0}</div>
                        <div>üïê Ultima sync: ${localStorage.getItem('lastDropboxSync') || 'Mai'}</div>
                    </div>
                `;

                const logs = this.debugLogs.slice(-20).reverse().map(log => {
                    const color = log.type === 'error' ? 'text-red-400' : 'text-green-400';
                    return `<div class="${color}">[${log.timestamp}] ${log.message}</div>`;
                }).join('');

                debugInfo.innerHTML = statusInfo + `<div class="max-h-64 overflow-y-auto">${logs}</div>`;
            }

            async testDropboxConnection() {
                if (!this.dropboxClient) {
                    console.error("‚ùå Client Dropbox non inizializzato");
                    this.showToast("‚ùå Dropbox non connesso", "error");
                    return;
                }

                try {
                    console.log("üß™ Test connessione Dropbox...");
                    const response = await this.dropboxClient.usersGetCurrentAccount();
                    console.log("‚úÖ Dropbox OK! Account:", response.result.name.display_name);
                    this.showToast(`‚úÖ Connesso: ${response.result.name.display_name}`);
                } catch (error) {
                    console.error("‚ùå Errore test:", error);
                    this.showToast(`‚ùå Errore: ${error.message}`, "error");
                }
            }
            setupDebugPanel() {
                const header = document.querySelector('h2.text-xl.font-bold');
                if (!header) return;

                let pressTimer;

                header.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(() => {
                        const debugPanel = document.getElementById('debug-panel');
                        debugPanel.classList.remove('hidden');
                        this.updateDebugPanel();
                        this.showToast('üêõ Pannello debug attivato');
                    }, 3000); // 3 secondi
                });

                header.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });

                header.addEventListener('touchmove', () => {
                    clearTimeout(pressTimer);
                });

                // Desktop: doppio click
                let clickCount = 0;
                header.addEventListener('click', () => {
                    clickCount++;
                    if (clickCount === 5) { // 5 click rapidi
                        const debugPanel = document.getElementById('debug-panel');
                        debugPanel.classList.remove('hidden');
                        this.updateDebugPanel();
                        this.showToast('üêõ Pannello debug attivato');
                        clickCount = 0;
                    }
                    setTimeout(() => { clickCount = 0; }, 2000);
                });
            }

            forceCheckRemote() {
                console.log('üîß Controllo remoto forzato manualmente');
                this.checkForRemoteUpdates();
            }

            clearDebugLogs() {
                this.debugLogs = [];
                this.updateDebugPanel();
                this.showToast('üóëÔ∏è Log puliti');
            }

        }

        const app = new OrderManager();
        document.addEventListener('click', (e) => {
            // Gestisci chiusura suggerimenti nella tab clienti
            if (!e.target.closest('#customer-search')) {
                document.getElementById('customer-suggestions').classList.add('hidden');
            }
            // Gestisci chiusura suggerimenti nel modal ordini
            if (!e.target.closest('#customer-search-order')) {
                const orderSuggestions = document.getElementById('customer-suggestions-order');
                if (orderSuggestions) {
                    orderSuggestions.classList.add('hidden');
                }
            }
            // Gestisci chiusura suggerimenti prodotti
            if (!e.target.closest('#order-product') && !e.target.closest('#product-suggestions')) {
                const productSuggestions = document.getElementById('product-suggestions');
                if (productSuggestions) {
                    productSuggestions.classList.add('hidden');
                }
            }
        });
    </script>
    <!-- Modal Cambio Password -->
    <div id="change-password-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">üîí Cambia Password</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Attuale</label>
                    <input type="password" id="current-password"
                        class="w-full px-3 py-2 border rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Inserisci password attuale">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nuova Password</label>
                    <input type="password" id="new-password"
                        class="w-full px-3 py-2 border rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Almeno 6 caratteri">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Conferma Nuova Password</label>
                    <input type="password" id="confirm-new-password"
                        class="w-full px-3 py-2 border rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Ripeti la nuova password"
                        onkeypress="if(event.key === 'Enter') authManager.changePassword()">
                </div>

                <div id="change-password-error"
                    class="hidden p-3 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm"></div>

                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 text-sm text-yellow-800">
                    ‚ö†Ô∏è Dopo il cambio password, dovrai effettuare nuovamente il login
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="authManager.closeChangePasswordModal()"
                    class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">
                    Annulla
                </button>
                <button onclick="authManager.changePassword()"
                    class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Cambia Password
                </button>
            </div>
        </div>
    </div>
</body>

</html>