<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#3b82f6">
    <title>Gestionale Ordini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dropbox@10.34.0/dist/Dropbox-sdk.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>


    <!-- ‚ö†Ô∏è CONFIGURAZIONE DROPBOX - AUTOMATICA ‚ö†Ô∏è -->
    <script>
        // Imposta la tua App Key
        const DROPBOX_APP_KEY = "jxj7rn2nzrs3y0p";

        // Rilevamento automatico ambiente
        const hostname = window.location.hostname;
        let redirectUri;

        if (hostname === "127.0.0.1" || hostname === "localhost") {
            // Ambiente locale (PC)
            redirectUri = "http://127.0.0.1:5500/";
        } else {
            // Online (usa l'origine corrente dinamicamente)
            redirectUri = `${window.location.origin}${window.location.pathname}`;
        }

        const DROPBOX_CONFIG = {
            clientId: DROPBOX_APP_KEY,
            redirectUri: redirectUri
        };

        console.log("üì¶ Dropbox redirect selezionato:", redirectUri);
    </script>
    <!-- ‚ö†Ô∏è Fine configurazione Dropbox ‚ö†Ô∏è -->

    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .modal {
            display: none;
        }

        .modal.open {
            display: flex;
        }

        .autocomplete-suggestions {
            position: absolute;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .autocomplete-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .autocomplete-suggestion:hover {
            background-color: #3b82f6;
            color: white;
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .stat-card {
            transition: transform 0.2s;
        }

        /* Effetti per dispositivi TOUCH (mobile/tablet) */
        @media (hover: none) and (pointer: coarse) {
            .stat-card:active {
                transform: scale(0.97);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15);
                transition: transform 0.1s, box-shadow 0.1s;
            }
        }

        /* Effetti per dispositivi con MOUSE (PC/laptop) */
        @media (hover: hover) and (pointer: fine) {
            .stat-card:hover {
                transform: translateY(-4px) scale(1.02);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Responsive mobile */
        @media (max-width: 768px) {
            .tab-btn {
                font-size: 0.7rem;
                padding: 0.5rem 0.3rem !important;
                min-width: 60px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Container tabs scrollabile */
            nav.flex {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            nav.flex::-webkit-scrollbar {
                display: none;
            }

            .stat-card {
                transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
                will-change: transform;
            }

            .toast {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }

            .toast>div {
                min-width: auto !important;
            }

            .max-w-4xl {
                padding: 0.5rem;
            }

            h1 {
                font-size: 1.25rem;
            }
        }

        @media (max-width: 640px) {
            .grid.md\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid.md\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }

            .grid.md\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        /* ========================================
   üì± OTTIMIZZAZIONI MOBILE
   ======================================== */

        /* Touch feedback */
        @media (hover: none) and (pointer: coarse) {

            button:active,
            .stat-card:active,
            [onclick]:active {
                opacity: 0.7;
                transform: scale(0.98);
                transition: all 0.1s ease;
            }
        }

        /* Previeni zoom iOS */
        button,
        a,
        input,
        select,
        textarea {
            touch-action: manipulation;
        }

        /* Area touch minima */
        @media (max-width: 768px) {

            button,
            .btn {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 16px;
            }

            input[type="text"],
            input[type="number"],
            input[type="email"],
            input[type="tel"],
            input[type="date"],
            select,
            textarea {
                font-size: 16px !important;
                min-height: 44px;
                padding: 12px;
            }
        }

        /* Modal fullscreen mobile */
        @media (max-width: 768px) {
            .modal.open {
                padding: 0 !important;
            }

            .modal.open>div {
                max-width: 100% !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }
        }

        /* QR Scanner video */
        @media (max-width: 768px) {

            #fidelity-qr-video,
            #dashboard-qr-video {
                width: 100% !important;
                max-height: 60vh;
                object-fit: cover;
            }
        }

        /* Scroll smooth iOS */
        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Toast mobile */
        @media (max-width: 768px) {
            .toast {
                bottom: 10px !important;
                right: 10px !important;
                left: 10px !important;
            }

            .toast>div {
                min-width: auto !important;
                width: 100% !important;
            }
        }

        /* Keyboard spazio */
        @media (max-width: 768px) {

            form,
            .modal form {
                padding-bottom: 300px;
            }
        }

        /* GPU acceleration */
        .transition-all,
        .stat-card,
        .toast,
        .modal {
            will-change: transform, opacity;
            transform: translateZ(0);
        }

        /* Floating buttons responsive */
        @media (max-width: 768px) {
            #floating-buttons {
                bottom: 1rem !important;
                padding: 0 1rem;
            }

            #floating-buttons button {
                width: 3.5rem !important;
                height: 3.5rem !important;
            }

            #floating-buttons button svg {
                width: 1.5rem !important;
                height: 1.5rem !important;
            }
        }
    </style>
</head>

<body class="bg-gray-100">

    <!-- Badge ambiente (discreto) -->
    <div id="env-badge" style="position:fixed; bottom:10px; left:10px; 
            background:rgba(0,0,0,0.6); color:white;
            padding:6px 10px; border-radius:8px; font-size:12px;
            font-weight:500; z-index:9999; backdrop-filter:blur(4px);
            pointer-events:none; user-select:none;">
    </div>

    <script>
        const host = window.location.hostname;
        let envMessage = "";

        if (host === "127.0.0.1" || host === "localhost") {
            envMessage = "Locale";
        }
        else if (/^192\.168\./.test(host) || /^10\./.test(host)) {
            envMessage = "LAN";
        }
        else {
            envMessage = "Online";
        }

        document.getElementById("env-badge").textContent = envMessage;
    </script>

    <!-- Schermata Login/Password -->
    <div id="auth-screen"
        class="fixed inset-0 bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center z-[9999] p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-8 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-8">
                <div
                    class="inline-block bg-gradient-to-br from-blue-600 to-purple-700 text-white rounded-full w-20 h-20 flex items-center justify-center mb-4">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">üîê Gestionale Sicuro</h1>
                <p class="text-gray-600 mt-2" id="auth-subtitle">Inserisci la password per accedere</p>
            </div>

            <!-- Form Password -->
            <div id="auth-form">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="auth-password"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Inserisci la password" onkeypress="if(event.key === 'Enter') authManager.login()">
                </div>

                <div class="mb-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="auth-remember" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm text-gray-700">Ricordami per 30 giorni</span>
                    </label>
                </div>

                <button onclick="if(typeof authManager !== 'undefined') authManager.login()"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-700 text-white py-3 px-4 rounded-lg hover:from-blue-700 hover:to-purple-800 font-semibold">
                    üîì Accedi
                </button>

                <div id="auth-error" class="hidden mt-4 p-3 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm">
                </div>
            </div>

            <!-- Setup Iniziale (Prima Password) -->
            <div id="auth-setup" class="hidden">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                    <p class="text-sm text-blue-800">
                        <strong>Prima configurazione:</strong> Crea una password per proteggere i tuoi dati con
                        crittografia AES-256.
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nuova Password</label>
                    <input type="password" id="setup-password"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Almeno 6 caratteri">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Conferma Password</label>
                    <input type="password" id="setup-password-confirm"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Ripeti la password"
                        onkeypress="if(event.key === 'Enter' && typeof authManager !== 'undefined') authManager.setupPassword()">
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                    <p class="text-sm text-yellow-800">
                        ‚ö†Ô∏è <strong>IMPORTANTE:</strong> Annota la password in un posto sicuro. Se la dimentichi, NON
                        potrai recuperare i dati!
                    </p>
                </div>

                <button onclick="authManager.setupPassword()"
                    class="w-full bg-gradient-to-r from-green-600 to-emerald-700 text-white py-3 px-4 rounded-lg hover:from-green-700 hover:to-emerald-800 font-semibold">
                    ‚úÖ Crea Password
                </button>
            </div>
        </div>
    </div>

    <!-- Indicatore Sincronizzazione -->
    <div id="sync-indicator" class="sync-indicator hidden">
        <div class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <span>Sincronizzazione...</span>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Modal Conferma Eliminazione -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-gray-800">‚ö†Ô∏è Conferma Eliminazione</h3>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex gap-3">
                <button onclick="app.cancelDelete()"
                    class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 font-medium">
                    Annulla
                </button>
                <button onclick="app.confirmDelete()"
                    class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 font-medium">
                    Elimina
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto p-4">
        <header class="bg-white shadow-md rounded-lg mb-4 sticky top-4 z-10" id="main-header">
            <h1 class="text-2xl font-bold text-gray-800 p-4 text-center">üìã Gestionale Ordini</h1>
            <nav class="border-t border-gray-200">
                <div class="flex justify-around overflow-x-auto">
                    <button onclick="app.switchTab('dashboard')"
                        class="tab-btn flex-1 p-4 border-b-2 border-blue-600 text-blue-600 font-semibold whitespace-nowrap"
                        data-tab="dashboard">üìä Dashboard</button>
                    <button onclick="app.switchTab('ordini')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="ordini">üìù Ordini</button>
                    <button onclick="app.switchTab('preparazione')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="preparazione">üìã Preparazione</button>
                    <button onclick="app.switchTab('modifiche')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap relative"
                        data-tab="modifiche">
                        ‚ö†Ô∏è Modifiche
                        <span id="mod-badge"
                            class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <button onclick="app.switchTab('clienti')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="clienti">üë• Clienti</button>
                    <button onclick="app.switchTab('prodotti')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="prodotti">üì¶ Prodotti</button>
                    <button onclick="app.switchTab('fidelity')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="fidelity">üéÅ Fidelity</button>
                    <button onclick="app.switchTab('impostazioni')"
                        class="tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap"
                        data-tab="impostazioni">‚öôÔ∏è Impostazioni</button>
                </div>
            </nav>
        </header>

        <!-- Tab Dashboard -->
        <div id="tab-dashboard" class="tab-content">
            <div class="space-y-4">
                <!-- Quick Actions (NUOVO) -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">‚ö° Azioni Rapide</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button onclick="app.openOrderModal()"
                            class="bg-gradient-to-br from-blue-500 to-blue-600 text-white py-4 px-4 rounded-lg hover:shadow-lg transition-all duration-200 flex flex-col items-center gap-2 active:scale-95">
                            <span class="text-2xl">üìù</span>
                            <span class="text-sm font-medium">Nuovo Ordine</span>
                        </button>
                        <button onclick="app.openCustomerModal()"
                            class="bg-gradient-to-br from-purple-500 to-purple-600 text-white py-4 px-4 rounded-lg hover:shadow-lg transition-all duration-200 flex flex-col items-center gap-2 active:scale-95">
                            <span class="text-2xl">üë§</span>
                            <span class="text-sm font-medium">Nuovo Cliente</span>
                        </button>
                        <button onclick="app.switchTab('preparazione')"
                            class="bg-gradient-to-br from-orange-500 to-orange-600 text-white py-4 px-4 rounded-lg hover:shadow-lg transition-all duration-200 flex flex-col items-center gap-2 active:scale-95">
                            <span class="text-2xl">üìã</span>
                            <span class="text-sm font-medium">Preparazione</span>
                        </button>
                        <button onclick="app.switchTab('modifiche')"
                            class="bg-gradient-to-br from-yellow-500 to-orange-600 text-white py-4 px-4 rounded-lg hover:shadow-lg transition-all duration-200 flex flex-col items-center gap-2 active:scale-95">
                            <span class="text-2xl">‚ö†Ô∏è</span>
                            <span class="text-sm font-medium">Modifiche</span>
                    </div>
                </div>

                <!-- Statistiche Rapide -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-xl cursor-pointer"
                        onclick="app.filterByToday()">
                        <div class="flex items-center justify-between mb-2">
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                            </div>
                            <div class="text-xs opacity-75">Oggi</div>
                        </div>
                        <div class="text-sm opacity-90 font-medium">Ordini</div>
                        <div class="text-4xl font-bold mt-2" id="stat-orders-today">0</div>
                        <div class="text-xs opacity-75 mt-2">üëÜ Clicca per filtrare</div>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-xl cursor-pointer"
                        onclick="app.filterByToday()">
                        <div class="flex items-center justify-between mb-2">
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="text-xs opacity-75">Oggi</div>
                        </div>
                        <div class="text-sm opacity-90 font-medium">Fatturato</div>
                        <div class="text-3xl font-bold mt-2" id="stat-revenue-today">‚Ç¨0</div>
                        <div class="text-xs opacity-75 mt-2">üëÜ Clicca per filtrare</div>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-xl cursor-pointer"
                        onclick="app.filterByMonth()">
                        <div class="flex items-center justify-between mb-2">
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div class="text-xs opacity-75">Mese</div>
                        </div>
                        <div class="text-sm opacity-90 font-medium">Ordini</div>
                        <div class="text-4xl font-bold mt-2" id="stat-orders-month">0</div>
                        <div class="text-xs opacity-75 mt-2">üëÜ Clicca per filtrare</div>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-xl cursor-pointer"
                        onclick="app.filterByMonth()">
                        <div class="flex items-center justify-between mb-2">
                            <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                            </div>
                            <div class="text-xs opacity-75">Mese</div>
                        </div>
                        <div class="text-sm opacity-90 font-medium">Fatturato</div>
                        <div class="text-3xl font-bold mt-2" id="stat-revenue-month">‚Ç¨0</div>
                        <div class="text-xs opacity-75 mt-2">üëÜ Clicca per filtrare</div>
                    </div>
                </div>

                <!-- Statistiche Complete -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                        <span>üìà</span>
                        <span>Panoramica Completa</span>
                    </h3>

                    <!-- Prima riga: 4 card principali -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <!-- Card Totale Ordini -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-5 border-2 border-blue-200 cursor-pointer hover:shadow-lg transition-all duration-200 active:scale-95"
                            onclick="app.switchTab('ordini')">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-4xl">üìù</div>
                                <div class="text-3xl font-bold text-blue-600" id="stat-total-orders">0</div>
                            </div>
                            <div class="text-sm font-semibold text-gray-700">Ordini Totali</div>
                            <div class="text-xs text-gray-500 mt-2">üëÜ Clicca per gestire</div>
                        </div>

                        <!-- Card Totale Clienti -->
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-5 border-2 border-purple-200 cursor-pointer hover:shadow-lg transition-all duration-200 active:scale-95"
                            onclick="app.switchTab('clienti')">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-4xl">üë•</div>
                                <div class="text-3xl font-bold text-purple-600" id="stat-total-customers">0</div>
                            </div>
                            <div class="text-sm font-semibold text-gray-700">Clienti Registrati</div>
                            <div class="text-xs text-gray-500 mt-2">üëÜ Clicca per gestire</div>
                        </div>

                        <!-- Card Totale Prodotti -->
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-5 border-2 border-orange-200 cursor-pointer hover:shadow-lg transition-all duration-200 active:scale-95"
                            onclick="app.switchTab('prodotti')">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-4xl">üì¶</div>
                                <div class="text-3xl font-bold text-orange-600" id="stat-total-products">0</div>
                            </div>
                            <div class="text-sm font-semibold text-gray-700">Prodotti Attivi</div>
                            <div class="text-xs text-gray-500 mt-2">üëÜ Clicca per gestire</div>
                        </div>

                        <!-- Card Clienti Fidelity -->
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-5 border-2 border-green-200 cursor-pointer hover:shadow-lg transition-all duration-200 active:scale-95"
                            onclick="app.switchTab('fidelity')">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-4xl">üéÅ</div>
                                <div class="text-3xl font-bold text-green-600" id="stat-fidelity-customers">0</div>
                            </div>
                            <div class="text-sm font-semibold text-gray-700">Clienti Fidelity</div>
                            <div class="text-xs text-gray-500 mt-2">üëÜ Clicca per gestire</div>
                        </div>
                    </div>

                    <!-- Seconda riga: 3 card statistiche -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- Card Ordini da Preparare CON BADGE ANIMATO -->
                        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-5 border-2 border-yellow-200 cursor-pointer hover:shadow-lg transition-all duration-200 active:scale-95 relative"
                            onclick="app.switchTab('preparazione')">
                            <!-- Badge notifica animato -->
                            <div class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-8 h-8 flex items-center justify-center shadow-lg"
                                style="animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;">
                                <span id="stat-orders-to-prepare-badge">0</span>
                            </div>
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-4xl">üìã</div>
                                <div class="text-3xl font-bold text-yellow-600" id="stat-orders-to-prepare">0</div>
                            </div>
                            <div class="text-sm font-semibold text-gray-700">Da Preparare Oggi</div>
                            <div class="text-xs text-gray-500 mt-2">üëÜ Vai a preparazione</div>
                        </div>

                        <!-- Card Categorie Prodotti -->
                        <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl p-5 border-2 border-pink-200 cursor-pointer hover:shadow-lg transition-all duration-200 active:scale-95"
                            onclick="app.switchTab('prodotti')">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-4xl">üè∑Ô∏è</div>
                                <div class="text-3xl font-bold text-pink-600" id="stat-total-categories">0</div>
                            </div>
                            <div class="text-sm font-semibold text-gray-700">Categorie Prodotti</div>
                            <div class="text-xs text-gray-500 mt-2">üëÜ Gestisci categorie</div>
                        </div>

                        <!-- Card Fatturato Totale -->
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-5 border-2 border-emerald-200 cursor-pointer hover:shadow-lg transition-all duration-200 active:scale-95">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-4xl">üí∞</div>
                                <div class="text-2xl font-bold text-emerald-600" id="stat-total-revenue">‚Ç¨0</div>
                            </div>
                            <div class="text-sm font-semibold text-gray-700">Fatturato Totale</div>
                            <div class="text-xs text-gray-500 mt-2">Solo ordini pagati</div>
                        </div>
                    </div>
                </div>

                <!-- Grafici e Analisi -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">üìä Analisi Rapida</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Stati Ordini</h4>
                            <div id="prep-status-chart" class="space-y-2"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Pagamenti</h4>
                            <div id="payment-status-chart" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Top Clienti -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">‚≠ê Top 5 Clienti</h3>
                    <div id="top-customers" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- Tab Ordini -->
        <div id="tab-ordini" class="tab-content hidden">
            <!-- Barra Ricerca e Filtri -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
                <!-- Prima riga: filtri base -->
                <div class="grid md:grid-cols-4 gap-3 mb-3">
                    <input type="text" id="order-search" placeholder="üîç Cerca per numero, cliente..."
                        class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none"
                        oninput="app.filterOrders()">
                    <select id="prep-filter"
                        class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none"
                        onchange="app.filterOrders()">
                        <option value="">Tutti gli stati</option>
                        <option value="da preparare">Da preparare</option>
                        <option value="da modificare">‚ö†Ô∏è Da modificare</option>
                        <option value="completato">Completato</option>
                        <option value="consegnato">Consegnato</option>
                    </select>
                    <select id="payment-filter"
                        class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none"
                        onchange="app.filterOrders()">
                        <option value="">Tutti i pagamenti</option>
                        <option value="non pagato">Non pagato</option>
                        <option value="pagato">Pagato</option>
                    </select>
                    <button onclick="app.resetAllFilters()"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-bold px-4 py-2 rounded-lg transition">
                        üîÑ Mostra Tutti
                    </button>
                </div>

                <!-- Seconda riga: filtri data -->
                <div class="border-t pt-3">
                    <div class="grid md:grid-cols-5 gap-3">
                        <select id="date-filter-type"
                            class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none"
                            onchange="app.updateDateFilterOptions()">
                            <option value="">üìÖ Tutte le date</option>
                            <option value="today">üìÜ Oggi</option>
                            <option value="tomorrow">üîú Domani</option>
                            <option value="week">üìÖ Questa settimana</option>
                            <option value="month">üìÜ Mese specifico</option>
                            <option value="year">üìÖ Anno specifico</option>
                            <option value="custom">üìä Periodo personalizzato</option>
                        </select>

                        <select id="month-filter"
                            class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none hidden"
                            onchange="app.filterOrders()">
                            <option value="">Seleziona mese</option>
                            <option value="01">Gennaio</option>
                            <option value="02">Febbraio</option>
                            <option value="03">Marzo</option>
                            <option value="04">Aprile</option>
                            <option value="05">Maggio</option>
                            <option value="06">Giugno</option>
                            <option value="07">Luglio</option>
                            <option value="08">Agosto</option>
                            <option value="09">Settembre</option>
                            <option value="10">Ottobre</option>
                            <option value="11">Novembre</option>
                            <option value="12">Dicembre</option>
                        </select>

                        <select id="year-filter"
                            class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none hidden"
                            onchange="app.filterOrders()">
                            <!-- Popolato dinamicamente -->
                        </select>

                        <input type="date" id="date-from" placeholder="Da data"
                            class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none hidden"
                            onchange="app.filterOrders()">

                        <input type="date" id="date-to" placeholder="A data"
                            class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none hidden"
                            onchange="app.filterOrders()">
                    </div>
                </div>
            </div>

            <!-- Pulsanti azione -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="app.deleteAllOrders()"
                    class="bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-red-700 transition">
                    üóëÔ∏è Elimina Tutti Ordini
                </button>
                <button onclick="app.openOrderModal()"
                    class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition">
                    ‚ûï Nuovo Ordine
                </button>
            </div>

            <!-- Lista ordini -->
            <div id="orders-list" class="space-y-3"></div>
        </div>

        <!-- Tab Preparazione -->
        <div id="tab-preparazione" class="tab-content hidden">
            <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-lg shadow-lg mb-4">
                <h2 class="text-2xl font-bold mb-2">üî• Preparazione in Serie</h2>
                <p class="text-sm opacity-90">Raggruppa i prodotti per preparare tutti gli ordini contemporaneamente</p>
            </div>

            <!-- Filtri Data -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Consegna</label>
                        <input type="date" id="prep-date-filter"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                            onchange="app.filterPreparation()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mostra</label>
                        <select id="prep-status-filter"
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-orange-500 focus:outline-none"
                            onchange="app.filterPreparation()">
                            <option value="notcompleted">Solo da preparare</option>
                            <option value="tomodify">‚ö†Ô∏è Solo da modificare</option>
                            <option value="all">Tutti</option>
                            <option value="completed">Solo completati</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="app.renderPreparation()"
                            class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 font-medium">
                            üîÑ Aggiorna
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista Prodotti Raggruppati -->
            <div id="preparation-list" class="space-y-4"></div>
        </div>

        <!-- TAB MODIFICHE -->
        <div id="tab-modifiche" class="tab-content hidden">
            <div class="mb-6 bg-white rounded-lg shadow p-4">
                <h2 class="text-2xl font-bold mb-4">‚ö†Ô∏è Modifiche Ordini</h2>

                <!-- Filtri -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Filtra per data consegna</label>
                        <input type="date" id="mod-date-filter"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            onchange="app.renderModifications()">
                    </div>

                    <div class="flex items-end">
                        <button onclick="document.getElementById('mod-date-filter').value=''; app.renderModifications()"
                            class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 w-full">
                            üîÑ Mostra tutte le date
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista Modifiche -->
            <div id="modifications-list"></div>
        </div>

        <!-- Tab Prodotti -->
        <div id="tab-prodotti" class="tab-content hidden">
            <button onclick="app.openProductModal()"
                class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-green-700 mb-4">
                + Nuovo Prodotto
            </button>
            <div id="products-list" class="space-y-3"></div>
        </div>

        <!-- Tab Clienti -->
        <div id="tab-clienti" class="tab-content hidden">
            <!-- Aggiungi Cliente e Gestione -->
            <div class="grid md:grid-cols-1 gap-4 mb-4">
                <!-- Nuovo Cliente -->
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold mb-4">üë• Gestione Clienti</h2>
                    <button onclick="app.openCustomerModal()"
                        class="w-full bg-white text-purple-600 font-bold py-3 px-4 rounded-lg hover:bg-gray-100 mb-3">
                        + Nuovo Cliente
                    </button>
                    <p class="text-sm opacity-90">Crea un nuovo cliente per gestire ordini e informazioni</p>
                </div>
            </div>

            <!-- Ricerca Cliente -->
            <div class="bg-white p-6 rounded-lg shadow mb-4">
                <h2 class="text-xl font-bold mb-4">üîç Cerca Cliente</h2>
                <div class="relative">
                    <input type="text" id="customer-search" class="w-full px-3 py-2 border rounded-lg"
                        placeholder="Nome, cognome o telefono..." oninput="app.searchCustomer(this.value)">
                    <div id="customer-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
            </div>

            <!-- Lista Clienti -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">üí≥ Tutti i Clienti</h2>
                <div id="customers-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Tab Impostazioni -->
        <div id="tab-impostazioni" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Dropbox -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span>üì¶</span>
                        <span>Sincronizzazione Dropbox</span>
                    </h2>
                    <div id="dropbox-status" class="mb-4"></div>
                    <div class="space-y-3">
                        <button onclick="app.connectDropbox()"
                            class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition">
                            üîó Connetti Dropbox
                        </button>
                        <button onclick="app.disconnectDropbox()"
                            class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-red-700 transition">
                            üîå Disconnetti Dropbox
                        </button>
                        <button onclick="app.syncToDropbox()"
                            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-green-700 transition">
                            üîÑ Sincronizza Manualmente
                        </button>
                    </div>
                    <div class="mt-4 flex items-center gap-2">
                        <input type="checkbox" id="auto-sync-toggle" onchange="app.toggleAutoSync()" class="w-4 h-4">
                        <label for="auto-sync-toggle" class="text-sm text-gray-700">Sincronizzazione automatica</label>
                    </div>
                </div>

                <!-- Sicurezza -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span>üîí</span>
                        <span>Sicurezza</span>
                    </h2>
                    <button onclick="app.openChangePasswordModal()"
                        class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-purple-700 transition">
                        üîë Cambia Password
                    </button>
                </div>

                <!-- Gestione Categorie -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span>üóÇÔ∏è</span>
                        <span>Categorie Prodotti</span>
                    </h2>
                    <button onclick="app.openCategoryModal()"
                        class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-orange-700 transition mb-3">
                        ‚ûï Nuova Categoria
                    </button>
                    <div id="categories-list" class="space-y-2"></div>
                </div>

                <!-- Dati e Backup -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span>üíæ</span>
                        <span>Gestione Dati</span>
                    </h2>
                    <div class="space-y-3">
                        <button onclick="app.exportOrders()"
                            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-green-700 transition">
                            üì• Esporta Ordini (CSV)
                        </button>
                        <button onclick="app.backupData()"
                            class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition">
                            üíæ Backup Locale
                        </button>
                        <button onclick="app.importData()"
                            class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition">
                            üì§ Importa Dati
                        </button>
                    </div>
                </div>

                <!-- Informazioni -->
                <div
                    class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl shadow-lg p-6 border-2 border-gray-200">
                    <h2 class="text-xl font-bold mb-3 text-gray-800">‚ÑπÔ∏è Informazioni App</h2>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><strong>Versione:</strong> 2.0.0</p>
                        <p><strong>Ultimo aggiornamento:</strong> Novembre 2025</p>
                        <p><strong>Gestionale Ordini</strong> - Pastificio Gramsci</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- TAB FIDELITY -->
        <!-- ========================================== -->
        <div id="tab-fidelity" class="tab-content hidden">
            <!-- Dashboard Stats Fidelity -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <!-- Card 1: Clienti Fidelity (solo statistica, NON cliccabile) -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center">
                        <div class="bg-purple-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Clienti Fidelity</p>
                            <p class="text-2xl font-bold" id="fidelity-total-customers">0</p>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Premi Disponibili (cliccabile) -->
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition"
                    onclick="app.showAvailableRewardsModal()">
                    <div class="flex items-center">
                        <div class="bg-green-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">üéÅ Premi Disponibili</p>
                            <p class="text-2xl font-bold text-green-600" id="fidelity-available-rewards">0</p>
                            <p class="text-xs text-gray-400 mt-1">üëÜ Clicca per vedere</p>
                        </div>
                    </div>
                </div>

                <!-- Card 3: Premi Riscattati (cliccabile) -->
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition"
                    onclick="app.showRedeemedRewardsModal()">
                    <div class="flex items-center">
                        <div class="bg-blue-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">‚úÖ Premi Riscattati</p>
                            <p class="text-2xl font-bold text-blue-600" id="fidelity-redeemed-rewards">0</p>
                            <p class="text-xs text-gray-400 mt-1">üëÜ Clicca per vedere</p>
                        </div>
                    </div>
                </div>

                <!-- Card 4: Coupon Attivi (cliccabile) -->
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition"
                    onclick="app.showActiveCouponsModal()">
                    <div class="flex items-center">
                        <div class="bg-pink-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">üéüÔ∏è Coupon Attivi</p>
                            <p class="text-2xl font-bold text-pink-600" id="fidelity-active-coupons">0</p>
                            <p class="text-xs text-gray-400 mt-1">üëÜ Clicca per vedere</p>
                        </div>
                    </div>
                </div>

                <!-- Card 5: Coupon Usati (cliccabile) -->
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition"
                    onclick="app.showUsedCouponsModal()">
                    <div class="flex items-center">
                        <div class="bg-orange-100 rounded-full p-3">
                            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">‚úîÔ∏è Coupon Usati</p>
                            <p class="text-2xl font-bold text-orange-600" id="fidelity-used-coupons">0</p>
                            <p class="text-xs text-gray-400 mt-1">üëÜ Clicca per vedere</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scanner QR -->
            <div
                class="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-300 rounded-lg shadow mb-6 p-6">
                <h2 class="text-xl font-bold text-amber-900 mb-4">üì∑ Scanner QR Fidelity Card</h2>
            </div>

            <!-- Gestione Campagne Coupon -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="p-4 border-b">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold">üé´ Campagne Coupon</h2>
                        <button onclick="app.openNewCampaignModal()"
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            ‚ûï Nuova Campagna
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <div id="campaigns-list"></div>
                </div>
            </div>

            <!-- Lista Clienti Fidelity -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold">üë• Gestione Clienti Fidelity</h2>
                        <button onclick="app.resetAllFidelity()"
                            class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 font-medium flex items-center gap-2">
                            üîÑ Azzera Tutti i Dati Fidelity
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <div id="fidelity-customers-list"></div>
                </div>
            </div>

            <div id="tab-impostazioni" class="tab-content hidden">
                <!-- Sicurezza -->
                <div class="bg-white p-6 rounded-lg shadow space-y-4 mb-4">
                    <h2 class="text-xl font-bold">üîê Sicurezza</h2>

                    <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                        <p class="text-sm text-green-800">
                            ‚úÖ <strong>Protezione attiva:</strong> I tuoi dati sono criptati con AES-256
                        </p>
                        <p class="text-xs text-green-700 mt-1">
                            Sia i dati locali che i backup su Dropbox sono protetti dalla tua password
                        </p>
                    </div>

                    <div class="grid md:grid-cols-2 gap-3">
                        <button onclick="authManager.logout()"
                            class="bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 font-medium flex items-center justify-center gap-2">
                            üö™ Esci (Logout)
                        </button>

                        <button onclick="authManager.openChangePasswordModal()"
                            class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-medium flex items-center justify-center gap-2">
                            üîí Cambia Password
                        </button>
                    </div>

                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                        <p class="text-sm text-yellow-800">
                            <strong>‚è∞ Auto-logout:</strong> Verrai disconnesso automaticamente dopo 2 ore di inattivit√†
                        </p>
                    </div>
                </div>

                <!-- Configurazione Dropbox -->
                <div class="bg-white p-6 rounded-lg shadow space-y-4 mb-4">
                    <h2 class="text-xl font-bold">üîó Connessione Dropbox</h2>

                    <div id="dropbox-status"></div>

                    <!-- Pannello Debug (appare dopo 3 secondi di pressione) -->
                    <div id="debug-panel"
                        class="hidden bg-gray-900 text-white p-4 rounded-lg space-y-2 text-xs font-mono">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-sm">üêõ Debug Sincronizzazione</span>
                            <button onclick="document.getElementById('debug-panel').classList.add('hidden')"
                                class="text-red-400 hover:text-red-300">‚úï</button>
                        </div>
                        <div id="debug-info"></div>
                        <button onclick="app.forceCheckRemote()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded mt-2">
                            üîç Forza Controllo Remoto
                        </button>
                        <button onclick="app.clearDebugLogs()"
                            class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded">
                            üóëÔ∏è Pulisci Log
                        </button>
                    </div>

                    <div id="dropbox-config" class="space-y-3">
                        <div class="bg-blue-50 p-4 rounded-lg text-sm border-l-4 border-blue-500">
                            <p class="text-blue-900 mb-3 font-semibold">
                                üì¶ Come configurare Dropbox
                            </p>

                            <ol class="text-xs text-blue-800 space-y-2 mb-4">
                                <li class="flex items-start gap-2">
                                    <span class="font-bold min-w-[20px]">1.</span>
                                    <span>Vai su <a href="https://www.dropbox.com/developers/apps" target="_blank"
                                            class="text-blue-600 underline font-medium">Dropbox Developers</a> e crea
                                        una
                                        nuova app</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="font-bold min-w-[20px]">2.</span>
                                    <span>Copia l'<strong>App Key</strong> dalla sezione "Settings"</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="font-bold min-w-[20px]">3.</span>
                                    <span>Modifica il file HTML (riga ~30) con la tua App Key:
                                        <pre
                                            class="text-xs bg-white p-2 rounded mt-1 overflow-x-auto border border-blue-200">const DROPBOX_CONFIG = {
  clientId: '<span class="text-red-600">LA_TUA_APP_KEY</span>',
  redirectUri: "https://gestionaleordini.netlify.app/"
};</pre>
                                    </span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="font-bold min-w-[20px]">4.</span>
                                    <span>Aggiungi questo URL nei <strong>Redirect URIs</strong> dell'app Dropbox:<br>
                                        <code
                                            class="bg-white px-2 py-1 rounded text-xs mt-1 inline-block border border-blue-200">
                        https://gestionaleordini.netlify.app/
                    </code>
                                        <button
                                            onclick="navigator.clipboard.writeText('https://gestionaleordini.netlify.app/'); app.showToast('‚úÖ URL copiato!')"
                                            class="ml-2 text-blue-600 hover:text-blue-800" title="Copia URL">
                                            üìã
                                        </button>
                                    </span>
                                </li>
                            </ol>

                            <div class="bg-green-50 border border-green-200 rounded p-3">
                                <p class="text-xs text-green-800">
                                    ‚úÖ <strong>PKCE OAuth2:</strong> Sicuro, non serve App Secret!
                                </p>
                            </div>
                        </div>

                        <button onclick="app.avviaAuthDropbox()"
                            class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold">
                            üîó Connetti Dropbox
                        </button>

                        <button onclick="app.testDropboxConnection()"
                            class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 font-medium mt-2">
                            üß™ Test Connessione Dropbox
                        </button>

                        <button onclick="app.disconnectDropbox()"
                            class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 text-sm">
                            Disconnetti
                        </button>
                    </div>

                    <script>
                        // Mostra l'URL corrente per Redirect URI
                        document.addEventListener('DOMContentLoaded', () => {
                            const urlEl = document.getElementById('current-url');
                            if (urlEl) {
                                urlEl.textContent = `${window.location.origin}${window.location.pathname}`;
                            }
                        });
                    </script>

                    <div class="border-t pt-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="font-semibold">Sincronizzazione Automatica</h3>
                                <p class="text-sm text-gray-600">Sincronizza ogni 30 secondi con Dropbox</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-sync-toggle" checked class="sr-only peer"
                                    onchange="app.toggleAutoSync()">
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                        <p class="text-sm font-semibold text-blue-900 mb-1">‚ÑπÔ∏è Come funziona (OAuth2 PKCE)</p>
                        <ul class="list-disc ml-4 space-y-1 text-sm text-blue-800">
                            <li>Inserisci l'App Key e clicca "Autorizza Dropbox"</li>
                            <li>Verrai reindirizzato a Dropbox per autorizzare l'app</li>
                            <li>Il token verr√† salvato automaticamente e non scadr√†</li>
                            <li>Attiva la sincronizzazione automatica per sync ogni 30s</li>
                            <li>Tutti i dispositivi si sincronizzeranno automaticamente</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow space-y-4 mb-4">
                    <h2 class="text-xl font-bold">Gestione Categorie Prodotti</h2>
                    <button onclick="app.openCategoryModal()"
                        class="w-full bg-orange-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-orange-700">+
                        Nuova
                        Categoria</button>
                    <div id="categories-list" class="space-y-2"></div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Backup Manuale</h2>
                    <div id="sync-status-manual" class="mb-4"></div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="app.syncToDropbox()"
                            class="bg-blue-600 text-white font-medium py-4 px-4 rounded-lg hover:bg-blue-700 flex flex-col items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <span class="font-bold">Carica su Dropbox</span>
                        </button>
                        <button onclick="app.syncFromDropbox()"
                            class="bg-green-600 text-white font-medium py-4 px-4 rounded-lg hover:bg-green-700 flex flex-col items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                            </svg>
                            <span class="font-bold">Scarica da Dropbox</span>
                        </button>
                    </div>
                    <div id="last-sync-info" class="text-sm text-gray-600 text-center mb-4"></div>
                    <details class="mb-4">
                        <summary class="cursor-pointer font-medium text-gray-700 hover:text-gray-900 py-2">üíæ Backup
                            Locale
                        </summary>
                        <div class="mt-3 space-y-3 pl-4 border-l-2 border-gray-200">
                            <button onclick="app.downloadLocalBackup()"
                                class="w-full bg-purple-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-purple-700">Scarica
                                Backup Locale</button>
                            <button onclick="document.getElementById('local-backup-file').click()"
                                class="w-full bg-orange-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-orange-700">Carica
                                Backup Locale</button>
                            <input type="file" id="local-backup-file" class="hidden" accept=".json"
                                onchange="app.loadLocalBackup(event)">
                        </div>
                    </details>
                    <div class="grid grid-cols-3 gap-3 pt-4 border-t">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-blue-600" id="stats-orders">0</p>
                            <p class="text-xs text-gray-600">Ordini</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-green-600" id="stats-products">0</p>
                            <p class="text-xs text-gray-600">Prodotti</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-purple-600" id="stats-customers">0</p>
                            <p class="text-xs text-gray-600">Clienti</p>
                        </div>
                    </div>
                </div>

                <!-- Configurazione Fidelity -->
                <!-- TEMPORANEAMENTE DISABILITATO - Fidelity Card in sviluppo -->
                <div class="bg-white p-6 rounded-lg shadow mt-4" style="display: none !important;">
                    <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Configurazione Fidelity Card</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome Attivit√†</label>
                            <input type="text" id="business-name" class="w-full px-3 py-2 border rounded-lg"
                                placeholder="Es. Pasticceria Rossi" value="La Mia Attivit√†">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‚Ç¨ per Bollino</label>
                                <input type="number" id="euros-per-stamp" class="w-full px-3 py-2 border rounded-lg"
                                    value="20" min="1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bollini per Premio</label>
                                <input type="number" id="stamps-per-reward" class="w-full px-3 py-2 border rounded-lg"
                                    value="10" min="1">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Link Gruppo WhatsApp</label>
                            <input type="text" id="whatsapp-group" class="w-full px-3 py-2 border rounded-lg"
                                placeholder="https://chat.whatsapp.com/...">
                            <p class="text-xs text-gray-500 mt-1">I clienti con consenso marketing vedranno un pulsante
                                per
                                unirsi al gruppo</p>
                        </div>

                        <button onclick="app.saveFidelityConfig()"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                            Salva Configurazione
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals (ordine, prodotto, cliente, categoria) -->
        <div id="order-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4">Nuovo Ordine</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Numero Prenotazione (Automatico)
                        </label>
                        <input type="text" id="order-number"
                            class="w-full px-3 py-2 border rounded-lg bg-gray-100 cursor-not-allowed"
                            placeholder="Verr√† calcolato automaticamente" readonly>
                        <p class="text-xs text-gray-500 mt-1">ü§ñ Calcolato automaticamente in base alla data di consegna
                        </p>
                    </div>
                    <div class="border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                        <h3 class="text-sm font-semibold text-blue-900 mb-3">Dati Cliente</h3>
                        <div class="relative mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cerca Cliente</label>
                            <input type="text" id="customer-search-order" class="w-full px-3 py-2 border rounded-lg"
                                placeholder="Digita nome, cognome o telefono..."
                                oninput="app.searchCustomerInOrder(this.value)">
                            <div id="customer-suggestions-order" class="autocomplete-suggestions hidden"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                                <input type="text" id="customer-firstname" class="w-full px-3 py-2 border rounded-lg"
                                    onblur="app.checkCustomerDuplicate()" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cognome *</label>
                                <input type="text" id="customer-lastname" class="w-full px-3 py-2 border rounded-lg"
                                    onblur="app.checkCustomerDuplicate()" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
                            <input type="tel" id="customer-phone" class="w-full px-3 py-2 border rounded-lg"
                                onblur="app.checkCustomerDuplicate()">
                        </div>
                        <div class="mt-3 flex items-start gap-2">
                            <input type="checkbox" id="customer-marketing-order"
                                class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="customer-marketing-order" class="text-sm text-gray-700 cursor-pointer">
                                <span class="font-medium">Acconsente a ricevere offerte promozionali</span>
                                <span class="block text-xs text-gray-500 mt-0.5">üìß Newsletter, SMS e comunicazioni
                                    marketing</span>
                            </label>
                        </div>
                        <div id="customer-status" class="mt-3 text-sm"></div>
                        <input type="hidden" id="selected-customer-id">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Inserimento</label>
                            <input type="date" id="order-created-date"
                                class="w-full px-3 py-2 border rounded-lg bg-gray-50" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Consegna *</label>
                            <input type="date" id="order-delivery-date" class="w-full px-3 py-2 border rounded-lg"
                                required onchange="app.updateOrderNumber()">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stato Preparazione</label>
                            <select id="order-prep-status" class="w-full px-3 py-2 border rounded-lg">
                                <option value="da preparare">Da Preparare</option>
                                <option value="da modificare">‚ö†Ô∏è Da Modificare</option>
                                <option value="completato">Completato</option>
                                <option value="consegnato">Consegnato</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stato Pagamento</label>
                            <select id="order-payment-status" class="w-full px-3 py-2 border rounded-lg">
                                <option value="non pagato">Non Pagato</option>
                                <option value="pagato">Pagato</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">üí∞ Acconto (‚Ç¨)</label>
                        <input type="number" id="order-deposit" step="0.01" min="0" placeholder="0.00"
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                            oninput="app.updateOrderDeposit()">
                        <p class="text-xs text-gray-600 mt-1">Lascia vuoto se non c'√® acconto</p>
                        <div id="deposit-info" class="mt-2 text-sm font-medium text-green-700 hidden"></div>
                    </div>
                    <div class="border-t border-b py-4">
                        <h3 class="text-lg font-semibold mb-3">Prodotti</h3>
                        <div class="space-y-3 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prodotto *</label>
                                <div class="relative">
                                    <input type="text" id="order-product" class="w-full px-3 py-2 border rounded-lg"
                                        placeholder="Cerca prodotto per nome..." autocomplete="off"
                                        oninput="app.searchProductForOrder(this.value)"
                                        onfocus="app.showAllProductsForOrder()">
                                    <div id="product-suggestions" class="autocomplete-suggestions hidden"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Peso (kg)
                                        <span class="text-xs text-gray-500">opzionale</span>
                                    </label>
                                    <input type="number" id="order-weight" step="0.001" min="0" placeholder="es. 1.5"
                                        class="w-full px-3 py-2 border rounded-lg"
                                        oninput="app.calculatePriceFromWeight()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√†</label>
                                    <input type="number" id="order-qty" step="0.1" min="0" placeholder="Qt√†"
                                        class="w-full px-3 py-2 border rounded-lg"
                                        oninput="app.calculateAutomaticPrice()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Prezzo (‚Ç¨)</label>
                                    <input type="number" id="order-price" step="0.01" min="0" placeholder="Prezzo"
                                        class="w-full px-3 py-2 border rounded-lg">
                                </div>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded p-2 text-sm text-blue-700"
                                id="weight-info" style="display: none;">
                                üí° <span id="weight-calculation"></span>
                            </div>
                            <button onclick="app.addProductToOrder()"
                                class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-medium">
                                + Aggiungi Prodotto
                            </button>
                        </div>
                        <div id="order-items" class="space-y-2 bg-gray-50 p-3 rounded-lg min-h-[100px]">
                            <p class="text-gray-500 text-center">Nessun prodotto aggiunto</p>
                        </div>
                        <div class="text-right mt-3 text-xl font-bold">Totale: <span id="order-total">0,00 ‚Ç¨</span>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button onclick="app.deleteOrder()" id="btn-delete-order"
                        class="text-red-600 hover:text-red-800 font-medium hidden">Elimina Ordine</button>
                    <div class="flex gap-3 ml-auto">
                        <button onclick="app.closeModal('order-modal')"
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Annulla</button>
                        <button id="save-order-btn" onclick="app.saveOrder()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Salva Ordine</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4">Nuovo Prodotto</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Prodotto *</label>
                        <input type="text" id="product-name" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <select id="product-category" class="w-full px-3 py-2 border rounded-lg"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Prezzo *</label>
                            <input type="number" id="product-price" step="0.01" min="0"
                                class="w-full px-3 py-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Unit√†</label>
                            <select id="product-unit" class="w-full px-3 py-2 border rounded-lg">
                                <option value="kg">kg</option>
                                <option value="pezzo">pezzo</option>
                                <option value="lt">lt</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                        <div class="space-y-3">
                            <div class="flex items-start gap-2">
                                <input type="checkbox" id="product-has-average-weight"
                                    class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                    onchange="app.toggleAverageWeightField()">
                                <label for="product-has-average-weight" class="text-sm text-gray-700 cursor-pointer">
                                    <span class="font-medium">‚öñÔ∏è Calcolo automatico per peso medio</span>
                                    <span class="block text-xs text-gray-600 mt-0.5">Per prodotti con peso medio fisso
                                        (es. vitello tonnato: 50g per fettina)</span>
                                </label>
                            </div>
                            <div id="average-weight-field" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Peso medio per unit√†
                                    (kg)</label>
                                <input type="number" id="product-average-weight" step="0.001" min="0"
                                    placeholder="es. 0.050 (50g)" class="w-full px-3 py-2 border rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">Es. vitello tonnato = 0.050 kg (50g) per fettina.
                                    Il sistema calcoler√†: quantit√† √ó peso medio √ó prezzo al kg</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button onclick="app.deleteProduct()" id="btn-delete-product"
                        class="text-red-600 hover:text-red-800 font-medium hidden">Elimina</button>
                    <div class="flex gap-3">
                        <button onclick="app.closeModal('product-modal')"
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Annulla</button>
                        <button onclick="app.saveProduct()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Salva</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="customer-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4">Nuovo Cliente</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                            <input type="text" id="edit-customer-firstname" class="w-full px-3 py-2 border rounded-lg"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cognome *</label>
                            <input type="text" id="edit-customer-lastname" class="w-full px-3 py-2 border rounded-lg"
                                required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
                        <input type="tel" id="edit-customer-phone" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="edit-customer-email" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex items-start">
                        <input type="checkbox" id="edit-customer-marketing" class="mt-1 mr-3">
                        <div>
                            <label class="font-medium text-gray-700">Approvazione Marketing</label>
                            <p class="text-sm text-gray-500">Autorizza invio info e promozioni</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button onclick="app.deleteCustomer()" id="btn-delete-customer"
                        class="text-red-600 hover:text-red-800 font-medium hidden">Elimina</button>
                    <div class="flex gap-3">
                        <button onclick="app.closeModal('customer-modal')"
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Annulla</button>
                        <button onclick="app.saveCustomer()"
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Salva</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="category-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Nuova Categoria</h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome Categoria *</label>
                    <input type="text" id="category-name" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="flex justify-between">
                    <button onclick="app.deleteCategory()" id="btn-delete-category"
                        class="text-red-600 hover:text-red-800 font-medium hidden">Elimina</button>
                    <div class="flex gap-3">
                        <button onclick="app.closeModal('category-modal')"
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Annulla</button>
                        <button onclick="app.saveCategory()"
                            class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">Salva</button>
                    </div>
                </div>
            </div>
        </div>
        <script>

            // Fix per Dropbox SDK - Wrapper fetch
            const originalFetch = window.fetch;
            const boundFetch = function (...args) {
                return originalFetch.apply(window, args);
            };

            // ============================================
            // SISTEMA AUTENTICAZIONE E CRITTOGRAFIA
            // ============================================
            class AuthManager {
                constructor() {
                    this.password = null;
                    this.sessionKey = 'auth_session';
                    this.passwordHashKey = 'auth_password_hash';
                    this.inactivityTimeout = 2 * 60 * 60 * 1000; // 2 ore
                    this.inactivityTimer = null;
                    this.isAuthenticated = false;
                }

                async init() {
                    // Controlla se esiste gi√† una password configurata
                    const hasPassword = localStorage.getItem(this.passwordHashKey);

                    if (!hasPassword) {
                        this.showSetup();
                        return;
                    }

                    // üîê Autologin sicuro ‚Äì cerca sessione e valida
                    const session = this.getSession();
                    if (session && !this.sessionExpired(session)) {
                        // üîì Decripta la password dalla sessione
                        try {
                            const decrypted = CryptoJS.AES.decrypt(session.encryptedPassword, session.token);
                            const password = decrypted.toString(CryptoJS.enc.Utf8);

                            if (password && password.length > 0) {
                                console.log("üîì Login automatico con sessione valida");
                                this.password = password;
                                this.isAuthenticated = true;

                                // Nascondi schermata auth e carica dati
                                document.getElementById('auth-screen').style.display = 'none';
                                if (typeof app !== 'undefined') {
                                    app.loadData();
                                    app.render();
                                    app.renderDashboard();
                                    app.updateStats();
                                }
                                this.startInactivityTimer();
                                return;
                            } else {
                                console.warn("‚ö†Ô∏è Token non valido, richiedo login");
                            }
                        } catch (err) {
                            console.warn("‚ö†Ô∏è Errore decrittazione token:", err);
                            // Elimina sessione corrotta
                            this.clearSession();
                        }
                    }

                    // Mostra form login
                    this.showLogin();

                    // Auto-hide floating buttons on scroll
                    this.initFloatingButtonsAutoHide();
                }

                initFloatingButtonsAutoHide() {
                    let lastScrollTop = 0;
                    let scrollTimeout;
                    const floatingButtons = document.getElementById('floating-buttons');

                    if (!floatingButtons) return;

                    window.addEventListener('scroll', () => {
                        // Clear timeout se esiste
                        clearTimeout(scrollTimeout);

                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                        if (scrollTop > lastScrollTop && scrollTop > 100) {
                            // Scroll DOWN - Nascondi
                            floatingButtons.style.transform = 'translateY(120px)';
                            floatingButtons.style.opacity = '0';
                        } else {
                            // Scroll UP - Mostra
                            floatingButtons.style.transform = 'translateY(0)';
                            floatingButtons.style.opacity = '1';
                        }

                        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;

                        // Rimostra dopo 2 secondi di inattivit√†
                        scrollTimeout = setTimeout(() => {
                            floatingButtons.style.transform = 'translateY(0)';
                            floatingButtons.style.opacity = '1';
                        }, 2000);
                    }, { passive: true });
                }

                showSetup() {
                    document.getElementById('auth-form').classList.add('hidden');
                    document.getElementById('auth-setup').classList.remove('hidden');
                    document.getElementById('auth-subtitle').textContent = 'Configura la tua password';
                }

                showLogin() {
                    document.getElementById('auth-form').classList.remove('hidden');
                    document.getElementById('auth-setup').classList.add('hidden');
                    document.getElementById('auth-subtitle').textContent = 'Inserisci la password per accedere';
                }

                setupPassword() {
                    const password = document.getElementById('setup-password').value;
                    const confirm = document.getElementById('setup-password-confirm').value;
                    const errorDiv = document.getElementById('auth-error');

                    if (!password || password.length < 6) {
                        errorDiv.textContent = '‚ùå La password deve essere di almeno 6 caratteri';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    if (password !== confirm) {
                        errorDiv.textContent = '‚ùå Le password non corrispondono';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    // Salva hash della password
                    const hash = CryptoJS.SHA256(password).toString();
                    localStorage.setItem(this.passwordHashKey, hash);

                    // Imposta password e accedi
                    this.password = password;
                    this.isAuthenticated = true;
                    this.saveSession(true); // Salva sessione con ricordami

                    // Nascondi schermata auth e carica dati
                    document.getElementById('auth-screen').style.display = 'none';
                    if (typeof app !== 'undefined') {
                        app.loadData();
                        app.render();
                        app.renderDashboard();
                        app.updateStats();
                    }
                    this.startInactivityTimer();
                }

                login() {
                    const password = document.getElementById('auth-password').value;
                    const remember = document.getElementById('auth-remember').checked;
                    const errorDiv = document.getElementById('auth-error');

                    if (!password) {
                        errorDiv.textContent = '‚ùå Inserisci la password';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    // Verifica password
                    const hash = CryptoJS.SHA256(password).toString();
                    const storedHash = localStorage.getItem(this.passwordHashKey);

                    if (hash !== storedHash) {
                        errorDiv.textContent = '‚ùå Password errata';
                        errorDiv.classList.remove('hidden');
                        document.getElementById('auth-password').value = '';
                        return;
                    }

                    // Login riuscito
                    this.password = password;
                    this.isAuthenticated = true;
                    this.saveSession(remember);

                    // Nascondi schermata auth e carica dati
                    document.getElementById('auth-screen').style.display = 'none';
                    if (typeof app !== 'undefined') {
                        app.loadData();
                        app.render();
                        app.renderDashboard();
                        app.updateStats();
                    }
                    this.startInactivityTimer();
                }

                logout() {
                    this.password = null;
                    this.isAuthenticated = false;
                    this.clearSession();
                    this.stopInactivityTimer();
                    location.reload();
                }

                saveSession(remember) {
                    const expiry = remember
                        ? Date.now() + (30 * 24 * 60 * 60 * 1000)
                        : Date.now() + this.inactivityTimeout;

                    // üîê Genera un token casuale come chiave di cifratura
                    const token = this.generateSecureToken();

                    // CORREZIONE: Cripta la PASSWORD con il token (non il contrario)
                    const encryptedPassword = CryptoJS.AES.encrypt(this.password, token).toString();

                    const session = {
                        token: token,
                        encryptedPassword: encryptedPassword,
                        expiry: expiry
                    };

                    const storage = remember ? localStorage : sessionStorage;
                    storage.setItem(this.sessionKey, JSON.stringify(session));
                }

                generateSecureToken() {
                    // Genera un token casuale di 32 caratteri
                    const array = new Uint8Array(32);
                    crypto.getRandomValues(array);
                    return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
                }
                getSession() {
                    // Controlla localStorage (ricordami)
                    let sessionData = localStorage.getItem(this.sessionKey);
                    if (sessionData) {
                        return JSON.parse(sessionData);
                    }
                    // Controlla sessionStorage (sessione corrente)
                    sessionData = sessionStorage.getItem(this.sessionKey);
                    if (sessionData) {
                        return JSON.parse(sessionData);
                    }
                    return null;
                }

                clearSession() {
                    localStorage.removeItem(this.sessionKey);
                    sessionStorage.removeItem(this.sessionKey);
                }

                sessionExpired(session) {
                    return Date.now() > session.expiry;
                }

                hideAuthScreen() {
                    this.showApp();
                }

                showApp() {
                    document.getElementById('auth-screen').style.display = 'none';

                    // ‚≠ê Carica i dati DOPO che la password √® disponibile
                    if (typeof app !== 'undefined') {
                        app.loadData(); // ‚úÖ ORA VIENE CHIAMATO DOPO IL LOGIN
                        app.render();
                        app.renderDashboard();
                        app.updateStats();
                    }
                }

                // Timer inattivit√†
                startInactivityTimer() {
                    this.resetInactivityTimer();

                    // Eventi per rilevare attivit√†
                    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                        document.addEventListener(event, () => this.resetInactivityTimer(), true);
                    });
                }

                resetInactivityTimer() {
                    if (this.inactivityTimer) {
                        clearTimeout(this.inactivityTimer);
                    }
                    this.inactivityTimer = setTimeout(() => {
                        alert('‚è∞ Sessione scaduta per inattivit√†. Verrai disconnesso.');
                        this.logout();
                    }, this.inactivityTimeout);
                }

                stopInactivityTimer() {
                    if (this.inactivityTimer) {
                        clearTimeout(this.inactivityTimer);
                        this.inactivityTimer = null;
                    }
                }

                // Funzioni crittografia
                encrypt(data) {
                    if (!this.password) return null;
                    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), this.password).toString();
                    return encrypted;
                }

                decrypt(encryptedData) {
                    if (!this.password || !encryptedData) return null;
                    try {
                        const decrypted = CryptoJS.AES.decrypt(encryptedData, this.password);
                        const decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);
                        return JSON.parse(decryptedStr);
                    } catch (e) {
                        console.error('Errore decrittazione:', e);
                        return null;
                    }
                }

                openChangePasswordModal() {
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-new-password').value = '';
                    document.getElementById('change-password-error').classList.add('hidden');
                    document.getElementById('change-password-modal').classList.add('open');
                }

                closeChangePasswordModal() {
                    document.getElementById('change-password-modal').classList.remove('open');
                }

                changePassword() {
                    const currentPassword = document.getElementById('current-password').value;
                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-new-password').value;
                    const errorDiv = document.getElementById('change-password-error');

                    // Reset errori
                    errorDiv.classList.add('hidden');

                    // Validazioni
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        errorDiv.textContent = '‚ùå Compila tutti i campi';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    // Verifica password attuale
                    const currentHash = CryptoJS.SHA256(currentPassword).toString();
                    const storedHash = localStorage.getItem(this.passwordHashKey);

                    if (currentHash !== storedHash) {
                        errorDiv.textContent = '‚ùå Password attuale errata';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    // Verifica nuova password
                    if (newPassword.length < 6) {
                        errorDiv.textContent = '‚ùå La nuova password deve essere di almeno 6 caratteri';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        errorDiv.textContent = '‚ùå Le password non corrispondono';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    // Salva nuova password
                    const newHash = CryptoJS.SHA256(newPassword).toString();
                    localStorage.setItem(this.passwordHashKey, newHash);

                    // Ricarica i dati con la nuova password e ri-cripta
                    this.password = newPassword;
                    if (typeof app !== 'undefined') {
                        app.saveData(); // Ri-cripta tutto con la nuova password
                    }

                    alert('‚úÖ Password cambiata con successo!\n\nVerrai disconnesso per sicurezza.');
                    this.logout();
                }
            }

            // Inizializza AuthManager
            const authManager = new AuthManager();

            // Avvia autenticazione quando la pagina √® pronta
            window.addEventListener('DOMContentLoaded', () => {
                authManager.init();
            });

            // ============================================
            // GESTIONALE ORDINI (Modificato per crittografia)
            // ============================================
            class OrderManager {
                constructor() {
                    this.db = {
                        products: [],
                        customers: [],
                        orders: [],
                        categories: [],
                        campaigns: [],
                        fidelityConfig: {
                            stampsPerReward: 10,
                            eurosPerStamp: 20
                        }
                    };
                    this.currentOrder = { items: [] };
                    this.editingId = null;
                    this.dropboxClient = null;
                    this.dropboxRefreshToken = localStorage.getItem('dropboxRefreshToken');
                    this.autoSyncEnabled = false;
                    this.syncInProgress = false;
                    this.autoSyncInterval = null;
                    this.debugLogs = [];
                    this.qrStream = null;
                    this.fidelityConfig = {
                        businessName: 'Pastificio Gramsci',
                        eurosPerStamp: 20,
                        stampsPerReward: 10,
                        whatsappGroup: ''
                    };
                    this.scannerPageStream = null;
                    this.pendingDelete = null;
                    this.filteredOrders = null;
                    this.searchDebounceTimer = null;
                    this.savingOrder = false;           // üõ°Ô∏è Protezione doppio click
                    this.lastSaveTime = 0;              // üõ°Ô∏è Timestamp ultimo salvataggio  
                    this.currentLockSessionId = null;   // üîí Session ID del lock corrente
                    this.currentStampsCustomerId = null; // üéÅ Cliente corrente per modal bollini
                    this.editingFidelity = false;        // üö´ Flag per bloccare auto-sync durante modifiche fidelity


                    // Setup debug logger intercept
                    this.setupDebugLogger();
                    this.loadFidelityConfig();
                    this.initDropbox();
                    this.checkUrlParams();

                    // ‚ö†Ô∏è NON caricare dati qui - aspetta che authManager sia pronto
                    // this.loadData(); // ‚ùå RIMUOVI QUESTA RIGA
                    // this.render(); // ‚ùå RIMUOVI QUESTA RIGA

                    this.updateStats();
                    this.updateLastSyncInfo();
                    this.checkDropboxStatus();
                    this.renderDashboard();

                    // Setup long press su titolo per mostrare debug
                    this.setupDebugPanel();
                }

                // NUOVE FUNZIONI PER FILTRI DATA
                filterByToday() {
                    // Passa alla tab ordini
                    this.switchTab('ordini');

                    // Imposta il filtro per la data odierna
                    const today = new Date().toISOString().split('T')[0];

                    // Filtra gli ordini
                    this.filteredOrders = this.db.orders.filter(order => {
                        return order.deliveryDate === today;
                    });

                    // Aggiorna la lista ordini
                    this.renderOrders();

                    // Mostra un messaggio
                    this.showToast('üìÖ Filtrati ordini di oggi');
                }

                filterByMonth() {
                    // Passa alla tab ordini
                    this.switchTab('ordini');

                    // Calcola il primo giorno del mese corrente
                    const now = new Date();
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const firstDayStr = firstDay.toISOString().split('T')[0];

                    // Calcola l'ultimo giorno del mese corrente
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    const lastDayStr = lastDay.toISOString().split('T')[0];

                    // Filtra gli ordini
                    this.filteredOrders = this.db.orders.filter(order => {
                        return order.deliveryDate >= firstDayStr && order.deliveryDate <= lastDayStr;
                    });

                    // Aggiorna la lista ordini
                    this.renderOrders();

                    // Mostra un messaggio
                    this.showToast('üìÖ Filtrati ordini del mese');
                }

                checkUrlParams() {
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('scan') === 'true') {
                        this.openQRScannerPage();
                    }
                }

                openQRScannerPage() {
                    document.getElementById('qr-scanner-page').classList.remove('hidden');
                    document.getElementById('main-header').classList.add('hidden');
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

                    this.startScannerPageCamera();
                }

                async startScannerPageCamera() {
                    const video = document.getElementById('scanner-page-video');
                    const canvas = document.getElementById('scanner-page-canvas');
                    const status = document.getElementById('scanner-status');

                    try {
                        // Verifica che getUserMedia sia disponibile
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            throw new Error('Il tuo browser non supporta l\'accesso alla fotocamera');
                        }

                        status.textContent = 'üì∑ Richiesta permessi fotocamera...';
                        status.className = 'text-center text-lg font-semibold mb-4 text-blue-600';

                        // Prova prima con fotocamera posteriore
                        let constraints = {
                            video: {
                                facingMode: { ideal: 'environment' },
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        };

                        try {
                            this.scannerPageStream = await navigator.mediaDevices.getUserMedia(constraints);
                        } catch (firstError) {
                            console.log('Tentativo con fotocamera posteriore fallito, provo con qualsiasi fotocamera...', firstError);

                            // Fallback: prova con qualsiasi fotocamera disponibile
                            constraints = {
                                video: {
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 }
                                }
                            };
                            this.scannerPageStream = await navigator.mediaDevices.getUserMedia(constraints);
                        }

                        video.srcObject = this.scannerPageStream;
                        await video.play();

                        status.textContent = 'üéØ Inquadra il QR code della tessera';
                        status.className = 'text-center text-lg font-semibold mb-4 text-green-600';

                        const ctx = canvas.getContext('2d');
                        let isScanning = true;

                        const scan = () => {
                            if (!isScanning || !this.scannerPageStream) return;

                            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                canvas.height = video.videoHeight;
                                canvas.width = video.videoWidth;
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                const code = jsQR(imageData.data, imageData.width, imageData.height);

                                if (code) {
                                    isScanning = false;
                                    this.processQRCodePage(code.data);
                                    return;
                                }
                            }
                            requestAnimationFrame(scan);
                        };
                        scan();

                    } catch (err) {
                        console.error('Errore accesso fotocamera:', err);

                        let errorMessage = '‚ùå Impossibile accedere alla fotocamera';
                        let suggestion = 'üí° Prova a caricare un\'immagine del QR code';

                        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                            errorMessage = '‚ùå Permesso negato';
                            suggestion = 'üí° Vai nelle impostazioni del browser e consenti l\'accesso alla fotocamera';
                        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                            errorMessage = '‚ùå Nessuna fotocamera trovata';
                            suggestion = 'üí° Assicurati che il dispositivo abbia una fotocamera';
                        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                            errorMessage = '‚ùå Fotocamera in uso';
                            suggestion = 'üí° Chiudi altre app che usano la fotocamera e riprova';
                        } else if (err.name === 'OverconstrainedError') {
                            errorMessage = '‚ùå Impostazioni non supportate';
                            suggestion = 'üí° La tua fotocamera non supporta le impostazioni richieste';
                        } else if (err.name === 'SecurityError') {
                            errorMessage = '‚ùå Errore di sicurezza';
                            suggestion = 'üí° Assicurati di usare HTTPS o localhost';
                        } else if (err.message) {
                            errorMessage = `‚ùå ${err.message}`;
                        }

                        status.innerHTML = `<div class="text-center">
                        <p class="text-red-600 font-semibold mb-2">${errorMessage}</p>
                        <p class="text-sm text-gray-600">${suggestion}</p>
                    </div>`;

                        this.showToast(errorMessage, 'error');
                    }
                }

                scanFromFilePage(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const status = document.getElementById('scanner-status');
                    status.textContent = 'üîç Analisi immagine...';
                    status.className = 'text-center text-lg font-semibold mb-4 text-blue-600';

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.getElementById('scanner-page-canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);

                            if (code) {
                                this.processQRCodePage(code.data);
                            } else {
                                status.textContent = '‚ùå QR Code non trovato';
                                status.className = 'text-center text-lg font-semibold mb-4 text-red-600';
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    event.target.value = '';
                }

                processQRCodePage(data) {
                    const status = document.getElementById('scanner-status');

                    try {
                        const qrData = JSON.parse(data);
                        if (qrData.app === 'fidelity-card' && qrData.id) {
                            status.textContent = '‚úÖ QR Code riconosciuto!';
                            status.className = 'text-center text-lg font-semibold mb-4 text-green-600';

                            // Chiudi scanner e apri scheda cliente
                            setTimeout(() => {
                                this.closeQRScannerPage();
                                this.switchTab('fidelity');
                                this.openFidelityCard(qrData.id);
                            }, 500);
                        } else {
                            status.textContent = '‚ùå QR Code non valido';
                            status.className = 'text-center text-lg font-semibold mb-4 text-red-600';
                            setTimeout(() => this.startScannerPageCamera(), 2000);
                        }
                    } catch (err) {
                        status.textContent = '‚ùå QR Code non valido';
                        status.className = 'text-center text-lg font-semibold mb-4 text-red-600';
                        setTimeout(() => this.startScannerPageCamera(), 2000);
                    }
                }

                closeQRScannerPage() {
                    if (this.scannerPageStream) {
                        this.scannerPageStream.getTracks().forEach(track => track.stop());
                        this.scannerPageStream = null;
                    }

                    const video = document.getElementById('scanner-page-video');
                    if (video) {
                        video.srcObject = null;
                    }

                    document.getElementById('qr-scanner-page').classList.add('hidden');
                    document.getElementById('main-header').classList.remove('hidden');
                    document.getElementById('tab-ordini').classList.remove('hidden');

                    // Rimuovi parametro dall'URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                copyScannerLink() {
                    const currentUrl = window.location.href.split('?')[0];
                    const scannerUrl = `${currentUrl}?scan=true`;

                    // Copia negli appunti
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(scannerUrl).then(() => {
                            this.showToast('‚úÖ Link scanner copiato! Salvalo come segnalibro');
                        }).catch(() => {
                            this.fallbackCopy(scannerUrl);
                        });
                    } else {
                        this.fallbackCopy(scannerUrl);
                    }
                }

                fallbackCopy(text) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        this.showToast('‚úÖ Link scanner copiato!');
                    } catch (err) {
                        this.showToast('Copia manualmente: ' + text, 'error');
                    }
                    document.body.removeChild(textarea);
                }

                // DROPBOX INTEGRATION (OAuth2 PKCE)
                initDropbox() {

                    console.log("üöÄ Inizializzazione Dropbox (PKCE)...");

                    // Gestisce eventuale callback OAuth
                    this.handleOAuthCallback();

                    // Recupera token
                    this.dropboxAccessToken = localStorage.getItem("dropboxAccessToken") || null;
                    this.dropboxRefreshToken = localStorage.getItem("dropboxRefreshToken") || null;

                    if (this.dropboxAccessToken) {
                        console.log("üîë Token Dropbox trovato, creo client...");
                        this.dropboxClient = new Dropbox.Dropbox({
                            accessToken: this.dropboxAccessToken
                        });
                    } else {
                        console.log("‚ÑπÔ∏è Nessun token Dropbox trovato");
                        this.dropboxClient = null;
                    }

                    // Gestione auto-sync
                    const savedValue = localStorage.getItem('autoSyncEnabled');
                    this.autoSyncEnabled = savedValue === null ? true : savedValue === 'true';
                    const autoSyncSwitch = document.getElementById("autosync-toggle");

                    if (autoSyncSwitch) {
                        autoSyncSwitch.checked = this.autoSyncEnabled;
                        autoSyncSwitch.addEventListener("change", (e) => {
                            if (e.target.checked) {
                                localStorage.setItem("autoSyncEnabled", "true");
                                this.autoSyncEnabled = true;
                                this.startAutoSync();
                            } else {
                                localStorage.setItem("autoSyncEnabled", "false");
                                this.autoSyncEnabled = false;
                                this.stopAutoSync();
                            }
                        });
                    }

                    if (this.autoSyncEnabled && this.dropboxClient) {
                        this.startAutoSync();
                    }

                    this.updateLastSyncInfo();
                }

                // === PKCE: Avvio Autenticazione Dropbox ===
                async avviaAuthDropbox() {
                    if (!DROPBOX_CONFIG.clientId || DROPBOX_CONFIG.clientId.includes("INSERISCI")) {
                        this.showToast("‚ö†Ô∏è Configura prima la App Key Dropbox", "error");
                        return;
                    }

                    console.log("üîê Avvio autenticazione Dropbox tramite PKCE...");

                    // Genera code_verifier
                    const verifierArray = new Uint8Array(64);
                    crypto.getRandomValues(verifierArray);
                    const codeVerifier = btoa(String.fromCharCode(...verifierArray))
                        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

                    // Salva il verifier in sessionStorage (pi√π affidabile per OAuth)
                    const verifierData = {
                        verifier: codeVerifier,
                        timestamp: Date.now()
                    };
                    sessionStorage.setItem("dropbox_pkce_verifier", JSON.stringify(verifierData));
                    console.log("üíæ Code verifier salvato in sessionStorage:", codeVerifier.substring(0, 10) + "...");

                    // Genera il code_challenge
                    const encoder = new TextEncoder();
                    const data = encoder.encode(codeVerifier);
                    const digest = await crypto.subtle.digest("SHA-256", data);
                    const hashArray = Array.from(new Uint8Array(digest));
                    const binary = String.fromCharCode(...hashArray);
                    const codeChallenge = btoa(binary)
                        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

                    console.log("üîê Code challenge generato:", codeChallenge.substring(0, 10) + "...");

                    // URL OAuth2 autorizzazione PKCE
                    const params = new URLSearchParams({
                        response_type: "code",
                        client_id: DROPBOX_CONFIG.clientId,
                        redirect_uri: DROPBOX_CONFIG.redirectUri,
                        code_challenge: codeChallenge,
                        code_challenge_method: "S256",
                        token_access_type: "offline" // refresh token
                    });

                    const authUrl = `https://www.dropbox.com/oauth2/authorize?${params.toString()}`;

                    console.log("üîÑ Redirect a Dropbox per autorizzazione...");

                    // Reindirizza a Dropbox
                    window.location.href = authUrl;
                }

                // === PKCE: Callback dopo il redirect da Dropbox ===
                async handleOAuthCallback() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const authCode = urlParams.get("code");

                    if (!authCode) return;

                    console.log("üîê Gestione callback OAuth con codice:", authCode.substring(0, 10) + "...");

                    // Pulisci l'URL IMMEDIATAMENTE per evitare riutilizzo del codice
                    window.history.replaceState({}, document.title, window.location.pathname);

                    let verifierData = sessionStorage.getItem("dropbox_pkce_verifier");

                    if (!verifierData) {
                        console.error("‚ùå Nessun code_verifier trovato.");
                        this.showToast("Errore autenticazione Dropbox: riprova a connetterti.", "error");
                        return;
                    }

                    let verifier;
                    try {
                        const parsed = JSON.parse(verifierData);
                        verifier = parsed.verifier;

                        // Controlla che non sia scaduto (max 10 minuti)
                        if (Date.now() - parsed.timestamp > 10 * 60 * 1000) {
                            console.error("‚ùå Code verifier scaduto")
                            this.showToast("Sessione scaduta, riprova a connetterti.", "error");
                            return;
                        }
                    } catch (e) {
                        // Retrocompatibilit√† con vecchio formato
                        verifier = verifierData;
                    }

                    if (!verifier) {
                        console.error("‚ùå Code verifier non valido");
                        return;
                    }

                    console.log("‚úÖ Code verifier trovato:", verifier.substring(0, 10) + "...");

                    try {
                        // Costruisci il corpo della richiesta come application/x-www-form-urlencoded
                        const params = new URLSearchParams();
                        params.append("code", authCode);
                        params.append("grant_type", "authorization_code");
                        params.append("client_id", DROPBOX_CONFIG.clientId);
                        params.append("redirect_uri", DROPBOX_CONFIG.redirectUri);
                        params.append("code_verifier", verifier);

                        console.log("üì§ Invio richiesta token a Dropbox...");

                        const response = await fetch("https://api.dropboxapi.com/oauth2/token", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded"
                            },
                            body: params.toString()
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error("Risposta errore:", errorText);

                            // Pulisci il verifier usato da entrambi gli storage
                            sessionStorage.removeItem("dropbox_pkce_verifier");

                            // Errori specifici
                            if (errorText.includes("code has expired")) {
                                this.showToast("‚è±Ô∏è Il codice √® scaduto. Clicca di nuovo su 'Connetti Dropbox'.", "error");
                            } else if (errorText.includes("invalid_grant")) {
                                this.showToast("‚ùå Codice non valido. Riprova a connetterti.", "error");
                            } else {
                                this.showToast("‚ùå Errore autenticazione Dropbox", "error");
                            }

                            throw new Error(`Errore HTTP ${response.status}`);
                        }

                        const data = await response.json();
                        console.log("üì• Token ricevuto con successo!");

                        if (!data.access_token) {
                            console.error("‚ùå Nessun access_token nella risposta.");
                            this.showToast("Errore autenticazione Dropbox", "error");
                            return;
                        }

                        // Salva access token
                        this.dropboxAccessToken = data.access_token;
                        localStorage.setItem("dropboxAccessToken", data.access_token);

                        // CORREZIONE: Salva refresh token se presente
                        if (data.refresh_token) {
                            this.dropboxRefreshToken = data.refresh_token;
                            localStorage.setItem("dropboxRefreshToken", data.refresh_token);
                            console.log("‚úÖ Refresh token salvato");
                        }

                        // Pulisci il verifier usato
                        sessionStorage.removeItem("dropbox_pkce_verifier");

                        // Ricrea il client Dropbox
                        this.dropboxClient = new Dropbox.Dropbox({
                            accessToken: this.dropboxAccessToken
                        });

                        // Aggiorna UI
                        this.checkDropboxStatus();

                        this.showToast("‚úîÔ∏è Dropbox collegato con successo!", "success");

                        // Download dati iniziali da Dropbox
                        console.log('üì• Download iniziale da Dropbox...');
                        await this.checkForRemoteUpdates();

                        // Avvia auto-sync
                        this.startAutoSync();

                    } catch (err) {
                        console.error("‚ùå Errore OAuth:", err);

                        // Pulisci tutto in caso di errore
                        sessionStorage.removeItem("dropbox_pkce_verifier");

                        // NON mostrare toast se gi√† mostrato prima
                        if (!err.message.includes("Errore HTTP")) {
                            this.showToast("Errore durante l'autenticazione Dropbox", "error");
                        }
                    }
                }

                // === PKCE: Rinnovo token Dropbox SOLO quando richiesto ===
                async rinnovaAccessToken() {
                    console.log("üîÑ Richiesta rinnovo access token...");

                    if (!this.dropboxRefreshToken) {
                        console.warn("‚ö†Ô∏è Nessun refresh token disponibile");
                        return null;
                    }

                    try {
                        const params = new URLSearchParams();
                        params.append("grant_type", "refresh_token");
                        params.append("refresh_token", this.dropboxRefreshToken);
                        params.append("client_id", DROPBOX_CONFIG.clientId);

                        const response = await fetch("https://api.dropboxapi.com/oauth2/token", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded"
                            },
                            body: params.toString()
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error("‚ùå Errore rinnovo:", errorText);
                            return null;
                        }

                        const data = await response.json();

                        if (!data.access_token) {
                            console.error("‚ùå Nessun token nella risposta");
                            return null;
                        }

                        this.dropboxAccessToken = data.access_token;
                        localStorage.setItem("dropboxAccessToken", data.access_token);

                        if (data.refresh_token) {
                            this.dropboxRefreshToken = data.refresh_token;
                            localStorage.setItem("dropboxRefreshToken", data.refresh_token);
                        }

                        this.dropboxClient = new Dropbox.Dropbox({
                            fetch: boundFetch,
                            accessToken: this.dropboxAccessToken
                        });

                        console.log("‚úîÔ∏è Token rinnovato con successo");
                        return data.access_token;

                    } catch (err) {
                        console.error("‚ùå Errore rinnovo token:", err);
                        return null;
                    }
                }

                async mergeWithRemoteData() {
                    try {
                        console.log('üîÄ Merge: scarico dati remoti...');

                        // Scarica dati remoti
                        const response = await this.dropboxClient.filesDownload({
                            path: '/gestionale-ordini-backup.json'
                        });

                        const blob = response.result.fileBlob;
                        const text = await blob.text();
                        const parsedData = JSON.parse(text);

                        // Decripta usando authManager
                        let remoteData;
                        if (parsedData.encrypted) {
                            remoteData = authManager.decrypt(parsedData.data);
                            if (!remoteData) {
                                console.error('‚ùå Errore: impossibile decriptare dati remoti');
                                return false;
                            }
                        } else {
                            remoteData = parsedData;
                        }

                        console.log('üîÄ Merge: unisco i dati...');

                        // ========== MERGE ORDINI ==========
                        const localOrderMap = new Map(this.db.orders.map(o => [o.id, o]));
                        let addedOrders = 0;
                        let updatedOrders = 0;

                        remoteData.orders.forEach(remoteOrder => {
                            const localOrder = localOrderMap.get(remoteOrder.id);

                            if (localOrder) {
                                // Ordine esiste: aggiorna con merge intelligente

                                // CASO 1: Remoto deleted, locale no ‚Üí marca come deleted
                                if (remoteOrder.deleted && !localOrder.deleted) {
                                    localOrder.deleted = true;
                                    localOrder.deletedAt = remoteOrder.deletedAt;
                                    updatedOrders++;
                                }
                                // CASO 2: Locale deleted, remoto no ‚Üí mantieni locale deleted (priorit√†)
                                else if (localOrder.deleted && !remoteOrder.deleted) {
                                    // Non fare nulla - la cancellazione locale ha priorit√†
                                }
                                // CASO 3: Entrambi non deleted ‚Üí merge intelligente
                                else if (!remoteOrder.deleted && !localOrder.deleted) {
                                    let hasChanges = false;

                                    // ‚úÖ ITEMS: Merge basato su lastModified (il pi√π recente vince SEMPRE)
                                    if (JSON.stringify(localOrder.items) !== JSON.stringify(remoteOrder.items)) {
                                        const localTime = new Date(localOrder.lastModified || 0).getTime();
                                        const remoteTime = new Date(remoteOrder.lastModified || 0).getTime();

                                        if (remoteTime > localTime) {
                                            console.log(`üì¶ Merge items ordine #${localOrder.number}: uso remoto pi√π recente (${remoteOrder.items.length} items, modificato: ${remoteOrder.lastModified})`);
                                            localOrder.items = remoteOrder.items;
                                            hasChanges = true;
                                        } else if (localTime > remoteTime) {
                                            console.log(`üì¶ Merge items ordine #${localOrder.number}: mantengo locale pi√π recente (${localOrder.items.length} items, modificato: ${localOrder.lastModified})`);
                                            // Non fare nulla, mantieni locale
                                        } else {
                                            // Stesso timestamp ‚Üí prendi quello con pi√π items (caso raro)
                                            if (remoteOrder.items.length > localOrder.items.length) {
                                                console.log(`üì¶ Merge items ordine #${localOrder.number}: stesso timestamp, uso remoto con pi√π items`);
                                                localOrder.items = remoteOrder.items;
                                                hasChanges = true;
                                            }
                                        }
                                    }


                                    // ‚úÖ PREPARED ITEMS: Merge con unione (Set)
                                    const localPrepared = localOrder.preparedItems || [];
                                    const remotePrepared = remoteOrder.preparedItems || [];
                                    if (JSON.stringify(localPrepared) !== JSON.stringify(remotePrepared)) {
                                        // Unione: mantieni tutti gli item preparati da entrambi
                                        localOrder.preparedItems = [...new Set([...localPrepared, ...remotePrepared])];
                                        hasChanges = true;
                                    }

                                    // ‚úÖ PREP STATUS: Usa timestamp per decidere
                                    if (localOrder.prepStatus !== remoteOrder.prepStatus) {
                                        const localPrepTime = new Date(localOrder.prepStatusUpdatedAt || localOrder.lastModified || 0).getTime();
                                        const remotePrepTime = new Date(remoteOrder.prepStatusUpdatedAt || remoteOrder.lastModified || 0).getTime();

                                        if (remotePrepTime > localPrepTime) {
                                            localOrder.prepStatus = remoteOrder.prepStatus;
                                            localOrder.prepStatusUpdatedAt = remoteOrder.prepStatusUpdatedAt;
                                            hasChanges = true;
                                        }
                                    }

                                    // ‚úÖ PAYMENT STATUS: Usa timestamp per decidere
                                    if (localOrder.paymentStatus !== remoteOrder.paymentStatus) {
                                        const localPayTime = new Date(localOrder.paymentStatusUpdatedAt || localOrder.lastModified || 0).getTime();
                                        const remotePayTime = new Date(remoteOrder.paymentStatusUpdatedAt || remoteOrder.lastModified || 0).getTime();

                                        if (remotePayTime > localPayTime) {
                                            localOrder.paymentStatus = remoteOrder.paymentStatus;
                                            localOrder.paymentStatusUpdatedAt = remoteOrder.paymentStatusUpdatedAt;
                                            hasChanges = true;
                                        }
                                    }

                                    // ‚úÖ DEPOSIT: Prendi il pi√π recente
                                    if (localOrder.deposit !== remoteOrder.deposit) {
                                        localOrder.deposit = remoteOrder.deposit;
                                        hasChanges = true;
                                    }

                                    // ‚úÖ NOTES: Prendi il pi√π recente
                                    if (localOrder.notes !== remoteOrder.notes) {
                                        localOrder.notes = remoteOrder.notes;
                                        hasChanges = true;
                                    }

                                    // ‚úÖ LAST MODIFIED: Aggiorna sempre
                                    if (remoteOrder.lastModified) {
                                        localOrder.lastModified = remoteOrder.lastModified;
                                    }

                                    if (hasChanges) updatedOrders++;
                                }
                            } else {
                                // Ordine nuovo: aggiungilo
                                this.db.orders.push(remoteOrder);
                                addedOrders++;
                            }
                        });

                        // ========== MERGE PRODOTTI ==========
                        const localProductMap = new Map(this.db.products.map(p => [p.id, p]));
                        let addedProducts = 0;
                        let updatedProducts = 0;

                        remoteData.products.forEach(remoteProduct => {
                            const localProduct = localProductMap.get(remoteProduct.id);

                            if (localProduct) {
                                // Prodotto esiste

                                if (remoteProduct.deleted && !localProduct.deleted) {
                                    localProduct.deleted = true;
                                    localProduct.deletedAt = remoteProduct.deletedAt;
                                    updatedProducts++;
                                }
                                else if (!remoteProduct.deleted && !localProduct.deleted) {
                                    // Aggiorna solo se diverso
                                    const remoteStr = JSON.stringify(remoteProduct);
                                    const localStr = JSON.stringify(localProduct);

                                    if (remoteStr !== localStr) {
                                        // Aggiorna campi (escluso id)
                                        localProduct.name = remoteProduct.name;
                                        localProduct.category = remoteProduct.category;
                                        localProduct.price = remoteProduct.price;
                                        localProduct.unit = remoteProduct.unit;
                                        localProduct.weightPerPiece = remoteProduct.weightPerPiece;
                                        if (remoteProduct.lastModified) {
                                            localProduct.lastModified = remoteProduct.lastModified;
                                        }
                                        updatedProducts++;
                                    }
                                }
                            } else {
                                // Prodotto nuovo
                                this.db.products.push(remoteProduct);
                                addedProducts++;
                            }
                        });

                        // ========== MERGE CLIENTI ==========
                        const localCustomerMap = new Map(this.db.customers.map(c => [c.id, c]));
                        let addedCustomers = 0;
                        let updatedCustomers = 0;

                        remoteData.customers.forEach(remoteCustomer => {
                            const localCustomer = localCustomerMap.get(remoteCustomer.id);

                            if (localCustomer) {
                                // Cliente esiste

                                if (remoteCustomer.deleted && !localCustomer.deleted) {
                                    localCustomer.deleted = true;
                                    localCustomer.deletedAt = remoteCustomer.deletedAt;
                                    updatedCustomers++;
                                }
                                else if (!remoteCustomer.deleted && !localCustomer.deleted) {
                                    let hasChanges = false;

                                    // Aggiorna dati base
                                    if (localCustomer.firstName !== remoteCustomer.firstName) {
                                        localCustomer.firstName = remoteCustomer.firstName;
                                        hasChanges = true;
                                    }
                                    if (localCustomer.lastName !== remoteCustomer.lastName) {
                                        localCustomer.lastName = remoteCustomer.lastName;
                                        hasChanges = true;
                                    }
                                    if (localCustomer.phone !== remoteCustomer.phone) {
                                        localCustomer.phone = remoteCustomer.phone;
                                        hasChanges = true;
                                    }
                                    if (localCustomer.address !== remoteCustomer.address) {
                                        localCustomer.address = remoteCustomer.address;
                                        hasChanges = true;
                                    }

                                    // ‚úÖ FIDELITY: Merge intelligente (prendi MASSIMO)
                                    if (remoteCustomer.fidelity) {
                                        if (!localCustomer.fidelity) {
                                            localCustomer.fidelity = remoteCustomer.fidelity;
                                            hasChanges = true;
                                        } else {
                                            // Prendi il MASSIMO per ogni campo numerico
                                            const localStamps = localCustomer.fidelity.stamps || 0;
                                            const remoteStamps = remoteCustomer.fidelity.stamps || 0;
                                            if (remoteStamps > localStamps) {
                                                localCustomer.fidelity.stamps = remoteStamps;
                                                hasChanges = true;
                                            }

                                            const localRewards = localCustomer.fidelity.rewards || 0;
                                            const remoteRewards = remoteCustomer.fidelity.rewards || 0;
                                            if (remoteRewards > localRewards) {
                                                localCustomer.fidelity.rewards = remoteRewards;
                                                hasChanges = true;
                                            }

                                            const localSpent = localCustomer.fidelity.totalSpent || 0;
                                            const remoteSpent = remoteCustomer.fidelity.totalSpent || 0;
                                            if (remoteSpent > localSpent) {
                                                localCustomer.fidelity.totalSpent = remoteSpent;
                                                hasChanges = true;
                                            }

                                            // History: merge senza duplicati (usa date come chiave)
                                            const localHistoryMap = new Map((localCustomer.fidelity.history || []).map(h => [h.date, h]));
                                            (remoteCustomer.fidelity.history || []).forEach(h => {
                                                if (!localHistoryMap.has(h.date)) {
                                                    localCustomer.fidelity.history.push(h);
                                                    hasChanges = true;
                                                }
                                            });

                                            // RewardsList: merge senza duplicati
                                            const localRewardsSet = new Set((localCustomer.fidelity.rewardsList || []).map(r => r.date + r.type));
                                            (remoteCustomer.fidelity.rewardsList || []).forEach(r => {
                                                const key = r.date + r.type;
                                                if (!localRewardsSet.has(key)) {
                                                    localCustomer.fidelity.rewardsList = localCustomer.fidelity.rewardsList || [];
                                                    localCustomer.fidelity.rewardsList.push(r);
                                                    hasChanges = true;
                                                }
                                            });

                                            // CardSent: OR logico (se uno ha inviato, √® inviato)
                                            if (remoteCustomer.fidelity.cardSent && !localCustomer.fidelity.cardSent) {
                                                localCustomer.fidelity.cardSent = true;
                                                hasChanges = true;
                                            }
                                        }
                                    }

                                    // ‚úÖ COUPONS: Merge per id
                                    if (remoteCustomer.coupons && remoteCustomer.coupons.length > 0) {
                                        if (!localCustomer.coupons) {
                                            localCustomer.coupons = remoteCustomer.coupons;
                                            hasChanges = true;
                                        } else {
                                            const localCouponMap = new Map(localCustomer.coupons.map(c => [c.id, c]));
                                            remoteCustomer.coupons.forEach(rc => {
                                                if (!localCouponMap.has(rc.id)) {
                                                    localCustomer.coupons.push(rc);
                                                    hasChanges = true;
                                                }
                                            });
                                        }
                                    }

                                    // ‚úÖ LAST MODIFIED
                                    if (remoteCustomer.lastModified) {
                                        localCustomer.lastModified = remoteCustomer.lastModified;
                                    }

                                    if (hasChanges) updatedCustomers++;
                                }
                            } else {
                                // Cliente nuovo
                                this.db.customers.push(remoteCustomer);
                                addedCustomers++;
                            }
                        });

                        console.log(`‚úÖ Merge completato:`);
                        console.log(`   Ordini: +${addedOrders} nuovi, ${updatedOrders} aggiornati`);
                        console.log(`   Prodotti: +${addedProducts} nuovi, ${updatedProducts} aggiornati`);
                        console.log(`   Clienti: +${addedCustomers} nuovi, ${updatedCustomers} aggiornati`);

                        return true;
                    } catch (error) {
                        if (error.status === 409) {
                            console.log('‚ÑπÔ∏è Nessun file remoto da mergeare');
                            return true;
                        }
                        console.error('‚ùå Errore merge:', error);
                        return false;
                    }
                }

                async syncToDropbox(silent = false, retryCount = 0) {
                    if (!this.dropboxClient || !this.dropboxAccessToken) {
                        console.error('‚ùå Dropbox non configurato');
                        if (!silent) this.showToast('Dropbox non configurato', 'error');
                        return;
                    }

                    if (retryCount > 5) {
                        console.error('‚ùå Troppi tentativi di sincronizzazione falliti');
                        if (!silent) this.showToast('‚ùå Errore sincronizzazione: troppi conflitti', 'error');
                        return;
                    }

                    if (!authManager.password) {
                        console.error('‚ùå Password non disponibile per crittografia');
                        if (!silent) this.showToast('Errore: password non disponibile', 'error');
                        return;
                    }

                    if (this.syncInProgress) {
                        console.log('‚è≥ Sync gi√† in corso');
                        return;
                    }

                    try {
                        this.syncInProgress = true;
                        if (!silent) this.showSyncIndicator(true);

                        // PASSO 1: Ottieni revision corrente del file
                        let currentRev = null;
                        try {
                            const metadata = await this.dropboxClient.filesGetMetadata({
                                path: '/gestionale-ordini-backup.json'
                            });
                            currentRev = metadata.result.rev;
                            console.log('üìã Revision corrente:', currentRev);
                        } catch (metaErr) {
                            if (metaErr.status === 409) {
                                // File non esiste, primo upload
                                console.log('üìù Primo upload (file non esiste)');
                            } else {
                                throw metaErr;
                            }
                        }

                        // PASSO 2: MERGE con dati remoti
                        const mergeSuccess = await this.mergeWithRemoteData();
                        if (!mergeSuccess) {
                            console.error('‚ùå Merge fallito');
                            return;
                        }

                        console.log('üì§ Upload su Dropbox con crittografia...');

                        const dataToSync = {
                            ...this.db,
                            lastModified: new Date().toISOString()
                        };

                        const encryptedData = authManager.encrypt(dataToSync);
                        if (!encryptedData) {
                            throw new Error('Errore durante la crittografia dei dati');
                        }

                        const payload = {
                            encrypted: true,
                            version: '1.0',
                            data: encryptedData
                        };

                        const jsonData = JSON.stringify(payload);
                        const blob = new Blob([jsonData], { type: 'application/json' });

                        console.log('üì¶ Dimensione dati criptati:', (blob.size / 1024).toFixed(2), 'KB');

                        // PASSO 3: Upload con controllo revision
                        try {
                            const uploadParams = {
                                path: '/gestionale-ordini-backup.json',
                                contents: blob,
                                autorename: false
                            };

                            if (currentRev) {
                                // File esiste: usa mode 'update' con revision
                                uploadParams.mode = {
                                    '.tag': 'update',
                                    update: currentRev
                                };
                            } else {
                                // File non esiste: usa mode 'add'
                                uploadParams.mode = { '.tag': 'add' };
                            }

                            await this.dropboxClient.filesUpload(uploadParams);

                        } catch (uploadErr) {
                            // Conflitto rilevato: il file √® stato modificato da altro dispositivo
                            if (uploadErr.status === 409 || uploadErr.error?.error['.tag'] === 'conflict') {
                                console.log('‚ö†Ô∏è Conflitto rilevato! Un altro dispositivo ha modificato il file.');
                                console.log('üîÑ Riprovo con nuovo merge... (tentativo ' + (retryCount + 1) + '/5)');

                                // Aspetta un tempo casuale tra 500ms e 2000ms per ridurre conflitti
                                const waitTime = 500 + Math.random() * 1500;
                                await new Promise(resolve => setTimeout(resolve, waitTime));

                                return await this.syncToDropbox(silent, retryCount + 1);
                            }
                            throw uploadErr;
                        }

                        const now = new Date().toISOString();
                        localStorage.setItem('lastDropboxSync', now);
                        localStorage.setItem('lastModified', dataToSync.lastModified);

                        this.updateLastSyncInfo();

                        if (!silent) this.showToast('‚úÖ Dati criptati caricati su Dropbox!');
                        console.log('‚úÖ Upload completato con successo' + (retryCount > 0 ? ` (dopo ${retryCount} retry)` : ''));

                    } catch (err) {
                        console.error('‚ùå Errore upload Dropbox:', err);

                        if (err?.error?.error_summary?.includes("expired_access_token") && this.dropboxRefreshToken) {
                            console.log('üîÑ Token scaduto, rinnovo automatico...');
                            const nuovoToken = await this.rinnovaAccessToken();
                            if (nuovoToken) {
                                console.log('üîÅ Riprovo upload...');
                                await this.syncToDropbox(silent, retryCount);
                                return;
                            }
                        }

                        if (!silent) this.showToast('‚ùå Errore caricamento su Dropbox', 'error');
                    } finally {
                        this.syncInProgress = false;
                        if (!silent) this.showSyncIndicator(false);
                    }
                }

                // ========== SISTEMA DI LOCK PER ORDINI SIMULTANEI ==========

                async acquireLock() {
                    const lockData = {
                        locked: true,
                        device: /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'Smartphone/Tablet' : 'PC',
                        timestamp: new Date().toISOString(),
                        sessionId: Math.random().toString(36).substring(7) // ID univoco
                    };

                    try {
                        // ‚úÖ USA 'add' invece di 'overwrite' - fallisce se lock esiste gi√†
                        await this.dropboxClient.filesUpload({
                            path: '/order-lock.json',
                            contents: new Blob([JSON.stringify(lockData)], { type: 'application/json' }),
                            mode: { '.tag': 'add' },
                            autorename: false
                        });

                        // ‚úÖ Verifica che il lock sia veramente nostro
                        await new Promise(resolve => setTimeout(resolve, 500)); // Piccola pausa
                        const verifyLock = await this.checkLock();

                        if (verifyLock && verifyLock.sessionId === lockData.sessionId) {
                            console.log('üîí Lock acquisito e verificato:', lockData.device);
                            this.currentLockSessionId = lockData.sessionId; // Salva per rilascio
                            return true;
                        } else {
                            console.error('‚ùå Lock acquisito ma verification failed');
                            return false;
                        }
                    } catch (err) {
                        // Lock gi√† esistente o altro errore
                        console.log('‚ö†Ô∏è Lock gi√† presente o errore:', err.error?.error_summary || err.message);
                        return false;
                    }
                }

                async releaseLock() {
                    try {
                        // ‚úÖ Verifica che il lock sia nostro prima di rimuoverlo
                        const currentLock = await this.checkLock();
                        if (currentLock && currentLock.sessionId === this.currentLockSessionId) {
                            await this.dropboxClient.filesDeleteV2({ path: '/order-lock.json' });
                            console.log('üîì Lock rilasciato');
                        } else {
                            console.log('‚ö†Ô∏è Lock non nostro, non lo rimuovo');
                        }
                        this.currentLockSessionId = null;
                    } catch (err) {
                        // Lock gi√† rimosso o non esiste
                        console.log('‚ÑπÔ∏è Lock gi√† rilasciato o errore');
                        this.currentLockSessionId = null;
                    }
                }

                // ‚úÖ HELPER: Esegui operazione con lock automatico
                async withLock(operation, operationName = 'operazione') {
                    console.log(`üîí Acquisizione lock per ${operationName}...`);
                    let lockAcquired = false;
                    let retryCount = 0;
                    const maxRetries = 3;

                    while (!lockAcquired && retryCount < maxRetries) {
                        const canProceed = await this.waitForLock(10000);
                        if (!canProceed) {
                            this.showToast(`‚ùå Timeout: altro dispositivo occupato. Riprova!`, 'error');
                            return false;
                        }

                        lockAcquired = await this.acquireLock();
                        if (!lockAcquired) {
                            retryCount++;
                            console.log(`‚ö†Ô∏è Lock non acquisito, riprovo... (${retryCount}/${maxRetries})`);
                            this.showToast(`‚è≥ Attesa sincronizzazione... (${retryCount}/${maxRetries})`, 'info');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }

                    if (!lockAcquired) {
                        this.showToast(`‚ùå Impossibile acquisire lock. Riprova!`, 'error');
                        return false;
                    }

                    try {
                        console.log(`üîí‚úÖ Lock acquisito per ${operationName}`);

                        // Sincronizza PRIMA dell'operazione
                        await this.syncFromDropboxSilent();

                        // Esegui l'operazione
                        const result = await operation();

                        // Salva e sincronizza
                        this.saveData();
                        await this.syncToDropbox(true);

                        return result !== false;
                    } catch (error) {
                        console.error(`‚ùå Errore in ${operationName}:`, error);
                        this.showToast(`‚ùå Errore durante ${operationName}`, 'error');
                        return false;
                    } finally {
                        await this.releaseLock();
                    }
                }

                async checkLock() {
                    try {
                        const response = await this.dropboxClient.filesDownload({ path: '/order-lock.json' });
                        const blob = response.result.fileBlob;
                        const text = await blob.text();
                        const lockData = JSON.parse(text);

                        // Timeout: se lock > 30 secondi, consideralo scaduto
                        const lockAge = Date.now() - new Date(lockData.timestamp).getTime();
                        if (lockAge > 30000) {
                            console.log('‚è∞ Lock scaduto, lo rimuovo');
                            await this.releaseLock();
                            return null;
                        }

                        return lockData;
                    } catch (err) {
                        return null; // Nessun lock attivo
                    }
                }

                async waitForLock(maxWait = 30000) {
                    const startTime = Date.now();
                    let attempts = 0;

                    while (Date.now() - startTime < maxWait) {
                        const lock = await this.checkLock();
                        if (!lock) {
                            console.log('‚úÖ Lock libero, procedo');
                            return true; // Lock libero
                        }

                        attempts++;
                        console.log(`‚è≥ Attesa lock... tentativo ${attempts}`);
                        this.showToast(`‚è≥ Attendi... ${lock.device} sta salvando ordine`, 'info');
                        await new Promise(resolve => setTimeout(resolve, 2000)); // Controlla ogni 2 secondi
                    }

                    console.log('‚ùå Timeout attesa lock');
                    return false; // Timeout
                }
                toggleAutoSync() {
                    this.autoSyncEnabled = document.getElementById('auto-sync-toggle').checked;
                    localStorage.setItem('autoSync', this.autoSyncEnabled);

                    if (this.autoSyncEnabled && !this.dropboxClient) {
                        this.showToast('Configura prima Dropbox', 'error');
                        document.getElementById('auto-sync-toggle').checked = false;
                        this.autoSyncEnabled = false;
                        return;
                    }

                    const status = this.autoSyncEnabled ? 'attivata' : 'disattivata';
                    this.showToast(`Sincronizzazione automatica ${status}`);

                    if (this.autoSyncEnabled) {
                        this.syncToDropbox();
                        this.startAutoSync();
                    } else {
                        this.stopAutoSync();
                    }
                }

                startAutoSync() {
                    // Ferma eventuali intervalli precedenti
                    this.stopAutoSync();

                    console.log('üöÄ Avvio sincronizzazione automatica...');
                    console.log('‚è∞ Intervallo: controllo ogni 10 secondi');
                    console.log('üì± Dispositivo:', navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop');

                    // Controlla aggiornamenti ogni 10 secondi
                    this.autoSyncInterval = setInterval(() => {
                        console.log('‚è∞ Timer scattato - controllo aggiornamenti...');
                        if (!this.syncInProgress && this.dropboxClient) {
                            this.checkForRemoteUpdates();
                        } else {
                            console.log('‚è≠Ô∏è Skip: syncing=' + this.syncInProgress + ', client=' + !!this.dropboxClient);
                        }
                    }, 10000); // 10 secondi

                    console.log('‚úÖ Sincronizzazione automatica avviata (ID:', this.autoSyncInterval, ')');

                    // Esegui subito un primo controllo
                    console.log('üîÑ Primo controllo immediato...');
                    setTimeout(() => {
                        if (!this.syncInProgress && this.dropboxClient) {
                            this.checkForRemoteUpdates();
                        }
                    }, 2000); // Dopo 2 secondi dall'avvio
                }


                stopAutoSync() {
                    if (this.autoSyncInterval) {
                        clearInterval(this.autoSyncInterval);
                        this.autoSyncInterval = null;
                        console.log('üõë Sincronizzazione automatica fermata');
                    }
                }

                async checkForRemoteUpdates() {
                    console.log('üîç checkForRemoteUpdates chiamato');
                    console.log('üìä Stato flags:', {
                        modalOpen: this.modalOpen,
                        editingFidelity: this.editingFidelity,
                        syncInProgress: this.syncInProgress,
                        dropboxClient: !!this.dropboxClient
                    });

                    if (this.modalOpen) {
                        console.log('‚è∏Ô∏è Modal aperto, skip autosync');
                        return;
                    }

                    if (this.editingFidelity) {
                        console.log('‚è∏Ô∏è Modifica fidelity in corso, skip autosync');
                        return;
                    }

                    if (!this.dropboxClient || this.syncInProgress) {
                        console.log('‚è≠Ô∏è Skip check: client=', !!this.dropboxClient, 'syncing=', this.syncInProgress);
                        return;
                    }

                    try {
                        console.log('‚úÖ Procedo con auto-sync');
                        await this.syncFromDropboxSilent();
                    } catch (err) {
                        console.log('‚ö†Ô∏è Errore controllo aggiornamenti:', err.message);
                    }
                }

                async syncFromDropbox(silent = false) {
                    console.log('üì• syncFromDropbox chiamata - silent:', silent);

                    if (!this.dropboxClient) {
                        console.error('‚ùå dropboxClient non inizializzato');
                        if (!silent) this.showToast('Configura prima Dropbox', 'error');
                        return;
                    }

                    if (this.syncInProgress) {
                        console.log('‚è≥ Sync gi√† in corso, ignoro');
                        return;
                    }

                    try {
                        this.syncInProgress = true;
                        if (!silent) this.showSyncIndicator(true);

                        console.log('üì• Download da Dropbox...');
                        const response = await this.dropboxClient.filesDownload({
                            path: '/gestionale-ordini-backup.json'
                        });

                        // ‚úÖ CORREZIONE: Verifica che response.result esista
                        if (!response || !response.result || !response.result.fileBlob) {
                            throw new Error('Risposta Dropbox non valida o file non trovato');
                        }

                        const blob = response.result.fileBlob;
                        const text = await blob.text();
                        const parsedData = JSON.parse(text);

                        let datiRemoti;
                        if (parsedData.encrypted) {
                            // Dati criptati, decripta
                            console.log('üîì Decrittazione dati da Dropbox...');
                            datiRemoti = authManager.decrypt(parsedData.data);
                            if (!datiRemoti) {
                                throw new Error('Errore decrittazione dati da Dropbox');
                            }
                        } else {
                            // Dati non criptati (vecchio formato), usa direttamente
                            datiRemoti = parsedData;
                        }

                        // Dati locali con timestamp
                        const datiLocali = {
                            ...this.db,
                            lastModified: this.db.lastModified || localStorage.getItem('lastModified') || new Date(0).toISOString()
                        };

                        const dataLocale = new Date(datiLocali.lastModified);
                        const dataRemota = new Date(datiRemoti.lastModified || 0);

                        console.log('üìÖ Timestamp locale:', datiLocali.lastModified);
                        console.log('üìÖ Timestamp remoto:', datiRemoti.lastModified);

                        if (dataRemota > dataLocale) {
                            // Dati remoti pi√π recenti
                            console.log('üÜï Dati remoti pi√π recenti');

                            this.db = datiRemoti;
                            if (!this.db.categories) this.db.categories = [];

                            // Salva i dati criptati localmente
                            this.saveData();
                            localStorage.setItem('lastModified', datiRemoti.lastModified);

                            this.render();
                            this.renderDashboard();
                            this.renderPreparation();
                            this.updateStats();

                            if (!silent) this.showToast('‚úÖ Dati scaricati da Dropbox!');
                            console.log('‚úÖ Dati aggiornati da remoto');

                        } else if (dataLocale > dataRemota) {
                            // Dati locali pi√π recenti, carica su Dropbox
                            console.log('üì§ Dati locali pi√π recenti, carico su Dropbox...');

                            await this.syncToDropbox(true);
                            if (!silent) this.showToast('‚úÖ Dati locali caricati su Dropbox!');

                        } else {
                            // Dati identici
                            console.log('‚úÖ Dati gi√† sincronizzati');
                            if (!silent) this.showToast('‚úÖ Dati gi√† sincronizzati!');
                        }

                        const now = new Date().toISOString();
                        localStorage.setItem('lastDropboxSync', now);
                        this.updateLastSyncInfo();

                    } catch (err) {
                        console.error('‚ùå Errore download Dropbox:', err);

                        if (err.status === 401 && this.dropboxRefreshToken) {
                            // Token scaduto, rinnova e riprova
                            console.log('üîÑ Token scaduto, rinnovo e riprovo...');
                            const nuovoToken = await this.rinnovaAccessToken();
                            if (nuovoToken) {
                                await this.syncFromDropbox(silent);
                                return;
                            }
                        } else if (err.status === 409) {
                            // File non esiste, crealo
                            console.log('üì§ File non esiste su Dropbox, lo creo...');
                            await this.syncToDropbox(silent);
                            if (!silent) this.showToast('‚úÖ Backup creato su Dropbox!');
                        } else if (err.message && err.message.includes('Password errata')) {
                            // Errore specifico di decrittazione
                            if (!silent) this.showToast('‚ùå Password errata: impossibile decrittare i dati Dropbox', 'error');
                        } else {
                            if (!silent) this.showToast('‚ùå Errore download da Dropbox', 'error');
                        }
                    } finally {
                        this.syncInProgress = false;
                        if (!silent) this.showSyncIndicator(false);
                    }
                }

                async syncFromDropboxSilent() {
                    if (!this.dropboxClient || !authManager.password) {
                        console.log('‚è≠Ô∏è Skip sync silente: client o password mancanti');
                        return;
                    }

                    // üîê Evita sincronizzazioni parallele
                    if (this.syncInProgress) {
                        console.log('‚è≠Ô∏è Sync silente ignorata: sync gi√† in corso');
                        return;
                    }

                    this.syncInProgress = true;

                    try {
                        console.log('üîÑ Sync silente da Dropbox...');

                        const response = await this.dropboxClient.filesDownload({
                            path: '/gestionale-ordini-backup.json'
                        });

                        // Verifica risposta Dropbox
                        if (!response || !response.result || !response.result.fileBlob) {
                            console.log('‚ö†Ô∏è File non trovato o risposta non valida');
                            return;
                        }

                        const blob = response.result.fileBlob;
                        const text = await blob.text();
                        const parsedData = JSON.parse(text);

                        let datiRemoti;
                        if (parsedData.encrypted) {
                            // üîì Decrittazione
                            datiRemoti = authManager.decrypt(parsedData.data);
                            if (!datiRemoti) {
                                console.error('‚ùå Impossibile decrittare dati remoti');
                                return;
                            }
                        } else {
                            datiRemoti = parsedData;
                        }

                        // Dati locali
                        const datiLocali = {
                            ...this.db,
                            lastModified: this.db.lastModified ||
                                localStorage.getItem('lastModified') ||
                                new Date(0).toISOString()
                        };

                        const dataLocale = new Date(datiLocali.lastModified);
                        const dataRemota = new Date(datiRemoti.lastModified || 0);

                        console.log('üìÖ Timestamp locale:', datiLocali.lastModified);
                        console.log('üìÖ Timestamp remoto:', datiRemoti.lastModified);

                        // MERGE SEMPRE, indipendentemente dal timestamp!
                        if (dataRemota > dataLocale) {
                            console.log('üÜï Dati remoti pi√π recenti, faccio merge...');
                        } else if (dataRemota.getTime() === dataLocale.getTime()) {
                            console.log('‚öñÔ∏è Timestamp uguali, faccio merge...');
                        } else {
                            console.log('‚ÑπÔ∏è Dati locali pi√π recenti, faccio merge comunque...');
                        }

                        // Salva i dati locali PRIMA di sovrascrivere
                        const oldLocalData = {
                            orders: [...this.db.orders],
                            products: [...this.db.products],
                            customers: [...this.db.customers]
                        };

                        // Carica dati remoti
                        this.db = datiRemoti;
                        if (!this.db.categories) this.db.categories = [];

                        // ===== MERGE INTELLIGENTE: Confronta timestamp di ogni elemento =====

                        // ORDINI: Merge con confronto timestamp
                        const mergedOrders = new Map();

                        // 1. Aggiungi ordini remoti
                        this.db.orders.forEach(order => {
                            mergedOrders.set(order.id, { ...order, source: 'remote' });
                        });

                        // 2. Sovrascrivi con ordini locali se pi√π recenti o solo locali
                        oldLocalData.orders.forEach(localOrder => {
                            const remoteOrder = mergedOrders.get(localOrder.id);

                            if (!remoteOrder) {
                                // Ordine solo locale ‚Üí mantienilo
                                mergedOrders.set(localOrder.id, { ...localOrder, source: 'local-only' });
                            } else {
                                // Ordine in entrambi ‚Üí confronta timestamp
                                const localTime = new Date(localOrder.deletedAt || localOrder.createdDate || 0).getTime();
                                const remoteTime = new Date(remoteOrder.deletedAt || remoteOrder.createdDate || 0).getTime();

                                if (localTime >= remoteTime) {
                                    // Locale pi√π recente o uguale ‚Üí usa locale
                                    mergedOrders.set(localOrder.id, { ...localOrder, source: 'local-newer' });
                                }
                                // Altrimenti mantieni remoto (gi√† in map)
                            }
                        });

                        // Rimuovi la propriet√† 'source' prima di salvare (serve solo per il debug)
                        this.db.orders = Array.from(mergedOrders.values()).map(order => {
                            const { source, ...cleanOrder } = order;
                            return cleanOrder;
                        });

                        // PRODOTTI: Stesso merge intelligente
                        const mergedProducts = new Map();
                        this.db.products.forEach(product => {
                            mergedProducts.set(product.id, { ...product, source: 'remote' });
                        });
                        oldLocalData.products.forEach(localProduct => {
                            const remoteProduct = mergedProducts.get(localProduct.id);
                            if (!remoteProduct) {
                                mergedProducts.set(localProduct.id, { ...localProduct, source: 'local-only' });
                            } else {
                                const localTime = new Date(localProduct.deletedAt || localProduct.createdAt || 0).getTime();
                                const remoteTime = new Date(remoteProduct.deletedAt || remoteProduct.createdAt || 0).getTime();
                                if (localTime >= remoteTime) {
                                    mergedProducts.set(localProduct.id, { ...localProduct, source: 'local-newer' });
                                }
                            }
                        });

                        this.db.products = Array.from(mergedProducts.values()).map(product => {
                            const { source, ...cleanProduct } = product;
                            return cleanProduct;
                        });

                        // CLIENTI: Stesso merge intelligente
                        const mergedCustomers = new Map();
                        this.db.customers.forEach(customer => {
                            mergedCustomers.set(customer.id, { ...customer, source: 'remote' });
                        });
                        oldLocalData.customers.forEach(localCustomer => {
                            const remoteCustomer = mergedCustomers.get(localCustomer.id);
                            if (!remoteCustomer) {
                                mergedCustomers.set(localCustomer.id, { ...localCustomer, source: 'local-only' });
                            } else {
                                const localTime = new Date(localCustomer.lastModified || localCustomer.deletedAt || localCustomer.createdAt || 0).getTime();
                                const remoteTime = new Date(remoteCustomer.lastModified || remoteCustomer.deletedAt || remoteCustomer.createdAt || 0).getTime();
                                if (localTime >= remoteTime) {
                                    mergedCustomers.set(localCustomer.id, { ...localCustomer, source: 'local-newer' });
                                }
                            }
                        });

                        this.db.customers = Array.from(mergedCustomers.values()).map(customer => {
                            const { source, ...cleanCustomer } = customer;
                            return cleanCustomer;
                        });

                        // Conta quanti elementi SOLO locali (non presenti su remoto)
                        const localOnlyOrders = Array.from(mergedOrders.values()).filter(o => o.source === 'local-only').length;
                        const localOnlyProducts = Array.from(mergedProducts.values()).filter(p => p.source === 'local-only').length;
                        const localOnlyCustomers = Array.from(mergedCustomers.values()).filter(c => c.source === 'local-only').length;

                        console.log(`üîÄ Merge completato: ${this.db.orders.length} ordini totali (${localOnlyOrders} solo locali), ${this.db.products.length} prodotti, ${this.db.customers.length} clienti`);
                        // Aggiorna timestamp solo se remoto √® pi√π recente
                        const newTimestamp = dataRemota > dataLocale ? datiRemoti.lastModified : datiLocali.lastModified;
                        this.db.lastModified = newTimestamp;

                        // ‚úÖ FIX SCROLL: Confronto intelligente basato su hash degli ID
                        const createHash = (arr) => {
                            // Crea una stringa ordinata con ID e timestamp per confronto veloce
                            return arr.map(item => `${item.id}:${item.deletedAt || item.lastModified || item.createdAt || item.createdDate || ''}`).sort().join('|');
                        };

                        const oldOrdersHash = createHash(oldLocalData.orders);
                        const newOrdersHash = createHash(this.db.orders);
                        const oldProductsHash = createHash(oldLocalData.products);
                        const newProductsHash = createHash(this.db.products);
                        const oldCustomersHash = createHash(oldLocalData.customers);
                        const newCustomersHash = createHash(this.db.customers);

                        const ordersChanged = oldOrdersHash !== newOrdersHash;
                        const productsChanged = oldProductsHash !== newProductsHash;
                        const customersChanged = oldCustomersHash !== newCustomersHash;

                        // ‚úÖ Se √® il primo caricamento (localStorage vuoto), forza render
                        const isFirstLoad = !localStorage.getItem('orderManagerData') || oldLocalData.orders.length === 0;

                        const hasChanges = ordersChanged || productsChanged || customersChanged || isFirstLoad;


                        if (!hasChanges) {
                            console.log('‚ÑπÔ∏è Nessun cambiamento, skip render');

                            // Salva comunque (potrebbero esserci aggiornamenti di stato)
                            const encrypted = authManager.encrypt(this.db);
                            if (encrypted) {
                                localStorage.setItem('orderManagerData', encrypted);
                                localStorage.setItem('lastModified', newTimestamp);
                            }

                            const now = new Date().toISOString();
                            localStorage.setItem('lastDropboxSync', now);
                            this.updateLastSyncInfo();

                            console.log('‚úÖ Dati sincronizzati da Dropbox (silent) - no render');
                            return; // Exit PRIMA del render
                        }

                        // Se arriviamo qui, ci sono cambiamenti ‚Üí fai render
                        console.log('üîÑ Cambiamenti rilevati, faccio render');

                        // Salva criptato
                        const encrypted = authManager.encrypt(this.db);
                        if (encrypted) {
                            localStorage.setItem('orderManagerData', encrypted);
                            localStorage.setItem('lastModified', newTimestamp);
                        }

                        const now = new Date().toISOString();
                        localStorage.setItem('lastDropboxSync', now);
                        this.updateLastSyncInfo();

                        // Salva posizione scroll
                        const scrollPos = window.scrollY;

                        this.render();
                        this.renderDashboard();
                        this.renderPreparation();
                        this.updateStats();

                        // Ripristina posizione scroll
                        setTimeout(() => window.scrollTo(0, scrollPos), 50);

                        console.log('‚úÖ Dati sincronizzati da Dropbox (silent)');

                    } catch (error) {

                        console.error('‚ùå Errore sync silent:', error);

                        // Token scaduto ‚Üí rinnova
                        if (error.status === 401 && this.dropboxRefreshToken) {
                            console.log('üîÑ Token scaduto, rinnovo...');
                            await this.rinnovaAccessToken();

                            // File non trovato ‚Üí creiamo il backup
                        } else if (error.status === 409) {
                            console.log('üì§ File non esiste su Dropbox, lo creo (silent)...');
                            await this.syncToDropbox(true);

                        } else {
                            console.log('‚ö†Ô∏è Errore sync silent:', error.message);
                        }

                    } finally {
                        // üîì Rilascia il blocco
                        this.syncInProgress = false;
                    }
                }

                showSyncIndicator(show) {
                    const indicator = document.getElementById('sync-indicator');
                    if (show) {
                        indicator.classList.remove('hidden');
                    } else {
                        indicator.classList.add('hidden');
                    }
                }

                checkDropboxStatus() {
                    const statusDiv = document.getElementById('dropbox-status');
                    const configDiv = document.getElementById('dropbox-config');

                    if (this.dropboxClient) {
                        statusDiv.innerHTML = `
            <div class="bg-green-50 border-l-4 border-green-500 p-4">
                <div class="flex items-start">
                    <svg class="w-6 h-6 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="font-semibold text-green-800">‚úÖ Dropbox Connesso</p>
                        <p class="text-sm text-green-700 mt-1">La sincronizzazione √® attiva</p>
                        <button onclick="app.disconnectDropbox()" class="mt-2 text-sm text-green-800 underline hover:text-green-900">Disconnetti</button>
                    </div>
                </div>
            </div>
        `;
                        configDiv.classList.add('hidden');
                    } else {
                        statusDiv.innerHTML = `
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                <div class="flex items-start">
                    <svg class="w-6 h-6 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-blue-800">üì¶ Dropbox non connesso</p>
                        <p class="text-sm text-blue-700 mt-1">Segui le istruzioni qui sotto per collegare Dropbox</p>
                    </div>
                </div>
            </div>
        `;
                        configDiv.classList.remove('hidden');
                    }
                }

                disconnectDropbox() {
                    if (confirm('Sei sicuro di voler disconnettere Dropbox?')) {
                        localStorage.removeItem('dropboxAccessToken');
                        localStorage.removeItem('dropboxRefreshToken');
                        this.dropboxClient = null;
                        this.dropboxAccessToken = null;
                        this.dropboxRefreshToken = null;

                        // Disattiva auto-sync
                        this.autoSyncEnabled = false;
                        localStorage.setItem('autoSyncEnabled', 'false');  // ‚Üê Cambiato qui
                        this.stopAutoSync();

                        this.checkDropboxStatus();
                        this.showToast('‚úÖ Dropbox disconnesso');
                    }
                }

                // BACKUP LOCALE
                downloadLocalBackup() {
                    const dataStr = JSON.stringify(this.db, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const timestamp = new Date().toISOString().split('T')[0];
                    a.download = `gestionale-ordini-${timestamp}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showToast('‚úÖ Backup locale scaricato!');
                }

                loadLocalBackup(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.products && data.customers && data.orders) {
                                const confirm = window.confirm(
                                    `Backup trovato:\n\n` +
                                    `üì¶ ${data.orders?.length || 0} ordini\n` +
                                    `üõçÔ∏è ${data.products?.length || 0} prodotti\n` +
                                    `üë• ${data.customers?.length || 0} clienti\n\n` +
                                    `Importare?`
                                );
                                if (confirm) {
                                    this.db = data;
                                    if (!this.db.categories) this.db.categories = [];
                                    this.saveData();
                                    this.render();
                                    this.showToast('‚úÖ Backup caricato!');

                                    // Sync automatico su Dropbox se attivo
                                    if (this.autoSyncEnabled) {
                                        this.syncToDropbox(true);
                                    }
                                }
                            } else this.showToast('‚ùå File non valido', 'error');
                        } catch (err) {
                            this.showToast('‚ùå Errore lettura', 'error');
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                }

                // DATA MANAGEMENT
                loadData() {
                    const data = localStorage.getItem('orderManagerData');
                    if (!data) {
                        console.log('‚ÑπÔ∏è Nessun dato locale trovato');
                        this.db = { products: [], customers: [], orders: [], categories: [], campaigns: [] };
                        return;
                    }

                    // Controlla se la password √® disponibile
                    if (!authManager.password) {
                        console.log('‚è≥ Password non ancora disponibile, attendo login...');
                        this.db = { products: [], customers: [], orders: [], categories: [], campaigns: [] };
                        return;
                    }

                    // Prova a decrittare (nuovo formato)
                    const decryptedData = authManager.decrypt(data);

                    if (decryptedData) {
                        console.log('üîì Dati locali decrittati con successo');
                        this.db = decryptedData;
                    } else {
                        // Prova formato vecchio (JSON non criptato) - RETROCOMPATIBILIT√Ä
                        try {
                            console.log('‚ö†Ô∏è Tentativo caricamento dati non criptati (vecchio formato)');
                            this.db = JSON.parse(data);

                            // Ricripta immediatamente con la nuova password
                            console.log('üîê Migrazione dati al formato criptato...');
                            this.saveData();

                        } catch (e) {
                            console.error('‚ùå Errore caricamento dati:', e);
                            console.error('‚ùå I dati sembrano criptati ma la password non li decripta');
                            this.db = { products: [], customers: [], orders: [], categories: [], campaigns: [] };
                        }
                    }

                    // Inizializza categorie se mancano
                    if (!this.db.categories) {
                        this.db.categories = [];
                    }

                    // Inizializza campaigns se mancano
                    if (!this.db.campaigns) {
                        this.db.campaigns = [];
                    }

                    // Inizializza fidelityConfig se manca
                    if (!this.db.fidelityConfig) {
                        this.db.fidelityConfig = {
                            stampsPerReward: 10,
                            eurosPerStamp: 20
                        };
                    }

                    // Inizializza fidelity e coupons per clienti esistenti
                    if (this.db.customers) {
                        this.db.customers.forEach(c => {
                            if (!c.fidelity) {
                                c.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [], rewardsList: [] };
                            }
                            // Aggiungi rewardsList se manca
                            if (c.fidelity && !c.fidelity.rewardsList) {
                                c.fidelity.rewardsList = [];
                            }
                            // Inizializza coupons se manca
                            if (!c.coupons) {
                                c.coupons = [];
                            }
                        });
                    }

                    console.log('‚úÖ Dati caricati:', {
                        ordini: this.db.orders?.length || 0,
                        prodotti: this.db.products?.length || 0,
                        clienti: this.db.customers?.length || 0
                    });
                }

                loadFidelityConfig() {
                    const config = localStorage.getItem('fidelityConfig');
                    if (config) {
                        this.fidelityConfig = JSON.parse(config);
                    }
                    // Carica valori nei campi
                    if (document.getElementById('business-name')) {
                        document.getElementById('business-name').value = this.fidelityConfig.businessName;
                        document.getElementById('euros-per-stamp').value = this.fidelityConfig.eurosPerStamp;
                        document.getElementById('stamps-per-reward').value = this.fidelityConfig.stampsPerReward;
                        document.getElementById('whatsapp-group').value = this.fidelityConfig.whatsappGroup || '';
                    }
                }

                saveFidelityConfig() {
                    this.fidelityConfig = {
                        businessName: document.getElementById('business-name').value.trim() || 'La Mia Attivit√†',
                        eurosPerStamp: parseInt(document.getElementById('euros-per-stamp').value) || 20,
                        stampsPerReward: parseInt(document.getElementById('stamps-per-reward').value) || 10,
                        whatsappGroup: document.getElementById('whatsapp-group').value.trim()
                    };
                    localStorage.setItem('fidelityConfig', JSON.stringify(this.fidelityConfig));
                    this.showToast('‚úÖ Configurazione salvata!');
                }

                // FIDELITY CARD FUNCTIONS
                calculateStamps(amount) {
                    return Math.floor(amount / this.fidelityConfig.eurosPerStamp);
                }

                async addStampsDirectly(customerId, stampsToAdd) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;

                    if (!customer.fidelity) {
                        customer.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [], cardSent: false };
                    }

                    if (stampsToAdd > 0) {
                        // ‚úÖ ACQUISISCI LOCK PER EVITARE RACE CONDITIONS
                        console.log('üîí Acquisizione lock fidelity per addStampsDirectly...');
                        let lockAcquired = false;
                        let retryCount = 0;
                        const maxRetries = 3;

                        while (!lockAcquired && retryCount < maxRetries) {
                            const canProceed = await this.waitForLock(10000);
                            if (!canProceed) {
                                this.showToast('‚ùå Timeout bollini: altro dispositivo occupato. Riprova!', 'error');
                                return;
                            }

                            lockAcquired = await this.acquireLock();
                            if (!lockAcquired) {
                                retryCount++;
                                console.log(`‚ö†Ô∏è Lock non acquisito, riprovo... (${retryCount}/${maxRetries})`);
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }

                        if (!lockAcquired) {
                            this.showToast('‚ùå Impossibile aggiungere bollini. Riprova!', 'error');
                            return;
                        }

                        try {
                            // Sincronizza PRIMA di modificare
                            await this.syncFromDropboxSilent();

                            // Ricarica il cliente aggiornato
                            const updatedCustomer = this.db.customers.find(c => c.id === customerId);
                            if (!updatedCustomer) return;

                            updatedCustomer.fidelity.stamps += stampsToAdd;
                            updatedCustomer.fidelity.history.push({
                                date: new Date().toISOString(),
                                type: 'earned',
                                stamps: stampsToAdd,
                                amount: 0
                            });

                            const rewardsEarned = Math.floor(updatedCustomer.fidelity.stamps / this.fidelityConfig.stampsPerReward);
                            if (rewardsEarned > updatedCustomer.fidelity.rewards) {
                                const newRewards = rewardsEarned - updatedCustomer.fidelity.rewards;
                                updatedCustomer.fidelity.rewards = rewardsEarned;
                                updatedCustomer.fidelity.stamps = updatedCustomer.fidelity.stamps % this.fidelityConfig.stampsPerReward;

                                this.showToast(`üéÅ ${updatedCustomer.firstName} ha guadagnato ${newRewards} premio/i!`);
                            }

                            this.saveData();
                            await this.syncToDropbox(true);

                        } catch (error) {
                            console.error('‚ùå Errore addStampsDirectly:', error);
                            this.showToast('‚ùå Errore aggiunta bollini', 'error');
                        } finally {
                            await this.releaseLock();
                        }
                    }
                }

                // Funzione per aggiungere bollini direttamente (senza calcolo da importo)
                addStampsDirectly(customerId, stampsToAdd) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;

                    if (!customer.fidelity) {
                        customer.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [], cardSent: false };
                    }

                    if (stampsToAdd > 0) {
                        customer.fidelity.stamps += stampsToAdd;
                        customer.fidelity.history.push({
                            date: new Date().toISOString(),
                            type: 'earned',
                            stamps: stampsToAdd,
                            amount: 0 // Non c'√® un importo specifico
                        });

                        // Controlla se ha raggiunto un premio
                        const rewardsEarned = Math.floor(customer.fidelity.stamps / this.fidelityConfig.stampsPerReward);
                        if (rewardsEarned > customer.fidelity.rewards) {
                            const newRewards = rewardsEarned - customer.fidelity.rewards;
                            customer.fidelity.rewards = rewardsEarned;
                            customer.fidelity.stamps = customer.fidelity.stamps % this.fidelityConfig.stampsPerReward;

                            this.showToast(`üéÅ ${customer.firstName} ha guadagnato ${newRewards} premio/i!`);
                        }

                        this.saveData();
                    }
                }

                openFidelityCard(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;

                    if (!customer.fidelity) {
                        customer.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [] };
                    }

                    const stampsNeeded = this.fidelityConfig.stampsPerReward;
                    const currentStamps = customer.fidelity.stamps;
                    const progress = (currentStamps / stampsNeeded) * 100;

                    let historyHTML = '';
                    if (customer.fidelity.history && customer.fidelity.history.length > 0) {
                        const recentHistory = customer.fidelity.history.slice(-10).reverse();
                        historyHTML = recentHistory.map(h => {
                            const date = new Date(h.date).toLocaleDateString('it-IT');
                            const icon = h.type === 'earned' ? '‚úÖ' : 'üéÅ';
                            const text = h.type === 'earned' ? `+${h.stamps} bollini (‚Ç¨${h.amount.toFixed(2)})` : `Premio riscattato`;
                            return `<div class="flex justify-between text-sm py-2 border-b"><span>${icon} ${text}</span><span class="text-gray-500">${date}</span></div>`;
                        }).join('');
                    }

                    const whatsappButton = customer.marketing && this.fidelityConfig.whatsappGroup ?
                        `<a href="${this.fidelityConfig.whatsappGroup}" target="_blank" class="w-full bg-green-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                        Unisciti al Gruppo WhatsApp
                    </a>` : '';

                    const cardSentInfo = customer.fidelity.cardSent ?
                        `<div class="text-xs text-green-600 mt-1">
                        ‚úì Tessera inviata ${customer.fidelity.cardSentDate ? 'il ' + new Date(customer.fidelity.cardSentDate).toLocaleDateString('it-IT') : ''}
                     </div>` :
                        `<div class="text-xs text-orange-600 mt-1">
                        ‚ö†Ô∏è Tessera non ancora inviata
                     </div>`;

                    const content = `
                    <div class="text-center mb-6">
                        <div class="inline-block bg-gradient-to-br from-amber-600 to-orange-700 text-white rounded-full w-24 h-24 flex items-center justify-center mb-4">
                            <span class="text-4xl font-bold">${customer.firstName.charAt(0)}${customer.lastName.charAt(0)}</span>
                        </div>
                        <h3 class="text-2xl font-bold">${customer.firstName} ${customer.lastName}</h3>
                        <p class="text-gray-600">${customer.phone || 'Nessun telefono'}</p>
                        ${cardSentInfo}
                    </div>

                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <p class="text-3xl font-bold text-amber-700">${currentStamps}</p>
                                <p class="text-sm text-gray-600">Bollini Attuali</p>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-green-600">${customer.fidelity.rewards}</p>
                                <p class="text-sm text-gray-600">Premi Disponibili</p>
                            </div>
                        </div>
                        
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div><span class="text-xs font-semibold inline-block text-amber-700">Progresso</span></div>
                                <div class="text-right"><span class="text-xs font-semibold inline-block text-amber-700">${currentStamps}/${stampsNeeded}</span></div>
                            </div>
                            <div class="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-amber-200">
                                <div style="width:${progress}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-amber-500 to-orange-600"></div>
                            </div>
                        </div>

                        <p class="text-center text-sm text-gray-600">Mancano <strong>${stampsNeeded - currentStamps}</strong> bollini al prossimo premio!</p>
                    </div>

                    <!-- GESTIONE PREMI -->
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                        <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                            üéÅ Gestione Premi
                        </h4>
                        
                        <div class="text-center py-4 text-gray-700">
                            <p class="text-sm font-semibold">Nessun premio ancora registrato</p>
                            <p class="text-xs mt-1 text-gray-500">Clicca il pulsante sotto per convertire un premio disponibile</p>
                        </div>
                        
                        <button onclick="app.addNewReward('${customer.id}')" class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-3 px-4 rounded-lg hover:from-yellow-500 hover:to-orange-600 font-bold mt-3" ${customer.fidelity.rewards === 0 ? 'disabled opacity-50' : ''}>
                            + Segna Premio come Disponibile (${customer.fidelity.rewards} da convertire)
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="app.generateFidelityCard('${customer.id}')" class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-medium">
                            üé´ Scarica Tessera PNG
                        </button>
                        ${!customer.fidelity.cardSent ?
                            `<button onclick="app.sendFidelityCardWhatsApp('${customer.id}')" class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-medium">
                            üì± Invia su WhatsApp
                        </button>` :
                            `<button onclick="app.sendStampsUpdateWhatsApp('${customer.id}', 0)" class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-medium">
                            üì± Invia Aggiornamento
                        </button>`}
                    </div>

                    ${whatsappButton}

                    ${historyHTML ? `
                        <div class="mt-6 border-t pt-4">
                            <h4 class="font-semibold mb-3">üìä Storico Recente</h4>
                            ${historyHTML}
                        </div>
                    ` : ''}

                    <div class="mt-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-lg">
                        <h4 class="font-semibold mb-3">‚úèÔ∏è Gestione Bollini</h4>
                        
                        <!-- Aggiungi bollini -->
                        <div class="mb-3">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Aggiungi Bollini</label>
                            <div class="flex gap-2">
                                <input type="number" id="manual-stamps" class="flex-1 px-3 py-2 border rounded-lg" placeholder="N¬∞ bollini" min="1" step="1" value="1">
                                <button onclick="app.addManualStampsDirect('${customer.id}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 whitespace-nowrap">+ Aggiungi</button>
                            </div>
                        </div>

                        <!-- Rimuovi bollini -->
                        <div class="mb-3">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Rimuovi Bollini (in caso di errore)</label>
                            <div class="flex gap-2">
                                <input type="number" id="remove-stamps" class="flex-1 px-3 py-2 border rounded-lg" placeholder="N¬∞ bollini" min="1" step="1" value="1">
                                <button onclick="app.removeStamps('${customer.id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 whitespace-nowrap">- Rimuovi</button>
                            </div>
                        </div>

                        <div class="text-xs text-gray-500 mt-2">
                            üí° Aggiungi o rimuovi bollini direttamente senza inserire l'importo
                        </div>
                    </div>

                    <!-- Pulsante Elimina Cliente -->
                    <div class="mt-6 pt-6 border-t">
                        <button onclick="app.deleteFidelityCustomer('${customer.id}')" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-medium flex items-center justify-center gap-2">
                            üóëÔ∏è Elimina Cliente
                        </button>
                        <p class="text-xs text-gray-500 text-center mt-2">Attenzione: questa azione √® irreversibile</p>
                    </div>
                `;

                    document.getElementById('fidelity-card-content').innerHTML = content;
                    this.openModal('fidelity-modal');
                }

                renderRewardsList(customer) {
                    // Inizializza l'array dei premi se non esiste
                    if (!customer.fidelity.rewardsList) {
                        customer.fidelity.rewardsList = [];
                    }

                    const rewardsList = customer.fidelity.rewardsList;

                    if (rewardsList.length === 0) {
                        return '<div class="text-center py-4 text-gray-500"><p class="text-sm font-bold">Nessun premio ancora registrato</p><p class="text-xs mt-1">Clicca il pulsante sotto per convertire un premio disponibile</p></div>';
                    }

                    let html = '<div class="space-y-2 max-h-60 overflow-y-auto">';

                    rewardsList.forEach((reward, index) => {
                        const statusIcon = reward.claimed ? '‚úÖ' : 'üéÅ';
                        const statusText = reward.claimed ? 'Ritirato' : 'Disponibile';
                        const statusColor = reward.claimed ? 'bg-green-50 border-green-300' : 'bg-yellow-50 border-yellow-300';
                        const date = new Date(reward.date).toLocaleDateString('it-IT');

                        // Escape delle virgolette nella descrizione
                        const safeDescription = reward.description ? reward.description.replace(/'/g, '&#39;').replace(/"/g, '&quot;') : '';

                        html += '<div class="border-2 ' + statusColor + ' rounded-lg p-3">';
                        html += '<div class="flex justify-between items-start mb-2">';
                        html += '<div class="flex-1">';
                        html += '<div class="flex items-center gap-2 mb-1">';
                        html += '<span class="text-lg">' + statusIcon + '</span>';
                        html += '<span class="font-semibold">' + statusText + '</span>';
                        html += '<span class="text-xs text-gray-500">' + date + '</span>';
                        html += '</div>';

                        if (safeDescription) {
                            html += '<p class="text-sm text-gray-700 mt-1">üìù ' + safeDescription + '</p>';
                        }

                        if (reward.claimedDate) {
                            const claimedDate = new Date(reward.claimedDate).toLocaleDateString('it-IT');
                            html += '<p class="text-xs text-gray-500 mt-1">Ritirato il ' + claimedDate + '</p>';
                        }

                        html += '</div>';

                        if (!reward.claimed) {
                            html += '<button onclick="app.markRewardAsClaimed(\'' + customer.id + '\', ' + index + ')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 whitespace-nowrap ml-2">Segna Ritirato</button>';
                        }

                        html += '</div>';

                        if (!reward.claimed) {
                            html += '<div class="mt-2">';
                            html += '<input type="text" id="reward-desc-' + index + '" placeholder="Descrivi il premio (es. Torta cioccolato 500g)" value="' + safeDescription + '" onchange="app.updateRewardDescription(\'' + customer.id + '\', ' + index + ', this.value)" class="w-full px-2 py-1 border rounded text-sm">';
                            html += '</div>';
                        }

                        html += '</div>';
                    });

                    html += '</div>';
                    return html;
                }

                addNewReward(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer || customer.fidelity.rewards === 0) {
                        this.showToast('Nessun premio disponibile da convertire', 'error');
                        return;
                    }

                    // Inizializza l'array se non esiste
                    if (!customer.fidelity.rewardsList) {
                        customer.fidelity.rewardsList = [];
                    }

                    // Aggiungi un nuovo premio alla lista
                    customer.fidelity.rewardsList.push({
                        date: new Date().toISOString(),
                        claimed: false,
                        description: '',
                        claimedDate: null
                    });

                    // Decrementa i premi disponibili
                    customer.fidelity.rewards--;

                    this.saveData();
                    this.showToast('‚úÖ Premio aggiunto alla lista!');

                    // Ricarica la fidelity card
                    this.openFidelityCard(customerId);
                }

                markRewardAsClaimed(customerId, rewardIndex) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer || !customer.fidelity.rewardsList || !customer.fidelity.rewardsList[rewardIndex]) {
                        this.showToast('Premio non trovato', 'error');
                        return;
                    }

                    const reward = customer.fidelity.rewardsList[rewardIndex];

                    if (confirm(`Confermi che il cliente ha ritirato questo premio?`)) {
                        reward.claimed = true;
                        reward.claimedDate = new Date().toISOString();

                        // Aggiungi anche allo storico
                        customer.fidelity.history.push({
                            date: reward.claimedDate,
                            type: 'redeemed',
                            stamps: 0,
                            amount: 0,
                            description: reward.description || 'Premio ritirato'
                        });

                        this.saveData();
                        this.showToast('üéÅ Premio segnato come ritirato!');

                        // Ricarica la fidelity card
                        this.openFidelityCard(customerId);
                    }
                }

                updateRewardDescription(customerId, rewardIndex, description) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer || !customer.fidelity.rewardsList || !customer.fidelity.rewardsList[rewardIndex]) {
                        return;
                    }

                    customer.fidelity.rewardsList[rewardIndex].description = description.trim();
                    this.saveData();
                    this.showToast('üíæ Descrizione salvata');
                }

                addManualStampsDirect(customerId) {
                    const stamps = parseInt(document.getElementById('manual-stamps').value) || 1;
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;

                    if (stamps <= 0) {
                        this.showToast('Inserisci un numero valido di bollini', 'error');
                        return;
                    }

                    if (!customer.fidelity) {
                        customer.fidelity = { stamps: 0, totalSpent: 0, rewards: 0, history: [] };
                    }

                    customer.fidelity.stamps += stamps;
                    customer.fidelity.history.push({
                        date: new Date().toISOString(),
                        type: 'manual_add',
                        stamps: stamps,
                        amount: 0
                    });

                    // Controlla premi
                    const rewardsEarned = Math.floor(customer.fidelity.stamps / this.fidelityConfig.stampsPerReward);
                    if (rewardsEarned > customer.fidelity.rewards) {
                        const newRewards = rewardsEarned - customer.fidelity.rewards;
                        customer.fidelity.rewards = rewardsEarned;
                        customer.fidelity.stamps = customer.fidelity.stamps % this.fidelityConfig.stampsPerReward;
                        this.showToast(`üéÅ ${customer.firstName} ha guadagnato ${newRewards} premio/i!`);
                    }

                    this.saveData();
                    this.showToast(`‚úÖ +${stamps} bollini aggiunti!`);
                    this.closeModal('fidelity-modal');
                    this.render();
                }

                removeStamps(customerId) {
                    const stamps = parseInt(document.getElementById('remove-stamps').value) || 1;
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer || !customer.fidelity) return;

                    if (stamps <= 0) {
                        this.showToast('Inserisci un numero valido di bollini', 'error');
                        return;
                    }

                    if (customer.fidelity.stamps < stamps) {
                        this.showToast(`‚ùå Il cliente ha solo ${customer.fidelity.stamps} bollini`, 'error');
                        return;
                    }

                    if (!confirm(`Rimuovere ${stamps} bollini da ${customer.firstName}?`)) return;

                    customer.fidelity.stamps -= stamps;
                    customer.fidelity.history.push({
                        date: new Date().toISOString(),
                        type: 'manual_remove',
                        stamps: -stamps,
                        amount: 0
                    });

                    this.saveData();
                    this.showToast(`‚úÖ ${stamps} bollini rimossi`);
                    this.closeModal('fidelity-modal');
                    this.render();
                }

                addManualStamps(customerId) {
                    const amount = parseFloat(document.getElementById('manual-amount').value);
                    if (isNaN(amount) || amount <= 0) {
                        this.showToast('Inserisci un importo valido', 'error');
                        return;
                    }

                    this.addStampsFromOrder(customerId, amount);
                    document.getElementById('manual-amount').value = '';
                    this.closeModal('fidelity-modal');
                    this.render();
                }

                redeemReward(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer || customer.fidelity.rewards === 0) {
                        this.showToast('Nessun premio disponibile', 'error');
                        return;
                    }

                    if (confirm(`Confermi il riscatto di 1 premio per ${customer.firstName}?`)) {
                        customer.fidelity.rewards--;
                        customer.fidelity.history.push({
                            date: new Date().toISOString(),
                            type: 'redeemed',
                            stamps: 0,
                            amount: 0
                        });
                        this.saveData();
                        this.showToast('üéÅ Premio riscattato!');
                        this.closeModal('fidelity-modal');
                        this.render();
                    }
                }


                generateFidelityCard(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;

                    // Genera l'immagine PNG della tessera
                    const qrData = JSON.stringify({
                        id: customer.id,
                        name: `${customer.firstName} ${customer.lastName}`,
                        app: 'fidelity-card'
                    });

                    const qrContainer = document.createElement('div');
                    qrContainer.style.display = 'none';
                    document.body.appendChild(qrContainer);

                    // Genera QR con callback per assicurarsi che sia pronto
                    const qrCode = new QRCode(qrContainer, {
                        text: qrData,
                        width: 400,
                        height: 400,
                        colorDark: "#3E2723",
                        colorLight: "#ffffff"
                    });

                    // Attendi che il QR sia effettivamente renderizzato
                    const waitForQR = () => {
                        return new Promise((resolve) => {
                            const checkQR = () => {
                                const qrImg = qrContainer.querySelector('img');
                                if (qrImg && qrImg.complete && qrImg.naturalHeight !== 0) {
                                    resolve(qrImg);
                                } else {
                                    setTimeout(checkQR, 100);
                                }
                            };
                            checkQR();
                        });
                    };

                    waitForQR().then((qrImg) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Formato card elegante (stessa dimensione della tessera WhatsApp)
                        canvas.width = 1200;
                        canvas.height = 750;

                        // Gradiente elegante beige simile al logo
                        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                        gradient.addColorStop(0, '#F8E3C4'); // Beige chiaro
                        gradient.addColorStop(1, '#F2D4A4'); // Beige pi√π caldo
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Texture leggera
                        ctx.globalAlpha = 0.03;
                        for (let i = 0; i < 2000; i++) {
                            ctx.fillStyle = '#5D3F24'; // Marrone pi√π scuro
                            ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
                        }
                        ctx.globalAlpha = 1;

                        // Intestazione Pastificio Gramsci (nome attivit√† pi√π evidente)
                        ctx.fillStyle = '#5D3F24'; // Marrone del logo
                        ctx.font = 'bold 60px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('PASTIFICIO GRAMSCI', canvas.width / 2, 100);

                        // Sottotitolo
                        ctx.font = 'italic 36px Georgia';
                        ctx.fillStyle = '#5D3F24';
                        ctx.fillText('TESSERA FEDELT√Ä', canvas.width / 2, 160);

                        // Linea decorativa ondulata
                        ctx.strokeStyle = '#5D3F24';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        for (let x = 0; x <= canvas.width; x += 10) {
                            const y = 200 + Math.sin(x * 0.02) * 5;
                            if (x === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.stroke();

                        // Nome cliente elegante
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'bold 46px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${customer.firstName} ${customer.lastName}`, canvas.width / 2, 280);

                        // QR Code con cornice elegante
                        const qrSize = 300;
                        const qrX = canvas.width / 2 - qrSize / 2; // Centrato
                        const qrY = 350; // Sotto il nome

                        // Ombra QR
                        ctx.shadowColor = 'rgba(0,0,0,0.2)';
                        ctx.shadowBlur = 20;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 10;

                        // Cornice marrone QR
                        ctx.fillStyle = '#5D3F24'; // Marrone del logo
                        ctx.fillRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30);

                        ctx.shadowColor = 'transparent';

                        // Sfondo bianco QR
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(qrX - 8, qrY - 8, qrSize + 16, qrSize + 16);

                        // Disegna QR
                        ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

                        // Testo sotto QR
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'italic 20px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('Scansiona in negozio', qrX + qrSize / 2, qrY + qrSize + 40);

                        // Footer elegante
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'italic 22px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('Grazie per la tua fedelt√†!', canvas.width / 2, canvas.height - 30);

                        // Converti canvas in PNG e scarica/condividi
                        canvas.toBlob(async (blob) => {
                            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                            const fileName = `tessera-fidelity-${customer.lastName}-${customer.firstName}.png`;
                            const currentStamps = customer.fidelity?.stamps || 0;

                            const messageText =
                                `üéâ Ciao ${customer.firstName}!\n\n` +
                                `üí≥ Ti rimando la tua tessera fedelt√†!\n\n` +
                                `üìä Stato attuale: ${currentStamps}/${this.fidelityConfig.stampsPerReward || 10} bollini\n` +
                                (customer.fidelity?.rewards > 0 ? `üéÅ Hai ${customer.fidelity.rewards} premio/i da riscattare!\n\n` : '\n') +
                                `üì± SALVA l'immagine sul telefono!\n\n` +
                                `Pastificio Gramsci`;

                            // Prova Web Share API su mobile (condivisione diretta con immagine allegata)
                            if (isMobile && navigator.share && navigator.canShare) {
                                try {
                                    const file = new File([blob], fileName, { type: 'image/png' });

                                    // Verifica se pu√≤ condividere file
                                    if (navigator.canShare({ files: [file] })) {
                                        await navigator.share({
                                            files: [file],
                                            title: 'Tessera Fidelity',
                                            text: messageText
                                        });

                                        this.showToast('‚úÖ Tessera condivisa! Scegli WhatsApp per inviarla');
                                        document.body.removeChild(qrContainer);
                                        return;
                                    }
                                } catch (err) {
                                    // Se l'utente annulla o c'√® un errore, continua con il metodo di fallback
                                    console.log('Condivisione annullata o non supportata:', err);
                                }
                            }

                            // Fallback: Download + apertura WhatsApp (per desktop o se Web Share non funziona)
                            const url = URL.createObjectURL(blob);

                            // Crea link per download
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = fileName;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();

                            // Pulizia
                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);

                            this.showToast('‚úÖ Tessera scaricata! Apertura WhatsApp...');

                            // Apri WhatsApp dopo il download
                            setTimeout(() => {
                                if (customer.phone) {
                                    const phone = customer.phone.replace(/[^0-9]/g, '');
                                    const phoneFormatted = phone.startsWith('39') ? phone : '39' + phone;
                                    const whatsappUrl = `https://wa.me/${phoneFormatted}?text=${encodeURIComponent(messageText)}`;
                                    window.open(whatsappUrl, '_blank');
                                } else {
                                    this.showToast('‚ö†Ô∏è Numero di telefono mancante per aprire WhatsApp', 'warning');
                                }
                            }, 800);
                        }, 'image/png', 1.0);

                        document.body.removeChild(qrContainer);
                    });
                }

                sendFidelityCardWhatsApp(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer || !customer.phone) {
                        this.showToast('‚ùå Cliente senza numero di telefono', 'error');
                        return;
                    }

                    console.log('üéØ INIZIO sendFidelityCardWhatsApp per:', customer.firstName);
                    console.log('üì± User Agent:', navigator.userAgent);
                    console.log('üîç Web Share supportato?', !!navigator.share);

                    const qrData = JSON.stringify({
                        id: customer.id,
                        name: `${customer.firstName} ${customer.lastName}`,
                        app: 'fidelity-card'
                    });

                    const qrContainer = document.createElement('div');
                    qrContainer.style.display = 'none';
                    document.body.appendChild(qrContainer);

                    // Genera QR con callback per assicurarsi che sia pronto
                    const qrCode = new QRCode(qrContainer, {
                        text: qrData,
                        width: 400,
                        height: 400,
                        colorDark: "#3E2723",
                        colorLight: "#ffffff"
                    });

                    // Attendi che il QR sia effettivamente renderizzato
                    const waitForQR = () => {
                        return new Promise((resolve) => {
                            const checkQR = () => {
                                const qrImg = qrContainer.querySelector('img');
                                if (qrImg && qrImg.complete && qrImg.naturalHeight !== 0) {
                                    resolve(qrImg);
                                } else {
                                    setTimeout(checkQR, 100);
                                }
                            };
                            checkQR();
                        });
                    };

                    waitForQR().then((qrImg) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Formato card elegante
                        canvas.width = 1200;
                        canvas.height = 750;

                        // Gradiente elegante beige simile al logo
                        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                        gradient.addColorStop(0, '#F8E3C4'); // Beige chiaro
                        gradient.addColorStop(1, '#F2D4A4'); // Beige pi√π caldo
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Texture leggera
                        ctx.globalAlpha = 0.03;
                        for (let i = 0; i < 2000; i++) {
                            ctx.fillStyle = '#5D3F24'; // Marrone pi√π scuro
                            ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
                        }
                        ctx.globalAlpha = 1;

                        // Intestazione Pastificio Gramsci (nome attivit√† pi√π evidente)
                        ctx.fillStyle = '#5D3F24'; // Marrone del logo
                        ctx.font = 'bold 60px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('PASTIFICIO GRAMSCI', canvas.width / 2, 100);

                        // Sottotitolo
                        ctx.font = 'italic 36px Georgia';
                        ctx.fillStyle = '#5D3F24';
                        ctx.fillText('TESSERA FEDELT√Ä', canvas.width / 2, 160);

                        // Linea decorativa ondulata
                        ctx.strokeStyle = '#5D3F24';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        for (let x = 0; x <= canvas.width; x += 10) {
                            const y = 200 + Math.sin(x * 0.02) * 5;
                            if (x === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.stroke();

                        // Nome cliente elegante
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'bold 46px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${customer.firstName} ${customer.lastName}`, canvas.width / 2, 280);

                        // QR Code con cornice elegante
                        const qrSize = 300;
                        const qrX = canvas.width / 2 - qrSize / 2; // Centrato
                        const qrY = 350; // Sotto il nome

                        // Ombra QR
                        ctx.shadowColor = 'rgba(0,0,0,0.2)';
                        ctx.shadowBlur = 20;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 10;

                        // Cornice marrone QR
                        ctx.fillStyle = '#5D3F24'; // Marrone del logo
                        ctx.fillRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30);

                        ctx.shadowColor = 'transparent';

                        // Sfondo bianco QR
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(qrX - 8, qrY - 8, qrSize + 16, qrSize + 16);

                        // Disegna QR
                        ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

                        // Testo sotto QR
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'italic 20px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('Scansiona in negozio', qrX + qrSize / 2, qrY + qrSize + 40);

                        // Footer elegante
                        ctx.fillStyle = '#5D3F24';
                        ctx.font = 'italic 22px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('Grazie per la tua fedelt√†!', canvas.width / 2, canvas.height - 30);

                        // Esporta l'immagine come data URL
                        const cardImageDataUrl = canvas.toDataURL('image/jpeg', 0.8);

                        // Prepara il messaggio WhatsApp
                        const phone = customer.phone.replace(/[^0-9]/g, '');
                        const phoneFormatted = phone.startsWith('39') ? phone : '39' + phone;
                        const currentStamps = customer.fidelity?.stamps || 0;

                        const messageText =
                            `üéâ Ciao ${customer.firstName}! Benvenuto nel programma Fedelt√†!\n\n` +
                            `üí≥ Ecco la tua tessera digitale personale!\n\n` +
                            `üìä Come funziona:\n` +
                            `üìç Ogni ${this.fidelityConfig.eurosPerStamp || 20}‚Ç¨ = 1 bollino ‚úì\n` +
                            `üè∑Ô∏è Accumula ${this.fidelityConfig.stampsPerReward || 10} bollini = 1 PREMIO! üéÅ\n\n` +
                            `üéØ Stato attuale: ${currentStamps}/${this.fidelityConfig.stampsPerReward || 10} bollini\n` +
                            (customer.fidelity?.rewards > 0 ? `üéÅ Hai ${customer.fidelity.rewards} premio/i da riscattare!\n\n` : '\n') +
                            `üì± SALVA QUESTA TESSERA sul telefono!\n\n` +
                            `Grazie per la fiducia! üòä\n\nPastificio Gramsci`;

                        // üöÄ SISTEMA AVANZATO DI AUTOMAZIONE COMPLETA
                        this.advancedCardSender(cardImageDataUrl, messageText, phoneFormatted, customer);

                        document.body.removeChild(qrContainer);
                    });
                }

                // Genera immagine coupon con QR code
                generateCouponImage(customerId, couponCode) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer || !customer.coupons) return;

                    const coupon = customer.coupons.find(c => c.code === couponCode);
                    if (!coupon) {
                        this.showToast('‚ùå Coupon non trovato', 'error');
                        return;
                    }

                    // Dati per il QR code
                    const qrData = JSON.stringify({
                        type: 'coupon',
                        couponCode: coupon.code,
                        customerId: customer.id,
                        customerName: `${customer.firstName} ${customer.lastName}`,
                        campaignName: coupon.campaignName
                    });

                    const qrContainer = document.createElement('div');
                    qrContainer.style.display = 'none';
                    document.body.appendChild(qrContainer);

                    // Genera QR con callback per assicurarsi che sia pronto
                    const qrCode = new QRCode(qrContainer, {
                        text: qrData,
                        width: 400,
                        height: 400,
                        colorDark: "#6B21A8", // Viola scuro per coupon
                        colorLight: "#ffffff"
                    });

                    // Attendi che il QR sia effettivamente renderizzato
                    const waitForQR = () => {
                        return new Promise((resolve) => {
                            const checkQR = () => {
                                const qrImg = qrContainer.querySelector('img');
                                if (qrImg && qrImg.complete && qrImg.naturalHeight !== 0) {
                                    resolve(qrImg);
                                } else {
                                    setTimeout(checkQR, 100);
                                }
                            };
                            checkQR();
                        });
                    };

                    waitForQR().then((qrImg) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Formato coupon (biglietto)
                        canvas.width = 1200;
                        canvas.height = 800;

                        // Gradiente viola/rosa per coupon
                        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                        gradient.addColorStop(0, '#FDF4FF'); // Rosa molto chiaro
                        gradient.addColorStop(1, '#FAE8FF'); // Rosa chiaro
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Texture leggera
                        ctx.globalAlpha = 0.03;
                        for (let i = 0; i < 2000; i++) {
                            ctx.fillStyle = '#6B21A8'; // Viola
                            ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
                        }
                        ctx.globalAlpha = 1;

                        // Intestazione
                        ctx.fillStyle = '#6B21A8'; // Viola
                        ctx.font = 'bold 56px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('PASTIFICIO GRAMSCI', canvas.width / 2, 90);

                        // Badge sconto in alto a destra
                        const discountText = coupon.discountType === 'percentage'
                            ? `${coupon.discountValue}%`
                            : `‚Ç¨${coupon.discountValue}`;

                        ctx.fillStyle = '#C026D3'; // Rosa/viola
                        ctx.beginPath();
                        ctx.arc(1000, 100, 80, 0, Math.PI * 2);
                        ctx.fill();

                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 48px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(discountText, 1000, 120);

                        // Tipo coupon
                        ctx.font = 'italic 32px Georgia';
                        ctx.fillStyle = '#6B21A8';
                        ctx.textAlign = 'center';
                        ctx.fillText('üéüÔ∏è COUPON SCONTO', canvas.width / 2, 150);

                        // Linea decorativa
                        ctx.strokeStyle = '#C026D3';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([10, 5]);
                        ctx.beginPath();
                        ctx.moveTo(100, 180);
                        ctx.lineTo(canvas.width - 100, 180);
                        ctx.stroke();
                        ctx.setLineDash([]);

                        // Nome campagna
                        ctx.fillStyle = '#6B21A8';
                        ctx.font = 'bold 40px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText(coupon.campaignName, canvas.width / 2, 240);

                        // Descrizione
                        if (coupon.description) {
                            ctx.font = 'italic 24px Georgia';
                            ctx.fillStyle = '#7C3AED';
                            ctx.fillText(coupon.description, canvas.width / 2, 280);
                        }

                        // Nome cliente
                        ctx.fillStyle = '#6B21A8';
                        ctx.font = 'bold 28px Georgia';
                        ctx.fillText(`Cliente: ${customer.firstName} ${customer.lastName}`, canvas.width / 2, 330);

                        // QR Code centrato
                        const qrSize = 280;
                        const qrX = canvas.width / 2 - qrSize / 2;
                        const qrY = 370;

                        // Ombra QR
                        ctx.shadowColor = 'rgba(107, 33, 168, 0.3)';
                        ctx.shadowBlur = 20;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 10;

                        // Cornice viola QR
                        ctx.fillStyle = '#6B21A8';
                        ctx.fillRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30);

                        ctx.shadowColor = 'transparent';

                        // Sfondo bianco QR
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(qrX - 8, qrY - 8, qrSize + 16, qrSize + 16);

                        // Disegna QR
                        ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

                        // Codice coupon sotto il QR
                        ctx.fillStyle = '#6B21A8';
                        ctx.font = 'bold 24px monospace';
                        ctx.textAlign = 'center';
                        ctx.fillText(coupon.code, canvas.width / 2, qrY + qrSize + 40);

                        // Scadenza
                        const expiryText = coupon.expiryDate
                            ? `Valido fino al ${new Date(coupon.expiryDate).toLocaleDateString('it-IT')}`
                            : 'Senza scadenza';

                        ctx.font = 'italic 20px Georgia';
                        ctx.fillStyle = '#7C3AED';
                        ctx.fillText(expiryText, canvas.width / 2, qrY + qrSize + 75);

                        // Footer
                        ctx.fillStyle = '#6B21A8';
                        ctx.font = 'italic 22px Georgia';
                        ctx.fillText('Mostra questo coupon in negozio!', canvas.width / 2, canvas.height - 30);

                        // Converti canvas in PNG
                        canvas.toBlob(async (blob) => {
                            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                            const fileName = `coupon-${coupon.code}.png`;

                            const messageText =
                                `üéüÔ∏è Ciao ${customer.firstName}!\n\n` +
                                `üéÅ Hai ricevuto un COUPON SCONTO!\n\n` +
                                `üìã Campagna: ${coupon.campaignName}\n` +
                                `üí∞ Sconto: ${discountText}\n` +
                                `üìÖ ${expiryText}\n\n` +
                                `üì± SALVA l'immagine e mostrala in negozio!\n\n` +
                                `Pastificio Gramsci`;

                            // Prova Web Share API su mobile
                            if (isMobile && navigator.share && navigator.canShare) {
                                try {
                                    const file = new File([blob], fileName, { type: 'image/png' });

                                    if (navigator.canShare({ files: [file] })) {
                                        await navigator.share({
                                            files: [file],
                                            title: 'Coupon Sconto',
                                            text: messageText
                                        });

                                        this.showToast('‚úÖ Coupon condiviso!');
                                        document.body.removeChild(qrContainer);
                                        return;
                                    }
                                } catch (err) {
                                    console.log('Condivisione annullata:', err);
                                }
                            }

                            // Fallback: Download
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = fileName;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();

                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);

                            this.showToast('‚úÖ Coupon scaricato!');
                        }, 'image/png', 1.0);

                        document.body.removeChild(qrContainer);
                    });
                }

                // Invia coupon su WhatsApp
                sendCouponWhatsApp(customerId, couponCode) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer || !customer.phone) {
                        this.showToast('‚ùå Cliente senza numero di telefono', 'error');
                        return;
                    }

                    const coupon = customer.coupons?.find(c => c.code === couponCode);
                    if (!coupon) {
                        this.showToast('‚ùå Coupon non trovato', 'error');
                        return;
                    }

                    // Dati per il QR code
                    const qrData = JSON.stringify({
                        type: 'coupon',
                        couponCode: coupon.code,
                        customerId: customer.id,
                        customerName: `${customer.firstName} ${customer.lastName}`,
                        campaignName: coupon.campaignName
                    });

                    const qrContainer = document.createElement('div');
                    qrContainer.style.display = 'none';
                    document.body.appendChild(qrContainer);

                    // Genera QR con callback
                    const qrCode = new QRCode(qrContainer, {
                        text: qrData,
                        width: 400,
                        height: 400,
                        colorDark: "#6B21A8",
                        colorLight: "#ffffff"
                    });

                    // Attendi che il QR sia pronto
                    const waitForQR = () => {
                        return new Promise((resolve) => {
                            const checkQR = () => {
                                const qrImg = qrContainer.querySelector('img');
                                if (qrImg && qrImg.complete && qrImg.naturalHeight !== 0) {
                                    resolve(qrImg);
                                } else {
                                    setTimeout(checkQR, 100);
                                }
                            };
                            checkQR();
                        });
                    };

                    waitForQR().then((qrImg) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // [Stesso codice del canvas di generateCouponImage]
                        canvas.width = 1200;
                        canvas.height = 800;

                        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                        gradient.addColorStop(0, '#FDF4FF');
                        gradient.addColorStop(1, '#FAE8FF');
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        ctx.globalAlpha = 0.03;
                        for (let i = 0; i < 2000; i++) {
                            ctx.fillStyle = '#6B21A8';
                            ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
                        }
                        ctx.globalAlpha = 1;

                        ctx.fillStyle = '#6B21A8';
                        ctx.font = 'bold 56px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('PASTIFICIO GRAMSCI', canvas.width / 2, 90);

                        const discountText = coupon.discountType === 'percentage'
                            ? `${coupon.discountValue}%`
                            : `‚Ç¨${coupon.discountValue}`;

                        ctx.fillStyle = '#C026D3';
                        ctx.beginPath();
                        ctx.arc(1000, 100, 80, 0, Math.PI * 2);
                        ctx.fill();

                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 48px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(discountText, 1000, 120);

                        ctx.font = 'italic 32px Georgia';
                        ctx.fillStyle = '#6B21A8';
                        ctx.textAlign = 'center';
                        ctx.fillText('üéüÔ∏è COUPON SCONTO', canvas.width / 2, 150);

                        ctx.strokeStyle = '#C026D3';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([10, 5]);
                        ctx.beginPath();
                        ctx.moveTo(100, 180);
                        ctx.lineTo(canvas.width - 100, 180);
                        ctx.stroke();
                        ctx.setLineDash([]);

                        ctx.fillStyle = '#6B21A8';
                        ctx.font = 'bold 40px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText(coupon.campaignName, canvas.width / 2, 240);

                        if (coupon.description) {
                            ctx.font = 'italic 24px Georgia';
                            ctx.fillStyle = '#7C3AED';
                            ctx.fillText(coupon.description, canvas.width / 2, 280);
                        }

                        ctx.fillStyle = '#6B21A8';
                        ctx.font = 'bold 28px Georgia';
                        ctx.fillText(`Cliente: ${customer.firstName} ${customer.lastName}`, canvas.width / 2, 330);

                        const qrSize = 280;
                        const qrX = canvas.width / 2 - qrSize / 2;
                        const qrY = 370;

                        ctx.shadowColor = 'rgba(107, 33, 168, 0.3)';
                        ctx.shadowBlur = 20;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 10;

                        ctx.fillStyle = '#6B21A8';
                        ctx.fillRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30);

                        ctx.shadowColor = 'transparent';

                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(qrX - 8, qrY - 8, qrSize + 16, qrSize + 16);

                        ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

                        ctx.fillStyle = '#6B21A8';
                        ctx.font = 'bold 24px monospace';
                        ctx.textAlign = 'center';
                        ctx.fillText(coupon.code, canvas.width / 2, qrY + qrSize + 40);

                        const expiryText = coupon.expiryDate
                            ? `Valido fino al ${new Date(coupon.expiryDate).toLocaleDateString('it-IT')}`
                            : 'Senza scadenza';

                        ctx.font = 'italic 20px Georgia';
                        ctx.fillStyle = '#7C3AED';
                        ctx.fillText(expiryText, canvas.width / 2, qrY + qrSize + 75);

                        ctx.fillStyle = '#6B21A8';
                        ctx.font = 'italic 22px Georgia';
                        ctx.fillText('Mostra questo coupon in negozio!', canvas.width / 2, canvas.height - 30);

                        // Converti e invia su WhatsApp
                        canvas.toBlob(async (blob) => {
                            const url = URL.createObjectURL(blob);
                            const fileName = `coupon-${coupon.code}.png`;

                            // Download
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = fileName;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();

                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }, 100);

                            // Messaggio WhatsApp
                            const messageText =
                                `üéüÔ∏è Ciao ${customer.firstName}!\n\n` +
                                `üéÅ Hai ricevuto un COUPON SCONTO!\n\n` +
                                `üìã ${coupon.campaignName}\n` +
                                `üí∞ Sconto: ${discountText}\n` +
                                `üìÖ ${expiryText}\n\n` +
                                `üì± SALVA l'immagine e mostrala in negozio per ottenere lo sconto!\n\n` +
                                `Pastificio Gramsci`;

                            this.showToast('‚úÖ Coupon scaricato! Apertura WhatsApp...');

                            setTimeout(() => {
                                const phone = customer.phone.replace(/[^0-9]/g, '');
                                const phoneFormatted = phone.startsWith('39') ? phone : '39' + phone;
                                const whatsappUrl = `https://wa.me/${phoneFormatted}?text=${encodeURIComponent(messageText)}`;
                                window.open(whatsappUrl, '_blank');
                            }, 800);
                        }, 'image/png', 1.0);

                        document.body.removeChild(qrContainer);
                    });
                }

                async advancedCardSender(imageDataUrl, messageText, phoneFormatted, customer) {
                    console.log('üì§ advancedCardSender chiamata');

                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    console.log('üì± isMobile:', isMobile);

                    // Strategia 1: Web Share API - Allega automaticamente su mobile
                    if (isMobile) {
                        const shareSuccess = await this.tryWebShare(imageDataUrl, messageText, customer);
                        if (shareSuccess) {
                            // Se Web Share funziona, file gi√† allegato - FATTO!
                            this.markCardAsSent(customer);
                            return;
                        }
                        // Se Web Share fallisce, continua con il backup
                        console.log('‚ö†Ô∏è Web Share fallito, uso metodo backup');
                    }

                    // Strategia di backup: Download + WhatsApp separati
                    const fileName = `tessera-fidelity-${customer.lastName}-${customer.firstName}.jpg`;
                    const link = document.createElement('a');
                    link.href = imageDataUrl;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    console.log('‚úÖ Download singolo creato:', fileName);
                    this.showToast('üì• Tessera scaricata! Allega manualmente su WhatsApp', 'info');

                    // Crea URL temporaneo per drag&drop (solo desktop)
                    let shareUrl = null;
                    if (!isMobile) {
                        shareUrl = await this.createShareableUrl(imageDataUrl, customer);
                    }

                    // Mostra istruzioni
                    this.showPreWhatsAppInstructions(customer.firstName, !isMobile);

                    // Apre WhatsApp dopo delay
                    setTimeout(() => {
                        this.openWhatsAppWithMessage(messageText, phoneFormatted, shareUrl, !isMobile);
                    }, 3000);

                    this.markCardAsSent(customer);
                }

                markCardAsSent(customer) {
                    if (!customer.fidelity) {
                        customer.fidelity = { stamps: 0, rewards: 0, history: [], cardSent: false };
                    }
                    customer.fidelity.cardSent = true;
                    customer.fidelity.cardSentDate = new Date().toISOString();
                    this.saveData();
                }

                async tryWebShare(imageDataUrl, messageText, customer) {
                    console.log('üß™ Tentativo Web Share API...');

                    if (!navigator.share) {
                        console.log('‚ùå Web Share API non supportata');
                        this.showToast('Web Share non supportato - uso download', 'info');
                        return false;
                    }

                    try {
                        // Converte data URL in blob
                        const response = await fetch(imageDataUrl);
                        const blob = await response.blob();
                        const file = new File([blob], `tessera-${customer.firstName}.jpg`, { type: 'image/jpeg' });

                        // Usa Web Share API per condivisione nativa
                        // Alcuni browser ignorano text se c'√® files - usa solo files
                        await navigator.share({
                            files: [file]
                        });

                        // Dopo la condivisione, apri WhatsApp con il messaggio
                        this.showToast('üì§ Ora invia il messaggio su WhatsApp!', 'info');
                        setTimeout(() => {
                            const phone = customer.phone.replace(/[^0-9]/g, '');
                            const phoneFormatted = phone.startsWith('39') ? phone : '39' + phone;
                            window.open(`https://wa.me/${phoneFormatted}?text=${encodeURIComponent(messageText)}`, '_blank');
                        }, 2000);

                        console.log('‚úÖ Condivisione Web Share API completata!');
                        this.showToast(`üéâ Tessera condivisa con successo per ${customer.firstName}!`);
                        return true;
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.log('‚ùå Errore Web Share API:', error);
                        }
                        return false;
                    }
                }

                async createShareableUrl(imageDataUrl, customer) {
                    try {
                        // Crea un URL blob temporaneo per l'immagine
                        const response = await fetch(imageDataUrl);
                        const blob = await response.blob();
                        const shareUrl = URL.createObjectURL(blob);

                        console.log('‚úÖ URL temporaneo creato per drag&drop');
                        return shareUrl;
                    } catch (error) {
                        console.log('‚ùå Errore creazione URL condivisione:', error);
                        return null;
                    }
                }

                openWhatsAppWithMessage(messageText, phoneFormatted, shareUrl, isDesktop, customerName) {
                    if (isDesktop) {
                        // Desktop: apre WhatsApp Web + finestra immagine separata
                        const whatsappWebUrl = `https://web.whatsapp.com/send?phone=${phoneFormatted}&text=${encodeURIComponent(messageText)}`;
                        window.open(whatsappWebUrl, '_blank');

                        // Apre anche l'immagine in una nuova tab per drag&drop facile
                        if (shareUrl) {
                            setTimeout(() => {
                                const imageWindow = window.open(shareUrl, '_blank', 'width=500,height=400,left=100,top=100');
                                if (imageWindow) {
                                    imageWindow.document.title = `Trascina in WhatsApp - ${customerName}`;
                                }
                            }, 1000);
                        }
                    } else {
                        // Mobile: apre app WhatsApp
                        const whatsappAppUrl = `https://wa.me/${phoneFormatted}?text=${encodeURIComponent(messageText)}`;
                        window.open(whatsappAppUrl, '_blank');
                    }

                    console.log('‚úÖ WhatsApp aperto con messaggio corretto');
                }

                showPreWhatsAppInstructions(customerName, isDesktop) {
                    const popup = document.createElement('div');
                    popup.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #10B981, #059669);
                    color: white;
                    padding: 30px;
                    border-radius: 20px;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
                    z-index: 10000;
                    max-width: 500px;
                    animation: popInCenter 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                    border: 3px solid rgba(255,255,255,0.3);
                    text-align: center;
                `;

                    popup.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">üéØ</div>
                    <h2 style="margin: 0 0 15px 0; font-size: 24px;">Tessera per ${customerName}</h2>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px;">‚úÖ TUTTO PRONTO!</div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            üì• Tessera scaricata in Download<br>
                            üì± WhatsApp si aprir√† tra 3 secondi<br>
                            ${isDesktop ? 'üñºÔ∏è Finestra immagine separata si aprir√†' : 'üìé Usa il pulsante allega in WhatsApp'}
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(59,130,246,0.9), rgba(37,99,235,0.9)); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">üöÄ PROSSIMO PASSO:</div>
                        ${isDesktop ?
                            '<div style="font-size: 15px;">Trascina l\'immagine dalla finestra separata ‚Üí WhatsApp</div>' :
                            '<div style="font-size: 15px;">Tocca üìé in WhatsApp ‚Üí Seleziona l\'immagine tessera</div>'
                        }
                    </div>
                    
                    <div style="font-size: 18px; font-weight: bold; color: #FFF; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                        WhatsApp si apre automaticamente in <span id="countdown" style="font-size: 24px;">3</span>
                    </div>
                `;

                    // Stile per animazione
                    const style = document.createElement('style');
                    style.textContent = `
                    @keyframes popInCenter {
                        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
                        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    }
                `;
                    document.head.appendChild(style);

                    document.body.appendChild(popup);

                    // Countdown 3 secondi
                    let count = 3;
                    const countdownEl = document.getElementById('countdown');
                    const countdownInterval = setInterval(() => {
                        count--;
                        if (countdownEl) countdownEl.textContent = count;
                        if (count <= 0) {
                            clearInterval(countdownInterval);
                            if (popup.parentNode) {
                                popup.parentNode.removeChild(popup);
                                if (style.parentNode) style.parentNode.removeChild(style);
                            }
                        }
                    }, 1000);
                }



                sendStampsUpdateWhatsApp(customerId, stampsAdded) {
                    console.log('üìû sendStampsUpdateWhatsApp chiamato:', { customerId, stampsAdded });

                    const customer = this.db.customers.find(c => c.id === customerId);
                    console.log('üë§ Cliente trovato:', customer ? customer.firstName : 'NESSUNO');
                    console.log('üì± Telefono cliente:', customer?.phone);

                    if (!customer || !customer.phone) {
                        console.error('‚ùå Cliente senza telefono, impossibile aprire WhatsApp');
                        this.showToast('‚ö†Ô∏è Cliente senza numero di telefono', 'warning');
                        return;
                    }

                    const phone = customer.phone.replace(/[^0-9]/g, '');
                    const phoneFormatted = phone.startsWith('39') ? phone : '39' + phone;
                    console.log('üìû Telefono formattato:', phoneFormatted);

                    const currentStamps = customer.fidelity.stamps;
                    const totalNeeded = this.fidelityConfig.stampsPerReward;
                    const availableRewards = Math.floor(currentStamps / totalNeeded);
                    const stampsToNext = totalNeeded - (currentStamps % totalNeeded);

                    let message = `üéâ Ciao ${customer.firstName}!\n\n`;

                    // Cambia il messaggio in base a se sono stati aggiunti bollini o √® solo un aggiornamento
                    if (stampsAdded > 0) {
                        message += `üìç Hai appena guadagnato ${stampsAdded} bollin${stampsAdded === 1 ? 'o' : 'i'}!\n\n`;
                    } else {
                        message += `üí≥ Ecco la situazione aggiornata della tua tessera fedelt√†!\n\n`;
                    }

                    message += `üè∑Ô∏è Bollini totali: ${currentStamps}/${totalNeeded}\n`;

                    if (availableRewards > 0) {
                        message += `üéÅ Hai ${availableRewards} premi${availableRewards === 1 ? 'o' : ''} disponibil${availableRewards === 1 ? 'e' : 'i'}!\n\n` +
                            `üéä Fantastico! Passa in negozio per riscattare il tuo premio! üéä\n`;
                    } else if (currentStamps % totalNeeded === 0) {
                        message += `\nüî• Hai completato la card! Al prossimo acquisto avrai un premio! üî•\n`;
                    } else if (stampsToNext > 0) {
                        message += `\n‚≠ê Ti manc${stampsToNext === 1 ? 'a' : 'ano'} solo ${stampsToNext} bollin${stampsToNext === 1 ? 'o' : 'i'} al prossimo premio!\n`;
                    }

                    message += `\nGrazie per la fiducia! üòä\n\nPastificio Gramsci`;

                    console.log('üí¨ Messaggio WhatsApp:', message);

                    const whatsappUrl = `https://wa.me/${phoneFormatted}?text=${encodeURIComponent(message)}`;
                    console.log('üîó URL WhatsApp:', whatsappUrl);

                    window.open(whatsappUrl, '_blank');
                    console.log('‚úÖ window.open chiamato');

                    this.showToast('‚úÖ Messaggio aggiornamento pronto su WhatsApp');
                }

                // NUOVA FUNZIONE: Messaggio premio riscattato
                sendRewardRedeemedWhatsApp(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer || !customer.phone) {
                        console.log('‚ö†Ô∏è Cliente senza telefono, skip notifica WhatsApp');
                        return;
                    }

                    const phone = customer.phone.replace(/[^0-9]/g, '');
                    const phoneFormatted = phone.startsWith('39') ? phone : '39' + phone;

                    const currentStamps = customer.fidelity?.stamps || 0;
                    const totalRedeemed = customer.fidelity?.rewards || 0;
                    const stampsPerReward = this.fidelityConfig.stampsPerReward;
                    const stampsToNext = stampsPerReward - (currentStamps % stampsPerReward);

                    const message = `üéâ Complimenti ${customer.firstName}!\n\n` +
                        `‚úÖ Il tuo premio √® stato riscattato con successo!\n\n` +
                        `üìä Riepilogo:\n` +
                        `‚Ä¢ Premi riscattati totali: ${totalRedeemed}\n` +
                        `‚Ä¢ Bollini attuali: ${currentStamps}/${stampsPerReward}\n\n` +
                        `üí™ Continua cos√¨! Al prossimo premio ti manc${stampsToNext === 1 ? 'a' : 'ano'} ${stampsToNext} bollin${stampsToNext === 1 ? 'o' : 'i'}!\n\n` +
                        `Grazie per la fiducia! üòä\n\nPastificio Gramsci`;

                    const whatsappUrl = `https://wa.me/${phoneFormatted}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                    console.log('üì± Aperto WhatsApp per notifica premio riscattato');
                }

                showWhatsAppInstructions(customer, imageUrl, isCard = false) {
                    const modal = document.createElement('div');
                    modal.className = 'modal open fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-[150]';
                    modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
                        <h3 class="text-xl font-bold mb-4">üì± Invia ${isCard ? 'Tessera' : 'QR'} su WhatsApp</h3>
                        
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                            <p class="text-sm text-green-800 mb-2">
                                <strong>‚úÖ ${isCard ? 'Tessera' : 'QR Code'} scaricata!</strong>
                            </p>
                            <p class="text-sm text-green-700">
                                Troverai l'immagine nella cartella Download
                            </p>
                        </div>

                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                            <p class="text-sm font-semibold text-blue-900 mb-2">Prossimi passaggi:</p>
                            <ol class="list-decimal ml-4 space-y-2 text-sm text-blue-800">
                                <li>WhatsApp si aprir√† con ${customer.firstName}</li>
                                <li>Il messaggio √® gi√† pronto</li>
                                <li><strong>Allega l'immagine</strong> (click su üìé ‚Üí Foto)</li>
                                <li>Invia!</li>
                            </ol>
                        </div>

                        <div class="space-y-3">
                            <a href="${imageUrl}" download="tessera-${customer.firstName}-${customer.lastName}.png" 
                               class="block w-full bg-purple-600 text-white text-center py-3 px-4 rounded-lg hover:bg-purple-700 font-medium">
                                üì• Scarica di nuovo l'immagine
                            </a>
                            <button onclick="this.closest('.modal').remove()" 
                                    class="w-full bg-gray-200 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-300 font-medium">
                                Ho capito, chiudi
                            </button>
                        </div>
                    </div>
                `;
                    document.body.appendChild(modal);

                    this.showToast(`‚úÖ ${isCard ? 'Tessera' : 'QR'} generata! Segui le istruzioni`);
                }

                // QUICK CUSTOMER ADD
                openQuickCustomerAdd() {
                    document.getElementById('quick-firstname').value = '';
                    document.getElementById('quick-lastname').value = '';
                    document.getElementById('quick-phone').value = '';
                    document.getElementById('quick-email').value = '';
                    document.getElementById('quick-marketing').checked = false;
                    document.getElementById('quick-stamps').value = '';
                    document.getElementById('quick-stamps-preview').classList.add('hidden');
                    document.getElementById('quick-customer-status').classList.add('hidden');
                    document.getElementById('quick-existing-customer-id').value = '';
                    document.getElementById('quick-save-btn-text').textContent = 'Salva & Invia Tessera';

                    this.openModal('quick-customer-modal');
                }

                checkQuickCustomerExists() {
                    const firstName = document.getElementById('quick-firstname').value.trim().toLowerCase();
                    const lastName = document.getElementById('quick-lastname').value.trim().toLowerCase();
                    const phone = document.getElementById('quick-phone').value.trim().replace(/[^0-9]/g, '');

                    // Cerca solo se c'√® almeno un dato
                    if (!firstName && !lastName && !phone) {
                        document.getElementById('quick-customer-status').classList.add('hidden');
                        document.getElementById('quick-existing-customer-id').value = '';
                        return;
                    }

                    // Cerca cliente esistente
                    const existingCustomer = this.db.customers.find(c => {
                        const nameMatch = firstName && lastName &&
                            c.firstName.toLowerCase() === firstName &&
                            c.lastName.toLowerCase() === lastName;
                        const phoneMatch = phone.length >= 9 && c.phone &&
                            c.phone.replace(/[^0-9]/g, '').includes(phone);
                        return nameMatch || phoneMatch;
                    });

                    if (existingCustomer) {
                        // Cliente trovato - popola i campi
                        document.getElementById('quick-firstname').value = existingCustomer.firstName;
                        document.getElementById('quick-lastname').value = existingCustomer.lastName;
                        document.getElementById('quick-phone').value = existingCustomer.phone || '';
                        document.getElementById('quick-email').value = existingCustomer.email || '';
                        document.getElementById('quick-marketing').checked = existingCustomer.marketing || false;
                        document.getElementById('quick-existing-customer-id').value = existingCustomer.id;

                        // Mostra status
                        const statusDiv = document.getElementById('quick-customer-status');
                        statusDiv.innerHTML = `
                        <div class="bg-green-50 border-l-4 border-green-500 p-4">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="flex-1">
                                    <p class="font-semibold text-green-800">‚úÖ Cliente Trovato!</p>
                                    <p class="text-sm text-green-700 mt-1">
                                        ${existingCustomer.firstName} ${existingCustomer.lastName}<br>
                                        Bollini attuali: <strong>${existingCustomer.fidelity?.stamps || 0}/${this.fidelityConfig.stampsPerReward}</strong><br>
                                        Premi: <strong>${existingCustomer.fidelity?.rewards || 0}</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                        statusDiv.classList.remove('hidden');
                        document.getElementById('quick-save-btn-text').textContent = 'Aggiungi Bollini & Aggiorna';
                    } else {
                        document.getElementById('quick-customer-status').classList.add('hidden');
                        document.getElementById('quick-existing-customer-id').value = '';
                        document.getElementById('quick-save-btn-text').textContent = 'Salva & Invia Tessera';
                    }

                    // Aggiorna anteprima bollini se c'√® un importo
                    this.updateQuickStampsPreview();
                }

                updateQuickStampsPreview() {
                    const stamps = parseInt(document.getElementById('quick-stamps').value) || 0;
                    if (stamps > 0) {
                        document.getElementById('preview-stamps').textContent = stamps;
                        document.getElementById('quick-stamps-preview').classList.remove('hidden');
                    } else {
                        document.getElementById('quick-stamps-preview').classList.add('hidden');
                    }
                }

                saveQuickCustomer() {
                    const firstName = document.getElementById('quick-firstname').value.trim();
                    const lastName = document.getElementById('quick-lastname').value.trim();
                    const phone = document.getElementById('quick-phone').value.trim();
                    const email = document.getElementById('quick-email').value.trim();
                    const marketing = document.getElementById('quick-marketing').checked;
                    const stampsToAdd = parseInt(document.getElementById('quick-stamps').value);
                    const existingCustomerId = document.getElementById('quick-existing-customer-id').value;

                    if (!firstName || !lastName || !phone) {
                        this.showToast('‚ùå Compila tutti i campi obbligatori', 'error');
                        return;
                    }

                    if (isNaN(stampsToAdd) || stampsToAdd <= 0) {
                        this.showToast('‚ùå Inserisci un numero di bollini valido', 'error');
                        return;
                    }

                    if (existingCustomerId) {
                        // Cliente esistente - aggiorna dati e aggiungi bollini
                        const customer = this.db.customers.find(c => c.id === existingCustomerId);
                        if (customer) {
                            customer.phone = phone;
                            customer.email = email;
                            customer.marketing = marketing;

                            this.addStampsDirectly(customer.id, stampsToAdd);
                            this.saveData();
                            this.showToast(`‚úÖ ${stampsToAdd} bollini aggiunti a ${customer.firstName}!`);

                            // Invia solo messaggio di aggiornamento
                            setTimeout(() => {
                                if (confirm(`Vuoi inviare l'aggiornamento bollini a ${customer.firstName} su WhatsApp?`)) {
                                    this.sendStampsUpdateWhatsApp(customer.id, stampsToAdd);
                                }
                            }, 1000);
                        }
                    } else {
                        // Nuovo cliente - invia tessera completa
                        const newCustomer = {
                            id: this.generateId(),
                            firstName,
                            lastName,
                            phone,
                            email,
                            marketing,
                            fidelity: { stamps: 0, totalSpent: 0, rewards: 0, history: [], cardSent: false }
                        };

                        this.db.customers.push(newCustomer);
                        this.addStampsDirectly(newCustomer.id, stampsToAdd);
                        this.saveData();

                        this.showToast(`‚úÖ Cliente ${firstName} creato con ${stampsToAdd} bollini!`);

                        // Invia tessera automaticamente su WhatsApp per nuovi clienti
                        setTimeout(() => {
                            this.sendFidelityCardWhatsApp(newCustomer.id);
                            this.showToast(`üì± Apertura WhatsApp con tessera di ${firstName}...`);
                        }, 1000);
                    }

                    this.closeModal('quick-customer-modal');
                    this.render();
                }

                // QR SCANNER
                openQRScanner() {
                    this.openModal('qr-scanner-modal');
                    document.getElementById('qr-result').innerHTML = '<p class="text-gray-500">Clicca "Avvia Camera" o carica un\'immagine</p>';
                }

                async startQRScanner() {
                    const video = document.getElementById('qr-video');
                    const canvas = document.getElementById('qr-canvas');
                    const result = document.getElementById('qr-result');
                    const startBtn = document.getElementById('start-scanner-btn');

                    try {
                        // Verifica che getUserMedia sia disponibile
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            throw new Error('Il tuo browser non supporta l\'accesso alla fotocamera');
                        }

                        startBtn.textContent = 'Richiesta permessi...';
                        startBtn.disabled = true;

                        // Prova prima con fotocamera posteriore (environment)
                        let constraints = {
                            video: {
                                facingMode: { ideal: 'environment' },
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        };

                        try {
                            this.qrStream = await navigator.mediaDevices.getUserMedia(constraints);
                        } catch (firstError) {
                            console.log('Tentativo con fotocamera posteriore fallito, provo con qualsiasi fotocamera...', firstError);

                            // Fallback: prova con qualsiasi fotocamera disponibile
                            constraints = {
                                video: {
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 }
                                }
                            };
                            this.qrStream = await navigator.mediaDevices.getUserMedia(constraints);
                        }

                        video.srcObject = this.qrStream;
                        video.style.display = 'block';

                        // Attendi che il video sia pronto
                        await video.play();

                        startBtn.textContent = 'üì∑ Scansionando...';
                        result.innerHTML = '<p class="text-green-600">‚úÖ Camera attiva - Inquadra il QR code</p>';

                        const ctx = canvas.getContext('2d');
                        let scanning = true;

                        const scan = () => {
                            if (!scanning || !this.qrStream) return;

                            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                canvas.height = video.videoHeight;
                                canvas.width = video.videoWidth;
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                const code = jsQR(imageData.data, imageData.width, imageData.height);

                                if (code) {
                                    scanning = false;
                                    this.processQRCode(code.data);
                                    return;
                                }
                            }
                            requestAnimationFrame(scan);
                        };
                        scan();

                    } catch (err) {
                        console.error('Errore accesso fotocamera:', err);

                        let errorMessage = '‚ùå Impossibile accedere alla fotocamera';

                        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                            errorMessage = '‚ùå Permesso fotocamera negato. Vai nelle impostazioni del browser e consenti l\'accesso alla fotocamera per questo sito.';
                        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                            errorMessage = '‚ùå Nessuna fotocamera trovata sul dispositivo.';
                        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                            errorMessage = '‚ùå Fotocamera in uso da un\'altra applicazione. Chiudi altre app che usano la camera.';
                        } else if (err.name === 'OverconstrainedError') {
                            errorMessage = '‚ùå Le impostazioni richieste non sono supportate dalla fotocamera.';
                        } else if (err.name === 'SecurityError') {
                            errorMessage = '‚ùå Errore di sicurezza. Assicurati di usare HTTPS o localhost.';
                        } else if (err.message) {
                            errorMessage = `‚ùå ${err.message}`;
                        }

                        result.innerHTML = `<p class="text-red-600">${errorMessage}</p>
                        <p class="text-sm text-gray-600 mt-2">üí° Suggerimento: Prova a caricare un'immagine del QR code usando il pulsante qui sotto</p>`;

                        startBtn.textContent = 'Riprova Camera';
                        startBtn.disabled = false;

                        this.showToast(errorMessage, 'error');
                    }
                }

                scanQRFromFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.getElementById('qr-canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);

                            if (code) {
                                this.processQRCode(code.data);
                            } else {
                                document.getElementById('qr-result').innerHTML = '<p class="text-red-600">‚ùå QR Code non trovato nell\'immagine</p>';
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }

                processQRCode(data) {
                    try {
                        const qrData = JSON.parse(data);
                        if (qrData.app === 'fidelity-card' && qrData.id) {
                            this.closeQRScanner();
                            this.openFidelityCard(qrData.id);
                        } else {
                            document.getElementById('qr-result').innerHTML = '<p class="text-red-600">‚ùå QR Code non valido</p>';
                        }
                    } catch (err) {
                        document.getElementById('qr-result').innerHTML = '<p class="text-red-600">‚ùå QR Code non valido</p>';
                    }
                }

                closeQRScanner() {
                    if (this.qrStream) {
                        this.qrStream.getTracks().forEach(track => track.stop());
                        this.qrStream = null;
                    }
                    const video = document.getElementById('qr-video');
                    video.style.display = 'none';
                    video.srcObject = null;
                    document.getElementById('start-scanner-btn').textContent = 'Avvia Camera';
                    document.getElementById('start-scanner-btn').disabled = false;
                    document.getElementById('qr-file').value = '';
                    this.closeModal('qr-scanner-modal');
                }

                // FUNZIONI SCANNER DASHBOARD
                async toggleDashboardScanner() {
                    const container = document.getElementById('dashboard-scanner-container');
                    const video = document.getElementById('dashboard-scanner-video');
                    const toggleBtn = document.getElementById('dashboard-scanner-toggle');

                    if (container.classList.contains('hidden')) {
                        // Apri scanner
                        container.classList.remove('hidden');
                        toggleBtn.textContent = 'Ferma Scanner';
                        toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                        this.startDashboardScanner();
                    } else {
                        // Chiudi scanner
                        this.stopDashboardScanner();
                        container.classList.add('hidden');
                        toggleBtn.textContent = 'Avvia Scanner';
                        toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    }
                }

                async startDashboardScanner() {
                    const video = document.getElementById('dashboard-scanner-video');
                    const canvas = document.getElementById('dashboard-scanner-canvas');
                    const status = document.getElementById('dashboard-scanner-status');
                    const overlay = document.getElementById('dashboard-scanner-overlay');

                    try {
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            throw new Error('Il tuo browser non supporta l\'accesso alla fotocamera');
                        }

                        status.textContent = 'üì∑ Richiesta permessi fotocamera...';
                        status.className = 'text-center text-lg font-semibold mb-4 text-blue-600';

                        let constraints = {
                            video: {
                                facingMode: { ideal: 'environment' },
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        };

                        try {
                            this.dashboardScannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                        } catch (firstError) {
                            console.log('Tentativo con fotocamera posteriore fallito, provo con qualsiasi fotocamera...', firstError);
                            constraints = {
                                video: {
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 }
                                }
                            };
                            this.dashboardScannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                        }

                        video.srcObject = this.dashboardScannerStream;
                        video.style.display = 'block';
                        overlay.classList.remove('hidden');
                        overlay.classList.add('flex');
                        await video.play();

                        status.textContent = 'üéØ Inquadra il QR code della tessera';
                        status.className = 'text-center text-lg font-semibold mb-4 text-green-600';

                        const ctx = canvas.getContext('2d');
                        let isScanning = true;

                        const scan = () => {
                            if (!isScanning || !this.dashboardScannerStream) return;

                            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                canvas.height = video.videoHeight;
                                canvas.width = video.videoWidth;
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                const code = jsQR(imageData.data, imageData.width, imageData.height);

                                if (code) {
                                    isScanning = false;
                                    this.processDashboardQRCode(code.data);
                                    return;
                                }
                            }
                            requestAnimationFrame(scan);
                        };
                        scan();

                    } catch (err) {
                        console.error('Errore accesso fotocamera:', err);

                        let errorMessage = '‚ùå Impossibile accedere alla fotocamera';

                        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                            errorMessage = '‚ùå Permesso negato. Vai nelle impostazioni del browser e consenti l\'accesso alla fotocamera';
                        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                            errorMessage = '‚ùå Nessuna fotocamera trovata';
                        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                            errorMessage = '‚ùå Fotocamera in uso. Chiudi altre app';
                        } else if (err.message) {
                            errorMessage = `‚ùå ${err.message}`;
                        }

                        status.innerHTML = `<div class="text-center">
                        <p class="text-red-600 font-semibold mb-2">${errorMessage}</p>
                        <p class="text-sm text-gray-600">üí° Prova a caricare un'immagine del QR code</p>
                    </div>`;

                        this.showToast(errorMessage, 'error');
                    }
                }

                stopDashboardScanner() {
                    if (this.dashboardScannerStream) {
                        this.dashboardScannerStream.getTracks().forEach(track => track.stop());
                        this.dashboardScannerStream = null;
                    }
                    const video = document.getElementById('dashboard-scanner-video');
                    const overlay = document.getElementById('dashboard-scanner-overlay');
                    video.style.display = 'none';
                    video.srcObject = null;
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    document.getElementById('dashboard-scanner-status').textContent = '';
                    document.getElementById('dashboard-scanner-file').value = '';
                }

                processDashboardQRCode(data) {
                    try {
                        const qrData = JSON.parse(data);
                        if (qrData.app === 'fidelity-card' && qrData.id) {
                            this.stopDashboardScanner();
                            document.getElementById('dashboard-scanner-container').classList.add('hidden');
                            const toggleBtn = document.getElementById('dashboard-scanner-toggle');
                            toggleBtn.textContent = 'Avvia Scanner';
                            toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                            toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                            this.showToast('‚úÖ Tessera rilevata!');
                            this.openFidelityCard(qrData.id);
                        } else {
                            document.getElementById('dashboard-scanner-status').innerHTML = '<p class="text-red-600">‚ùå QR Code non valido</p>';
                        }
                    } catch (err) {
                        document.getElementById('dashboard-scanner-status').innerHTML = '<p class="text-red-600">‚ùå QR Code non valido</p>';
                    }
                }

                scanFromFileDashboard(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const status = document.getElementById('dashboard-scanner-status');
                    status.textContent = 'üîç Analisi immagine...';
                    status.className = 'text-center text-lg font-semibold mb-4 text-blue-600';

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.getElementById('dashboard-scanner-canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);

                            if (code) {
                                this.processDashboardQRCode(code.data);
                            } else {
                                status.textContent = '‚ùå QR Code non trovato nell\'immagine';
                                status.className = 'text-center text-lg font-semibold mb-4 text-red-600';
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    event.target.value = '';
                }

                searchFidelityCustomer(query) {
                    const suggestions = document.getElementById('fidelity-suggestions');
                    if (query.length < 2) { suggestions.classList.add('hidden'); return; }
                    const matches = this.db.customers.filter(c => {
                        const fullName = `${c.firstName} ${c.lastName}`.toLowerCase();
                        const phone = (c.phone || '').toLowerCase();
                        return fullName.includes(query.toLowerCase()) || phone.includes(query.toLowerCase());
                    });
                    if (matches.length === 0) { suggestions.classList.add('hidden'); return; }
                    suggestions.innerHTML = matches.map(c => `<div class="autocomplete-suggestion" data-customer-id="${c.id}" onclick="app.openFidelityCard(this.dataset.customerId)"><div class="font-medium">${c.lastName} ${c.firstName}</div><div class="text-sm text-gray-600">${c.fidelity?.stamps || 0} bollini - ${c.fidelity?.rewards || 0} premi</div></div>`).join('');
                    suggestions.classList.remove('hidden');
                }

                saveData() {
                    console.log('üíæ saveData chiamato - editingFidelity:', this.editingFidelity);

                    // Aggiungi timestamp di ultima modifica
                    this.db.lastModified = new Date().toISOString();

                    // Cripta i dati prima di salvarli
                    const encryptedData = authManager.encrypt(this.db);
                    if (encryptedData) {
                        localStorage.setItem('orderManagerData', encryptedData);
                    } else {
                        console.error('Errore crittografia dati');
                        return;
                    }

                    const now = new Date().toISOString();
                    localStorage.setItem('lastSync', now);
                    this.updateLastSyncInfo();
                    this.updateStats();

                    // Sync automatico su Dropbox se attivo (MA NON durante editing fidelity)
                    if (this.autoSyncEnabled && !this.syncInProgress && !this.editingFidelity) {
                        console.log('üì§ Avvio upload automatico su Dropbox');
                        this.syncToDropbox(true);
                    } else if (this.editingFidelity) {
                        console.log('‚è∏Ô∏è Upload Dropbox posticipato (editing fidelity in corso)');
                    }
                }

                batchRender(components) {
                    // üîí SAFE: Durante editing/modal/sync, render IMMEDIATO (no ottimizzazione)
                    if (this.editingFidelity || this.modalOpen || this.syncInProgress) {
                        if (components.includes('dashboard')) this.renderDashboard();
                        if (components.includes('fidelity')) this.renderFidelityDashboard();
                        if (components.includes('customers')) this.renderFidelityCustomers();
                        if (components.includes('orders')) this.renderOrders();
                        console.log('üîí Render immediato (lock attivo - data safe)');
                        return;
                    }

                    // ‚ö° Altrimenti ottimizza con requestAnimationFrame
                    requestAnimationFrame(() => {
                        if (components.includes('dashboard')) this.renderDashboard();
                        if (components.includes('fidelity')) this.renderFidelityDashboard();
                        if (components.includes('customers')) this.renderFidelityCustomers();
                        if (components.includes('orders')) this.renderOrders();
                        console.log('‚ö° Render ottimizzato (nessun lock attivo)');
                    });
                }

                generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
                formatPrice(price) { return parseFloat(price || 0).toFixed(2).replace('.', ',') + ' ‚Ç¨'; }
                formatDate(dateStr) { if (!dateStr) return ''; const d = new Date(dateStr + 'T00:00:00'); return d.toLocaleDateString('it-IT'); }

                // Sanitizzazione per prevenire XSS
                sanitizeHTML(str) {
                    const temp = document.createElement('div');
                    temp.textContent = str;
                    return temp.innerHTML;
                }

                showToast(message, type = 'success') {
                    const container = document.getElementById('toast-container');

                    const toast = document.createElement('div');
                    toast.className = 'toast';

                    const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
                    const icon = type === 'success' ? '‚úì' : '‚úï';

                    toast.innerHTML = `
                    <div class="${bgColor} text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 min-w-[300px]">
                        <span class="text-2xl font-bold">${icon}</span>
                        <span class="font-medium">${message}</span>
                    </div>
                `;

                    container.appendChild(toast);

                    // Anima l'entrata
                    setTimeout(() => toast.classList.add('show'), 10);

                    // Rimuovi dopo 3 secondi
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => container.removeChild(toast), 300);
                    }, 3000);
                }

                switchTab(tabName) {
                    // Ferma lo scanner della Dashboard se attivo
                    if (this.dashboardScannerStream) {
                        this.stopDashboardScanner();
                        const container = document.getElementById('dashboard-scanner-container');
                        const toggleBtn = document.getElementById('dashboard-scanner-toggle');
                        if (container && !container.classList.contains('hidden')) {
                            container.classList.add('hidden');
                            toggleBtn.textContent = 'Avvia Scanner';
                            toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                            toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        }
                    }

                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.className = btn.dataset.tab === tabName ? 'tab-btn flex-1 p-4 border-b-2 border-blue-600 text-blue-600 font-semibold whitespace-nowrap' : 'tab-btn flex-1 p-4 border-b-2 border-transparent text-gray-500 whitespace-nowrap';
                    });
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

                    const targetTab = document.getElementById(`tab-${tabName}`);
                    if (targetTab) {
                        targetTab.classList.remove('hidden');
                    } else {
                        console.error(`‚ùå Tab non trovata: tab-${tabName}`);
                        return;
                    }
                    // Reset filtri quando si cambia tab
                    if (tabName === 'ordini') {
                        this.filteredOrders = null;
                        if (document.getElementById('order-search')) {
                            document.getElementById('order-search').value = '';
                            document.getElementById('prep-filter').value = '';
                            document.getElementById('payment-filter').value = '';
                        }
                    }

                    // Aggiorna dashboard quando si apre
                    if (tabName === 'dashboard') {
                        this.renderDashboard();
                        this.updateDashboardStats();
                    }

                    // Aggiorna preparazione quando si apre
                    if (tabName === 'preparazione') {
                        const prepDateFilter = document.getElementById('prep-date-filter');
                        const prepStatusFilter = document.getElementById('prep-status-filter');

                        if (prepDateFilter) {
                            const tomorrow = new Date();
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            prepDateFilter.value = tomorrow.toISOString().split('T')[0];
                        }

                        if (prepStatusFilter) {
                            prepStatusFilter.value = '';
                        }

                        this.renderPreparation();
                    }

                    // Aggiorna modifiche quando si apre
                    if (tabName === 'modifiche') {
                        const modDateFilter = document.getElementById('mod-date-filter');

                        if (modDateFilter) {
                            const tomorrow = new Date();
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            modDateFilter.value = tomorrow.toISOString().split('T')[0];
                        }

                        this.renderModifications();
                    }

                    // Aggiorna fidelity quando si apre
                    if (tabName === 'fidelity') {
                        this.renderFidelityDashboard();
                    }
                }

                openModal(modalId) {
                    this.modalOpen = true;
                    const modal = document.getElementById(modalId);
                    modal.classList.add('open');

                    // üîß FIX MOBILE: Blocca scroll body
                    this._scrollPosition = window.scrollY;
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.width = '100%';
                    document.body.style.top = `-${this._scrollPosition}px`;
                }

                closeModal(modalId) {
                    this.modalOpen = false;
                    const modal = document.getElementById(modalId);
                    modal.classList.remove('open');

                    // üîß FIX MOBILE: Ripristina scroll
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.width = '';
                    document.body.style.top = '';

                    if (this._scrollPosition !== undefined) {
                        window.scrollTo(0, this._scrollPosition);
                        this._scrollPosition = undefined;
                    }
                }

                // CATEGORIE
                openCategoryModal(id = null) {
                    this.editingId = id;
                    document.getElementById('category-name').value = '';
                    document.getElementById('btn-delete-category').classList.add('hidden');
                    if (id) {
                        const cat = this.db.categories.find(c => c.id === id);
                        if (cat) {
                            document.getElementById('category-name').value = cat.name;
                            document.getElementById('btn-delete-category').classList.remove('hidden');
                        }
                    }
                    this.openModal('category-modal');
                }

                async saveCategory() {
                    const name = document.getElementById('category-name').value.trim();
                    if (!name) {
                        this.showToast('‚ùå Nome obbligatorio', 'error');
                        return;
                    }

                    const isDuplicate = this.db.categories.some(c =>
                        c.name.toLowerCase() === name.toLowerCase() && c.id !== this.editingId
                    );
                    if (isDuplicate) {
                        this.showToast('‚ùå Categoria esistente', 'error');
                        return;
                    }

                    if (this.editingId) {
                        const idx = this.db.categories.findIndex(c => c.id === this.editingId);
                        if (idx > -1) {
                            this.db.categories[idx].name = name;
                            this.db.categories[idx].lastModified = new Date().toISOString();
                        }
                    } else {
                        this.db.categories.push({
                            id: this.generateId(),
                            name,
                            lastModified: new Date().toISOString()
                        });
                    }

                    this.saveData();
                    await this.syncToDropbox(true); // ‚úÖ AGGIUNTO await
                    this.render();
                    this.closeModal('category-modal');
                    this.showToast('‚úÖ Categoria salvata e sincronizzata');
                }

                async deleteCategory() {
                    if (!confirm('Eliminare categoria?')) return;

                    const usedInProducts = this.db.products.some(p =>
                        p.category === this.db.categories.find(c => c.id === this.editingId)?.name
                    );
                    if (usedInProducts) {
                        this.showToast('‚ùå Categoria in uso', 'error');
                        return;
                    }

                    this.db.categories = this.db.categories.filter(c => c.id !== this.editingId);
                    this.saveData();
                    await this.syncToDropbox(true); // ‚úÖ AGGIUNTO await
                    this.render();
                    this.closeModal('category-modal');
                    this.showToast('‚úÖ Categoria eliminata e sincronizzata');
                }

                // PRODOTTI
                openProductModal(id = null) {
                    this.editingId = id;
                    document.getElementById('product-name').value = '';
                    document.getElementById('product-price').value = '';
                    document.getElementById('product-unit').value = 'kg';
                    document.getElementById('product-has-average-weight').checked = false;
                    document.getElementById('product-average-weight').value = '';
                    document.getElementById('average-weight-field').classList.add('hidden');
                    document.getElementById('btn-delete-product').classList.add('hidden');
                    const select = document.getElementById('product-category');
                    select.innerHTML = '<option value="">Nessuna categoria</option>';
                    this.db.categories.forEach(cat => { select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`; });
                    if (id) {
                        const prod = this.db.products.find(p => p.id === id);
                        if (prod) {
                            document.getElementById('product-name').value = prod.name;
                            document.getElementById('product-category').value = prod.category || '';
                            document.getElementById('product-price').value = prod.price;
                            document.getElementById('product-unit').value = prod.unit;

                            // Gestisci peso medio
                            if (prod.averageWeight) {
                                document.getElementById('product-has-average-weight').checked = true;
                                document.getElementById('product-average-weight').value = prod.averageWeight;
                                document.getElementById('average-weight-field').classList.remove('hidden');
                            }

                            document.getElementById('btn-delete-product').classList.remove('hidden');
                        }
                    }
                    this.openModal('product-modal');
                }

                toggleAverageWeightField() {
                    const checkbox = document.getElementById('product-has-average-weight');
                    const field = document.getElementById('average-weight-field');

                    if (checkbox.checked) {
                        field.classList.remove('hidden');
                    } else {
                        field.classList.add('hidden');
                        document.getElementById('product-average-weight').value = '';
                    }
                }

                async saveProduct() {
                    const name = document.getElementById('product-name').value.trim();
                    const price = parseFloat(document.getElementById('product-price').value);
                    const category = document.getElementById('product-category').value;
                    const unit = document.getElementById('product-unit').value;
                    const hasAverageWeight = document.getElementById('product-has-average-weight').checked;
                    const averageWeight = hasAverageWeight ? parseFloat(document.getElementById('product-average-weight').value) : null;

                    // Validazioni
                    if (!name) {
                        this.showToast('‚ùå Nome prodotto obbligatorio', 'error');
                        return;
                    }
                    if (isNaN(price)) {
                        this.showToast('‚ùå Prezzo non valido', 'error');
                        return;
                    }
                    if (price < 0) {
                        this.showToast('‚ùå Il prezzo non pu√≤ essere negativo', 'error');
                        return;
                    }
                    if (price === 0 && !confirm('‚ö†Ô∏è Il prezzo √® zero. Confermi?')) {
                        return;
                    }
                    if (price > 100000) {
                        this.showToast('‚ùå Prezzo troppo elevato (max ‚Ç¨100,000)', 'error');
                        return;
                    }
                    if (hasAverageWeight && (isNaN(averageWeight) || averageWeight <= 0)) {
                        this.showToast('‚ùå Peso medio non valido', 'error');
                        return;
                    }

                    // Controlla duplicati
                    const isDuplicate = this.db.products.some(p =>
                        p.name.toLowerCase() === name.toLowerCase() &&
                        p.id !== this.editingId &&
                        !p.deleted
                    );

                    if (isDuplicate) {
                        this.showToast('‚ùå Prodotto gi√† esistente', 'error');
                        return;
                    }

                    const product = {
                        id: this.editingId || this.generateId(),
                        name,
                        category,
                        price,
                        unit,
                        lastModified: new Date().toISOString()
                    };

                    // Aggiungi peso medio solo se specificato
                    if (hasAverageWeight && averageWeight > 0) {
                        product.weightPerPiece = averageWeight;
                    }

                    if (this.editingId) {
                        const idx = this.db.products.findIndex(p => p.id === this.editingId);
                        if (idx > -1) this.db.products[idx] = product;
                    } else {
                        this.db.products.push(product);
                    }

                    this.saveData();
                    await this.syncToDropbox(true); // ‚úÖ AGGIUNTO SYNC

                    this.render();
                    this.closeModal('product-modal');
                    this.showToast('‚úÖ Prodotto salvato e sincronizzato');
                }

                deleteProduct() {
                    const usedInOrders = this.db.orders.some(o => o.items.some(item => item.productId === this.editingId));
                    if (usedInOrders) {
                        this.showToast('‚ùå Impossibile eliminare: prodotto presente in ordini esistenti', 'error');
                        return;
                    }
                    const product = this.db.products.find(p => p.id === this.editingId);
                    this.pendingDelete = {
                        type: 'product',
                        id: this.editingId,
                        name: product?.name || 'questo prodotto'
                    };
                    document.getElementById('confirm-message').textContent =
                        `Sei sicuro di voler eliminare "${this.pendingDelete.name}"? Questa azione non pu√≤ essere annullata.`;

                    // Chiudi modal prodotto prima di aprire conferma
                    this.closeModal('product-modal');

                    // Apri modal conferma dopo un piccolo delay
                    setTimeout(() => {
                        this.openModal('confirm-modal');
                    }, 100);
                }

                // CLIENTI
                openCustomerModal(id = null) {
                    this.editingId = id;
                    document.getElementById('edit-customer-firstname').value = '';
                    document.getElementById('edit-customer-lastname').value = '';
                    document.getElementById('edit-customer-phone').value = '';
                    document.getElementById('edit-customer-email').value = '';
                    document.getElementById('edit-customer-marketing').checked = false;
                    document.getElementById('btn-delete-customer').classList.add('hidden');

                    if (id) {
                        const cust = this.db.customers.find(c => c.id === id);
                        if (cust) {
                            document.getElementById('edit-customer-firstname').value = cust.firstName;
                            document.getElementById('edit-customer-lastname').value = cust.lastName;
                            document.getElementById('edit-customer-phone').value = cust.phone || '';
                            document.getElementById('edit-customer-email').value = cust.email || '';
                            document.getElementById('edit-customer-marketing').checked = cust.marketing || false;
                            document.getElementById('btn-delete-customer').classList.remove('hidden');
                        }
                    }
                    this.openModal('customer-modal');
                }

                async saveCustomer() {
                    const firstName = document.getElementById('edit-customer-firstname').value.trim();
                    const lastName = document.getElementById('edit-customer-lastname').value.trim();
                    const phone = document.getElementById('edit-customer-phone').value.trim();
                    const email = document.getElementById('edit-customer-email').value.trim();
                    const marketing = document.getElementById('edit-customer-marketing').checked;

                    if (!firstName || !lastName) {
                        this.showToast('‚ùå Nome e cognome obbligatori', 'error');
                        return;
                    }

                    const isDuplicate = this.db.customers.some(c => {
                        if (c.id === this.editingId || c.deleted) return false;
                        const sameName = c.firstName.toLowerCase() === firstName.toLowerCase() &&
                            c.lastName.toLowerCase() === lastName.toLowerCase();
                        const samePhone = phone && c.phone && c.phone === phone;
                        return sameName || samePhone;
                    });

                    if (isDuplicate) {
                        this.showToast('‚ùå Cliente gi√† presente', 'error');
                        return;
                    }

                    const isNewCustomer = !this.editingId;

                    if (this.editingId) {
                        // Cliente esistente - aggiorna solo i dati anagrafici preservando fidelity
                        const idx = this.db.customers.findIndex(c => c.id === this.editingId);
                        if (idx > -1) {
                            const existingCustomer = this.db.customers[idx];
                            this.db.customers[idx] = {
                                ...existingCustomer,
                                firstName,
                                lastName,
                                phone,
                                email,
                                marketing,
                                lastModified: new Date().toISOString()
                            };
                        }
                    } else {
                        // Nuovo cliente
                        const customer = {
                            id: this.generateId(),
                            firstName,
                            lastName,
                            phone,
                            email,
                            marketing,
                            fidelity: {
                                stamps: 0,
                                totalSpent: 0,
                                rewards: 0,
                                history: [],
                                rewardsList: [],
                                cardSent: false
                            },
                            coupons: [],
                            lastModified: new Date().toISOString()
                        };
                        this.db.customers.push(customer);
                    }

                    this.saveData();
                    await this.syncToDropbox(true); // ‚úÖ AGGIUNTO await
                    this.render();
                    this.closeModal('customer-modal');
                    this.showToast('‚úÖ Cliente salvato e sincronizzato');

                    // ‚úÖ RIABILITATO invio automatico tessera
                    if (isNewCustomer) {
                        const newCustomer = this.db.customers[this.db.customers.length - 1];
                        if (newCustomer.phone) {
                            setTimeout(() => {
                                this.sendFidelityCardWhatsApp(newCustomer.id);
                                this.showToast(`üì± Tessera fedelt√† inviata a ${newCustomer.firstName}!`, 'success');
                            }, 1000);
                        }
                    }
                }

                deleteCustomer() {
                    const usedInOrders = this.db.orders.some(o => o.customerId === this.editingId && !o.deleted);
                    if (usedInOrders) {
                        this.showToast('‚ùå Impossibile eliminare: cliente presente in ordini esistenti', 'error');
                        return;
                    }
                    const customer = this.db.customers.find(c => c.id === this.editingId);
                    this.pendingDelete = {
                        type: 'customer',
                        id: this.editingId,
                        name: customer ? `${customer.firstName} ${customer.lastName}` : 'questo cliente'
                    };
                    document.getElementById('confirm-message').textContent =
                        `Sei sicuro di voler eliminare ${this.pendingDelete.name}? Questa azione non pu√≤ essere annullata.`;

                    // Chiudi modal cliente prima di aprire conferma
                    this.closeModal('customer-modal');

                    // Apri modal conferma dopo un piccolo delay
                    setTimeout(() => {
                        this.openModal('confirm-modal');
                    }, 100);
                }

                deleteFidelityCustomer(customerId) {
                    const usedInOrders = this.db.orders.some(o => o.customerId === customerId && !o.deleted);
                    if (usedInOrders) {
                        this.showToast('‚ùå Impossibile eliminare: cliente presente in ordini esistenti', 'error');
                        return;
                    }
                    const customer = this.db.customers.find(c => c.id === customerId);
                    this.pendingDelete = {
                        type: 'customer',
                        id: customerId,
                        name: customer ? `${customer.firstName} ${customer.lastName}` : 'questo cliente'
                    };
                    document.getElementById('confirm-message').textContent =
                        `Sei sicuro di voler eliminare ${this.pendingDelete.name}? Questa azione non pu√≤ essere annullata.`;

                    // Chiudi modal fidelity prima di aprire conferma
                    this.closeModal('fidelity-modal');

                    // Apri modal conferma dopo un piccolo delay
                    setTimeout(() => {
                        this.openModal('confirm-modal');
                    }, 100);
                }

                // ORDINI
                openOrderModal(id = null) {
                    this.modalOpen = true;
                    this.editingId = id;
                    this.currentOrder = { items: [] };
                    document.getElementById('order-number').value = '';
                    document.getElementById('customer-search-order').value = '';
                    document.getElementById('customer-firstname').value = '';
                    document.getElementById('customer-lastname').value = '';
                    document.getElementById('customer-phone').value = '';
                    document.getElementById('customer-marketing-order').checked = false;
                    document.getElementById('selected-customer-id').value = '';
                    document.getElementById('customer-status').innerHTML = '';
                    document.getElementById('order-created-date').value = new Date().toISOString().split('T')[0];
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    document.getElementById('order-delivery-date').value = tomorrow.toISOString().split('T')[0];
                    document.getElementById('order-prep-status').value = 'da preparare';
                    document.getElementById('order-payment-status').value = 'non pagato';
                    document.getElementById('btn-delete-order').classList.add('hidden');
                    document.getElementById('order-deposit').value = '';
                    document.getElementById('deposit-info').classList.add('hidden');

                    // Nascondi campo peso di default
                    const weightField = document.getElementById('order-weight');
                    const weightContainer = weightField.closest('.grid').children[0];
                    weightContainer.style.display = 'none';

                    // Non √® pi√π necessario popolare un select, ora utilizziamo l'autocomplete

                    if (id) {
                        const order = this.db.orders.find(o => o.id === id);
                        if (order) {
                            document.getElementById('order-number').value = order.number;
                            document.getElementById('order-created-date').value = order.createdDate;
                            document.getElementById('order-delivery-date').value = order.deliveryDate;
                            document.getElementById('order-prep-status').value = order.prepStatus;
                            document.getElementById('order-payment-status').value = order.paymentStatus;
                            document.getElementById('order-deposit').value = order.deposit || '';
                            const customer = this.db.customers.find(c => c.id === order.customerId);
                            if (customer) {
                                document.getElementById('selected-customer-id').value = customer.id;
                                document.getElementById('customer-firstname').value = customer.firstName;
                                document.getElementById('customer-lastname').value = customer.lastName;
                                document.getElementById('customer-phone').value = customer.phone || '';
                                document.getElementById('customer-marketing-order').checked = customer.marketing || false;
                                this.showCustomerStatus('existing');
                            }
                            this.currentOrder.items = [...order.items];
                            document.getElementById('btn-delete-order').classList.remove('hidden');
                        }
                    } else {
                        // Calcola il numero ordine automaticamente per nuovi ordini
                        this.updateOrderNumber();
                    }
                    this.renderOrderItems();
                    this.updateOrderDeposit(); // Aggiorna info acconto
                    this.openModal('order-modal');
                }

                updateOrderNumber() {
                    // Non ricalcolare se stiamo modificando un ordine esistente
                    if (this.editingId) {
                        return;
                    }

                    const deliveryDate = document.getElementById('order-delivery-date').value;

                    if (!deliveryDate) {
                        document.getElementById('order-number').value = '';
                        return;
                    }

                    // Formatta la data nel formato gg/m/aa
                    const date = new Date(deliveryDate);
                    const day = date.getDate();
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear().toString().slice(-2);
                    const dateFormatted = `${day}/${month}/${year}`;

                    // Conta quanti ordini esistono gi√† per quella data (escluso quello in modifica)
                    const ordersOnDate = this.db.orders.filter(o => {
                        // Escludi l'ordine in modifica dal conteggio
                        if (this.editingId && o.id === this.editingId) return false;
                        return o.deliveryDate === deliveryDate;
                    });

                    // Genera il numero progressivo (01, 02, 03, ...)
                    const progressive = String(ordersOnDate.length + 1).padStart(2, '0');

                    // Componi il numero finale: progressivo-gg/m/aa
                    const orderNumber = `${progressive}-${dateFormatted}`;

                    document.getElementById('order-number').value = orderNumber;
                }

                searchCustomer(query) {
                    const suggestions = document.getElementById('customer-suggestions');
                    if (query.length < 2) { suggestions.classList.add('hidden'); return; }
                    const matches = this.db.customers.filter(c => {
                        const fullName1 = `${c.firstName} ${c.lastName}`.toLowerCase();
                        const fullName2 = `${c.lastName} ${c.firstName}`.toLowerCase();
                        const firstName = c.firstName.toLowerCase();
                        const lastName = c.lastName.toLowerCase();
                        const phone = (c.phone || '').toLowerCase();
                        const q = query.toLowerCase();
                        return fullName1.includes(q) || fullName2.includes(q) || firstName.includes(q) || lastName.includes(q) || phone.includes(q);
                    });
                    if (matches.length === 0) { suggestions.classList.add('hidden'); return; }
                    suggestions.innerHTML = matches.map(c => `<div class="autocomplete-suggestion" data-customer-id="${c.id}" onclick="app.selectCustomerFromSearch(this.dataset.customerId)"><div class="font-medium">${c.lastName} ${c.firstName}</div><div class="text-sm text-gray-600">${c.phone || 'Nessun telefono'}</div></div>`).join('');
                    suggestions.classList.remove('hidden');
                }

                // Funzione dedicata per la ricerca clienti nel modal ordini
                searchCustomerInOrder(query) {
                    const suggestions = document.getElementById('customer-suggestions-order');
                    if (query.length < 2) { suggestions.classList.add('hidden'); return; }
                    const matches = this.db.customers.filter(c => {
                        const fullName1 = `${c.firstName} ${c.lastName}`.toLowerCase();
                        const fullName2 = `${c.lastName} ${c.firstName}`.toLowerCase();
                        const firstName = c.firstName.toLowerCase();
                        const lastName = c.lastName.toLowerCase();
                        const phone = (c.phone || '').toLowerCase();
                        const q = query.toLowerCase();
                        return fullName1.includes(q) || fullName2.includes(q) || firstName.includes(q) || lastName.includes(q) || phone.includes(q);
                    });
                    if (matches.length === 0) { suggestions.classList.add('hidden'); return; }
                    suggestions.innerHTML = matches.map(c => `<div class="autocomplete-suggestion" data-customer-id="${c.id}" onclick="app.selectCustomerForOrder(this.dataset.customerId)"><div class="font-medium">${c.lastName} ${c.firstName}</div><div class="text-sm text-gray-600">${c.phone || 'Nessun telefono'}</div></div>`).join('');
                    suggestions.classList.remove('hidden');
                }

                selectCustomerFromSearch(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;
                    document.getElementById('selected-customer-id').value = customer.id;
                    document.getElementById('customer-firstname').value = customer.firstName;
                    document.getElementById('customer-lastname').value = customer.lastName;
                    document.getElementById('customer-phone').value = customer.phone || '';
                    document.getElementById('customer-marketing-order').checked = customer.marketing || false;
                    document.getElementById('customer-search').value = `${customer.lastName} ${customer.firstName}`;
                    document.getElementById('customer-suggestions').classList.add('hidden');
                    this.showCustomerStatus('existing');
                }

                // Funzione dedicata per selezionare un cliente nel modal ordini
                selectCustomerForOrder(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;

                    // Compila tutti i campi del modal ordini
                    document.getElementById('selected-customer-id').value = customer.id;
                    document.getElementById('customer-firstname').value = customer.firstName;
                    document.getElementById('customer-lastname').value = customer.lastName;
                    document.getElementById('customer-phone').value = customer.phone || '';
                    document.getElementById('customer-marketing-order').checked = customer.marketing || false;

                    // Aggiorna il campo di ricerca con il nome completo
                    document.getElementById('customer-search-order').value = `${customer.lastName} ${customer.firstName}`;

                    // Nascondi i suggerimenti
                    document.getElementById('customer-suggestions-order').classList.add('hidden');

                    // Mostra lo status di cliente esistente
                    this.showCustomerStatus('existing');
                }

                checkCustomerDuplicate() {
                    const firstName = document.getElementById('customer-firstname').value.trim();
                    const lastName = document.getElementById('customer-lastname').value.trim();
                    const phone = document.getElementById('customer-phone').value.trim();
                    if (!firstName && !lastName && !phone) { document.getElementById('customer-status').innerHTML = ''; return; }
                    const existing = this.db.customers.find(c => {
                        const sameName = c.firstName.toLowerCase() === firstName.toLowerCase() && c.lastName.toLowerCase() === lastName.toLowerCase();
                        const samePhone = phone && c.phone && c.phone === phone;
                        return sameName || samePhone;
                    });
                    if (existing) this.selectCustomerFromSearch(existing.id);
                    else this.showCustomerStatus('new');
                }

                showCustomerStatus(status) {
                    const statusDiv = document.getElementById('customer-status');
                    if (status === 'existing') {
                        statusDiv.innerHTML = `<div class="flex items-center gap-2 text-green-700 bg-green-50 p-2 rounded"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span class="font-medium">Cliente gi√† presente</span></div>`;
                    } else if (status === 'new') {
                        statusDiv.innerHTML = `<div class="flex items-center gap-2 text-blue-700 bg-blue-50 p-2 rounded"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg><span class="font-medium">Nuovo cliente - verr√† aggiunto</span></div>`;
                    }
                }

                selectProduct() {
                    const productInput = document.getElementById('order-product');
                    const productId = productInput.dataset.productId || productInput.value;
                    const weightField = document.getElementById('order-weight');
                    const weightContainer = weightField.closest('.grid').children[0]; // primo div del grid (peso)

                    if (!productId) {
                        document.getElementById('order-weight').value = '';
                        document.getElementById('order-qty').value = '';
                        document.getElementById('order-price').value = '';
                        document.getElementById('weight-info').style.display = 'none';
                        weightContainer.style.display = 'none'; // Nascondi campo peso
                        return;
                    }

                    const product = this.db.products.find(p => p.id === productId);
                    if (product) {
                        document.getElementById('order-qty').value = 1;
                        document.getElementById('order-price').value = product.price.toFixed(2);
                        document.getElementById('order-weight').value = '';
                        document.getElementById('weight-info').style.display = 'none';

                        // Se ha peso medio, nasconde il campo peso e calcola automaticamente
                        if (product.averageWeight && product.averageWeight > 0) {
                            weightContainer.style.display = 'none';
                            // Mostra info peso medio
                            const weightInfo = document.getElementById('weight-info');
                            const weightCalc = document.getElementById('weight-calculation');
                            weightCalc.textContent = `Peso medio: ${product.averageWeight}kg per unit√†. Prezzo calcolato automaticamente.`;
                            weightInfo.style.display = 'block';

                            // Calcola prezzo automatico per quantit√† 1
                            const autoPrice = 1 * product.averageWeight * product.price;
                            document.getElementById('order-price').value = autoPrice.toFixed(2);
                        } else {
                            // Vecchio sistema per prodotti senza peso medio
                            weightContainer.style.display = 'none';
                        }

                        // Salva il prezzo base del prodotto per calcoli successivi
                        document.getElementById('order-price').dataset.basePrice = product.price;
                    }
                }

                calculatePriceFromWeight() {
                    const weight = parseFloat(document.getElementById('order-weight').value);
                    const priceInput = document.getElementById('order-price');
                    const basePrice = parseFloat(priceInput.dataset.basePrice || priceInput.value);
                    const weightInfo = document.getElementById('weight-info');
                    const weightCalc = document.getElementById('weight-calculation');

                    if (!weight || weight <= 0 || !basePrice) {
                        weightInfo.style.display = 'none';
                        if (basePrice) {
                            priceInput.value = basePrice.toFixed(2);
                        }
                        return;
                    }

                    // Calcola prezzo totale: peso √ó prezzo al kg
                    const totalPrice = weight * basePrice;
                    priceInput.value = totalPrice.toFixed(2);

                    // Mostra info calcolo
                    weightCalc.textContent = `${weight} kg √ó ${this.formatPrice(basePrice)} = ${this.formatPrice(totalPrice)}`;
                    weightInfo.style.display = 'block';
                }

                calculateAutomaticPrice() {
                    const productInput = document.getElementById('order-product');
                    const productId = productInput.dataset.productId;
                    const qty = parseFloat(document.getElementById('order-qty').value) || 0;

                    if (!productId || qty <= 0) return;

                    const product = this.db.products.find(p => p.id === productId);
                    if (!product) return;

                    // Calcolo automatico solo se ha peso medio
                    if (product.averageWeight && product.averageWeight > 0) {
                        const totalWeight = qty * product.averageWeight;
                        const totalPrice = totalWeight * product.price;

                        document.getElementById('order-price').value = totalPrice.toFixed(2);

                        // Aggiorna info peso
                        const weightInfo = document.getElementById('weight-info');
                        const weightCalc = document.getElementById('weight-calculation');
                        weightCalc.textContent = `${qty} √ó ${product.averageWeight}kg √ó ${this.formatPrice(product.price)}/kg = ${this.formatPrice(totalPrice)}`;
                        weightInfo.style.display = 'block';
                    } else if (product.unit === 'kg') {
                        // ‚úÖ Prodotti a peso (Acciughe) - calcola: qty(peso) √ó prezzo/kg
                        const totalPrice = qty * product.price;
                        document.getElementById('order-price').value = totalPrice.toFixed(2);
                    }
                    // ‚úÖ Per prodotti a pezzo: NON calcolare nulla, lascia il prezzo base
                }
                searchProductForOrder(query) {
                    const suggestions = document.getElementById('product-suggestions');

                    if (!query.trim()) {
                        suggestions.classList.add('hidden');
                        return;
                    }

                    // Filtra prodotti per nome
                    const filteredProducts = this.db.products.filter(p =>
                        p.name.toLowerCase().includes(query.toLowerCase())
                    );

                    if (filteredProducts.length === 0) {
                        suggestions.innerHTML = '<div class="autocomplete-suggestion text-gray-500">Nessun prodotto trovato</div>';
                        suggestions.classList.remove('hidden');
                        return;
                    }

                    // Raggruppa per categoria
                    const categories = {};
                    filteredProducts.forEach(prod => {
                        const category = prod.category || 'Senza categoria';
                        if (!categories[category]) {
                            categories[category] = [];
                        }
                        categories[category].push(prod);
                    });

                    // Genera HTML raggruppato
                    let html = '';
                    Object.keys(categories).sort().forEach(categoryName => {
                        const products = categories[categoryName];
                        html += `<div class="py-1 px-2 bg-gray-100 text-xs font-semibold text-gray-700 border-b">${categoryName}</div>`;
                        products.forEach(prod => {
                            html += `<div class="autocomplete-suggestion" data-product-id="${prod.id}">${prod.name} - ${this.formatPrice(prod.price)}/${prod.unit}</div>`;
                        });
                    });

                    suggestions.innerHTML = html;
                    suggestions.classList.remove('hidden');

                    // Aggiungi eventi click
                    suggestions.querySelectorAll('.autocomplete-suggestion[data-product-id]').forEach(item => {
                        item.onclick = () => this.selectProductForOrder(item.dataset.productId, item.textContent);
                    });
                }

                showAllProductsForOrder() {
                    const suggestions = document.getElementById('product-suggestions');

                    if (this.db.products.length === 0) {
                        suggestions.innerHTML = '<div class="autocomplete-suggestion text-gray-500">Nessun prodotto disponibile</div>';
                        suggestions.classList.remove('hidden');
                        return;
                    }

                    // Raggruppa tutti i prodotti per categoria
                    const categories = {};
                    const sorted = [...this.db.products].sort((a, b) => a.name.localeCompare(b.name));

                    sorted.forEach(prod => {
                        const category = prod.category || 'Senza categoria';
                        if (!categories[category]) {
                            categories[category] = [];
                        }
                        categories[category].push(prod);
                    });

                    // Genera HTML raggruppato
                    let html = '';
                    Object.keys(categories).sort().forEach(categoryName => {
                        const products = categories[categoryName];
                        html += `<div class="py-1 px-2 bg-gray-100 text-xs font-semibold text-gray-700 border-b">${categoryName} (${products.length})</div>`;
                        products.forEach(prod => {
                            html += `<div class="autocomplete-suggestion" data-product-id="${prod.id}">${prod.name} - ${this.formatPrice(prod.price)}/${prod.unit}</div>`;
                        });
                    });

                    suggestions.innerHTML = html;
                    suggestions.classList.remove('hidden');

                    // Aggiungi eventi click
                    suggestions.querySelectorAll('.autocomplete-suggestion[data-product-id]').forEach(item => {
                        item.onclick = () => this.selectProductForOrder(item.dataset.productId, item.textContent);
                    });
                }

                selectProductForOrder(productId, productText) {
                    const input = document.getElementById('order-product');
                    const suggestions = document.getElementById('product-suggestions');

                    input.value = productText;
                    input.dataset.productId = productId;
                    suggestions.classList.add('hidden');

                    // Simula il comportamento della vecchia selectProduct()
                    this.selectProduct();
                }

                addProductToOrder() {
                    const productInput = document.getElementById('order-product');
                    const productId = productInput.dataset.productId || productInput.value;
                    const qty = parseFloat(document.getElementById('order-qty').value);
                    const price = parseFloat(document.getElementById('order-price').value);
                    const weight = parseFloat(document.getElementById('order-weight').value) || null;

                    if (!productId || isNaN(qty) || qty <= 0 || isNaN(price) || price <= 0) {
                        this.showToast('‚ùå Dati prodotto non validi', 'error');
                        return;
                    }

                    const product = this.db.products.find(p => p.id === productId);
                    if (!product) return;


                    // Sistema peso medio automatico
                    let finalPrice = price; // price viene dal campo ed √® gi√† calcolato
                    let calculatedWeight = null;
                    let finalUnit = product.unit;

                    if (product.averageWeight && product.averageWeight > 0) {
                        // Prodotti con peso medio automatico (es. Focaccia Barese)
                        calculatedWeight = qty * product.averageWeight;
                        finalPrice = calculatedWeight * product.price;
                        finalUnit = 'pezzo';
                        console.log(`Peso automatico: ${qty} pezzi √ó ${product.averageWeight}kg = ${calculatedWeight}kg, Prezzo: ${calculatedWeight}kg √ó ‚Ç¨${product.price}/kg = ‚Ç¨${finalPrice.toFixed(2)}`);
                    } else if (product.unit === 'kg') {
                        // Prodotti a peso (es. Acciughe) - qty √® il peso, price √® gi√† totale
                        finalPrice = price;
                        calculatedWeight = qty;
                    } else {
                        // Prodotti normali a pezzo (es. Panino)
                        finalPrice = qty * price;
                    }

                    // Salva il prodotto
                    const item = {
                        productId: product.id,
                        productName: product.name,
                        qty,
                        unit: finalUnit, // Usa l'unit√† corretta (pezzo per peso medio, originale altrimenti)
                        price: finalPrice
                    };

                    // Aggiungi peso calcolato automaticamente o inserito manualmente
                    if (calculatedWeight) {
                        item.weight = calculatedWeight;
                        item.calculatedFromAverage = true;
                    } else if (weight && weight > 0) {
                        item.weight = weight;
                        item.calculatedFromAverage = false;
                    }

                    this.currentOrder.items.push(item);

                    // Reset campi
                    document.getElementById('order-product').value = '';
                    document.getElementById('order-qty').value = '';
                    document.getElementById('order-price').value = '';
                    document.getElementById('order-weight').value = '';
                    document.getElementById('weight-info').style.display = 'none';

                    this.renderOrderItems();
                    this.showToast('‚úÖ Prodotto aggiunto');
                }

                removeOrderItem(index) {
                    this.currentOrder.items.splice(index, 1);
                    this.renderOrderItems();
                }

                renderOrderItems() {
                    const container = document.getElementById('order-items');
                    if (this.currentOrder.items.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">Nessun prodotto aggiunto</p>';
                        document.getElementById('order-total').textContent = '0,00 ‚Ç¨';
                        return;
                    }
                    let total = 0;
                    container.innerHTML = this.currentOrder.items.map((item, index) => {
                        // IMPORTANTE: item.price √® SEMPRE il totale gi√† calcolato
                        const itemTotal = item.price;
                        total += itemTotal;

                        // Costruisci la descrizione
                        let description;
                        if (item.calculatedFromAverage && item.weight) {
                            // Per prodotti con peso medio, mostra: "2 pezzi (‚öñÔ∏è 0.6 kg) = ‚Ç¨X.XX"
                            description = `${item.qty} ${item.unit} (‚öñÔ∏è ${item.weight.toFixed(3)} kg) = ${this.formatPrice(itemTotal)}`;
                        } else if (item.weight && item.weight > 0) {
                            description = `‚öñÔ∏è ${item.weight} kg = ${this.formatPrice(itemTotal)}`;
                        } else {
                            // Per prodotti normali senza peso
                            if (item.unit === 'kg') {
                                // Prodotto a peso - price √® gi√† totale
                                description = `${item.qty} ${item.unit} = ${this.formatPrice(itemTotal)}`;
                            } else {
                                // Prodotto a pezzo - calcola prezzo unitario
                                const pricePerUnit = item.price / item.qty;
                                description = `${item.qty} ${item.unit} √ó ${this.formatPrice(pricePerUnit)} = ${this.formatPrice(itemTotal)}`;
                            }
                        }

                        return `<div class="flex justify-between items-center bg-white p-2 rounded">
                        <div class="flex-1">
                            <div class="font-medium">${item.productName}</div>
                            <div class="text-sm text-gray-600">${description}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold">${this.formatPrice(itemTotal)}</span>
                            <button onclick="app.removeOrderItem(${index})" class="text-red-600 hover:text-red-800">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>`;
                    }).join('');
                    document.getElementById('order-total').textContent = this.formatPrice(total);
                    this.updateOrderDeposit(); // Aggiorna info acconto quando cambiano i prodotti
                }

                updateOrderDeposit() {
                    // CORREZIONE: item.price √® gi√† il totale, non serve moltiplicare per qty
                    const total = this.currentOrder.items.reduce((sum, item) => sum + (item.qty * item.price), 0);
                    const deposit = parseFloat(document.getElementById('order-deposit').value) || 0;
                    const depositInfo = document.getElementById('deposit-info');

                    if (deposit > 0) {
                        const remaining = total - deposit;
                        depositInfo.innerHTML = `
                        Totale: ${this.formatPrice(total)}<br>
                        Acconto: ${this.formatPrice(deposit)}<br>
                        <strong>Resto da pagare: ${this.formatPrice(remaining)}</strong>
                    `;
                        depositInfo.classList.remove('hidden');

                        if (deposit > total) {
                            depositInfo.innerHTML += '<br><span class="text-red-600">‚ö†Ô∏è L\'acconto supera il totale!</span>';
                        }
                    } else {
                        depositInfo.classList.add('hidden');
                    }
                }

                async saveOrder() {
                    // ===== FIX: Protezione double-click RAFFORZATA =====
                    const saveBtn = document.getElementById('save-order-btn');

                    // Controlla PRIMA il bottone (pi√π veloce del flag)
                    if (saveBtn && saveBtn.disabled) {
                        console.log('‚è∏Ô∏è Bottone gi√† disabilitato, ignoro click');
                        return;
                    }

                    // Controlla anche il flag
                    if (this.savingOrder) {
                        console.log('‚è∏Ô∏è Salvataggio gi√† in corso, ignoro click');
                        return;
                    }

                    // DISABILITA IMMEDIATAMENTE (prima di settare il flag)
                    if (saveBtn) {
                        saveBtn.disabled = true;
                        saveBtn.textContent = '‚è≥ Salvataggio...';
                        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }

                    // ADESSO setta il flag
                    this.savingOrder = true;

                    // Helper per resettare bottone in caso di errore
                    const resetButton = () => {
                        this.savingOrder = false;
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Salva Ordine';
                            saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    };

                    // ===== VALIDAZIONI PRIMA DEL TRY =====
                    const number = document.getElementById('order-number').value.trim();
                    const firstName = document.getElementById('customer-firstname').value.trim();
                    const lastName = document.getElementById('customer-lastname').value.trim();
                    const phone = document.getElementById('customer-phone').value.trim();
                    const deliveryDate = document.getElementById('order-delivery-date').value;

                    // Validazioni con reset
                    if (!firstName || !lastName) {
                        resetButton();
                        this.showToast('‚ùå Dati cliente obbligatori', 'error');
                        return;
                    }
                    if (this.currentOrder.items.length === 0) {
                        resetButton();
                        this.showToast('‚ùå Aggiungi almeno un prodotto', 'error');
                        return;
                    }
                    if (!deliveryDate) {
                        resetButton();
                        this.showToast('‚ùå Data consegna obbligatoria', 'error');
                        return;
                    }

                    // Assicurati che il numero sia stato generato
                    if (!number) {
                        this.updateOrderNumber();
                        const generatedNumber = document.getElementById('order-number').value.trim();
                        if (!generatedNumber) {
                            resetButton();
                            this.showToast('‚ùå Errore generazione numero ordine', 'error');
                            return;
                        }
                    }

                    // Validazione data consegna
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const delivery = new Date(deliveryDate);
                    delivery.setHours(0, 0, 0, 0);

                    if (delivery < today && !this.editingId) {
                        if (!confirm('‚ö†Ô∏è La data di consegna √® nel passato. Confermi?')) {
                            resetButton();
                            return;
                        }
                    }

                    // ===== INIZIO TRY-CATCH =====
                    try {
                        let customerId = document.getElementById('selected-customer-id').value;
                        const marketing = document.getElementById('customer-marketing-order').checked;

                        if (!customerId) {
                            // Nuovo cliente
                            const newCustomer = {
                                id: this.generateId(),
                                firstName,
                                lastName,
                                phone,
                                email: '',
                                marketing: marketing,
                                fidelity: {
                                    stamps: 0,
                                    totalSpent: 0,
                                    rewards: 0,
                                    history: [],
                                    rewardsList: [],
                                    cardSent: false
                                },
                                coupons: []
                            };
                            this.db.customers.push(newCustomer);
                            customerId = newCustomer.id;
                        } else {
                            // Cliente esistente - aggiorna consenso marketing
                            const existingCustomer = this.db.customers.find(c => c.id === customerId);
                            if (existingCustomer) {
                                existingCustomer.marketing = marketing;
                            }
                        }

                        const deposit = parseFloat(document.getElementById('order-deposit').value) || 0;
                        const finalOrderNumber = document.getElementById('order-number').value.trim();

                        // Se stiamo modificando, recupera l'ordine esistente
                        let existingPreparedItems = [];
                        if (this.editingId) {
                            const existingOrder = this.db.orders.find(o => o.id === this.editingId);
                            if (existingOrder && existingOrder.preparedItems) {
                                existingPreparedItems = existingOrder.preparedItems;
                            }
                        }

                        const order = {
                            id: this.editingId || this.generateId(),
                            number: finalOrderNumber,
                            customerId,
                            createdDate: document.getElementById('order-created-date').value,
                            deliveryDate,
                            prepStatus: document.getElementById('order-prep-status').value,
                            paymentStatus: document.getElementById('order-payment-status').value,
                            items: [...this.currentOrder.items],
                            deposit: deposit > 0 ? deposit : 0,
                            preparedItems: this.editingId ? existingPreparedItems : [],
                            lastModified: new Date().toISOString()
                        };

                        // ‚úÖ LOGICA COMPLETA: Gestione modifiche post-preparazione
                        if (this.editingId) {
                            const existingOrder = this.db.orders.find(o => o.id === this.editingId);

                            if (existingOrder) {
                                const oldItems = existingOrder.items;
                                const newItems = order.items;
                                const wasCompleted = existingOrder.prepStatus === 'completato' || existingOrder.prepStatus === 'da modificare';
                                const hadPreparedItems = existingOrder.preparedItems && existingOrder.preparedItems.length > 0;

                                // Array per tracciare quali items sono ancora validi come "preparati"
                                const validPreparedItems = [];

                                // Array per tracciare le modifiche da fare
                                const pendingModifications = [];

                                // ‚úÖ STEP 1: Controlla ogni item preparato
                                if (hadPreparedItems) {
                                    existingOrder.preparedItems.forEach(preparedIndex => {
                                        const oldItem = oldItems[preparedIndex];

                                        if (!oldItem) return; // Skip se l'indice non esiste pi√π

                                        // üîß FIX: Trova il prodotto nel nuovo ordine per productId, non per indice
                                        const newItemIndex = newItems.findIndex(item => item.productId === oldItem.productId);
                                        const newItem = newItemIndex >= 0 ? newItems[newItemIndex] : null;

                                        if (newItem) {
                                            // ‚úÖ PRODOTTO ESISTE ANCORA: controlla modifiche quantit√†/peso
                                            const qtyChanged = newItem.qty !== oldItem.qty;

                                            // Controlla peso SOLO se NON √® calcolato automaticamente
                                            let weightChanged = false;
                                            if (newItem.weight && oldItem.weight) {
                                                if (!newItem.calculatedFromAverage && !oldItem.calculatedFromAverage) {
                                                    weightChanged = newItem.weight !== oldItem.weight;
                                                }
                                            }

                                            if (qtyChanged || weightChanged) {
                                                // ‚ö†Ô∏è MODIFICATO: Quantit√† o peso cambiato
                                                if (wasCompleted || hadPreparedItems) {
                                                    const diff = newItem.qty - oldItem.qty;
                                                    const action = diff > 0 ? 'aggiungere' : 'togliere';
                                                    const absDiff = Math.abs(diff);

                                                    pendingModifications.push({
                                                        index: newItemIndex, // üîß USA IL NUOVO INDICE
                                                        productName: newItem.productName,
                                                        action: action,
                                                        oldQty: oldItem.qty,
                                                        newQty: newItem.qty,
                                                        diff: absDiff,
                                                        unit: newItem.unit,
                                                        description: `${action === 'aggiungere' ? '‚ûï' : '‚ûñ'} ${action} ${absDiff} ${newItem.unit} di ${newItem.productName}`
                                                    });

                                                    console.log(`‚ö†Ô∏è MODIFICA: ${newItem.productName} da ${oldItem.qty} a ${newItem.qty} ${newItem.unit}`);
                                                }
                                            } else {
                                                // Nessuna modifica, mantieni come preparato con NUOVO INDICE
                                                validPreparedItems.push(newItemIndex);
                                            }
                                        } else {
                                            // ‚ö†Ô∏è PRODOTTO RIMOSSO (non esiste pi√π nell'ordine)
                                            if (wasCompleted || hadPreparedItems) {
                                                // üîß Usa un ID univoco negativo per rimozioni (non indice)
                                                pendingModifications.push({
                                                    index: preparedIndex, // Mantieni vecchio indice per riferimento
                                                    productName: oldItem.productName,
                                                    action: 'rimuovere',
                                                    oldQty: oldItem.qty,
                                                    unit: oldItem.unit,
                                                    description: `‚ûñ Rimuovere ${oldItem.productName} (${oldItem.qty} ${oldItem.unit})`,
                                                    _removedProductId: oldItem.productId // Flag per identificare rimozioni
                                                });

                                                console.log(`‚ö†Ô∏è RIMOZIONE: ${oldItem.productName} eliminato dall'ordine`);
                                            }
                                        }
                                    });
                                }

                                // ‚úÖ STEP 2: Controlla prodotti NUOVI aggiunti
                                newItems.forEach((newItem, newIndex) => {
                                    // Cerca se questo prodotto esisteva nel vecchio ordine
                                    const existedBefore = oldItems.some(oldItem => oldItem.productId === newItem.productId);

                                    if (!existedBefore && (wasCompleted || hadPreparedItems)) {
                                        // Prodotto completamente nuovo
                                        pendingModifications.push({
                                            index: newIndex,
                                            productName: newItem.productName,
                                            action: 'aggiungere',
                                            newQty: newItem.qty,
                                            unit: newItem.unit,
                                            description: `‚ûï Aggiungere ${newItem.productName} (${newItem.qty} ${newItem.unit})`
                                        });

                                        console.log(`‚ö†Ô∏è NUOVO: ${newItem.productName} aggiunto all'ordine`);
                                    }
                                });

                                // ‚úÖ STEP 4: Aggiorna ordine con modifiche
                                order.preparedItems = validPreparedItems;
                                order.pendingModifications = pendingModifications;

                                const totalItems = newItems.length;
                                const preparedCount = validPreparedItems.length;
                                const modificationsCount = pendingModifications.length;

                                console.log(`üîç Ordine #${order.number}: ${totalItems} items, ${preparedCount} preparati, ${modificationsCount} modifiche`);

                                // ‚úÖ STEP 5: DETERMINA NUOVO STATO
                                if (modificationsCount > 0) {
                                    // Ci sono modifiche da fare
                                    order.prepStatus = 'da modificare';
                                    this.showToast(`‚ö†Ô∏è Ordine #${order.number} richiede ${modificationsCount} modifica/e`, 'warning');
                                } else if (totalItems > preparedCount) {
                                    // Ci sono items non preparati (nuovi in ordine non completato)
                                    order.prepStatus = 'da preparare';
                                } else if (totalItems === preparedCount && preparedCount > 0) {
                                    // Tutti preparati
                                    order.prepStatus = 'completato';
                                } else if (preparedCount === 0 && totalItems > 0) {
                                    order.prepStatus = 'da preparare';
                                }
                            }
                        }


                        const isNewOrder = !this.editingId;
                        const orderTotal = order.items.reduce((sum, item) => sum + item.price, 0);

                        // ========== ACQUISISCI LOCK PER TUTTI (nuovi E modifiche) ==========
                        console.log('üîí Acquisizione lock con retry automatico...');

                        let lockAcquired = false;
                        let retryCount = 0;
                        const maxRetries = 5;

                        while (!lockAcquired && retryCount < maxRetries) {
                            const canProceed = await this.waitForLock();

                            if (!canProceed) {
                                resetButton();
                                this.showToast('‚ùå Timeout: altro dispositivo occupato troppo a lungo. Riprova!', 'error');
                                return;
                            }

                            lockAcquired = await this.acquireLock();

                            if (!lockAcquired) {
                                retryCount++;
                                console.log(`‚ö†Ô∏è Lock non acquisito, riprovo... (tentativo ${retryCount}/${maxRetries})`);
                                this.showToast(`‚è≥ Altro dispositivo sta salvando, riprovo... (${retryCount}/${maxRetries})`, 'info');
                                await new Promise(resolve => setTimeout(resolve, 2000));
                            }
                        }

                        if (!lockAcquired) {
                            resetButton();
                            this.showToast('‚ùå Impossibile acquisire lock dopo 5 tentativi. Riprova manualmente!', 'error');
                            return;
                        }

                        console.log('üîí‚úÖ Lock acquisito con successo');

                        if (retryCount > 0) {
                            console.log(`‚è∞ Attendo 1.5s per propagazione Dropbox (c'erano ${retryCount} retry)...`);
                            this.showToast('‚è∞ Attendo sincronizzazione dati...', 'info');
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }

                        // SINCRONIZZA SEMPRE prima di salvare (sia nuovo che modifica)
                        console.log('üîÑ Sincronizzazione pre-salvataggio...');
                        await this.syncFromDropboxSilent();

                        // Se √® una modifica, ricarica l'ordine aggiornato
                        if (this.editingId) {
                            const freshOrder = this.db.orders.find(o => o.id === this.editingId);
                            if (freshOrder && freshOrder.preparedItems) {
                                existingPreparedItems = freshOrder.preparedItems;
                                order.preparedItems = existingPreparedItems;
                            }
                        }

                        // Se √® un nuovo ordine, rigenera il numero
                        if (!this.editingId) {
                            this.updateOrderNumber();
                            order.number = document.getElementById('order-number').value.trim();
                            console.log('üìã Nuovo numero ordine generato:', order.number);
                        }

                        // Salva ordine
                        if (this.editingId) {
                            const idx = this.db.orders.findIndex(o => o.id === this.editingId);
                            if (idx > -1) this.db.orders[idx] = order;
                        } else {
                            this.db.orders.push(order);
                        }

                        this.saveData();
                        await this.syncToDropbox(true);

                        // Sincronizzazione post-salvataggio
                        console.log('üîÑ Sincronizzazione post-salvataggio...');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        await this.syncFromDropboxSilent();

                        // Aggiungi bollini solo per ordini nuovi con pagamento completato
                        if (isNewOrder && order.paymentStatus === 'pagato') {
                            this.addStampsFromOrder(customerId, orderTotal);
                        }

                        this.filteredOrders = null;
                        this.render();
                        this.renderDashboard();
                        this.renderPreparation();
                        this.closeModal('order-modal');
                        this.showToast('‚úÖ Ordine salvato e sincronizzato');

                        // Genera messaggio WhatsApp sempre
                        const customer = this.db.customers.find(c => c.id === customerId);
                        this.generateWhatsAppMessage(order, customer);

                    } catch (error) {
                        console.error('‚ùå Errore salvataggio ordine:', error);
                        this.showToast('‚ùå Errore durante il salvataggio', 'error');
                    } finally {
                        // ‚úÖ Rilascia SEMPRE il lock (nuovi E modifiche)
                        await this.releaseLock();

                        // Reset flag e bottone
                        resetButton();
                    }
                }

                generateWhatsAppMessage(order, customer) {
                    if (!customer) {
                        console.error('Cliente non trovato per generare messaggio WhatsApp');
                        return;
                    }

                    // Raggruppa prodotti per categoria
                    const productsByCategory = {};
                    order.items.forEach(item => {
                        const product = this.db.products.find(p => p.name === item.productName);
                        const category = product ? (product.category || 'Altro') : 'Altro';

                        if (!productsByCategory[category]) {
                            productsByCategory[category] = [];
                        }

                        productsByCategory[category].push({
                            name: item.productName,
                            quantity: item.qty,
                            unit: item.unit || 'pz'
                        });
                    });

                    // Costruisci il messaggio (senza template literals per evitare problemi)
                    let message = '';
                    message += 'üçù *PASTIFICIO GRAMSCI*\n';
                    message += '\nüî¢ *ORDINE #' + order.number + '*\n';
                    message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';

                    // Data di consegna
                    const deliveryDate = new Date(order.deliveryDate + 'T00:00:00');
                    const formattedDate = deliveryDate.toLocaleDateString('it-IT', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    message += 'üìÖ *Consegna:* ' + formattedDate + '\n\n';

                    // Prodotti per categoria
                    message += 'üìã *RIEPILOGO ORDINE:*\n';
                    Object.keys(productsByCategory).sort().forEach(category => {
                        message += '\n*' + category.toUpperCase() + ':*\n';
                        productsByCategory[category].forEach(item => {
                            message += '‚Ä¢ ' + item.name + ' - ' + item.quantity + ' ' + item.unit + '\n';
                        });
                    });

                    // Acconto se presente (senza mostrare il totale)
                    if (order.deposit && order.deposit > 0) {
                        message += '\nüíµ *Acconto lasciato:* ‚Ç¨' + order.deposit.toFixed(2) + '\n';
                    }

                    message += '\n‚úÖ Ordine confermato!';

                    // Prepara il numero di telefono se presente
                    let phoneNumber = '';
                    if (customer.phone) {
                        phoneNumber = customer.phone.replace(/[^0-9]/g, '');
                        if (phoneNumber && !phoneNumber.startsWith('39')) {
                            phoneNumber = '39' + phoneNumber;
                        }
                    }

                    // Crea l'URL di WhatsApp
                    let whatsappUrl;
                    if (phoneNumber) {
                        whatsappUrl = 'https://wa.me/' + phoneNumber;
                    } else {
                        whatsappUrl = 'https://wa.me/';
                    }

                    // Mostra il messaggio di anteprima
                    this.showWhatsAppPreview(message, whatsappUrl, customer);
                }

                showWhatsAppPreview(message, whatsappUrl, customer) {
                    console.log('>>> showWhatsAppPreview CHIAMATA');

                    // Codifica il messaggio - usa encodeURIComponent per gestire caratteri speciali
                    const encodedMessage = encodeURIComponent(message);
                    const fullWhatsappUrl = whatsappUrl + '?text=' + encodedMessage;

                    console.log('Lunghezza messaggio:', message.length);
                    console.log('Lunghezza URL completo:', fullWhatsappUrl.length);

                    // HTML per anteprima (escape HTML)
                    let htmlMessage = message
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\n/g, '<br>');

                    // Rimuovi modal esistenti
                    const existingModal = document.getElementById('whatsapp-preview-modal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    // Crea modal
                    const modal = document.createElement('div');
                    modal.id = 'whatsapp-preview-modal';
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 99999; padding: 20px;';

                    const content = document.createElement('div');
                    content.style.cssText = 'background: white; border-radius: 10px; padding: 30px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;';

                    content.innerHTML =
                        '<h3 style="font-size: 20px; font-weight: bold; margin-bottom: 20px; text-align: center;">üì± Messaggio WhatsApp</h3>' +
                        '<div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 15px; margin-bottom: 20px;">' +
                        '<div style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: 600;">üìû ' + this.sanitizeHTML(customer.firstName + ' ' + customer.lastName) + '</div>' +
                        '<div style="font-size: 12px; color: #999; margin-bottom: 15px;">' + this.sanitizeHTML(customer.phone || 'Numero non disponibile') + '</div>' +
                        '<div style="background: white; border: 1px solid #ddd; border-radius: 6px; padding: 12px; font-size: 13px; max-height: 300px; overflow-y: auto; line-height: 1.6; white-space: pre-wrap; font-family: monospace;">' + htmlMessage + '</div>' +
                        '</div>' +
                        '<div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; margin-bottom: 20px; border-radius: 6px;">' +
                        '<p style="font-size: 13px; color: #1e40af; margin: 0;">' +
                        '<strong>üìã Istruzioni:</strong><br>' +
                        '1. Verifica il messaggio nell\'anteprima sopra<br>' +
                        '2. Clicca "Apri WhatsApp"<br>' +
                        '3. Il messaggio sar√† gi√† pronto<br>' +
                        '4. Controlla e premi Invia manualmente' +
                        '</p>' +
                        '</div>' +
                        '<div style="display: flex; gap: 10px;">' +
                        '<button id="btn-wa-close" style="flex: 1; background: #e5e7eb; color: #374151; padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">‚ùå Annulla</button>' +
                        '<button id="btn-wa-open" style="flex: 2; background: #16a34a; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">üì± Apri WhatsApp</button>' +
                        '</div>';

                    modal.appendChild(content);
                    document.body.appendChild(modal);

                    console.log('>>> Modal aggiunto al DOM');

                    // ===== FIX: Variabile per prevenire doppio click =====
                    let modalClosed = false;

                    const closeModal = () => {
                        if (modalClosed) {
                            console.log('>>> Modal gi√† chiuso, ignoro');
                            return;
                        }
                        modalClosed = true;
                        console.log('>>> Chiusura modal WhatsApp');
                        modal.remove();
                    };

                    // Event listeners
                    const btnClose = document.getElementById('btn-wa-close');
                    const btnOpen = document.getElementById('btn-wa-open');

                    btnClose.addEventListener('click', function (e) {
                        e.stopPropagation(); // Previeni propagazione evento
                        console.log('>>> Bottone CHIUDI cliccato');
                        closeModal();
                    });

                    btnOpen.addEventListener('click', function (e) {
                        e.stopPropagation(); // Previeni propagazione evento
                        console.log('>>> Bottone APRI WHATSAPP cliccato MANUALMENTE');
                        console.log('>>> Apertura URL:', fullWhatsappUrl);

                        // ===== FIX: Chiudi PRIMA di aprire WhatsApp =====
                        closeModal();

                        // Apri WhatsApp dopo aver chiuso il modal
                        setTimeout(() => {
                            window.open(fullWhatsappUrl, '_blank');
                        }, 100);
                    });

                    // ===== FIX: Auto-chiusura quando torni dall'app =====
                    const handleVisibilityChange = () => {
                        if (!document.hidden && !modalClosed) {
                            console.log('>>> App tornata in foreground, chiudo modal automaticamente');
                            setTimeout(() => {
                                closeModal();
                            }, 1000);
                        }
                    };

                    document.addEventListener('visibilitychange', handleVisibilityChange);

                    // Chiudi modal cliccando fuori (opzionale)
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) {
                            closeModal();
                        }
                    });

                    // ===== FIX: Pulizia listener quando modal viene rimosso =====
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            mutation.removedNodes.forEach((node) => {
                                if (node === modal) {
                                    console.log('>>> Modal rimosso, pulisco listener');
                                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                                    observer.disconnect();
                                }
                            });
                        });
                    });

                    observer.observe(document.body, { childList: true });

                    console.log('>>> Modal pronto, attesa click manuale');
                    this.showToast('üì± Verifica il messaggio e clicca "Apri WhatsApp"');
                }
                async deleteOrder() {
                    if (!this.pendingDelete || this.pendingDelete.type !== 'order') return;

                    const orderId = this.pendingDelete.id;

                    // ‚úÖ ESEGUI CON LOCK
                    const success = await this.withLock(async () => {
                        const order = this.db.orders.find(o => o.id === orderId);
                        if (order) {
                            order.deleted = true;
                            order.deletedAt = new Date().toISOString();
                        }
                        return true;
                    }, 'eliminazione ordine');

                    if (success) {
                        this.showToast('‚úÖ Ordine eliminato e sincronizzato');
                        this.filteredOrders = null;
                        this.render();
                        this.renderDashboard();
                        this.closeModal('confirm-modal');
                        this.pendingDelete = null;
                    }
                }

                // ‚ö° AZIONI RAPIDE per ordini
                quickEditOrder(orderId, event) {
                    event.stopPropagation(); // Previene apertura modal dal click sul div
                    this.openOrderModal(orderId);
                }

                quickDeleteOrder(orderId, event) {
                    event.stopPropagation(); // Previene apertura modal dal click sul div

                    const order = this.db.orders.find(o => o.id === orderId);
                    if (!order) return;

                    this.pendingDelete = {
                        type: 'order',
                        id: orderId,
                        name: 'Ordine #' + order.number
                    };

                    const confirmMsg = 'Sei sicuro di voler eliminare ' + this.pendingDelete.name + '? Questa azione non pu√≤ essere annullata.';
                    document.getElementById('confirm-message').textContent = confirmMsg;
                    this.openModal('confirm-modal');
                }

                // ‚ö° AZIONI RAPIDE per ordini
                quickEditOrder(orderId, event) {
                    event.stopPropagation(); // Previene apertura modal dal click sul div
                    this.openOrderModal(orderId);
                }

                quickDeleteOrder(orderId, event) {
                    event.stopPropagation(); // Previene apertura modal dal click sul div

                    const order = this.db.orders.find(o => o.id === orderId);
                    if (!order) return;

                    this.pendingDelete = {
                        type: 'order',
                        id: orderId,
                        name: 'Ordine #' + order.number
                    };

                    const confirmMsg = 'Sei sicuro di voler eliminare ' + this.pendingDelete.name + '? Questa azione non pu√≤ essere annullata.';
                    document.getElementById('confirm-message').textContent = confirmMsg;
                    this.openModal('confirm-modal');
                }

                updateStats() {
                    document.getElementById('stats-orders').textContent = this.db.orders.filter(o => !o.deleted).length;
                    document.getElementById('stats-products').textContent = this.db.products.filter(p => !p.deleted).length;
                    document.getElementById('stats-customers').textContent = this.db.customers.filter(c => !c.deleted).length;
                    // Aggiorna badge modifiche
                    const ordersWithMods = this.db.orders.filter(o =>
                        !o.deleted &&
                        o.pendingModifications &&
                        o.pendingModifications.length > 0
                    );
                    const totalMods = ordersWithMods.reduce((sum, o) => sum + o.pendingModifications.length, 0);

                    const modBadge = document.getElementById('mod-badge');
                    if (modBadge) {
                        if (totalMods > 0) {
                            modBadge.textContent = totalMods > 99 ? '99+' : totalMods;
                            modBadge.classList.remove('hidden');
                        } else {
                            modBadge.classList.add('hidden');
                        }
                    }
                }

                updateDashboardStats() {
                    // Ordini totali (FILTRA DELETED)
                    const totalOrders = this.db.orders.filter(o => !o.deleted).length;
                    const ordersElement = document.getElementById('stat-total-orders');
                    if (ordersElement) ordersElement.textContent = totalOrders;

                    // Clienti totali (FILTRA DELETED)
                    const totalCustomers = this.db.customers.filter(c => !c.deleted).length;
                    const customersElement = document.getElementById('stat-total-customers');
                    if (customersElement) customersElement.textContent = totalCustomers;

                    // Prodotti totali (FILTRA DELETED)
                    const activeProducts = this.db.products.filter(p => !p.deleted).length;
                    const productsElement = document.getElementById('stat-total-products');
                    if (productsElement) productsElement.textContent = activeProducts;

                    // Clienti fidelity (FILTRA DELETED)
                    const fidelityCustomers = this.db.customers.filter(c => !c.deleted && c.fidelity && c.fidelity.stamps > 0).length;
                    const fidelityElement = document.getElementById('stat-fidelity-customers');
                    if (fidelityElement) fidelityElement.textContent = fidelityCustomers;

                    // Ordini da preparare oggi (FILTRA DELETED)
                    const today = new Date().toISOString().split('T')[0];
                    const todayOrders = this.db.orders.filter(o => {
                        if (o.deleted) return false;
                        const orderDate = new Date(o.deliveryDate).toISOString().split('T')[0];
                        return orderDate === today && o.prepStatus === 'da preparare';
                    }).length;
                    const prepareElement = document.getElementById('stat-orders-to-prepare');
                    if (prepareElement) prepareElement.textContent = todayOrders;

                    // Categorie
                    const categoriesElement = document.getElementById('stat-total-categories');
                    if (categoriesElement && this.db.categories) {
                        categoriesElement.textContent = this.db.categories.length;
                    }

                    // Fatturato totale (FILTRA DELETED)
                    const totalRevenue = this.db.orders
                        .filter(o => !o.deleted && o.paymentStatus === 'pagato')
                        .reduce((sum, order) => {
                            const orderTotal = order.items.reduce((itemSum, item) => itemSum + (item.price || 0), 0);
                            return sum + orderTotal;
                        }, 0);
                    const revenueElement = document.getElementById('stat-total-revenue');
                    if (revenueElement) revenueElement.textContent = this.formatPrice(totalRevenue);

                    // Aggiorna anche il badge del numero ordini da preparare
                    const badgeElement = document.getElementById('stat-orders-to-prepare-badge');
                    if (badgeElement) badgeElement.textContent = todayOrders;
                }

                // CONFERMA ELIMINAZIONE
                async confirmDelete() {
                    if (!this.pendingDelete) return;

                    const { type, id } = this.pendingDelete;
                    const now = new Date().toISOString();

                    switch (type) {
                        case 'order':
                            const order = this.db.orders.find(o => o.id === id);
                            if (order) {
                                order.deleted = true;
                                order.deletedAt = now;
                            }
                            this.showToast('‚úÖ Ordine eliminato');
                            break;
                        case 'product':
                            const product = this.db.products.find(p => p.id === id);
                            if (product) {
                                product.deleted = true;
                                product.deletedAt = now;
                            }
                            this.showToast('‚úÖ Prodotto eliminato');
                            break;
                        case 'customer':
                            const customer = this.db.customers.find(c => c.id === id);
                            if (customer) {
                                customer.deleted = true;
                                customer.deletedAt = now;
                            }
                            this.showToast('‚úÖ Cliente eliminato');
                            break;
                    }

                    this.saveData();
                    await this.syncToDropbox(true); // ‚úÖ AGGIUNTO await
                    this.filteredOrders = null;
                    this.render();
                    this.batchRender(['dashboard', 'fidelity', 'customers']);
                    this.closeModal('confirm-modal');
                    this.pendingDelete = null;
                }
                cancelDelete() {
                    this.pendingDelete = null;
                    this.closeModal('confirm-modal');
                }

                deleteAllOrders() {
                    if (!confirm('‚ö†Ô∏è ATTENZIONE! Stai per eliminare TUTTI gli ordini.\n\nQuesta operazione:\n- Eliminer√† tutti gli ordini definitivamente\n- NON toccher√† i dati fidelity (bollini, premi, cronologia)\n- NON eliminer√† i clienti\n\nSei sicuro di voler continuare?')) {
                        return;
                    }

                    // Seconda conferma di sicurezza
                    if (!confirm('ULTIMA CONFERMA: Questa azione √® IRREVERSIBILE!\n\nConfermi di voler eliminare tutti gli ordini?')) {
                        return;
                    }

                    const now = new Date().toISOString();

                    // Marca tutti gli ordini come eliminati (SENZA toccare la fidelity)
                    this.db.orders.forEach(order => {
                        order.deleted = true;
                        order.deletedAt = now;
                    });

                    this.saveData();
                    this.syncToDropbox();
                    this.filteredOrders = null;
                    this.render();
                    this.renderDashboard();
                    this.showToast('‚úÖ Tutti gli ordini sono stati eliminati (dati fidelity preservati)', 'success');
                }

                resetAllFidelity() {
                    if (!confirm('‚ö†Ô∏è ATTENZIONE! Stai per AZZERARE tutti i dati fidelity.\n\nQuesta operazione:\n- Resetter√† tutti i bollini a 0\n- Eliminer√† tutti i premi disponibili e riscattati\n- Canceller√† tutta la cronologia fidelity\n- Resetter√† il flag "tessera inviata"\n- NON eliminer√† i clienti\n- NON eliminer√† gli ordini\n\nSei ASSOLUTAMENTE sicuro di voler continuare?')) {
                        return;
                    }

                    // Seconda conferma di sicurezza
                    if (!confirm('ULTIMA CONFERMA: Questa azione √® IRREVERSIBILE!\n\nConfermi di voler azzerare tutti i dati fidelity?')) {
                        return;
                    }

                    // Resetta tutti i dati fidelity dei clienti (senza eliminare i clienti)
                    this.db.customers.forEach(customer => {
                        if (!customer.deleted && customer.fidelity) {
                            customer.fidelity.stamps = 0;
                            customer.fidelity.rewards = 0;
                            customer.fidelity.totalSpent = 0;
                            customer.fidelity.history = [];
                            customer.fidelity.cardSent = false;
                        }
                    });

                    this.saveData();
                    this.syncToDropbox();
                    this.render();
                    this.batchRender(['dashboard', 'fidelity', 'customers']);
                    this.showToast('‚úÖ Tutti i dati fidelity sono stati azzerati (ordini preservati)', 'success');
                }

                // FILTRI ORDINI
                filterOrders() {
                    if (this.searchDebounceTimer) {
                        clearTimeout(this.searchDebounceTimer);
                    }

                    this.searchDebounceTimer = setTimeout(() => {
                        const searchTerm = document.getElementById('order-search').value.toLowerCase().trim();
                        const prepFilter = document.getElementById('prep-filter').value;
                        const paymentFilter = document.getElementById('payment-filter').value;
                        const dateFilterType = document.getElementById('date-filter-type')?.value || '';

                        this.filteredOrders = this.db.orders.filter(order => {
                            // Filtro deleted
                            if (order.deleted) return false;

                            // Filtro testo
                            if (searchTerm) {
                                const customer = this.db.customers.find(c => c.id === order.customerId);
                                const customerName = customer ? `${customer.firstName} ${customer.lastName}`.toLowerCase() : '';
                                const orderNumber = order.number.toString().toLowerCase();

                                if (!orderNumber.includes(searchTerm) && !customerName.includes(searchTerm)) {
                                    return false;
                                }
                            }

                            // Filtro stato preparazione
                            if (prepFilter && order.prepStatus !== prepFilter) {
                                return false;
                            }

                            // Filtro pagamento
                            if (paymentFilter && order.paymentStatus !== paymentFilter) {
                                return false;
                            }

                            // ‚úÖ FILTRO DATA
                            if (dateFilterType) {
                                const orderDate = new Date(order.deliveryDate);
                                orderDate.setHours(0, 0, 0, 0);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);

                                if (dateFilterType === 'today') {
                                    if (orderDate.getTime() !== today.getTime()) return false;
                                }
                                else if (dateFilterType === 'tomorrow') {
                                    const tomorrow = new Date(today);
                                    tomorrow.setDate(tomorrow.getDate() + 1);
                                    if (orderDate.getTime() !== tomorrow.getTime()) return false;
                                }
                                else if (dateFilterType === 'week') {
                                    // Questa settimana (da luned√¨ a domenica)
                                    const startOfWeek = new Date(today);
                                    const day = startOfWeek.getDay();
                                    const diff = day === 0 ? -6 : 1 - day; // Luned√¨
                                    startOfWeek.setDate(startOfWeek.getDate() + diff);

                                    const endOfWeek = new Date(startOfWeek);
                                    endOfWeek.setDate(endOfWeek.getDate() + 6); // Domenica

                                    if (orderDate < startOfWeek || orderDate > endOfWeek) return false;
                                }
                                else if (dateFilterType === 'month') {
                                    const monthFilter = document.getElementById('month-filter')?.value;
                                    const yearFilter = document.getElementById('year-filter')?.value;

                                    if (monthFilter && yearFilter) {
                                        const orderMonth = String(orderDate.getMonth() + 1).padStart(2, '0');
                                        const orderYear = String(orderDate.getFullYear());

                                        if (orderMonth !== monthFilter || orderYear !== yearFilter) return false;
                                    }
                                }
                                else if (dateFilterType === 'year') {
                                    const yearFilter = document.getElementById('year-filter')?.value;

                                    if (yearFilter) {
                                        const orderYear = String(orderDate.getFullYear());
                                        if (orderYear !== yearFilter) return false;
                                    }
                                }
                                else if (dateFilterType === 'custom') {
                                    const dateFrom = document.getElementById('date-from')?.value;
                                    const dateTo = document.getElementById('date-to')?.value;

                                    if (dateFrom) {
                                        const fromDate = new Date(dateFrom);
                                        fromDate.setHours(0, 0, 0, 0);
                                        if (orderDate < fromDate) return false;
                                    }

                                    if (dateTo) {
                                        const toDate = new Date(dateTo);
                                        toDate.setHours(0, 0, 0, 0);
                                        if (orderDate > toDate) return false;
                                    }
                                }
                            }

                            return true;
                        });

                        this.renderOrders();
                    }, 300); // Debounce di 300ms
                }

                resetAllFilters() {
                    // Reset tutti i filtri
                    this.filteredOrders = null;

                    // Reset campi input base
                    const searchInput = document.getElementById('order-search');
                    const prepFilter = document.getElementById('prep-filter');
                    const paymentFilter = document.getElementById('payment-filter');

                    if (searchInput) searchInput.value = '';
                    if (prepFilter) prepFilter.value = '';
                    if (paymentFilter) paymentFilter.value = '';

                    // ‚úÖ Reset filtri data
                    const dateFilterType = document.getElementById('date-filter-type');
                    const monthFilter = document.getElementById('month-filter');
                    const yearFilter = document.getElementById('year-filter');
                    const dateFrom = document.getElementById('date-from');
                    const dateTo = document.getElementById('date-to');

                    if (dateFilterType) dateFilterType.value = '';
                    if (monthFilter) monthFilter.classList.add('hidden');
                    if (yearFilter) yearFilter.classList.add('hidden');
                    if (dateFrom) {
                        dateFrom.value = '';
                        dateFrom.classList.add('hidden');
                    }
                    if (dateTo) {
                        dateTo.value = '';
                        dateTo.classList.add('hidden');
                    }

                    // Aggiorna vista
                    this.renderOrders();
                    this.showToast('üìã Mostrati tutti gli ordini', 'info');
                }

                updateDateFilterOptions() {
                    const filterType = document.getElementById('date-filter-type').value;
                    const monthFilter = document.getElementById('month-filter');
                    const yearFilter = document.getElementById('year-filter');
                    const dateFrom = document.getElementById('date-from');
                    const dateTo = document.getElementById('date-to');

                    // Nascondi tutti i filtri opzionali
                    monthFilter.classList.add('hidden');
                    yearFilter.classList.add('hidden');
                    dateFrom.classList.add('hidden');
                    dateTo.classList.add('hidden');

                    // Mostra i filtri necessari in base al tipo
                    if (filterType === 'month') {
                        monthFilter.classList.remove('hidden');
                        yearFilter.classList.remove('hidden');

                        // Popola anni disponibili
                        this.populateYearFilter();

                        // Imposta mese e anno correnti di default
                        const now = new Date();
                        monthFilter.value = String(now.getMonth() + 1).padStart(2, '0');
                        yearFilter.value = now.getFullYear();
                    } else if (filterType === 'year') {
                        yearFilter.classList.remove('hidden');
                        this.populateYearFilter();
                        yearFilter.value = new Date().getFullYear();
                    } else if (filterType === 'custom') {
                        dateFrom.classList.remove('hidden');
                        dateTo.classList.remove('hidden');
                    }

                    // Applica il filtro
                    this.filterOrders();
                }

                populateYearFilter() {
                    const yearFilter = document.getElementById('year-filter');
                    if (!yearFilter) return;

                    // Trova il range di anni negli ordini
                    const years = new Set();
                    this.db.orders.forEach(order => {
                        if (order.deliveryDate) {
                            const year = new Date(order.deliveryDate).getFullYear();
                            years.add(year);
                        }
                    });

                    // Aggiungi anno corrente se non presente
                    years.add(new Date().getFullYear());

                    // Ordina anni in ordine decrescente
                    const sortedYears = Array.from(years).sort((a, b) => b - a);

                    yearFilter.innerHTML = sortedYears.map(year =>
                        `<option value="${year}">${year}</option>`
                    ).join('');
                }

                // DASHBOARD E STATISTICHE
                renderDashboard() {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const firstDayMonth = new Date(today.getFullYear(), today.getMonth(), 1);

                    // Ordini e fatturato oggi (FILTRO AGGIUNTO)
                    const ordersToday = this.db.orders.filter(o => {
                        if (o.deleted) return false; // ‚Üê AGGIUNTO
                        const orderDate = new Date(o.deliveryDate);
                        orderDate.setHours(0, 0, 0, 0);
                        return orderDate.getTime() === today.getTime();
                    });

                    const revenueToday = ordersToday.reduce((sum, order) => {
                        return sum + order.items.reduce((itemSum, item) => itemSum + item.price, 0);
                    }, 0);

                    // Ordini e fatturato mese (FILTRO AGGIUNTO)
                    const ordersMonth = this.db.orders.filter(o => {
                        if (o.deleted) return false; // ‚Üê AGGIUNTO
                        const orderDate = new Date(o.deliveryDate);
                        return orderDate >= firstDayMonth;
                    });

                    const revenueMonth = ordersMonth.reduce((sum, order) => {
                        return sum + order.items.reduce((itemSum, item) => itemSum + item.price, 0);
                    }, 0);

                    // Aggiorna statistiche
                    const statOrdersToday = document.getElementById('stat-orders-today');
                    const statRevenueToday = document.getElementById('stat-revenue-today');
                    const statOrdersMonth = document.getElementById('stat-orders-month');
                    const statRevenueMonth = document.getElementById('stat-revenue-month');

                    if (statOrdersToday) statOrdersToday.textContent = ordersToday.length;
                    if (statRevenueToday) statRevenueToday.textContent = this.formatPrice(revenueToday);
                    if (statOrdersMonth) statOrdersMonth.textContent = ordersMonth.length;
                    if (statRevenueMonth) statRevenueMonth.textContent = this.formatPrice(revenueMonth);

                    // Grafici stati
                    this.renderStatusCharts();

                    // Top clienti
                    this.renderTopCustomers();
                }

                renderStatusCharts() {
                    const prepStatusChart = document.getElementById('prep-status-chart');
                    const paymentStatusChart = document.getElementById('payment-status-chart');

                    if (!prepStatusChart || !paymentStatusChart) return;

                    // Conteggio stati preparazione
                    const prepCounts = {
                        'da preparare': 0,
                        'completato': 0,
                        'consegnato': 0
                    };

                    const paymentCounts = {
                        'non pagato': 0,
                        'pagato': 0
                    };

                    // FILTRO AGGIUNTO: ignora ordini eliminati
                    const visibleOrders = this.db.orders.filter(o => !o.deleted);

                    visibleOrders.forEach(order => {
                        prepCounts[order.prepStatus]++;
                        paymentCounts[order.paymentStatus]++;
                    });

                    // CORREZIONE: usa visibleOrders invece di this.db.orders
                    const total = visibleOrders.length || 1;

                    // Render preparazione
                    prepStatusChart.innerHTML = Object.entries(prepCounts).map(([status, count]) => {
                        const percentage = Math.round((count / total) * 100);
                        const colors = {
                            'da preparare': 'bg-red-500',
                            'completato': 'bg-green-500',
                            'consegnato': 'bg-blue-500'
                        };
                        return `
            <div class="flex items-center gap-2 mb-2">
                <div class="flex-1">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium capitalize">${status}</span>
                        <span class="text-gray-600">${count} (${percentage}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${colors[status]} h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
                    }).join('');

                    // Render pagamenti
                    paymentStatusChart.innerHTML = Object.entries(paymentCounts).map(([status, count]) => {
                        const percentage = Math.round((count / total) * 100);
                        const colors = {
                            'non pagato': 'bg-red-500',
                            'pagato': 'bg-green-500'
                        };
                        return `
            <div class="flex items-center gap-2 mb-2">
                <div class="flex-1">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium capitalize">${status}</span>
                        <span class="text-gray-600">${count} (${percentage}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${colors[status]} h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
                    }).join('');
                }

                renderTopCustomers() {
                    const container = document.getElementById('top-customers');
                    if (!container) return;

                    // Calcola totale speso per cliente
                    const customerTotals = {};

                    // FILTRO AGGIUNTO: ignora ordini eliminati
                    this.db.orders.filter(o => !o.deleted).forEach(order => {
                        const total = order.items.reduce((sum, item) => sum + item.price, 0);
                        if (!customerTotals[order.customerId]) {
                            customerTotals[order.customerId] = { total: 0, orders: 0 };
                        }
                        customerTotals[order.customerId].total += total;
                        customerTotals[order.customerId].orders++;
                    });

                    // Ordina e prendi top 5
                    const topCustomers = Object.entries(customerTotals)
                        .sort((a, b) => b[1].total - a[1].total)
                        .slice(0, 5)
                        .map(([customerId, data]) => {
                            const customer = this.db.customers.find(c => c.id === customerId);
                            return { customer, ...data };
                        })
                        .filter(item => item.customer);

                    if (topCustomers.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">Nessun ordine ancora</p>';
                        return;
                    }

                    container.innerHTML = topCustomers.map((item, index) => {
                        const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">${medals[index]}</span>
                    <div>
                        <div class="font-semibold">${item.customer.lastName} ${item.customer.firstName}</div>
                        <div class="text-sm text-gray-600">${item.orders} ordini</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-green-600">${this.formatPrice(item.total)}</div>
                </div>
            </div>
        `;
                    }).join('');
                }

                // ==========================================
                // üéÅ FIDELITY SYSTEM FUNCTIONS
                // ==========================================

                renderFidelityDashboard() {
                    // Calcola statistiche
                    let totalCustomers = this.db.customers.length;
                    let totalAvailableRewards = 0;
                    let totalRedeemedRewards = 0;
                    let totalActiveCoupons = 0;

                    this.db.customers.forEach(customer => {
                        if (customer.fidelity) {
                            const availableRewards = Math.floor(customer.fidelity.stamps / this.fidelityConfig.stampsPerReward);
                            totalAvailableRewards += availableRewards;
                            totalRedeemedRewards += customer.fidelity.rewards || 0;
                        }
                        if (customer.coupons) {
                            totalActiveCoupons += customer.coupons.filter(c => !c.used).length;
                        }
                    });

                    // Aggiorna UI
                    document.getElementById('fidelity-total-customers').textContent = totalCustomers;
                    document.getElementById('fidelity-available-rewards').textContent = totalAvailableRewards;
                    document.getElementById('fidelity-redeemed-rewards').textContent = totalRedeemedRewards;
                    document.getElementById('fidelity-active-coupons').textContent = totalActiveCoupons;

                    // Renderizza lista clienti
                    this.renderFidelityCustomers();
                    this.renderCampaignsList();
                }

                renderFidelityCustomers() {
                    const container = document.getElementById('fidelity-customers-list');
                    if (!container) return;

                    const customers = this.db.customers.filter(c => !c.deleted).map(customer => {
                        const stamps = customer.fidelity?.stamps || 0;
                        const availableRewards = Math.floor(stamps / this.fidelityConfig.stampsPerReward);

                        // üîç DEBUG
                        if (customer.firstName === 'Nadia') {
                            console.log('üîç DEBUG Nadia nel render:', {
                                stamps,
                                stampsPerReward: this.fidelityConfig.stampsPerReward,
                                availableRewards,
                                calcolo: stamps + ' / ' + this.fidelityConfig.stampsPerReward + ' = ' + availableRewards
                            });
                        }

                        const redeemedRewards = customer.fidelity?.rewards || 0;
                        const activeCoupons = customer.coupons ? customer.coupons.filter(c => !c.used).length : 0;

                        return { ...customer, stamps, availableRewards, redeemedRewards, activeCoupons };
                    }).sort((a, b) => b.stamps - a.stamps);

                    if (customers.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">Nessun cliente ancora</p>';
                        return;
                    }

                    container.innerHTML = customers.map(customer => {
                        const progress = (customer.stamps % this.fidelityConfig.stampsPerReward) / this.fidelityConfig.stampsPerReward * 100;
                        const stampsNeeded = this.fidelityConfig.stampsPerReward - (customer.stamps % this.fidelityConfig.stampsPerReward);

                        return `
        <div class="bg-white border rounded-lg p-4 mb-3 hover:shadow-lg transition">
            <div class="cursor-pointer" onclick="app.openCustomerFidelityModal('${customer.id}')">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-lg">${customer.lastName} ${customer.firstName}</h3>
                        <p class="text-sm text-gray-600">${customer.phone}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-purple-600">${customer.stamps} üéØ</div>
                        <p class="text-xs text-gray-500">bollini totali</p>
                    </div>
                </div>

                <!-- Barra progresso -->
                <div class="mb-3">
                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                        <span>Prossimo premio: ${stampsNeeded} bollini</span>
                        <span>${customer.stamps % this.fidelityConfig.stampsPerReward}/${this.fidelityConfig.stampsPerReward}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>

                <!-- Statistiche -->
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div class="bg-green-50 rounded p-2 text-center">
                        <div class="text-lg font-bold text-green-600">${customer.availableRewards}</div>
                        <div class="text-xs text-gray-600">Premi disponibili</div>
                    </div>
                    <div class="bg-blue-50 rounded p-2 text-center">
                        <div class="text-lg font-bold text-blue-600">${customer.redeemedRewards}</div>
                        <div class="text-xs text-gray-600">Premi riscattati</div>
                    </div>
                    <div class="bg-pink-50 rounded p-2 text-center">
                        <div class="text-lg font-bold text-pink-600">${customer.activeCoupons}</div>
                        <div class="text-xs text-gray-600">Coupon attivi</div>
                    </div>
                </div>
            </div>

            <!-- Azioni -->
            <div class="flex gap-2 flex-wrap">
                <button onclick="app.openAddStampsModal('${customer.id}')" 
                    class="flex-1 bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">
                    ‚ûï Aggiungi Bollini
                </button>
                ${customer.availableRewards > 0 ? `
                    <button onclick="app.redeemReward('${customer.id}')" 
                        class="flex-1 bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
                        üéÅ Riscatta Premio
                    </button>
                ` : ''}
                <button onclick="app.showCustomerFidelityHistory('${customer.id}')" 
                    class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm hover:bg-gray-300">
                    üìã
                </button>
                <button onclick="app.sendFidelityCardWhatsApp('${customer.id}')" 
                    class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 whitespace-nowrap">
                    üì§ Tessera
                </button>
                <button onclick="app.deleteFidelityCustomer('${customer.id}')" 
                    class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700">
                    üóëÔ∏è Elimina
                </button>
            </div>
        </div>
    `;
                    }).join('');
                }

                async addStamps(customerId, amount) {
                    console.log('‚ûï addStamps chiamato:', { customerId, amount });

                    // ‚úÖ ACQUISISCI LOCK PER EVITARE RACE CONDITIONS
                    console.log('üîí Acquisizione lock fidelity...');
                    let lockAcquired = false;
                    let retryCount = 0;
                    const maxRetries = 3;

                    while (!lockAcquired && retryCount < maxRetries) {
                        const canProceed = await this.waitForLock(10000);
                        if (!canProceed) {
                            this.showToast('‚ùå Timeout: altro dispositivo occupato. Riprova!', 'error');
                            return;
                        }

                        lockAcquired = await this.acquireLock();
                        if (!lockAcquired) {
                            retryCount++;
                            console.log(`‚ö†Ô∏è Lock non acquisito, riprovo... (${retryCount}/${maxRetries})`);
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }

                    if (!lockAcquired) {
                        this.showToast('‚ùå Impossibile acquisire lock. Riprova!', 'error');
                        return;
                    }

                    try {
                        // Sincronizza PRIMA di modificare
                        await this.syncFromDropboxSilent();

                        const customer = this.db.customers.find(c => c.id === customerId);
                        if (!customer) {
                            console.error('‚ùå Cliente non trovato');
                            return;
                        }

                        console.log('üë§ Cliente trovato:', customer.firstName, customer.lastName);

                        if (!customer.fidelity) {
                            customer.fidelity = {
                                stamps: 0,
                                totalSpent: 0,
                                rewards: 0,
                                history: [],
                                rewardsList: [],
                                cardSent: false
                            };
                        }

                        const stampsToAdd = parseInt(amount);
                        if (isNaN(stampsToAdd) || stampsToAdd < 1) {
                            this.showToast('‚ùå Numero bollini non valido', 'error');
                            return;
                        }

                        customer.fidelity.stamps += stampsToAdd;

                        customer.fidelity.history.push({
                            date: new Date().toISOString(),
                            type: 'earned',
                            stamps: stampsToAdd,
                            amount: 0
                        });

                        const stampsPerReward = this.fidelityConfig.stampsPerReward;
                        const availableRewards = Math.floor(customer.fidelity.stamps / stampsPerReward);
                        const currentRewards = customer.fidelity.rewards || 0;

                        console.log('üìä Calcolo premi:', {
                            stampsAttuali: customer.fidelity.stamps,
                            stampsPerReward,
                            availableRewards,
                            currentRewards
                        });

                        if (availableRewards > currentRewards) {
                            const newRewards = availableRewards - currentRewards;
                            customer.fidelity.rewards = availableRewards;
                            customer.fidelity.stamps = customer.fidelity.stamps % stampsPerReward;

                            console.log(`üéÅ Nuovo premio! ${customer.firstName} ha ${newRewards} premio/i`);
                            this.showToast(`üéÅ ${customer.firstName} ha guadagnato ${newRewards} premio/i!`, 'success');
                        }

                        this.editingFidelity = true;
                        this.saveData();
                        await this.syncToDropbox(true);

                        this.batchRender(['fidelity', 'customers']);

                        this.showToast(`‚úÖ +${stampsToAdd} bollini aggiunti a ${customer.firstName}!`, 'success');

                        setTimeout(() => {
                            this.editingFidelity = false;
                        }, 3000);

                    } catch (error) {
                        console.error('‚ùå Errore addStamps:', error);
                        this.showToast('‚ùå Errore aggiunta bollini', 'error');
                    } finally {
                        await this.releaseLock();
                    }
                }

                async redeemReward(customerId) {
                    console.log('üéÅ redeemReward chiamato con ID:', customerId);

                    // ‚úÖ ACQUISISCI LOCK PER EVITARE RACE CONDITIONS
                    console.log('üîí Acquisizione lock fidelity...');
                    let lockAcquired = false;
                    let retryCount = 0;
                    const maxRetries = 3;

                    while (!lockAcquired && retryCount < maxRetries) {
                        const canProceed = await this.waitForLock(10000);
                        if (!canProceed) {
                            this.showToast('‚ùå Timeout: altro dispositivo occupato. Riprova!', 'error');
                            return;
                        }

                        lockAcquired = await this.acquireLock();
                        if (!lockAcquired) {
                            retryCount++;
                            console.log(`‚ö†Ô∏è Lock non acquisito, riprovo... (${retryCount}/${maxRetries})`);
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }

                    if (!lockAcquired) {
                        this.showToast('‚ùå Impossibile acquisire lock. Riprova!', 'error');
                        return;
                    }

                    try {
                        // Sincronizza PRIMA di modificare
                        await this.syncFromDropboxSilent();

                        const customer = this.db.customers.find(c => c.id === customerId);

                        if (!customer) {
                            console.error('‚ùå Cliente non trovato:', customerId);
                            this.showToast('‚ùå Cliente non trovato', 'error');
                            return;
                        }

                        console.log('üë§ Cliente trovato:', customer.firstName, customer.lastName);
                        console.log('üìä Fidelity data:', customer.fidelity);

                        if (!customer.fidelity) {
                            console.error('‚ùå Dati fidelity mancanti');
                            this.showToast('‚ùå Dati fidelity non trovati', 'error');
                            return;
                        }

                        const stamps = customer.fidelity.stamps || 0;
                        console.log('üéØ Bollini attuali:', stamps);
                        console.log('‚öôÔ∏è Bollini per premio:', this.fidelityConfig.stampsPerReward);

                        const availableRewards = Math.floor(stamps / this.fidelityConfig.stampsPerReward);
                        console.log('üéÅ Premi disponibili calcolati:', availableRewards);

                        if (availableRewards < 1) {
                            console.error('‚ùå Premi disponibili < 1');
                            this.showToast('‚ùå Nessun premio disponibile', 'error');
                            return;
                        }

                        if (!confirm(`Riscattare 1 premio per ${customer.firstName} ${customer.lastName}?\n\nBollini attuali: ${stamps}\nVerranno scalati ${this.fidelityConfig.stampsPerReward} bollini`)) {
                            return;
                        }

                        customer.fidelity.stamps -= this.fidelityConfig.stampsPerReward;
                        customer.fidelity.rewards = (customer.fidelity.rewards || 0) + 1;
                        customer.lastModified = new Date().toISOString();

                        customer.fidelity.rewardsList = customer.fidelity.rewardsList || [];
                        customer.fidelity.rewardsList.push({
                            date: new Date().toISOString(),
                            redeemed: true
                        });

                        customer.fidelity.history.push({
                            date: new Date().toISOString(),
                            type: 'reward',
                            stamps: this.fidelityConfig.stampsPerReward,
                            amount: 0
                        });

                        console.log('‚úÖ Premio riscattato! Nuovi bollini:', customer.fidelity.stamps);

                        this.editingFidelity = true;
                        this.saveData();
                        await this.syncToDropbox(true);

                        const modal = document.getElementById('customer-fidelity-modal');
                        if (modal && !modal.classList.contains('hidden')) {
                            this.openCustomerFidelityModal(customerId);
                        }

                        this.batchRender(['fidelity', 'customers']);
                        this.showToast(`‚úÖ Premio riscattato per ${customer.firstName}!`);

                        console.log('üéÅ Premio riscattato! Invio notifica WhatsApp automatica...');
                        setTimeout(() => {
                            this.sendRewardRedeemedWhatsApp(customerId);
                        }, 1000);

                        setTimeout(() => {
                            this.editingFidelity = false;
                            console.log('‚úÖ Sblocco auto-sync');
                        }, 3000);

                    } catch (error) {
                        console.error('‚ùå Errore redeemReward:', error);
                        this.showToast('‚ùå Errore riscatto premio', 'error');
                    } finally {
                        await this.releaseLock();
                    }
                }

                // Modal Aggiungi Bollini
                openAddStampsModal(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;

                    document.getElementById('stamps-customer-name').textContent = `${customer.firstName} ${customer.lastName}`;
                    document.getElementById('stamps-customer-current').textContent = customer.fidelity?.stamps || 0;
                    document.getElementById('stamps-count').value = '';

                    this.currentStampsCustomerId = customerId;

                    const modal = document.getElementById('add-stamps-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }

                closeAddStampsModal() {
                    const modal = document.getElementById('add-stamps-modal');
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                    this.currentStampsCustomerId = null;
                }

                calculateStampsPreview() {
                    const amount = parseFloat(document.getElementById('stamps-amount').value) || 0;
                    const stamps = Math.floor(amount / this.fidelityConfig.eurosPerStamp);

                    const preview = document.getElementById('stamps-preview');
                    const count = document.getElementById('stamps-preview-count');

                    if (amount > 0 && stamps > 0) {
                        count.textContent = stamps;
                        preview.classList.remove('hidden');
                    } else {
                        preview.classList.add('hidden');
                    }
                }

                async confirmAddStamps() {
                    console.log('üîµ confirmAddStamps chiamato');
                    console.log('üÜî currentStampsCustomerId:', this.currentStampsCustomerId);

                    const stampsCount = parseInt(document.getElementById('stamps-count').value);
                    console.log('üìù Valore input:', stampsCount);

                    if (!stampsCount || stampsCount <= 0) {
                        this.showToast('‚ö†Ô∏è Inserisci un numero di bollini valido', 'error');
                        return;
                    }

                    const customer = this.db.customers.find(c => c.id === this.currentStampsCustomerId);
                    const customerId = this.currentStampsCustomerId; // ‚Üê SALVA PRIMA CHE VENGA RESETTATO

                    console.log('üë§ Cliente trovato:', customer ? `${customer.firstName} ${customer.lastName}` : 'NESSUNO');

                    if (!customer || !customer.fidelity) {
                        this.showToast('‚ùå Cliente non trovato', 'error');
                        return;
                    }

                    const stampsBefore = customer.fidelity.stamps;
                    console.log('üìä Bollini PRIMA:', stampsBefore);

                    customer.fidelity.stamps += stampsCount;
                    console.log('üìä Bollini DOPO:', customer.fidelity.stamps);

                    customer.lastModified = new Date().toISOString();

                    customer.fidelity.history.push({
                        date: new Date().toISOString(),
                        type: 'add',
                        stamps: stampsCount,
                        amount: stampsCount * this.fidelityConfig.eurosPerStamp
                    });

                    console.log('üíæ Salvataggio dati...');

                    // Blocca auto-sync PRIMA di salvare
                    this.editingFidelity = true;

                    this.saveData();

                    console.log('‚úÖ Dati salvati');

                    this.closeAddStampsModal();

                    console.log('üîÑ Rendering dashboard...');
                    this.renderFidelityDashboard();

                    this.showToast(`‚úÖ Aggiunti ${stampsCount} bollini!`);

                    // Notifica se ha guadagnato un nuovo premio
                    const rewardsBefore = Math.floor(stampsBefore / this.fidelityConfig.stampsPerReward);
                    const rewardsAfter = Math.floor(customer.fidelity.stamps / this.fidelityConfig.stampsPerReward);
                    const newRewardsEarned = rewardsAfter - rewardsBefore;

                    console.log('üîç CHECK PREMIO:', {
                        stampsBefore,
                        stampsAfter: customer.fidelity.stamps,
                        rewardsBefore,
                        rewardsAfter,
                        newRewardsEarned,
                        calculation: `${rewardsAfter} - ${rewardsBefore} = ${newRewardsEarned} nuovi premi`
                    });

                    if (newRewardsEarned > 0) {
                        console.log(`üéÅ ‚úÖ ${newRewardsEarned} NUOVO/I PREMIO/I! Invio notifica WhatsApp...`);
                        this.showToast(`üéâ ${customer.firstName} ha guadagnato ${newRewardsEarned} premio${newRewardsEarned > 1 ? 'i' : ''}!`);

                        setTimeout(() => {
                            console.log('üì± Apertura WhatsApp per:', customer.firstName);
                            this.sendStampsUpdateWhatsApp(customerId, stampsCount); // ‚Üê USA customerId salvato
                        }, 1000);
                    } else {
                        console.log('‚ÑπÔ∏è Nessun nuovo premio guadagnato');
                    }

                    // Sblocca auto-sync dopo 5 secondi
                    setTimeout(() => {
                        this.editingFidelity = false;
                        console.log('‚úÖ Sblocco auto-sync');
                    }, 5000);
                }

                // Campagne Coupon
                renderCampaignsList() {
                    const container = document.getElementById('campaigns-list');
                    if (!container) return;

                    if (!this.db.campaigns || this.db.campaigns.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center text-sm">Nessuna campagna attiva</p>';
                        return;
                    }

                    container.innerHTML = this.db.campaigns.map(campaign => {
                        const isActive = !campaign.expiryDate || new Date(campaign.expiryDate) >= new Date();
                        const statusColor = isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                        const statusText = isActive ? 'Attiva' : 'Scaduta';

                        const discountText = campaign.discountType === 'percentage'
                            ? `${campaign.discountValue}%`
                            : `‚Ç¨${campaign.discountValue}`;

                        return `
                        <div class="border rounded-lg p-4 mb-3 ${!isActive ? 'opacity-50' : ''}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-lg">${campaign.name}</h3>
                                    <p class="text-sm text-gray-600">${campaign.description || ''}</p>
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-semibold ${statusColor}">${statusText}</span>
                            </div>
                            
                            <div class="flex gap-4 text-sm mb-2">
                                <div class="bg-purple-50 px-3 py-1 rounded">
                                    <span class="font-bold text-purple-600">${discountText}</span> di sconto
                                </div>
                                ${campaign.expiryDate ? `
                                    <div class="text-gray-600">
                                        Scade: ${new Date(campaign.expiryDate).toLocaleDateString('it-IT')}
                                    </div>
                                ` : ''}
                            </div>

                            ${campaign.deliveryDates && campaign.deliveryDates.length > 0 ? `
                                <div class="text-xs text-gray-600 mt-2">
                                    üìÖ Date valide: ${campaign.deliveryDates.map(d => new Date(d).toLocaleDateString('it-IT')).join(', ')}
                                </div>
                            ` : ''}

                            <div class="flex gap-2 mt-3">
                                <button onclick="app.generateCouponsForCampaign('${campaign.id}')" 
                                    class="flex-1 bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">
                                    üé´ Genera Coupon
                                </button>
                                <button onclick="app.deleteCampaign('${campaign.id}')" 
                                    class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                    }).join('');
                }

                openNewCampaignModal() {
                    document.getElementById('campaign-name').value = '';
                    document.getElementById('campaign-description').value = '';
                    document.getElementById('campaign-discount-type').value = 'percentage';
                    document.getElementById('campaign-discount-value').value = '';
                    document.getElementById('campaign-expiry').value = '';
                    document.getElementById('campaign-dates-container').innerHTML = '';

                    this.addCampaignDateInput();
                    this.updateCampaignDiscountLabel();

                    const modal = document.getElementById('campaign-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }

                closeCampaignModal() {
                    const modal = document.getElementById('campaign-modal');
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }

                updateCampaignDiscountLabel() {
                    const type = document.getElementById('campaign-discount-type').value;
                    const label = document.getElementById('campaign-discount-label');
                    label.textContent = type === 'percentage' ? '(% da 1 a 100)' : '(‚Ç¨)';
                }

                addCampaignDateInput() {
                    const container = document.getElementById('campaign-dates-container');
                    const index = container.children.length;

                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'flex gap-2';
                    dateDiv.innerHTML = `
                    <input type="date" class="campaign-date flex-1 px-3 py-2 border rounded-lg" />
                    <button type="button" onclick="this.parentElement.remove()" 
                        class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600">√ó</button>
                `;
                    container.appendChild(dateDiv);
                }

                async saveCampaign() {
                    const name = document.getElementById('campaign-name').value.trim();
                    const description = document.getElementById('campaign-description').value.trim();
                    const discountType = document.getElementById('campaign-discount-type').value;
                    const discountValue = parseFloat(document.getElementById('campaign-discount-value').value);
                    const expiryDate = document.getElementById('campaign-expiry').value;

                    if (!name) {
                        this.showToast('‚ö†Ô∏è Inserisci il nome della campagna', 'error');
                        return;
                    }

                    if (!discountValue || discountValue <= 0) {
                        this.showToast('‚ö†Ô∏è Inserisci un valore sconto valido', 'error');
                        return;
                    }

                    const dateInputs = document.querySelectorAll('.campaign-date');
                    const deliveryDates = Array.from(dateInputs)
                        .map(input => input.value)
                        .filter(date => date);

                    const campaign = {
                        id: this.generateId(),
                        name,
                        description,
                        discountType,
                        discountValue,
                        deliveryDates,
                        expiryDate: expiryDate || null,
                        createdAt: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    };

                    this.db.campaigns.push(campaign);
                    this.saveData();
                    await this.syncToDropbox(true); // ‚úÖ AGGIUNTO

                    this.closeCampaignModal();
                    this.renderCampaignsList();
                    this.showToast('‚úÖ Campagna creata e sincronizzata!');
                }

                async deleteCampaign(campaignId) {
                    if (!confirm('Eliminare questa campagna?')) return;

                    this.db.campaigns = this.db.campaigns.filter(c => c.id !== campaignId);
                    this.saveData();
                    await this.syncToDropbox(true); // ‚úÖ AGGIUNTO
                    this.renderCampaignsList();
                    this.showToast('‚úÖ Campagna eliminata e sincronizzata');
                }

                async generateCouponsForCampaign(campaignId) {
                    const campaign = this.db.campaigns.find(c => c.id === campaignId);
                    if (!campaign) return;

                    let count = 0;
                    this.db.customers.forEach(customer => {
                        if (!customer.coupons) customer.coupons = [];

                        const couponCode = `${campaign.name.substring(0, 3).toUpperCase()}${Date.now().toString().slice(-4)}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`;

                        customer.coupons.push({
                            id: this.generateId(),
                            code: couponCode,
                            campaignId: campaign.id,
                            campaignName: campaign.name,
                            description: campaign.description,
                            discountType: campaign.discountType,
                            discountValue: campaign.discountValue,
                            deliveryDates: campaign.deliveryDates,
                            expiryDate: campaign.expiryDate,
                            used: false,
                            createdAt: new Date().toISOString()
                        });
                        count++;
                    });

                    await this.saveData();
                    this.renderFidelityDashboard();
                    this.showToast(`‚úÖ ${count} coupon generati e inviati ai clienti!`);
                }

                // Scanner QR Universale (Dashboard e altre sezioni)
                openUniversalQRScanner() {
                    // Riutilizza il modal fidelity scanner che riconosce sia fidelity card che coupon
                    this.openFidelityQRScanner();
                }

                // Scanner QR Fidelity
                async openFidelityQRScanner() {
                    const modal = document.getElementById('fidelity-qr-scanner-modal');
                    const video = document.getElementById('fidelity-qr-video');

                    modal.classList.remove('hidden');
                    modal.classList.add('flex');

                    try {
                        const constraints = {
                            video: {
                                facingMode: 'environment',
                                width: { ideal: 1280, max: 1920 },
                                height: { ideal: 720, max: 1080 },
                                frameRate: { ideal: 30, max: 30 }
                            }
                        };

                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        video.srcObject = stream;

                        await new Promise(resolve => {
                            video.onloadedmetadata = resolve;
                        });
                        await video.play();

                        this.scanFidelityQRCode(video);

                    } catch (err) {
                        console.error('üì∑ Camera error:', err);

                        let message = '‚ùå Impossibile accedere alla fotocamera';

                        if (err.name === 'NotAllowedError') {
                            message = 'üì∑ Permesso camera negato. Abilita nelle impostazioni.';
                        } else if (err.name === 'NotFoundError') {
                            message = 'üì∑ Nessuna fotocamera trovata.';
                        } else if (err.name === 'NotReadableError') {
                            message = 'üì∑ Fotocamera gi√† in uso.';
                        }

                        this.showToast(message, 'error');
                        this.closeFidelityQRScanner();
                    }
                }

                closeFidelityQRScanner() {
                    const modal = document.getElementById('fidelity-qr-scanner-modal');
                    const video = document.getElementById('fidelity-qr-video');

                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                    }

                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }

                scanFidelityQRCode(video) {
                    const canvas = document.getElementById('fidelity-qr-canvas');
                    const context = canvas.getContext('2d');
                    let lastScan = 0;
                    let scanCount = 0;

                    const scan = () => {
                        const now = Date.now();

                        // Scansiona solo ogni 300ms per evitare letture parziali
                        if (now - lastScan < 300) {
                            requestAnimationFrame(scan);
                            return;
                        }

                        lastScan = now;

                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);

                            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);

                            if (code && code.data && code.data.length > 10) {
                                scanCount++;
                                console.log(`üì∑ Scansione #${scanCount}:`, code.data.substring(0, 50) + '...');

                                // Prova a parsare e processare
                                this.handleFidelityQRCode(code.data);

                                // Se il parsing ha successo, handleFidelityQRCode chiuder√† lo scanner
                                // Se fallisce, continua a scansionare
                            }
                        }
                        requestAnimationFrame(scan);
                    };

                    scan();
                }

                async handleFidelityQRCode(qrData) {
                    // Ignora letture vuote o troppo corte
                    if (!qrData || qrData.length < 10) {
                        console.log('‚è≠Ô∏è QR troppo corto, ignorato');
                        return;
                    }

                    try {
                        const data = JSON.parse(qrData);
                        console.log('üîç QR scansionato:', data);

                        // ============ FIDELITY CARD ============
                        const isFidelityCard = data.type === 'fidelity-card' || data.app === 'fidelity-card';
                        const customerId = data.customerId || data.id;

                        if (isFidelityCard && customerId) {
                            // Cerca prima per ID
                            let customer = this.db.customers.find(c => c.id === customerId);

                            // Se non trovato per ID, cerca per nome (fallback)
                            if (!customer && data.name) {
                                const nameParts = data.name.split(' ');
                                customer = this.db.customers.find(c =>
                                    nameParts.some(part => c.firstName === part || c.lastName === part)
                                );

                                if (customer) {
                                    console.log('‚úÖ Cliente trovato per nome (ID cambiato):', customer);
                                }
                            }

                            if (customer) {
                                this.closeFidelityQRScanner();
                                this.showToast(`‚úÖ Cliente: ${customer.firstName} ${customer.lastName}`);
                                this.switchTab('fidelity');

                                setTimeout(() => {
                                    this.openCustomerFidelityModal(customer.id);
                                }, 300);
                                return;
                            } else {
                                console.error('‚ùå Cliente non trovato con ID:', customerId);
                                this.showToast('‚ùå Cliente non trovato. Rigenera il QR dalla tessera.', 'error');
                                return;
                            }
                        }

                        // ============ COUPON ============
                        if (data.type === 'coupon' && data.couponCode) {
                            this.closeFidelityQRScanner();
                            this.handleCouponQRCode(data);
                            return;
                        }

                        // ============ QR NON RICONOSCIUTO ============
                        console.error('‚ùå QR non riconosciuto:', data);
                        this.showToast('‚ùå QR code non riconosciuto', 'error');

                    } catch (e) {
                        // Ignora errori di parsing parziale, continua a scansionare
                        console.log('‚ö†Ô∏è Lettura QR parziale, riprovo...');
                    }
                }

                // Gestione QR Coupon
                handleCouponQRCode(data) {
                    // Cerca il coupon nel database
                    let foundCustomer = null;
                    let foundCoupon = null;

                    for (const customer of this.db.customers) {
                        if (customer.coupons) {
                            const coupon = customer.coupons.find(c => c.code === data.couponCode);
                            if (coupon) {
                                foundCustomer = customer;
                                foundCoupon = coupon;
                                break;
                            }
                        }
                    }

                    if (!foundCoupon) {
                        this.showToast('‚ùå Coupon non trovato o gi√† usato', 'error');
                        return;
                    }

                    if (foundCoupon.used) {
                        this.showToast('‚ùå Coupon gi√† utilizzato', 'error');
                        return;
                    }

                    // Mostra dettagli coupon
                    const discountText = foundCoupon.discountType === 'percentage'
                        ? `${foundCoupon.discountValue}%`
                        : `‚Ç¨${foundCoupon.discountValue}`;

                    const expiryText = foundCoupon.expiryDate
                        ? `Scade: ${new Date(foundCoupon.expiryDate).toLocaleDateString('it-IT')}`
                        : 'Senza scadenza';

                    const message = `üéüÔ∏è COUPON VALIDO!\n\n` +
                        `Cliente: ${foundCustomer.firstName} ${foundCustomer.lastName}\n` +
                        `Campagna: ${foundCoupon.campaignName}\n` +
                        `Sconto: ${discountText}\n` +
                        `${expiryText}\n\n` +
                        `Vuoi applicare questo coupon a un ordine?`;

                    if (confirm(message)) {
                        // Vai alla tab ordini per applicare il coupon
                        this.switchTab('ordini');
                        this.showToast(`‚úÖ Coupon pronto! Seleziona l'ordine dove applicarlo.`, 'success');
                        // Qui potresti aggiungere logica per pre-selezionare il coupon
                    } else {
                        this.showToast('‚ÑπÔ∏è Coupon scansionato ma non applicato', 'info');
                    }
                }

                // Storia Fidelity Cliente
                showCustomerFidelityHistory(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;

                    document.getElementById('history-customer-name').textContent = `${customer.firstName} ${customer.lastName}`;
                    document.getElementById('history-customer-stamps').textContent = customer.fidelity?.stamps || 0;

                    const history = customer.fidelity?.history || [];
                    const container = document.getElementById('fidelity-history-list');

                    if (history.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">Nessuna attivit√†</p>';
                    } else {
                        container.innerHTML = history.slice().reverse().map(entry => {
                            const date = new Date(entry.date).toLocaleDateString('it-IT', {
                                day: '2-digit', month: '2-digit', year: 'numeric',
                                hour: '2-digit', minute: '2-digit'
                            });

                            let icon = 'üìù';
                            let text = '';
                            let bgColor = 'bg-gray-50';

                            if (entry.type === 'add') {
                                icon = '‚ûï';
                                text = `Aggiunti ${entry.stamps} bollini (Spesa: ‚Ç¨${entry.amount.toFixed(2)})`;
                                bgColor = 'bg-green-50';
                            } else if (entry.type === 'reward') {
                                icon = 'üéÅ';
                                text = `Premio riscattato (-${entry.stamps} bollini)`;
                                bgColor = 'bg-blue-50';
                            } else if (entry.type === 'remove') {
                                icon = '‚ûñ';
                                text = `Rimossi ${entry.stamps} bollini`;
                                bgColor = 'bg-red-50';
                            }

                            return `
                            <div class="${bgColor} border rounded p-3">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="text-lg">${icon}</span>
                                        <span class="ml-2 font-medium">${text}</span>
                                    </div>
                                    <span class="text-xs text-gray-500">${date}</span>
                                </div>
                            </div>
                        `;
                        }).join('');
                    }

                    const modal = document.getElementById('customer-fidelity-history-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }

                closeCustomerFidelityHistory() {
                    const modal = document.getElementById('customer-fidelity-history-modal');
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }

                // Modal Dettagli Cliente Fidelity (cliccabile)
                openCustomerFidelityModal(customerId) {
                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) return;

                    const stamps = customer.fidelity?.stamps || 0;
                    const rewards = customer.fidelity?.rewards || 0;
                    const availableRewards = Math.floor(stamps / this.fidelityConfig.stampsPerReward);

                    // üîç DEBUG MODAL
                    console.log('üîç DEBUG openCustomerFidelityModal:', {
                        customerName: customer.firstName + ' ' + customer.lastName,
                        stamps,
                        stampsPerReward: this.fidelityConfig.stampsPerReward,
                        availableRewards,
                        fidelityConfig: this.fidelityConfig
                    });

                    const stampsTowardNext = stamps % this.fidelityConfig.stampsPerReward; const progress = (stampsTowardNext / this.fidelityConfig.stampsPerReward) * 100;
                    const remainingForNext = this.fidelityConfig.stampsPerReward - stampsTowardNext;
                    const activeCoupons = customer.coupons ? customer.coupons.filter(c => !c.used).length : 0;

                    const content = document.getElementById('customer-fidelity-modal-content');
                    content.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-2xl font-bold">${customer.firstName} ${customer.lastName}</h2>
                                <p class="text-gray-500">${customer.phone || ''}</p>
                            </div>
                            <button onclick="app.closeCustomerFidelityModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 rounded-lg p-4 text-center">
                                <p class="text-3xl font-bold text-blue-600">${stamps}</p>
                                <p class="text-sm text-gray-600">Bollini Totali</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4 text-center">
                                <p class="text-3xl font-bold text-purple-600">${availableRewards}</p>
                                <p class="text-sm text-gray-600">Premi Disponibili</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4 text-center">
                                <p class="text-3xl font-bold text-green-600">${rewards}</p>
                                <p class="text-sm text-gray-600">Premi Riscattati</p>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm font-semibold text-gray-700">Progresso verso prossimo premio</p>
                                <p class="text-sm text-gray-600">${stampsTowardNext}/${this.fidelityConfig.stampsPerReward}</p>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-blue-600 h-3 rounded-full transition-all" style="width: ${progress}%"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2 text-center">
                                ${stampsTowardNext === 0 && stamps > 0 ?
                            'üéâ Premio completo! Riscattalo qui sotto' :
                            `Mancano ${remainingForNext} bollini al prossimo premio`}
                            </p>
                        </div>

                        <!-- Riscatta Premio -->
                        ${availableRewards > 0 ? `
                            <div class="mb-6">
                                <button onclick="app.redeemReward('${customer.id}'); app.closeCustomerFidelityModal();" 
                                        class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-lg hover:from-green-700 hover:to-green-800 font-bold text-lg shadow-lg">
                                    üéÅ Riscatta Premio (${availableRewards} disponibile${availableRewards > 1 ? 'i' : ''})
                                </button>
                            </div>
                        ` : ''}

                        <!-- Azioni Bollini -->
                        <div class="mb-4">
                            <p class="text-sm font-semibold text-gray-700 mb-2">‚ûï Aggiungi Bollini</p>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="app.quickAddStamps('${customer.id}', 1)" 
                                        class="bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold">+1</button>
                                <button onclick="app.quickAddStamps('${customer.id}', 2)" 
                                        class="bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold">+2</button>
                                <button onclick="app.quickAddStamps('${customer.id}', 3)" 
                                        class="bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold">+3</button>
                                <button onclick="app.openAddStampsModal('${customer.id}')" 
                                        class="bg-blue-700 text-white py-3 rounded-lg hover:bg-blue-800 font-bold">+N</button>
                            </div>
                        </div>

                        <!-- Coupon -->
                        ${activeCoupons > 0 ? `
                            <div class="border-t pt-4 mb-4">
                                <h3 class="font-bold mb-2">üé´ Coupon Attivi (${activeCoupons})</h3>
                                ${customer.coupons.filter(c => !c.used).map(coupon => `
                                    <div class="bg-purple-50 border border-purple-200 rounded p-3 mb-2">
                                        <div class="font-bold">${coupon.campaignName}</div>
                                        <div class="text-sm text-gray-600">${coupon.code}</div>
                                        <div class="text-sm text-purple-600">
                                            ${coupon.discountType === 'percentage' ? `${coupon.discountValue}%` : `‚Ç¨${coupon.discountValue}`} di sconto
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- Cronologia -->
                        <div class="border-t pt-4">
                            <button onclick="app.showCustomerFidelityHistory('${customer.id}')" 
                                    class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 font-bold">
                                üìã Vedi Cronologia Completa
                            </button>
                        </div>
                    </div>
                `;

                    const modal = document.getElementById('customer-fidelity-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }

                closeCustomerFidelityModal() {
                    const modal = document.getElementById('customer-fidelity-modal');
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }

                async quickAddStamps(customerId, stampCount) {
                    console.log('‚ö° quickAddStamps chiamato:', { customerId, stampCount });

                    const customer = this.db.customers.find(c => c.id === customerId);
                    if (!customer) {
                        console.error('‚ùå Cliente non trovato');
                        return;
                    }

                    if (!customer.fidelity) {
                        console.error('‚ùå Fidelity non inizializzato');
                        return;
                    }

                    const stampsBefore = customer.fidelity.stamps;
                    console.log('üìä Bollini prima:', stampsBefore);

                    customer.fidelity.stamps += stampCount;
                    customer.lastModified = new Date().toISOString();

                    console.log('üìä Bollini dopo:', customer.fidelity.stamps);
                    console.log('‚ûï Aggiunti:', stampCount);

                    customer.fidelity.history.push({
                        date: new Date().toISOString(),
                        type: 'add',
                        stamps: stampCount,
                        amount: stampCount * this.fidelityConfig.eurosPerStamp
                    });

                    // Blocca auto-sync PRIMA di salvare
                    this.editingFidelity = true;

                    this.saveData();

                    console.log('üíæ Dati salvati');
                    console.log('üîÑ Refresh modal...');

                    this.openCustomerFidelityModal(customerId);
                    this.renderFidelityDashboard();
                    this.showToast(`‚úÖ +${stampCount} bollini!`);

                    // Notifica se ha guadagnato un nuovo premio
                    const rewardsBefore = Math.floor(stampsBefore / this.fidelityConfig.stampsPerReward);
                    const rewardsAfter = Math.floor(customer.fidelity.stamps / this.fidelityConfig.stampsPerReward);
                    const newRewardsEarned = rewardsAfter - rewardsBefore;

                    console.log('üîç CHECK PREMIO:', {
                        stampsBefore,
                        stampsAfter: customer.fidelity.stamps,
                        rewardsBefore,
                        rewardsAfter,
                        newRewardsEarned,
                        calculation: `${rewardsAfter} - ${rewardsBefore} = ${newRewardsEarned} nuovi premi`
                    });

                    if (newRewardsEarned > 0) {
                        console.log(`üéÅ ‚úÖ ${newRewardsEarned} NUOVO/I PREMIO/I! Invio notifica WhatsApp...`);
                        this.showToast(`üéâ ${customer.firstName} ha guadagnato ${newRewardsEarned} premio${newRewardsEarned > 1 ? 'i' : ''}!`);

                        setTimeout(() => {
                            console.log('üì± Apertura WhatsApp per:', customer.firstName);
                            this.sendStampsUpdateWhatsApp(customerId, stampCount);
                        }, 1000);
                    } else {
                        console.log('‚ÑπÔ∏è Nessun nuovo premio guadagnato');
                    }

                    // Sblocca auto-sync dopo 5 secondi
                    setTimeout(() => {
                        this.editingFidelity = false;
                        console.log('‚úÖ Sblocco auto-sync');
                    }, 5000);
                }
                showCustomersWithRewards() {
                    this.switchTab('fidelity');
                    setTimeout(() => {
                        const container = document.getElementById('fidelity-customers-list');
                        if (container) container.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                }

                showCustomersWithCoupons() {
                    this.switchTab('fidelity');
                    setTimeout(() => {
                        const container = document.getElementById('fidelity-customers-list');
                        if (container) container.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                }

                showCustomersWithRedeemedRewards() {
                    // Ora apre il modal invece di scrollare
                    this.showRedeemedRewardsModal();
                }

                showAvailableRewardsModal() {
                    const customersWithRewards = this.db.customers.filter(c => {
                        const stamps = c.fidelity?.stamps || 0;
                        const availableRewards = Math.floor(stamps / this.fidelityConfig.stampsPerReward);
                        return availableRewards > 0;
                    });

                    const container = document.getElementById('available-rewards-list');

                    if (customersWithRewards.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">Nessun cliente ha premi disponibili al momento.</p>';
                    } else {
                        // Ordina per numero di premi disponibili (decrescente)
                        customersWithRewards.sort((a, b) => {
                            const aRewards = Math.floor((a.fidelity?.stamps || 0) / this.fidelityConfig.stampsPerReward);
                            const bRewards = Math.floor((b.fidelity?.stamps || 0) / this.fidelityConfig.stampsPerReward);
                            return bRewards - aRewards;
                        });

                        container.innerHTML = customersWithRewards.map(customer => {
                            const stamps = customer.fidelity?.stamps || 0;
                            const stampsPerReward = this.fidelityConfig.stampsPerReward;
                            const availableRewards = Math.floor(stamps / stampsPerReward);
                            const remainingStamps = stamps % stampsPerReward;

                            return `
                <div class="bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-800">${customer.lastName} ${customer.firstName}</h3>
                            <p class="text-sm text-gray-600">${customer.phone}</p>
                        </div>
                        <div class="text-right">
                            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-full shadow-lg">
                                <p class="text-3xl font-bold">üéÅ ${availableRewards}</p>
                                <p class="text-xs">Premio${availableRewards > 1 ? 'i' : ''} disponibile${availableRewards > 1 ? 'i' : ''}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">${stamps} bollini totali</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-3 mb-3">
                        <p class="text-sm font-semibold text-gray-700 mb-2">‚ÑπÔ∏è Info premio:</p>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div>‚Ä¢ Ha ${stamps} bollin${stamps === 1 ? 'o' : 'i'} totali</div>
                            <div>‚Ä¢ Pu√≤ riscattare ${availableRewards} premi${availableRewards === 1 ? 'o' : ''}</div>
                            <div>‚Ä¢ Dopo il riscatto avr√† ${remainingStamps} bollin${remainingStamps === 1 ? 'o' : 'i'}</div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="app.closeAvailableRewardsModal(); app.redeemReward('${customer.id}')"
                                class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-bold">
                            üéÅ Riscatta Ora
                        </button>
                        <button onclick="app.closeAvailableRewardsModal(); app.openCustomerFidelityModal('${customer.id}')"
                                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-bold">
                            üë§ Dettagli
                        </button>
                    </div>
                </div>
            `;
                        }).join('');
                    }

                    const modal = document.getElementById('available-rewards-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }

                closeAvailableRewardsModal() {
                    const modal = document.getElementById('available-rewards-modal');
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }

                showRedeemedRewardsModal() {
                    const customersWithRedeemed = this.db.customers.filter(c => {
                        return c.fidelity && (c.fidelity.rewards || 0) > 0;
                    });

                    const container = document.getElementById('redeemed-rewards-list');

                    if (customersWithRedeemed.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">Nessun cliente ha ancora riscattato premi.</p>';
                    } else {
                        // Ordina per numero di premi riscattati (decrescente)
                        customersWithRedeemed.sort((a, b) => {
                            const aRewards = a.fidelity?.rewards || 0;
                            const bRewards = b.fidelity?.rewards || 0;
                            return bRewards - aRewards;
                        });

                        container.innerHTML = customersWithRedeemed.map(customer => {
                            const redeemedRewards = customer.fidelity?.rewards || 0;
                            const stamps = customer.fidelity?.stamps || 0;
                            const lastReward = customer.fidelity?.rewardsList?.[customer.fidelity.rewardsList.length - 1];
                            const lastRewardDate = lastReward ? new Date(lastReward.date).toLocaleDateString('it-IT') : 'N/A';

                            const rewardHistory = customer.fidelity?.rewardsList || [];
                            const rewardHistoryHTML = rewardHistory.length > 0 ?
                                rewardHistory.slice().reverse().slice(0, 3).map(reward => {
                                    const date = new Date(reward.date).toLocaleDateString('it-IT', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric'
                                    });
                                    return `<div class="text-xs text-gray-600">‚úÖ ${date}</div>`;
                                }).join('') :
                                '<div class="text-xs text-gray-500">Nessuna cronologia</div>';

                            return `
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-300 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-800">${customer.lastName} ${customer.firstName}</h3>
                            <p class="text-sm text-gray-600">${customer.phone}</p>
                        </div>
                        <div class="text-right">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-full shadow-lg">
                                <p class="text-3xl font-bold">‚úÖ ${redeemedRewards}</p>
                                <p class="text-xs">Premio${redeemedRewards > 1 ? 'i' : ''} riscattato${redeemedRewards > 1 ? 'i' : ''}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">${stamps} bollini attuali</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-3 mb-3">
                        <p class="text-sm font-semibold text-gray-700 mb-2">üìÖ Ultimi premi riscattati:</p>
                        ${rewardHistoryHTML}
                        ${rewardHistory.length > 3 ? '<div class="text-xs text-gray-500 mt-1">...e altri</div>' : ''}
                    </div>

                    <div class="flex gap-2">
                        <button onclick="app.closeRedeemedRewardsModal(); app.showCustomerFidelityHistory('${customer.id}')"
                                class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-bold">
                            üìã Cronologia Completa
                        </button>
                        <button onclick="app.closeRedeemedRewardsModal(); app.openCustomerFidelityModal('${customer.id}')"
                                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-bold">
                            üë§ Dettagli
                        </button>
                    </div>
                </div>
            `;
                        }).join('');
                    }

                    const modal = document.getElementById('redeemed-rewards-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }

                closeRedeemedRewardsModal() {
                    const modal = document.getElementById('redeemed-rewards-modal');
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }

                showActiveCouponsModal() {
                    const customersWithActiveCoupons = this.db.customers.filter(c => {
                        return c.coupons && c.coupons.some(coupon => !coupon.used);
                    });

                    const container = document.getElementById('active-coupons-list');

                    if (customersWithActiveCoupons.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">Nessun cliente ha coupon attivi al momento.</p>';
                    } else {
                        container.innerHTML = customersWithActiveCoupons.map(customer => {
                            const activeCoupons = customer.coupons.filter(c => !c.used);

                            const couponsHTML = activeCoupons.map(coupon => {
                                const expiryDate = coupon.expiryDate ? new Date(coupon.expiryDate).toLocaleDateString('it-IT') : 'Senza scadenza';
                                const discountText = coupon.discountType === 'percentage'
                                    ? `${coupon.discountValue}%`
                                    : `‚Ç¨${coupon.discountValue}`;

                                return `
                                    <div class="bg-pink-50 border border-pink-200 rounded-lg p-3 mb-2">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex-1">
                                                <p class="font-bold text-gray-800">${coupon.campaignName}</p>
                                                <p class="text-sm text-gray-600">${coupon.description || ''}</p>
                                                <p class="text-xs text-gray-500 mt-1">Codice: <span class="font-mono font-bold">${coupon.code}</span></p>
                                            </div>
                                            <div class="bg-pink-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                ${discountText}
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 mb-2">üìÖ Scadenza: ${expiryDate}</p>
        
                                        <div class="grid grid-cols-2 gap-2 mt-2">
                                                <button onclick="app.generateCouponImage('${customer.id}', '${coupon.code}')" 
                                                        class="bg-purple-600 text-white py-2 px-3 rounded-lg hover:bg-purple-700 text-sm font-medium">
                                                    üì• Scarica PNG
                                                </button>
                                                <button onclick="app.sendCouponWhatsApp('${customer.id}', '${coupon.code}')" 
                                                        class="bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700 text-sm font-medium">
                                                    üì± Invia WhatsApp
                                                </button>
                                            </div>
                                        </div>
                                    `;
                            }).join('');

                            return `
                <div class="bg-gradient-to-r from-pink-50 to-pink-100 border-2 border-pink-300 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-800">${customer.lastName} ${customer.firstName}</h3>
                            <p class="text-sm text-gray-600">${customer.phone}</p>
                        </div>
                        <div class="bg-gradient-to-r from-pink-500 to-pink-600 text-white px-4 py-2 rounded-full shadow-lg">
                            <p class="text-2xl font-bold">${activeCoupons.length}</p>
                            <p class="text-xs">Coupon attiv${activeCoupons.length === 1 ? 'o' : 'i'}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        ${couponsHTML}
                    </div>
                    
                    <div class="mt-3">
                        <button onclick="app.closeActiveCouponsModal(); app.openCustomerFidelityModal('${customer.id}')"
                                class="w-full bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 font-bold">
                            üë§ Vedi Dettagli Cliente
                        </button>
                    </div>
                </div>
            `;
                        }).join('');
                    }

                    const modal = document.getElementById('active-coupons-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }

                closeActiveCouponsModal() {
                    const modal = document.getElementById('active-coupons-modal');
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }

                showUsedCouponsModal() {
                    const customersWithUsedCoupons = this.db.customers.filter(c => {
                        return c.coupons && c.coupons.some(coupon => coupon.used);
                    });

                    const container = document.getElementById('used-coupons-list');

                    if (customersWithUsedCoupons.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">Nessun cliente ha ancora usato coupon.</p>';
                    } else {
                        container.innerHTML = customersWithUsedCoupons.map(customer => {
                            const usedCoupons = customer.coupons.filter(c => c.used);

                            const couponsHTML = usedCoupons.map(coupon => {
                                const usedDate = coupon.usedAt ? new Date(coupon.usedAt).toLocaleDateString('it-IT') : 'N/A';
                                const discountText = coupon.discountType === 'percentage'
                                    ? `${coupon.discountValue}%`
                                    : `‚Ç¨${coupon.discountValue}`;

                                return `
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-2">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800">${coupon.campaignName}</p>
                                <p class="text-sm text-gray-600">${coupon.description || ''}</p>
                                <p class="text-xs text-gray-500 mt-1">Codice: <span class="font-mono font-bold">${coupon.code}</span></p>
                            </div>
                            <div class="bg-orange-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                ${discountText}
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">‚úîÔ∏è Usato il: ${usedDate}</p>
                    </div>
                `;
                            }).join('');

                            return `
                <div class="bg-gradient-to-r from-orange-50 to-orange-100 border-2 border-orange-300 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-800">${customer.lastName} ${customer.firstName}</h3>
                            <p class="text-sm text-gray-600">${customer.phone}</p>
                        </div>
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-full shadow-lg">
                            <p class="text-2xl font-bold">${usedCoupons.length}</p>
                            <p class="text-xs">Coupon usat${usedCoupons.length === 1 ? 'o' : 'i'}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        ${couponsHTML}
                    </div>
                    
                    <div class="mt-3">
                        <button onclick="app.closeUsedCouponsModal(); app.openCustomerFidelityModal('${customer.id}')"
                                class="w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 font-bold">
                            üë§ Vedi Dettagli Cliente
                        </button>
                    </div>
                </div>
            `;
                        }).join('');
                    }

                    const modal = document.getElementById('used-coupons-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }

                closeUsedCouponsModal() {
                    const modal = document.getElementById('used-coupons-modal');
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                }

                // EXPORT CSV
                exportOrders() {
                    if (this.db.orders.filter(o => !o.deleted).length === 0) {
                        this.showToast('‚ö†Ô∏è Nessun ordine da esportare', 'error');
                        return;
                    }

                    const headers = ['Numero', 'Cliente', 'Data Consegna', 'Stato Prep', 'Stato Pagamento', 'Totale', 'Acconto', 'Resto'];
                    const rows = this.db.orders.filter(o => !o.deleted).map(order => {
                        const customer = this.db.customers.find(c => c.id === order.customerId);
                        const customerName = customer ? `${customer.lastName} ${customer.firstName}` : 'Sconosciuto';
                        const total = order.items.reduce((sum, item) => sum + item.price, 0);

                        const deposit = order.deposit || 0;
                        const remaining = total - deposit;

                        return [
                            order.number,
                            customerName,
                            this.formatDate(order.deliveryDate),
                            order.prepStatus,
                            order.paymentStatus,
                            `‚Ç¨ ${total.toFixed(2).replace('.', ',')}`, // Formato valuta con simbolo ‚Ç¨
                            deposit > 0 ? `‚Ç¨ ${deposit.toFixed(2).replace('.', ',')}` : '-', // Mostra "-" se nessun acconto
                            `‚Ç¨ ${remaining.toFixed(2).replace('.', ',')}` // Formato valuta
                        ];
                    });

                    // Usa punto e virgola come separatore per Excel italiano
                    const csvContent = [
                        headers.join(';'),
                        ...rows.map(row => row.map(cell => {
                            // Escape delle virgolette e aggiungi virgolette se contiene punto e virgola o spazi
                            const cellStr = String(cell);
                            const escaped = cellStr.replace(/"/g, '""');
                            // Racchiudi tra virgolette se contiene punto e virgola, virgola o inizia con ‚Ç¨
                            return (escaped.includes(';') || escaped.includes(',') || escaped.startsWith('‚Ç¨'))
                                ? `"${escaped}"`
                                : escaped;
                        }).join(';'))
                    ].join('\n');

                    // BOM UTF-8 per caratteri accentati corretti in Excel
                    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);

                    const date = new Date().toISOString().split('T')[0];
                    link.setAttribute('href', url);
                    link.setAttribute('download', `ordini_${date}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    this.showToast('‚úÖ Ordini esportati in CSV (formato Excel IT)');
                }

                // BACKUP LOCALE
                backupData() {
                    const backup = {
                        version: '1.0',
                        date: new Date().toISOString(),
                        data: this.db,
                        fidelityConfig: this.fidelityConfig
                    };

                    const json = JSON.stringify(backup, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);

                    const date = new Date().toISOString().split('T')[0];
                    link.setAttribute('href', url);
                    link.setAttribute('download', `backup_gestionale_${date}.json`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    this.showToast('‚úÖ Backup scaricato');
                }

                updateLastSyncInfo() {
                    const lastSync = localStorage.getItem('lastSync');
                    const lastDropboxSync = localStorage.getItem('lastDropboxSync');
                    const infoDiv = document.getElementById('last-sync-info');

                    let html = '';

                    if (lastSync) {
                        const date = new Date(lastSync);
                        const now = new Date();
                        const diffMs = now - date;
                        const diffMins = Math.floor(diffMs / 60000);
                        let timeText;
                        if (diffMins < 1) timeText = 'adesso';
                        else if (diffMins < 60) timeText = `${diffMins} min fa`;
                        else if (diffMins < 1440) { const hours = Math.floor(diffMins / 60); timeText = `${hours}h fa`; }
                        else { const days = Math.floor(diffMins / 1440); timeText = `${days}g fa`; }
                        html += `üíæ Locale: ${timeText}`;
                    }

                    if (lastDropboxSync) {
                        const date = new Date(lastDropboxSync);
                        const now = new Date();
                        const diffMs = now - date;
                        const diffMins = Math.floor(diffMs / 60000);
                        let timeText;
                        if (diffMins < 1) timeText = 'adesso';
                        else if (diffMins < 60) timeText = `${diffMins} min fa`;
                        else if (diffMins < 1440) { const hours = Math.floor(diffMins / 60); timeText = `${hours}h fa`; }
                        else { const days = Math.floor(diffMins / 1440); timeText = `${days}g fa`; }
                        html += ` | ‚òÅÔ∏è Dropbox: ${timeText}`;
                    }

                    infoDiv.innerHTML = html || '<span class="text-gray-500">Nessun salvataggio</span>';
                }

                render() {
                    this.renderOrders();
                    this.renderProducts();
                    this.renderCustomers();
                    this.renderCategories();
                    this.renderFidelityList();
                }

                renderOrders() {
                    const container = document.getElementById('orders-list');

                    // ‚úÖ CONTROLLO DI SICUREZZA: Se l'elemento non esiste, esci
                    if (!container) {
                        console.log('‚è≠Ô∏è orders-list non trovato, skip render');
                        return;
                    }

                    // Usa ordini filtrati se disponibili, altrimenti tutti
                    const ordersToShow = this.filteredOrders !== null
                        ? this.filteredOrders.filter(o => !o.deleted)
                        : this.db.orders.filter(o => !o.deleted);
                    if (ordersToShow.length === 0) {
                        const message = this.filteredOrders !== null
                            ? '<p class="text-gray-500 text-center p-4">‚ö†Ô∏è Nessun ordine corrisponde ai filtri</p>'
                            : '<p class="text-gray-500 text-center p-4">Nessun ordine</p>';
                        container.innerHTML = message;
                        return;
                    }

                    const statusColors = {
                        'da preparare': 'bg-red-100 text-red-800',
                        'completato': 'bg-green-100 text-green-800',
                        'consegnato': 'bg-blue-100 text-blue-800',
                        'non pagato': 'bg-red-100 text-red-800',
                        'pagato': 'bg-green-100 text-green-800'
                    };

                    const sorted = [...ordersToShow].sort((a, b) => new Date(b.deliveryDate) - new Date(a.deliveryDate));

                    container.innerHTML = sorted.map(order => {
                        const customer = this.db.customers.find(c => c.id === order.customerId);
                        const customerName = customer ? `${customer.lastName} ${customer.firstName}` : 'Sconosciuto';
                        const total = order.items.reduce((sum, item) => sum + item.price, 0);

                        // Calcola stato preparazione prodotti
                        const totalItems = order.items.length;
                        const preparedItems = order.preparedItems ? order.preparedItems.length : 0;
                        const allPrepared = preparedItems === totalItems && totalItems > 0;
                        const preparationBadge = order.prepStatus === 'da preparare' ?
                            `<span class="px-2 py-1 rounded-full text-xs font-medium ${allPrepared ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                üì¶ ${preparedItems}/${totalItems}
            </span>` : '';

                        // Badge acconto
                        const depositBadge = order.deposit && order.deposit > 0 ?
                            `<span class="px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                üí∞ Acconto: ${this.formatPrice(order.deposit)}
            </span>` : '';

                        return `
            <div onclick="app.openOrderModal('${order.id}')" class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition slide-in">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center">
                            <span class="font-bold text-blue-900">${order.number}</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">${customerName}</h3>
                            <p class="text-sm text-gray-600">Consegna: ${this.formatDate(order.deliveryDate)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-xl">${this.formatPrice(total)}</p>
                        <div class="flex gap-2 mt-1 flex-wrap justify-end">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[order.prepStatus]}">${order.prepStatus}</span>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[order.paymentStatus]}">${order.paymentStatus}</span>
                            ${preparationBadge}
                            ${depositBadge}
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 pt-3 border-t border-gray-200">
                    <button onclick="app.quickEditOrder('${order.id}', event)" 
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        Modifica
                    </button>
                    <button onclick="app.quickDeleteOrder('${order.id}', event)" 
                            class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Elimina
                    </button>
                </div>
            </div>
        `;
                    }).join('');
                }

                renderProducts() {
                    const container = document.getElementById('products-list');

                    if (!container) {
                        console.log('‚è≠Ô∏è products-list non trovato, skip render');
                        return;
                    }

                    if (this.db.products.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center p-4">Nessun prodotto</p>';
                        return;
                    }

                    // Raggruppa prodotti per categoria
                    const categories = {};
                    const sorted = [...this.db.products].sort((a, b) => a.name.localeCompare(b.name));

                    sorted.forEach(prod => {
                        const category = prod.category || 'Senza categoria';
                        if (!categories[category]) {
                            categories[category] = [];
                        }
                        categories[category].push(prod);
                    });

                    // Ordina le categorie alfabeticamente
                    const sortedCategories = Object.keys(categories).sort();

                    let html = '';
                    sortedCategories.forEach(categoryName => {
                        const products = categories[categoryName];
                        html += `
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3 pb-2 border-b-2 border-green-200">
                                üì¶ ${categoryName} (${products.length})
                            </h3>
                            <div class="grid md:grid-cols-2 gap-3">
                                ${products.map(prod => `
                                    <div onclick="app.openProductModal('${prod.id}')" class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition">
                                        <div class="flex items-center gap-4">
                                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                                </svg>
                                            </div>
                                            <div class="flex-1">
                                                <h4 class="font-bold text-md">${prod.name}</h4>
                                                <p class="text-sm font-semibold text-green-700">${this.formatPrice(prod.price)} / ${prod.unit}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    });

                    container.innerHTML = html;
                }

                renderCustomers() {
                    const container = document.getElementById('customers-list');

                    if (!container) {
                        console.log('‚è≠Ô∏è customers-list non trovato, skip render');
                        return;
                    }

                    const activeCustomers = this.db.customers.filter(c => !c.deleted);
                    if (activeCustomers.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center p-4">Nessun cliente</p>';
                        return;
                    }
                    const sorted = [...activeCustomers].sort((a, b) => a.lastName.localeCompare(b.lastName));
                    container.innerHTML = sorted.map(cust => {
                        const stamps = cust.fidelity?.stamps || 0;
                        const rewards = cust.fidelity?.rewards || 0;
                        return `<div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-lg">${cust.lastName} ${cust.firstName}</h3>
                    <p class="text-sm text-gray-600">${cust.phone || 'Nessun telefono'}</p>
                    <div class="flex items-center gap-3 text-sm mt-1">
                        <span class="text-purple-600 font-semibold">üéØ ${stamps} bollini</span>
                        ${rewards > 0 ? `<span class="text-green-600 font-semibold">üéÅ ${rewards} premi</span>` : ''}
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="event.stopPropagation(); event.preventDefault(); app.sendFidelityCardWhatsApp('${cust.id}')"
                        class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 text-sm font-medium whitespace-nowrap active:scale-95 transition-transform"
                        style="min-height: 44px; touch-action: manipulation;">
                        üì§ Invia Tessera
                    </button>
                    <button onclick="event.stopPropagation(); app.openCustomerModal('${cust.id}')"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium whitespace-nowrap">
                        ‚úèÔ∏è Modifica
                    </button>
                </div>
            </div>
        </div>`;
                    }).join('');
                }

                renderCategories() {
                    const container = document.getElementById('categories-list');
                    if (this.db.categories.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center">Nessuna categoria</p>'; return; }
                    const sorted = [...this.db.categories].sort((a, b) => a.name.localeCompare(b.name));
                    container.innerHTML = sorted.map(cat => {
                        const count = this.db.products.filter(p => p.category === cat.name).length;
                        return `<div onclick="app.openCategoryModal('${cat.id}')" class="bg-gray-50 p-3 rounded flex justify-between items-center cursor-pointer hover:bg-gray-100"><span class="font-medium">${cat.name}</span><span class="text-sm text-gray-500">${count} prodotti</span></div>`;
                    }).join('');
                }

                renderFidelityList() {
                    const container = document.getElementById('fidelity-list');
                    if (!container) return;

                    if (this.db.customers.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center p-4">Nessun cliente</p>';
                        return;
                    }

                    const sorted = [...this.db.customers].sort((a, b) => {
                        const aStamps = (a.fidelity?.stamps || 0);
                        const bStamps = (b.fidelity?.stamps || 0);
                        return bStamps - aStamps;
                    });

                    container.innerHTML = sorted.map(cust => {
                        const stamps = cust.fidelity?.stamps || 0;
                        const rewards = cust.fidelity?.rewards || 0;
                        const progress = (stamps / this.fidelityConfig.stampsPerReward) * 100;

                        return `<div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white font-bold text-xl cursor-pointer"
                        onclick="app.openFidelityCard('${cust.id}')">
                        ${cust.firstName.charAt(0)}${cust.lastName.charAt(0)}
                    </div>
                    <div class="flex-1 cursor-pointer" onclick="app.openFidelityCard('${cust.id}')">
                        <h3 class="font-bold text-lg">${cust.lastName} ${cust.firstName}</h3>
                        <div class="flex items-center gap-4 text-sm mt-1">
                            <span class="text-purple-600 font-semibold">üéØ ${stamps}/${this.fidelityConfig.stampsPerReward} bollini</span>
                            ${rewards > 0 ? `<span class="text-green-600 font-semibold">üéÅ ${rewards} premi</span>` : ''}
                        </div>
                        <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 shrink-0">
                        <button onclick="event.stopPropagation(); event.preventDefault(); app.sendFidelityCardWhatsApp('${cust.id}')"
                            class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 text-sm font-medium whitespace-nowrap active:scale-95 transition-transform"
                            style="min-height: 44px; touch-action: manipulation;">
                            üì§ Tessera
                        </button>
                        <button onclick="app.deleteFidelityCustomer('${cust.id}')"
                            class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 text-sm font-medium whitespace-nowrap">
                            üóëÔ∏è Elimina
                        </button>
                    </div>
                </div>
            </div>`;
                    }).join('');
                }

                // PREPARAZIONE IN SERIE
                filterPreparation() {
                    this.renderPreparation();
                }

                renderPreparation() {
                    const container = document.getElementById('preparation-list');

                    // ‚úÖ CONTROLLO DI SICUREZZA
                    if (!container) {
                        console.log('‚è≠Ô∏è preparation-list non trovato, skip render');
                        return;
                    }

                    const dateFilter = document.getElementById('prep-date-filter').value;
                    const statusFilter = document.getElementById('prep-status-filter').value;
                    // Filtra ordini per data
                    let ordersToShow = this.db.orders.filter(o => !o.deleted);
                    this.db.orders.filter
                    if (dateFilter) {
                        ordersToShow = ordersToShow.filter(o => o.deliveryDate === dateFilter);
                    }

                    // ‚úÖ Filtra per stato in base alla selezione
                    if (statusFilter === 'notcompleted') {
                        // Solo da preparare E senza modifiche pendenti
                        ordersToShow = ordersToShow.filter(o =>
                            o.prepStatus === 'da preparare' &&
                            (!o.pendingModifications || o.pendingModifications.length === 0)
                        );
                    } else if (statusFilter === 'tomodify') {
                        // ‚ö†Ô∏è Solo da modificare
                        ordersToShow = ordersToShow.filter(o => o.prepStatus === 'da modificare');
                    } else if (statusFilter === 'completed') {
                        // Solo completati
                        ordersToShow = ordersToShow.filter(o => o.prepStatus === 'completato');
                    } else if (statusFilter === 'all') {
                        // Mostra tutti (da preparare + da modificare + completati)
                        ordersToShow = ordersToShow.filter(o =>
                            o.prepStatus === 'da preparare' ||
                            o.prepStatus === 'da modificare' ||
                            o.prepStatus === 'completato'
                        );
                    } else {
                        // Default: mostra solo da preparare SENZA modifiche
                        ordersToShow = ordersToShow.filter(o =>
                            o.prepStatus === 'da preparare' &&
                            (!o.pendingModifications || o.pendingModifications.length === 0)
                        );
                    }

                    if (ordersToShow.length === 0) {
                        container.innerHTML = '<div class="bg-white rounded-lg shadow p-8 text-center"><p class="text-gray-500 text-lg">üì¶ Nessun ordine da preparare per questa data</p><p class="text-sm text-gray-400 mt-2">Prova a cambiare la data filtro o lo stato</p></div>';
                        return;
                    }

                    // Raggruppa per prodotto
                    const productGroups = {};

                    ordersToShow.forEach(order => {
                        const customer = this.db.customers.find(c => c.id === order.customerId);
                        const customerName = customer ? `${customer.lastName} ${customer.firstName}` : 'Sconosciuto';

                        // ‚úÖ LOOP ITEMS: Mostra prodotti nell'ordine + modifiche di AGGIUNTA
                        order.items.forEach((item, index) => {
                            const key = item.productId;
                            if (!productGroups[key]) {
                                productGroups[key] = {
                                    productName: item.productName,
                                    productId: item.productId,
                                    unit: item.unit,
                                    orders: []
                                };
                            }

                            // ‚úÖ Controlla se questo item ha modifiche pendenti di tipo AGGIUNTA
                            let modification = null;
                            if (order.pendingModifications) {
                                modification = order.pendingModifications.find(m =>
                                    m.index === index && m.action === 'aggiungere'
                                );
                            }

                            // ‚úÖ FIX: isPrepared √® FALSE se c'√® una modifica pendente di AGGIUNTA
                            const hasPendingAddition = modification && modification.action === 'aggiungere';
                            const isPrepared = hasPendingAddition ? false : (order.preparedItems && order.preparedItems.includes(index));

                            productGroups[key].orders.push({
                                orderId: order.id,
                                orderNumber: order.number,
                                customerName,
                                qty: item.qty,
                                weight: item.weight,
                                isPrepared,  // ‚úÖ FALSE se c'√® modifica di aggiunta
                                itemIndex: index,
                                modification: modification  // ‚úÖ Info modifica (solo aggiunte)
                            });
                        });

                        // ‚úÖ LOOP RIMOZIONI: Crea card separate per prodotti da rimuovere
                        if (order.pendingModifications) {
                            order.pendingModifications.forEach(mod => {
                                if (mod.action === 'rimuovere') {
                                    const key = `removed-${order.id}-${mod.index}`;
                                    if (!productGroups[key]) {
                                        productGroups[key] = {
                                            productName: mod.productName,
                                            productId: key,
                                            unit: mod.unit,
                                            orders: [],
                                            isRemovalOnly: true  // ‚úÖ FLAG per rimozioni
                                        };
                                    }

                                    productGroups[key].orders.push({
                                        orderId: order.id,
                                        orderNumber: order.number,
                                        customerName,
                                        qty: mod.oldQty,
                                        weight: null,
                                        isPrepared: false,
                                        itemIndex: mod.index,
                                        modification: mod  // ‚úÖ Info rimozione
                                    });
                                }
                            });
                        }
                    });


                    // Filtra per stato completamento
                    const filteredGroups = Object.values(productGroups).filter(group => {
                        const allPrepared = group.orders.every(o => o.isPrepared);
                        const nonePrepared = group.orders.every(o => !o.isPrepared);

                        if (statusFilter === 'completed') return allPrepared;
                        if (statusFilter === 'notcompleted') return !allPrepared;
                        return true; // 'all'
                    });

                    if (filteredGroups.length === 0) {
                        container.innerHTML = '<div class="bg-white rounded-lg shadow p-8 text-center"><p class="text-gray-500 text-lg">‚úÖ Tutto preparato!</p></div>';
                        return;
                    }

                    // Ordina per numero di ordini (prodotti pi√π richiesti prima)
                    const sortedGroups = filteredGroups.sort((a, b) => b.orders.length - a.orders.length);

                    // Render
                    container.innerHTML = sortedGroups.map(group => {
                        const totalQty = group.orders.reduce((sum, o) => sum + o.qty, 0);
                        const preparedCount = group.orders.filter(o => o.isPrepared).length;
                        const totalOrders = group.orders.length;
                        const allPrepared = preparedCount === totalOrders;
                        const progress = (preparedCount / totalOrders) * 100;

                        return `
<div class="bg-white rounded-lg shadow-lg overflow-hidden ${allPrepared && !group.isRemovalOnly ? 'opacity-60' : ''} mb-4">
    <!-- Header Prodotto -->
    <div class="bg-gradient-to-r ${group.isRemovalOnly ? 'from-red-500 to-red-600' : allPrepared ? 'from-green-500 to-green-600' : 'from-orange-500 to-red-500'} text-white p-3">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-lg font-bold">
                    ${group.isRemovalOnly ? 'üóëÔ∏è' : allPrepared ? '‚úÖ' : 'üì¶'} ${group.productName}
                    ${group.isRemovalOnly ? ' (DA RIMUOVERE)' : ''}
                </h3>
                <p class="text-sm opacity-90 mt-1">
                    ${totalOrders} ordini ‚Ä¢ Totale: ${totalQty.toFixed(1)} ${group.unit}
                </p>
            </div>
            <div class="text-right">
                <div class="text-xl font-bold">${preparedCount}/${totalOrders}</div>
                <div class="text-xs opacity-90">preparati</div>
            </div>
        </div>
        <div class="mt-2 h-2 bg-white bg-opacity-30 rounded-full overflow-hidden">
            <div class="h-full bg-white transition-all duration-300" style="width: ${progress}%"></div>
        </div>
    </div>
    
    <div class="p-3">
        <div class="flex justify-between items-center mb-3">
            <span class="text-sm font-medium text-gray-700">Dettaglio ordini:</span>
            ${!allPrepared ? `<button data-product-name="${group.productName}" data-date-filter="${dateFilter}" onclick="app.markAllProductPrepared(this.dataset.productName, this.dataset.dateFilter)" 
                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 font-medium">
                ‚úì Segna tutti
            </button>` : ''}
        </div>
        
        <!-- üñ•Ô∏è DESKTOP/TABLET: Tabella -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-100 text-xs uppercase text-gray-600">
                    <tr>
                        <th class="px-3 py-2 text-left">Ordine</th>
                        <th class="px-3 py-2 text-left">Cliente</th>
                        <th class="px-3 py-2 text-center">Quantit√†</th>
                        <th class="px-3 py-2 text-center hidden lg:table-cell">Stato</th>
                        <th class="px-3 py-2 text-right">Azione</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    ${group.orders.map(order => {
                            const hasMod = order.modification;
                            const isAddition = hasMod && hasMod.action === 'aggiungere';
                            const isRemoval = hasMod && hasMod.action === 'rimuovere';

                            let rowBg = 'hover:bg-gray-50';
                            let borderClass = '';

                            if (order.isPrepared) {
                                rowBg = 'bg-green-50 hover:bg-green-100';
                            } else if (isRemoval) {
                                rowBg = 'bg-red-50 hover:bg-red-100';
                                borderClass = 'border-l-4 border-red-500';
                            } else if (isAddition) {
                                rowBg = 'bg-orange-50 hover:bg-orange-100';
                                borderClass = 'border-l-4 border-orange-500';
                            }

                            return `
                        <tr class="${rowBg} ${borderClass}">
                            <td class="px-3 py-2">
                                <div class="flex items-center gap-2">
                                    <span class="bg-${isRemoval ? 'red' : isAddition ? 'orange' : order.isPrepared ? 'green' : 'blue'}-600 text-white text-xs font-bold px-2 py-1 rounded whitespace-nowrap">
                                        #${order.orderNumber}
                                    </span>
                                    <!-- Badge Stato su Tablet (nascosto su desktop) -->
                                    ${hasMod ? `
                                        <span class="lg:hidden bg-${isRemoval ? 'red' : 'orange'}-600 text-white text-xs px-2 py-0.5 rounded font-bold">
                                            ${isRemoval ? 'üóëÔ∏è' : '‚ûï'}
                                        </span>
                                    ` : ''}
                                </div>
                            </td>
                            <td class="px-3 py-2 font-medium">${order.customerName}</td>
                            <td class="px-3 py-2 text-center font-medium whitespace-nowrap">
                                ${order.qty % 1 === 0 ? order.qty : order.qty.toFixed(1)} ${group.unit}
                            </td>
                            <!-- Colonna Stato (solo Desktop) -->
                            <td class="px-3 py-2 text-center hidden lg:table-cell">
                                ${hasMod ? `
                                    <span class="inline-flex items-center bg-${isRemoval ? 'red' : 'orange'}-600 text-white text-xs px-2 py-1 rounded font-bold">
                                        ${isRemoval ? 'üóëÔ∏è RIMUOVI' : '‚ûï AGGIUNGI'}
                                    </span>
                                ` : '<span class="text-gray-400">-</span>'}
                            </td>
                            <td class="px-3 py-2 text-right">
                                ${order.isPrepared ? `
                                    <span class="inline-flex items-center bg-green-600 text-white font-bold px-3 py-1 rounded-full text-xs shadow">
                                        ‚úì FATTO
                                    </span>
                                ` : isRemoval ? `
                                    <button onclick="app.confirmModificationDone('${order.orderId}', ${order.itemIndex})"
                                        class="inline-flex items-center bg-red-600 hover:bg-red-700 text-white font-bold px-3 py-1 rounded shadow transition text-xs whitespace-nowrap">
                                        ‚úì Rimuovi
                                    </button>
                                ` : isAddition ? `
                                    <button onclick="app.confirmModificationDone('${order.orderId}', ${order.itemIndex})"
                                        class="inline-flex items-center bg-orange-600 hover:bg-orange-700 text-white font-bold px-3 py-1 rounded shadow transition text-xs whitespace-nowrap">
                                        ‚úì Aggiunto
                                    </button>
                                ` : `
                                    <button onclick="app.toggleItemPrepared('${order.orderId}', ${order.itemIndex})"
                                        class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold px-3 py-1 rounded shadow transition text-xs whitespace-nowrap">
                                        ‚úì Fatto
                                    </button>
                                `}
                            </td>
                        </tr>
                        `;
                        }).join('')}
                </tbody>
            </table>
        </div>
        
        <!-- üì± MOBILE: Card List -->
        <div class="md:hidden space-y-2">
            ${group.orders.map(order => {
                            const hasMod = order.modification;
                            const isAddition = hasMod && hasMod.action === 'aggiungere';
                            const isRemoval = hasMod && hasMod.action === 'rimuovere';

                            let cardBg = 'bg-white border-gray-200';
                            let borderClass = 'border-2';

                            if (order.isPrepared) {
                                cardBg = 'bg-green-50 border-green-300';
                            } else if (isRemoval) {
                                cardBg = 'bg-red-50 border-red-400';
                                borderClass = 'border-l-4';
                            } else if (isAddition) {
                                cardBg = 'bg-orange-50 border-orange-400';
                                borderClass = 'border-l-4';
                            }

                            return `
                <div class="rounded-lg ${borderClass} ${cardBg} p-3">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="bg-${isRemoval ? 'red' : isAddition ? 'orange' : order.isPrepared ? 'green' : 'blue'}-600 text-white text-sm font-bold px-3 py-1 rounded">
                                #${order.orderNumber}
                            </span>
                            ${hasMod ? `
                                <span class="bg-${isRemoval ? 'red' : 'orange'}-600 text-white text-xs px-2 py-0.5 rounded font-bold">
                                    ${isRemoval ? 'üóëÔ∏è' : '‚ûï'}
                                </span>
                            ` : ''}
                        </div>
                        ${order.isPrepared ? `
                            <span class="inline-flex items-center bg-green-600 text-white font-bold px-3 py-1 rounded-full text-xs">
                                ‚úì FATTO
                            </span>
                        ` : isRemoval ? `
                            <button onclick="app.confirmModificationDone('${order.orderId}', ${order.itemIndex})"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold px-3 py-1 rounded text-xs">
                                ‚úì Rimuovi
                            </button>
                        ` : isAddition ? `
                            <button onclick="app.confirmModificationDone('${order.orderId}', ${order.itemIndex})"
                                class="bg-orange-600 hover:bg-orange-700 text-white font-bold px-3 py-1 rounded text-xs">
                                ‚úì Fatto
                            </button>
                        ` : `
                            <button onclick="app.toggleItemPrepared('${order.orderId}', ${order.itemIndex})"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-3 py-1 rounded text-xs">
                                ‚úì Fatto
                            </button>
                        `}
                    </div>
                    <div class="text-sm text-gray-700 font-medium">${order.customerName}</div>
                    <div class="text-sm text-gray-600 mt-1">
                        ${group.unit === 'pezzo' ? 'üî¢' : '‚öñÔ∏è'} ${order.qty % 1 === 0 ? order.qty : order.qty.toFixed(1)} ${group.unit}
                    </div>
                    ${hasMod ? `
                        <div class="text-xs font-semibold text-${isRemoval ? 'red' : 'orange'}-700 mt-1">
                            ${order.modification.description}
                        </div>
                    ` : ''}
                </div>
                `;
                        }).join('')}
        </div>
    </div>
</div>
`;
                    }).join('');
                }

                renderModifications() {
                    const container = document.getElementById('modifications-list');

                    if (!container) {
                        console.log('‚è≠Ô∏è modifications-list non trovato, skip render');
                        this.updateStats(); // Aggiorna badge
                        return;
                    }

                    const dateFilter = document.getElementById('mod-date-filter').value;

                    // Filtra ordini con modifiche pendenti
                    let ordersWithMods = this.db.orders.filter(o =>
                        !o.deleted &&
                        o.pendingModifications &&
                        o.pendingModifications.length > 0
                    );

                    // Filtra per data se selezionata
                    if (dateFilter) {
                        ordersWithMods = ordersWithMods.filter(o => o.deliveryDate === dateFilter);
                    }

                    if (ordersWithMods.length === 0) {
                        container.innerHTML = `
            <div class="bg-white rounded-lg shadow p-8 text-center">
                <p class="text-gray-500 text-lg">‚úÖ Nessuna modifica pendente!</p>
                <p class="text-sm text-gray-400 mt-2">Tutti gli ordini sono aggiornati</p>
            </div>
        `;
                        this.updateStats(); // Aggiorna badge
                        return;
                    }

                    // Ordina per numero ordine
                    ordersWithMods.sort((a, b) => {
                        const numA = parseInt(a.number.split('-')[0]);
                        const numB = parseInt(b.number.split('-')[0]);
                        return numA - numB;
                    });

                    // Render
                    container.innerHTML = ordersWithMods.map(order => {
                        const customer = this.db.customers.find(c => c.id === order.customerId);
                        const customerName = customer ? `${customer.lastName} ${customer.firstName}` : 'Sconosciuto';
                        const modsCount = order.pendingModifications.length;

                        // Raggruppa modifiche per tipo
                        const additions = order.pendingModifications.filter(m => m.action === 'aggiungere');
                        const removals = order.pendingModifications.filter(m => m.action === 'rimuovere');

                        return `
<div class="bg-white rounded-lg shadow-lg overflow-hidden mb-4 border-l-4 border-orange-500">
    <!-- Header Ordine -->
    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-4">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-xl font-bold">
                    üì¶ Ordine #${order.number}
                </h3>
                <p class="text-sm opacity-90 mt-1">${customerName}</p>
            </div>
            <div class="text-right">
                <div class="bg-white text-orange-600 px-3 py-1 rounded-full font-bold text-sm">
                    ‚ö†Ô∏è ${modsCount} modifica${modsCount > 1 ? 'he' : ''}
                </div>
            </div>
        </div>
    </div>
    
    <div class="p-4 space-y-3">
        ${additions.length > 0 ? `
            <div class="space-y-2">
                <h4 class="font-bold text-orange-700 text-sm uppercase mb-2">‚ûï Da Aggiungere</h4>
                ${additions.map(mod => `
                    <div class="flex items-center justify-between p-3 bg-orange-50 border-2 border-orange-200 rounded-lg">
                        <div class="flex-1">
                            <div class="font-bold text-orange-900">${mod.productName}</div>
                            <div class="text-sm text-orange-700">${mod.description}</div>
                            <div class="text-sm font-medium text-orange-800 mt-1">
                                üì¶ ${mod.newQty} ${mod.unit}
                            </div>
                        </div>
                        <button onclick="app.confirmModificationDone('${order.id}', ${mod.index})"
                            class="bg-orange-600 hover:bg-orange-700 text-white font-bold px-4 py-2 rounded-lg shadow-lg transition whitespace-nowrap ml-3">
                            ‚úì Aggiunto
                        </button>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        
        ${removals.length > 0 ? `
            <div class="space-y-2">
                <h4 class="font-bold text-red-700 text-sm uppercase mb-2">üóëÔ∏è Da Rimuovere</h4>
                ${removals.map(mod => `
                    <div class="flex items-center justify-between p-3 bg-red-50 border-2 border-red-200 rounded-lg">
                        <div class="flex-1">
                            <div class="font-bold text-red-900">${mod.productName}</div>
                            <div class="text-sm text-red-700">${mod.description}</div>
                            <div class="text-sm font-medium text-red-800 mt-1">
                                üóëÔ∏è ${mod.oldQty} ${mod.unit}
                            </div>
                        </div>
                        <button onclick="app.confirmModificationDone('${order.id}', ${mod.index})"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold px-4 py-2 rounded-lg shadow-lg transition whitespace-nowrap ml-3">
                            ‚úì Rimosso
                        </button>
                    </div>
                `).join('')}
            </div>
        ` : ''}
    </div>
</div>
        `;
                    }).join('');

                    this.updateStats(); // Aggiorna badge
                }

                toggleItemPrepared(orderId, itemIndex) {
                    const order = this.db.orders.find(o => o.id === orderId);
                    if (!order) return;

                    if (!order.preparedItems) {
                        order.preparedItems = [];
                    }

                    const idx = order.preparedItems.indexOf(itemIndex);
                    if (idx > -1) {
                        order.preparedItems.splice(idx, 1);
                    } else {
                        order.preparedItems.push(itemIndex);
                    }

                    // Controlla se tutti i prodotti sono stati preparati
                    const totalItems = order.items.length;
                    const preparedCount = order.preparedItems.length;

                    if (preparedCount === totalItems && order.prepStatus === 'da preparare') {
                        // Tutti i prodotti preparati! Passa automaticamente a completato
                        console.log(`‚úÖ Cambio stato ordine #${order.number}: da preparare ‚Üí completato`);
                        order.prepStatus = 'completato';
                        const customer = this.db.customers.find(c => c.id === order.customerId);
                        const customerName = customer ? `${customer.lastName} ${customer.firstName}` : 'Ordine';
                        this.showToast(`‚úÖ ${customerName} #${order.number} ‚Üí COMPLETATO!`);
                    }

                    console.log(`Ordine #${order.number} - Stato: ${order.prepStatus}, Preparati: ${preparedCount}/${totalItems}`);

                    this.saveData();
                    this.renderPreparation();
                    this.filteredOrders = null; // Reset filtri per mostrare tutti gli ordini
                    this.render(); // Aggiorna anche la lista ordini
                    this.renderDashboard(); // Aggiorna dashboard
                }

                markAllProductPrepared(productName, dateFilter) {
                    let ordersToMark = this.db.orders;

                    if (dateFilter) {
                        ordersToMark = ordersToMark.filter(o => o.deliveryDate === dateFilter);
                    }

                    ordersToMark = ordersToMark.filter(o => o.prepStatus === 'da preparare');

                    let completedOrders = 0;

                    ordersToMark.forEach(order => {
                        if (!order.preparedItems) {
                            order.preparedItems = [];
                        }

                        order.items.forEach((item, index) => {
                            if (item.productName === productName && !order.preparedItems.includes(index)) {
                                order.preparedItems.push(index);
                            }
                        });

                        // Controlla se questo ordine √® ora completo
                        if (order.preparedItems.length === order.items.length && order.prepStatus === 'da preparare') {
                            order.prepStatus = 'completato';
                            completedOrders++;
                        }
                    });

                    this.saveData();
                    this.renderPreparation();
                    this.filteredOrders = null; // Reset filtri
                    this.render(); // Aggiorna lista ordini
                    this.renderDashboard(); // Aggiorna dashboard

                    let message = `‚úÖ Tutti i "${productName}" segnati come preparati`;
                    if (completedOrders > 0) {
                        message += `\nüéâ ${completedOrders} ordini completati automaticamente!`;
                    }
                    this.showToast(message);
                }

                confirmModificationDone(orderId, itemIndex) {
                    const order = this.db.orders.find(o => o.id === orderId);
                    if (!order) return;

                    console.log(`‚úÖ Conferma modifica per ordine #${order.number}, item index ${itemIndex}`);

                    // ‚úÖ STEP 1: Trova la modifica per capire se √® un'aggiunta o rimozione
                    let isRemoval = false;
                    if (order.pendingModifications) {
                        const mod = order.pendingModifications.find(m => m.index === itemIndex);
                        if (mod && mod.action === 'rimuovere') {
                            isRemoval = true;
                            console.log(`üóëÔ∏è Modifica √® una RIMOZIONE di ${mod.productName}`);
                        }
                    }

                    // ‚úÖ STEP 2: Se √® un'AGGIUNTA, segna l'item come preparato
                    if (!isRemoval) {
                        if (!order.preparedItems) {
                            order.preparedItems = [];
                        }

                        // Se non √® gi√† nell'array preparedItems, aggiungilo
                        if (!order.preparedItems.includes(itemIndex)) {
                            order.preparedItems.push(itemIndex);
                            console.log(`‚úÖ Item ${itemIndex} aggiunto a preparedItems`);
                        }
                    }

                    // ‚úÖ STEP 3: Rimuovi SOLO la modifica specifica (non tutte con lo stesso index)
                    if (order.pendingModifications) {
                        const modBefore = order.pendingModifications.length;

                        // Trova la modifica specifica da rimuovere
                        const modToRemove = order.pendingModifications.find(m =>
                            m.index === itemIndex && m.action === (isRemoval ? 'rimuovere' : 'aggiungere')
                        );

                        if (modToRemove) {
                            // Rimuovi SOLO questa modifica specifica
                            order.pendingModifications = order.pendingModifications.filter(m => m !== modToRemove);
                            console.log(`‚úÖ Rimossa modifica: ${modToRemove.action} ${modToRemove.productName}`);
                        }

                        const modAfter = order.pendingModifications.length;
                        console.log(`üìù Modifiche rimaste: ${modAfter} (prima: ${modBefore})`);
                    }

                    // ‚úÖ STEP 3.5: PULISCI preparedItems dagli indici che non esistono pi√π
                    if (order.preparedItems) {
                        const validIndices = order.preparedItems.filter(idx => idx < order.items.length);
                        if (validIndices.length !== order.preparedItems.length) {
                            console.log(`üßπ Pulizia preparedItems: da ${order.preparedItems.length} a ${validIndices.length} items validi`);
                            order.preparedItems = validIndices;
                        }
                    }

                    // ‚úÖ STEP 4: Ricalcola stato ordine
                    const totalItems = order.items.length;
                    const preparedCount = order.preparedItems ? order.preparedItems.length : 0;
                    const modificationsCount = order.pendingModifications ? order.pendingModifications.length : 0;

                    console.log(`üìä Ordine #${order.number}: ${preparedCount}/${totalItems} preparati, ${modificationsCount} modifiche pendenti`);

                    if (modificationsCount === 0) {
                        // ‚úÖ Nessuna modifica pendente
                        if (preparedCount === totalItems && totalItems > 0) {
                            // Tutti gli items sono preparati
                            order.prepStatus = 'completato';
                            order.pendingModifications = []; // Pulisci array
                            console.log(`‚úÖ Ordine #${order.number} ‚Üí COMPLETATO`);
                            this.showToast(`‚úÖ Ordine #${order.number} ‚Üí COMPLETATO!`, 'success');
                        } else if (preparedCount < totalItems) {
                            // Ci sono ancora items da preparare
                            order.prepStatus = 'da preparare';
                            order.pendingModifications = []; // Pulisci array
                            console.log(`‚ö†Ô∏è Ordine #${order.number} ‚Üí DA PREPARARE (${preparedCount}/${totalItems})`);
                            this.showToast(`‚úÖ Modifica completata. Rimangono ${totalItems - preparedCount} prodotti da preparare`, 'info');
                        }
                    } else {
                        // Ci sono ancora modifiche pendenti
                        order.prepStatus = 'da modificare';
                        console.log(`‚ö†Ô∏è Ordine #${order.number} ‚Üí DA MODIFICARE (${modificationsCount} modifiche pendenti)`);
                        this.showToast(`‚úÖ Modifica completata. Rimangono ${modificationsCount} modifiche`, 'info');
                    }

                    this.saveData();
                    this.renderPreparation();
                    this.filteredOrders = null;
                    this.render();
                    this.renderDashboard();
                }


                // DEBUG FUNCTIONS
                setupDebugLogger() {
                    const originalLog = console.log;
                    const originalError = console.error;

                    console.log = (...args) => {
                        originalLog.apply(console, args);
                        this.addDebugLog('log', args.join(' '));
                    };

                    console.error = (...args) => {
                        originalError.apply(console, args);
                        this.addDebugLog('error', args.join(' '));
                    };
                }

                addDebugLog(type, message) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.debugLogs.push({ type, message, timestamp });

                    // Mantieni solo gli ultimi 50 log
                    if (this.debugLogs.length > 50) {
                        this.debugLogs.shift();
                    }

                    // Aggiorna il pannello se visibile
                    const debugPanel = document.getElementById('debug-panel');
                    if (debugPanel && !debugPanel.classList.contains('hidden')) {
                        this.updateDebugPanel();
                    }
                }

                updateDebugPanel() {
                    const debugInfo = document.getElementById('debug-info');
                    if (!debugInfo) return;

                    const statusInfo = `
                    <div class="mb-3 p-2 bg-gray-800 rounded">
                        <div>üîå Client: ${this.dropboxClient ? '‚úÖ Connesso' : '‚ùå Non connesso'}</div>
                        <div>üîÑ Sync in corso: ${this.syncInProgress ? 'S√¨' : 'No'}</div>
                        <div>‚öôÔ∏è Auto-sync: ${this.autoSyncEnabled ? '‚úÖ Attivo' : '‚ùå Inattivo'}</div>
                        <div>‚è∞ Interval ID: ${this.autoSyncInterval || 'N/A'}</div>
                        <div>üìä Ordini: ${this.db.orders?.length || 0}</div>
                        <div>üõçÔ∏è Prodotti: ${this.db.products?.length || 0}</div>
                        <div>üë• Clienti: ${this.db.customers?.length || 0}</div>
                        <div>üïê Ultima sync: ${localStorage.getItem('lastDropboxSync') || 'Mai'}</div>
                    </div>
                `;

                    const logs = this.debugLogs.slice(-20).reverse().map(log => {
                        const color = log.type === 'error' ? 'text-red-400' : 'text-green-400';
                        return `<div class="${color}">[${log.timestamp}] ${log.message}</div>`;
                    }).join('');

                    debugInfo.innerHTML = statusInfo + `<div class="max-h-64 overflow-y-auto">${logs}</div>`;
                }

                async testDropboxConnection() {
                    if (!this.dropboxClient) {
                        console.error("‚ùå Client Dropbox non inizializzato");
                        this.showToast("‚ùå Dropbox non connesso", "error");
                        return;
                    }

                    try {
                        console.log("üß™ Test connessione Dropbox...");
                        const response = await this.dropboxClient.usersGetCurrentAccount();
                        console.log("‚úÖ Dropbox OK! Account:", response.result.name.display_name);
                        this.showToast(`‚úÖ Connesso: ${response.result.name.display_name}`);
                    } catch (error) {
                        console.error("‚ùå Errore test:", error);
                        this.showToast(`‚ùå Errore: ${error.message}`, "error");
                    }
                }
                setupDebugPanel() {
                    const header = document.querySelector('h2.text-xl.font-bold');
                    if (!header) return;

                    let pressTimer;

                    header.addEventListener('touchstart', (e) => {
                        pressTimer = setTimeout(() => {
                            const debugPanel = document.getElementById('debug-panel');
                            debugPanel.classList.remove('hidden');
                            this.updateDebugPanel();
                            this.showToast('üêõ Pannello debug attivato');
                        }, 3000); // 3 secondi
                    });

                    header.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                    });

                    header.addEventListener('touchmove', () => {
                        clearTimeout(pressTimer);
                    });

                    // Desktop: doppio click
                    let clickCount = 0;
                    header.addEventListener('click', () => {
                        clickCount++;
                        if (clickCount === 5) { // 5 click rapidi
                            const debugPanel = document.getElementById('debug-panel');
                            debugPanel.classList.remove('hidden');
                            this.updateDebugPanel();
                            this.showToast('üêõ Pannello debug attivato');
                            clickCount = 0;
                        }
                        setTimeout(() => { clickCount = 0; }, 2000);
                    });
                }

                forceCheckRemote() {
                    console.log('üîß Controllo remoto forzato manualmente');
                    this.checkForRemoteUpdates();
                }

                clearDebugLogs() {
                    this.debugLogs = [];
                    this.updateDebugPanel();
                    this.showToast('üóëÔ∏è Log puliti');
                }

            }

            const app = new OrderManager();
            document.addEventListener('click', (e) => {
                // Gestisci chiusura suggerimenti nella tab clienti
                if (!e.target.closest('#customer-search')) {
                    const customerSuggestions = document.getElementById('customer-suggestions');
                    if (customerSuggestions) {
                        customerSuggestions.classList.add('hidden');
                    }
                }
                // Gestisci chiusura suggerimenti nel modal ordini
                if (!e.target.closest('#customer-search-order')) {
                    const orderSuggestions = document.getElementById('customer-suggestions-order');
                    if (orderSuggestions) {
                        orderSuggestions.classList.add('hidden');
                    }
                }
                // Gestisci chiusura suggerimenti prodotti
                if (!e.target.closest('#order-product') && !e.target.closest('#product-suggestions')) {
                    const productSuggestions = document.getElementById('product-suggestions');
                    if (productSuggestions) {
                        productSuggestions.classList.add('hidden');
                    }
                }
            });
        </script>

        <!-- Modal Cambio Password -->
        <div id="change-password-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">üîí Cambia Password</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password Attuale</label>
                        <input type="password" id="current-password"
                            class="w-full px-3 py-2 border rounded-lg focus:border-blue-500 focus:outline-none"
                            placeholder="Inserisci password attuale">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nuova Password</label>
                        <input type="password" id="new-password"
                            class="w-full px-3 py-2 border rounded-lg focus:border-blue-500 focus:outline-none"
                            placeholder="Almeno 6 caratteri">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Conferma Nuova Password</label>
                        <input type="password" id="confirm-new-password"
                            class="w-full px-3 py-2 border rounded-lg focus:border-blue-500 focus:outline-none"
                            placeholder="Ripeti la nuova password"
                            onkeypress="if(event.key === 'Enter') authManager.changePassword()">
                    </div>

                    <div id="change-password-error"
                        class="hidden p-3 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm"></div>

                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 text-sm text-yellow-800">
                        ‚ö†Ô∏è Dopo il cambio password, dovrai effettuare nuovamente il login
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="authManager.closeChangePasswordModal()"
                        class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">
                        Annulla
                    </button>
                    <button onclick="authManager.changePassword()"
                        class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Cambia Password
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- MODAL FIDELITY -->
        <!-- ========================================== -->

        <!-- Modal Aggiungi Bollini -->
        <div id="add-stamps-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-[100]">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-md">
                <!-- Header -->
                <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">‚ûï Aggiungi Bollini</h2>
                        <button onclick="app.closeAddStampsModal()" class="text-white hover:text-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Body -->
                <div class="p-6">
                    <!-- Info Cliente -->
                    <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-600">Cliente</p>
                                <p class="text-lg font-bold text-gray-800" id="stamps-customer-name">-</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Bollini attuali</p>
                                <p class="text-2xl font-bold text-purple-600" id="stamps-customer-current">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Input Bollini -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Quanti bollini vuoi aggiungere?
                        </label>
                        <input type="number" id="stamps-count" step="1" min="1"
                            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none"
                            placeholder="Es. 5" autofocus>
                    </div>

                    <!-- Info Box -->
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                    clip-rule="evenodd" />
                            </svg>
                            <div class="flex-1 text-sm text-blue-800">
                                <p class="font-semibold mb-1">üí° Promemoria</p>
                                <p>‚Ä¢ Ogni ‚Ç¨20 di spesa = 1 bollino</p>
                                <p>‚Ä¢ 10 bollini = 1 premio üéÅ</p>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-3">
                        <button onclick="app.closeAddStampsModal()"
                            class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-semibold transition">
                            Annulla
                        </button>
                        <button onclick="app.confirmAddStamps()"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 font-semibold shadow-lg transition">
                            Aggiungi Bollini
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Nuova Campagna Coupon -->
        <div id="campaign-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-[100]">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4">üé´ Nuova Campagna Coupon</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Campagna</label>
                        <input type="text" id="campaign-name"
                            class="w-full px-3 py-2 border rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Es. Natale 2024">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                        <input type="text" id="campaign-description"
                            class="w-full px-3 py-2 border rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Es. Sconto natalizio speciale">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Sconto</label>
                        <select id="campaign-discount-type" onchange="app.updateCampaignDiscountLabel()"
                            class="w-full px-3 py-2 border rounded-lg focus:border-purple-500 focus:outline-none">
                            <option value="percentage">Percentuale (%)</option>
                            <option value="fixed">Importo Fisso (‚Ç¨)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Valore Sconto <span id="campaign-discount-label">(% da 1 a 100)</span>
                        </label>
                        <input type="number" id="campaign-discount-value" step="1" min="0"
                            class="w-full px-3 py-2 border rounded-lg focus:border-purple-500 focus:outline-none"
                            placeholder="Es. 10">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date di Ritiro Valide</label>
                        <div class="text-sm text-gray-600 mb-2">Seleziona le date in cui il coupon √® valido:</div>
                        <div id="campaign-dates-container" class="space-y-2 mb-2">
                            <!-- Date inputs dinamici -->
                        </div>
                        <button type="button" onclick="app.addCampaignDateInput()"
                            class="w-full bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 text-sm">
                            + Aggiungi Data
                        </button>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Scadenza Coupon (Opzionale)</label>
                        <input type="date" id="campaign-expiry"
                            class="w-full px-3 py-2 border rounded-lg focus:border-purple-500 focus:outline-none">
                        <p class="text-xs text-gray-500 mt-1">Lascia vuoto per nessuna scadenza</p>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="app.closeCampaignModal()"
                        class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">
                        Annulla
                    </button>
                    <button onclick="app.saveCampaign()"
                        class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                        Crea Campagna
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Scanner QR Fidelity -->
        <div id="fidelity-qr-scanner-modal"
            class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-[100]">
            <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">üì∑ Scanner QR Fidelity</h2>
                    <button onclick="app.closeFidelityQRScanner()"
                        class="text-gray-500 hover:text-gray-700 text-3xl leading-none">
                        √ó
                    </button>
                </div>

                <div class="relative">
                    <video id="fidelity-qr-video" class="w-full rounded-lg" autoplay playsinline></video>
                    <canvas id="fidelity-qr-canvas" class="hidden"></canvas>
                </div>

                <div id="fidelity-qr-result" class="mt-4"></div>

                <div class="mt-4 text-center text-sm text-gray-600">
                    <p>Inquadra il QR code della tessera fidelity del cliente</p>
                </div>
            </div>
        </div>

        <!-- Modal Storia Fidelity Cliente -->
        <div id="customer-fidelity-history-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-[100]">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">

                <!-- Header Fisso -->
                <div
                    class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-lg flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">üìã Cronologia Fidelity</h2>
                        <p class="text-sm text-blue-100 mt-1">
                            Cliente: <span id="history-customer-name" class="font-semibold"></span>
                        </p>
                    </div>
                    <button onclick="app.closeCustomerFidelityHistory()"
                        class="text-white hover:text-blue-200 transition">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Info Bollini -->
                <div class="bg-blue-50 px-6 py-3 border-b">
                    <p class="text-sm text-gray-700">
                        Bollini totali: <span id="history-customer-stamps" class="font-bold text-blue-600"></span>
                    </p>
                </div>

                <!-- Contenuto Scrollabile -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="fidelity-history-list" class="space-y-2"></div>
                </div>

            </div>
        </div>

        <!-- Modal Dettagli Cliente Fidelity -->
        <div id="customer-fidelity-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div id="customer-fidelity-modal-content"></div>
            </div>
        </div>

        <!-- Modal Premi Disponibili -->
        <div id="available-rewards-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-[9999] hidden">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üéÅ Clienti con Premi Disponibili</h2>
                    <button onclick="app.closeAvailableRewardsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="overflow-y-auto flex-1 p-6">
                    <div id="available-rewards-list"></div>
                </div>
            </div>
        </div>

        <!-- Modal Premi Riscattati -->
        <div id="redeemed-rewards-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-[9999] hidden">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold">‚úÖ Clienti con Premi Riscattati</h2>
                    <button onclick="app.closeRedeemedRewardsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="overflow-y-auto flex-1 p-6">
                    <div id="redeemed-rewards-list"></div>
                </div>
            </div>
        </div>

        <!-- Modal Coupon Attivi -->
        <div id="active-coupons-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-[9999] hidden">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <div
                    class="bg-gradient-to-r from-pink-600 to-pink-700 text-white p-6 rounded-t-lg flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üéüÔ∏è Clienti con Coupon Attivi</h2>
                    <button onclick="app.closeActiveCouponsModal()" class="text-white hover:text-pink-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="overflow-y-auto flex-1 p-6">
                    <div id="active-coupons-list"></div>
                </div>
            </div>
        </div>

        <!-- Modal Coupon Usati -->
        <div id="used-coupons-modal"
            class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-[9999] hidden">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <div
                    class="bg-gradient-to-r from-orange-600 to-orange-700 text-white p-6 rounded-t-lg flex justify-between items-center">
                    <h2 class="text-2xl font-bold">‚úîÔ∏è Clienti con Coupon Usati</h2>
                    <button onclick="app.closeUsedCouponsModal()" class="text-white hover:text-orange-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="overflow-y-auto flex-1 p-6">
                    <div id="used-coupons-list"></div>
                </div>
            </div>
        </div>


        <!-- Floating Buttons con Auto-Hide -->
        <div id="floating-buttons"
            class="fixed bottom-6 left-0 right-0 flex justify-between px-6 transition-all duration-300 z-50"
            style="pointer-events: none;">
            <!-- Home Button (Left) -->
            <button onclick="app.switchTab('dashboard')"
                class="bg-gradient-to-br from-blue-500 to-blue-600 text-white w-14 h-14 rounded-full shadow-2xl hover:shadow-3xl transition-all duration-300 flex items-center justify-center hover:scale-110 active:scale-95"
                style="pointer-events: auto;">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
            </button>

            <!-- Scanner QR Button (Right) -->
            <button onclick="app.openFidelityQRScanner()"
                class="bg-gradient-to-br from-green-500 to-green-600 text-white w-14 h-14 rounded-full shadow-2xl hover:shadow-3xl transition-all duration-300 flex items-center justify-center hover:scale-110 active:scale-95"
                style="pointer-events: auto;">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
                    </path>
                </svg>
            </button>
        </div>

</body>

</html>